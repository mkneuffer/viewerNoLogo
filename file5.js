/*!For license information please see 671.b3a59ef8.js.LICENSE.txt*/"use strict";(self.webpackChunkwebgi=self.webpackChunkwebgi||[]).push([[671],{3995:function(e,t,i){i.d(t,{M:function(){return n},Q:function(){return s}});var r=i(9008),a=i(4107);class s extends r.SimpleEventDispatcher{constructor(){super(...arguments),this._dirty=!1}get dirty(){return this.enabled&&this._dirty}set dirty(e){this._dirty=e}async onAdded(e){this._viewer=e}async onDispose(e){}async onRemove(e){this._viewer!==e&&console.error("Wrong viewer"),this._viewer=void 0}toJSON(e){const t=(0,a.HD)(this,!0,e);return t.type=this.constructor.PluginType,this.dispatchEvent({type:"serialize",data:t}),t}fromJSON(e,t){return e.type!==this.constructor.PluginType?null:((0,a.Hx)(e,this,!0,t),this.dispatchEvent({type:"deserialize",data:e,meta:t}),this)}_storeKey(e){return(e??"webgi")+"_"+(this.constructor.PluginType||this.constructor.name)}exportState(){return this._viewer?.getPluginByType("AssetManager")?.exportPluginPreset(this)??this.toJSON?.()}async importState(e){const t=this._viewer?.getPluginByType("AssetManager");t?await t.importPluginPreset(e,this):this.fromJSON?.(e)}storeState(e,t,i){(t=t||(window?window.localStorage:void 0))?(void 0===i&&(i=this.exportState()),i&&t.setItem(this._storeKey(e),JSON.stringify(i))):console.warn("Unable to store state")}async loadState(e,t){if(!(t=t||(window?window.localStorage:void 0)))return void console.warn("Unable to load state");const i=t.getItem(this._storeKey(e));i&&await this.importState(JSON.parse(i))}}function n(e,t,i){return{...t,get dirty(){return t.dirty||!1},set dirty(e){(0,r.safeSetProperty)(t,"dirty",e,!0)},update(){this.passObject.enabled&&(this.passObject.updateShaderProperties?.((0,r.getOrCall)(i)),t.update?.call(this))},onRegister(i){this.passObject.materialExtension&&e.getPluginByType("AssetManager")?.materials?.registerMaterialExtension(this.passObject.materialExtension),t.onRegister?.call(this,i)},onUnregister(i){this.passObject.materialExtension&&e.getPluginByType("AssetManager")?.materials?.unregisterMaterialExtension(this.passObject.materialExtension),t.onUnregister?.call(this,i)},dispose(){this.passObject.dispose?.(),t.dispose?.call(this)}}}},4091:function(e,t,i){i.d(t,{B$:function(){return c},iw:function(){return o},qD:function(){return l},qt:function(){return n}});var r=i(2988),a=i(4107),s=i(1483);class n extends r.Ox3{get lightObject(){return this}get modelObject(){return this}constructor(e,t){super(),this.assetType="light",this.isDirectionalLight2=!0,this.color=new r.Ilk(e),this.intensity=t||1,this.target.position.set(0,0,-1),this.add(this.target)}copy(e,t){const i=this.target,r=e.userData;return e.userData={},super.copy(e,t),(0,s.A)(this.userData,r),i.position.copy(this.target.position),i.updateMatrixWorld(),this.target=i,this}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Directional Light",children:[{type:"checkbox",label:"Enabled",property:[this,"visible"]},{type:"color",label:"Color",property:[this,"color"]},{type:"slider",label:"Intensity",bounds:[0,20],property:[this,"intensity"]},{type:"vec3",label:"Rotation",property:[this,"rotation"]},{type:"vec3",label:"Position",property:[this,"position"]},{type:"checkbox",label:"Shadow Enabled",property:[this,"castShadow"]},{type:"vec2",label:"Shadow Map Size",property:[this?.shadow,"mapSize"],onChange:()=>{this.shadow.map?.dispose(),this.shadow.mapPass?.dispose(),this.shadow.map=null,this.shadow.mapPass=null}},{type:"slider",bounds:[-.001,.001],stepSize:2e-5,label:"Shadow Bias",property:[this?.shadow,"bias"],onChange:this.setDirty},{type:"slider",bounds:[-.1,.1],stepSize:.005,label:"Shadow Normal Bias",property:[this?.shadow,"normalBias"],onChange:this.setDirty},{type:"slider",bounds:[0,5],label:"Shadow radius",property:[this?.shadow,"radius"],onChange:this.setDirty},{type:"slider",bounds:[.1,50],label:"Shadow frustum",getValue:()=>2*this.shadow.camera.right,setValue:e=>{this.shadow.camera.left=-e/2,this.shadow.camera.right=e/2,this.shadow.camera.top=e/2,this.shadow.camera.bottom=-e/2},onChange:this.setDirty}]}}toJSON(e){const{userData:t,children:i}=this;this.userData={},this.children=[];const r=super.toJSON(e);return r.userData=(0,a.HD)((0,s.A)({},t),!1),this.userData={},this.children=i,r.type="DirectionalLight2",r.target=this.target.position.toArray(),Object.assign(r,(0,a.HD)(this,!0,e))}fromJSON(e,t){if("DirectionalLight2"!==e.type)return null;const i=e.target,r=e.object;return e.target&&(this.target.position.fromArray(e.target),this.target.updateMatrixWorld(),delete e.target),e.object&&delete e.object,(0,a.Hx)(e,this,!0,t),i&&(e.target=i),r&&(void 0!==r.color&&this.color.set(r.color),void 0!==r.intensity&&(this.intensity=r.intensity),e.object=r),this}}class o extends r.PMe{get lightObject(){return this}get modelObject(){return this}constructor(e,t,i,r,a,s){super(e,t,i,r,a,s),this.assetType="light",this.target.position.set(0,0,-1),this.add(this.target)}copy(e,t){const i=this.target,r=e.userData;return e.userData={},super.copy(e,t),(0,s.A)(this.userData,r),i.position.copy(this.target.position),i.updateMatrixWorld(),this.target=i,this}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Spot Light",children:[{type:"checkbox",label:"Enabled",property:[this,"visible"]},{type:"color",label:"Color",property:[this,"color"]},{type:"slider",label:"Intensity",bounds:[0,30],property:[this,"intensity"]},{type:"slider",bounds:[0,2],property:[this,"angle"]},{type:"slider",bounds:[0,.9999],property:[this,"penumbra"]},{type:"vec3",label:"Rotation",property:[this,"rotation"]},{type:"vec3",label:"Position",property:[this,"position"]},{type:"checkbox",label:"Shadow Enabled",property:[this,"castShadow"]},{type:"vec2",label:"Shadow Map Size",property:[this?.shadow,"mapSize"],onChange:()=>{this.shadow.map?.dispose(),this.shadow.mapPass?.dispose(),this.shadow.map=null,this.shadow.mapPass=null}},{type:"slider",bounds:[-.001,.001],stepSize:2e-5,label:"Shadow Bias",property:[this?.shadow,"bias"],onChange:this.setDirty},{type:"slider",bounds:[0,5],label:"Shadow radius",property:[this?.shadow,"radius"],onChange:this.setDirty}]}}toJSON(e){const{userData:t,children:i}=this;this.userData={},this.children=[];const r=super.toJSON(e);return r.userData=(0,a.HD)((0,s.A)({},t),!1),this.userData={},this.children=i,r.type="SpotLight2",r.target=this.target.position.toArray(),Object.assign(r,(0,a.HD)(this,!0,e))}fromJSON(e,t){return"SpotLight2"!==e.type?null:(e.target&&(this.target.position.fromArray(e.target),this.target.updateMatrixWorld()),e.object?(void 0!==e.object.color&&this.color.set(e.object.color),void 0!==e.object.intensity&&(this.intensity=e.object.intensity),void 0!==e.object.distance&&(this.distance=e.object.distance),void 0!==e.object.angle&&(this.angle=e.object.angle),void 0!==e.object.decay&&(this.decay=e.object.decay),void 0!==e.object.penumbra&&(this.penumbra=e.object.penumbra),(0,a.Hx)(e,this,!0,t),this):this)}}class l extends r.cek{get lightObject(){return this}get modelObject(){return this}constructor(e,t,i,r){super(e,t,i,r),this.assetType="light"}copy(e,t){const i=e.userData;return e.userData={},super.copy(e,t),(0,s.A)(this.userData,i),this}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Point Light",children:[{type:"checkbox",label:"Enabled",property:[this,"visible"]},{type:"color",label:"Color",property:[this,"color"]},{type:"slider",label:"Intensity",bounds:[0,20],property:[this,"intensity"]},{type:"input",label:"Distance",property:[this,"distance"]},{type:"input",property:[this,"decay"]},{type:"vec3",label:"Position",property:[this,"position"]},{type:"checkbox",label:"Shadow Enabled",property:[this,"castShadow"]},{type:"vec2",label:"Shadow Map Size",property:[this?.shadow,"mapSize"],onChange:()=>{this.shadow.map?.dispose(),this.shadow.mapPass?.dispose(),this.shadow.map=null,this.shadow.mapPass=null}},{type:"slider",bounds:[-.001,.001],stepSize:2e-5,label:"Shadow Bias",property:[this?.shadow,"bias"],onChange:this.setDirty},{type:"slider",bounds:[0,5],label:"Shadow radius",property:[this?.shadow,"radius"],onChange:this.setDirty}]}}toJSON(e){const{userData:t}=this;this.userData={};const i=super.toJSON(e);return i.userData=(0,a.HD)((0,s.A)({},t),!1),this.userData={},i.type="PointLight2",Object.assign(i,(0,a.HD)(this,!0,e))}fromJSON(e,t){return"PointLight2"!==e.type?null:e.object?(void 0!==e.object.color&&this.color.set(e.object.color),void 0!==e.object.intensity&&(this.intensity=e.object.intensity),void 0!==e.object.distance&&(this.distance=e.object.distance),void 0!==e.object.decay&&(this.decay=e.object.decay),(0,a.Hx)(e,this,!0,t),this):this}}class c extends r.Mig{get lightObject(){return this}get modelObject(){return this}constructor(e,t){super(e,t),this.assetType="light"}copy(e,t){const i=e.userData;return e.userData={},super.copy(e,t),(0,s.A)(this.userData,i),this}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Ambient Light",children:[{type:"checkbox",label:"Enabled",property:[this,"visible"]},{type:"color",label:"Color",property:[this,"color"]},{type:"slider",label:"Intensity",bounds:[0,20],property:[this,"intensity"]}]}}toJSON(e){const{userData:t}=this;this.userData={};const i=super.toJSON(e);return i.userData=(0,a.HD)((0,s.A)({},t),!1),this.userData={},i.type="AmbientLight2",Object.assign(i,(0,a.HD)(this,!0,e))}fromJSON(e,t){return"AmbientLight2"!==e.type?null:e.object?(void 0!==e.object.color&&this.color.set(e.object.color),void 0!==e.object.intensity&&(this.intensity=e.object.intensity),(0,a.Hx)(e,this,!0,t),this):this}}},7485:function(e,t,i){i.d(t,{N:function(){return l},j:function(){return c}});var r=i(2988),a=i(1191),s=i(6533),n=i(1865),o=i(1483);class l{get visible(){return this._modelObject.visible}set visible(e){this._modelObject.visible=e}get uuid(){return this._modelObject.uuid}get modelObject(){return this._modelObject}get name(){return this._modelObject.name}set name(e){this._modelObject.name=e}constructor(e,{pseudoCenter:t=!1,autoCenter:i=!0,autoScale:n=!0,autoScaleRadius:l=2,license:c=""}={}){if(this.assetType="model",this._modelObject=(0,o.LC)(new r.Tme),this.setDirty=this.setDirty.bind(this),this.updateBounds=this.updateBounds.bind(this),e||(e=this._modelObject),!t||e.userData.pseudoCentered||e.userData.isCentered)!i||e.userData.autoCentered||e.userData.isCentered||e.userData.pseudoCentered?t||i||(e.userData.isCentered=!0):(0,s.HC)(e),this._modelObject=e;else{i&&console.error("cannot use pseudoCenter and autoCenter at the same time");const t=(new a.q).expandByObject(e,!0,!0).getCenter(new r.Pa4);this._modelObject.position.copy(t).negate(),this._modelObject.updateMatrix(),this._modelObject.add(e),this._modelObject.name=e.name+"-centered",this._modelObject.userData.pseudoCentered=!0,this._modelObject.userData.isCentered=!0,e.userData.iModel=this}n&&!this._modelObject.userData.autoScaled?(0,s.RG)(this._modelObject,e.userData.autoScaleRadius||l):this._modelObject.userData.autoScaled=!0,this._modelObject.addEventListener("dispose",(()=>{this.__disposed=!0})),this._modelObject.userData.iModel=this,this.license=c}get license(){return this._modelObject.userData.license}set license(e){this._modelObject.userData.license=e}addEventListener(e,t){this._modelObject.addEventListener(e,t)}dispatchEvent(e){this._modelObject.dispatchEvent(e)}hasEventListener(e,t){return this._modelObject.hasEventListener(e,t)}removeEventListener(e,t){this._modelObject.removeEventListener(e,t)}traverse(e){this._modelObject.traverse(e)}dispose(){const e=this._modelObject.dispose;e&&"function"==typeof e?e():(console.warn("no dispose in modelObject"),this._modelObject.removeFromParent())}setDirty(e){this._modelObject?.setDirty?.(e),this._uiConfig?.uiRefresh?.("postFrame",!0)}setMaterial(e){return this._modelObject.isMesh?this._modelObject.setMaterial?.(e)||[]:(console.error("setMaterial only works on meshes"),[])}get material(){return this._modelObject.material}get geometry(){return this._modelObject.geometry}setGeometry(e,t=!1){if(this._modelObject.isMesh)return this._modelObject.setGeometry?.(e,t);console.error("setGeometry only works on meshes")}get userData(){return this._modelObject.userData}set userData(e){this._modelObject.userData=e}updateBounds(){console.warn("updateBounds: NOT IMPLEMENTED"),this.setDirty()}get uiConfig(){return this._uiConfig||(this._uiConfig=(0,n.s)(this._modelObject,!1)),this._uiConfig}clone(){return new l(this._modelObject.clone(),{pseudoCenter:!1,autoScale:!0,autoCenter:!0,license:this.license})}}function c(e,t){return[e.modelObject,...e.modelObject.children].forEach((i=>{(0,o.LC)(i,i!==e.modelObject?e:void 0,t)})),e}},1483:function(e,t,i){i.d(t,{A:function(){return o},DQ:function(){return n},Ej:function(){return s},LC:function(){return a}});var r=i(1865);function a(e,t,i){if(!e)return void console.warn("setupIModel: object is undefined");if(e.__disposed&&(console.warn("re-init/re-add disposed object, things might not work as intended",e),delete e.__disposed),e.userData||(e.userData={}),e.userData.__iModelSetup&&e.modelObject)return e;e.userData.__iModelSetup=!0;let s=[];s.push((()=>{[...e.children].forEach((t=>{t?.dispose?.(),e.add(t)})),e.parent&&e.removeFromParent()})),e.isLight&&!e.assetType?(e.assetType="light",e.lightObject=e):e.isCamera?(e.assetType="camera",e.cameraObject=e):e.assetType||(e.assetType="model"),e.modelObject||(e.modelObject=e),e.setDirty||(e.setDirty=(t={})=>{e.dispatchEvent({...t,type:"objectUpdate",object:e})},e.userData.setDirty&&console.warn("userData.setDirty already defined",e.userData.setDirty,e),e.userData.setDirty=t=>{console.warn("userData.setDirty is deprecated, use setDirty directly"),e.setDirty?.(t)}),e.addEventListener("added",(t=>{const i=e.parent?.userData.parentRoot??e.parent;i!==e.userData.parentRoot&&e.traverse((e=>{e.userData.parentRoot=i})),e.setDirty?.({change:"addedToParent"})})),e.addEventListener("removed",(()=>{e.setDirty?.({change:"removedFromParent"}),void 0!==e.userData.parentRoot&&e.traverse((e=>{e.userData.parentRoot=void 0}))})),s.push((()=>{}));const n=e.dispose;e.dispose=()=>{e.dispatchEvent({type:"dispose"}),n?.call(e)},e.userData.dispose&&console.warn("userData.dispose already defined"),e.userData.dispose=()=>{console.warn("userData.dispose is deprecated, use dispose directly"),e.dispose?.()};const l=e;!l.isMesh&&!l.isLine||l.userData.__meshSetup||(l.userData.__meshSetup=!0,l.setMaterial||(l.setMaterial=e=>function(e,t){const i=(Array.isArray(t)?t:[t]).map((e=>e?.materialObject)).filter((e=>e));if(e.material==i||1===i.length&&e.material===i[0])return[];e.userData.__materialUpdater||(e.userData.__materialUpdater=()=>{e.dispatchEvent({type:"materialUpdate"})}),e.userData.__textureUpdater||(e.userData.__textureUpdater=()=>{e.dispatchEvent({type:"textureUpdate"})});const r=Array.isArray(e.material)?[...e.material]:[e.material];for(const t of r)t&&(t.removeEventListener("materialUpdate",e.userData.__materialUpdater),t.removeEventListener("textureUpdate",e.userData.__textureUpdater),t.userData?.__appliedMeshes?.delete(e));const a=[];for(const t of i)t.userData.__appliedMeshes||(t.userData.__appliedMeshes=new Set),a.push(t),t&&(t.addEventListener("materialUpdate",e.userData.__materialUpdater),t.addEventListener("textureUpdate",e.userData.__textureUpdater),t.userData.__appliedMeshes.add(e));return e.material=1!==a.length?a:a[0]??void 0,e.dispatchEvent({type:"materialChanged",material:t,mesh:e}),e.uiConfig?.uiRefresh?.("postFrame",!0),r}(l,e)),l.setGeometry||(l.setGeometry=(e,t=!1)=>function(e,t,i=!1){e.userData.__objectUpdater||(e.userData.__objectUpdater=t=>{e.dispatchEvent({...t,type:"objectUpdate"})});let a=e.geometry;const s=a;return(a!==t||i)&&(a&&(a.removeEventListener("geometryUpdate",e.userData.__objectUpdater),a.userData?.__appliedMeshes?.delete(e)),a=t,a&&!a.userData.__appliedMeshes&&(a.userData.__appliedMeshes=new Set),e.geometry=a??void 0,a&&(e.updateMorphTargets(),a.addEventListener("geometryUpdate",e.userData.__objectUpdater),a.userData?.__appliedMeshes?.add(e))),t&&!t.uiConfig&&(t.uiConfig=(0,r.l)(e.geometry)),e.dispatchEvent({type:"geometryChanged",geometry:t}),e.uiConfig?.uiRefresh?.("postFrame",!0),s===a?void 0:s||void 0}(l,e,t),l.setGeometry(l.geometry,!0)),e.userData.setMaterial&&console.warn("userData.setMaterial already defined"),e.userData.setMaterial=t=>{console.warn("userData.setMaterial is deprecated, use setMaterial directly"),e.setMaterial?.(t)},e.userData.setGeometry&&console.warn("userData.setGeometry already defined"),e.userData.setGeometry=(t,...i)=>{console.warn("userData.setGeometry is deprecated, use setGeometry directly"),e.setGeometry?.(t,...i)},e.userData.__keepShadowDef||(e.castShadow=!0,e.receiveShadow=!0,e.userData.__keepShadowDef=!0),s.push((()=>{const e=l.setMaterial?.(void 0)||[],t=l.setGeometry?.(void 0);for(const t of e)t&&t.userData&&0===t.userData.__appliedMeshes?.size&&!1!==t.userData.disposeOnIdle&&t.dispose();t&&t.userData&&0===t.userData.__appliedMeshes?.size&&!1!==t.userData.disposeOnIdle&&t.dispose(),l.setMaterial?.(e),l.setGeometry?.(t)}))),e.uiConfig||"model"!==e.assetType&&"camera"!==e.assetType||((0,r.s)(e),s.push((()=>{}))),e.addEventListener("objectUpdate",(({refreshUi:t})=>!1!==t&&e.uiConfig?.uiRefresh?.("postFrame",!0,1))),e.userData.__autoParentDispatchEvents?console.warn("object.userData.__autoParentDispatchEvents already set"):(e.userData.__autoParentDispatchEvents=e.userData.__autoParentDispatchEvents||["objectUpdate","materialUpdate","select","materialChanged","textureUpdate"],e.isCamera&&e.userData.__autoParentDispatchEvents.push("activateMain","setView")),t&&(e.userData.parentRoot=t);const c=e.dispatchEvent;e.dispatchEvent=t=>{e.userData.__autoParentDispatchEvents?.includes(t.type)&&(t.parentDispatch=!0),t.parentDispatch&&(t=>{const i=e.userData.parentRoot??e.parent;i?.modelObject&&i.dispatchEvent(t)})(t),c.call(e,t)};const d=e.clone;e.clone=(...t)=>{const r=e.userData;e.userData={};let s=d.call(e,...t);e.userData=r,o(s.userData,r);const n=e.userData.parentRoot;return n&&"model"!==n.assetType&&console.warn("Cloning an object with a parent that is not an IModel is not supported"),s=a(s,n,i),s.userData.cloneParent=e.uuid,s};const h=e.copy;e.copy=(t,...i)=>{const r=t.userData;t.userData={};const a=h.call(e,t,...i);return t.userData=r,o(e.userData,t),a};const p=e.add;return e.add=(...t)=>(t.forEach((t=>a(t,e.userData.parentRoot||e,i))),p.call(e,...t)),(e=i?.(e)??e).addEventListener("dispose",(()=>{s.forEach((e=>e())),s=[]})),[...e.children].forEach((t=>a(t,e,i))),e}const s=["appliedMeshes"],n=["parentRoot","iCamera","iModel"];function o(e,t){if(t)for(const i of Object.keys(t))n.includes(i)||i.startsWith("__")||"function"!=typeof e[i]&&"function"!=typeof t[i]&&(e[i]=t[i]);return e}},1865:function(e,t,i){i.d(t,{l:function(){return o},s:function(){return n}});var r=i(2988),a=i(6533),s=i(6453);function n(e,t){if(e.uiConfig)return e.uiConfig;const i={type:"folder",label:()=>e.name||"unnamed",expanded:!0,limitedUi:!0,children:[{type:"checkbox",label:"Visible",property:[e,"visible"],limitedUi:!0},{type:"button",label:"Pick/Focus",value:()=>{e.dispatchEvent({type:"select",ui:!0,value:e,focusCamera:!0})}},{type:"button",label:"Pick Parent",hidden:()=>!e.parent,value:()=>{const t=e.parent;t&&t.dispatchEvent({type:"select",ui:!0,value:t})}},{type:"input",label:"Name",property:[e,"name"],onChange:t=>{t.last&&e.setDirty?.({sceneUpdate:!0,refreshUi:!0})}},{type:"checkbox",label:"Casts Shadow",hidden:()=>!e.isMesh,property:[e,"castShadow"]},{type:"checkbox",label:"Receive Shadow",hidden:()=>!e.isMesh,property:[e,"receiveShadow"]},{type:"checkbox",label:"Frustum culled",property:[e,"frustumCulled"]},{type:"vec3",label:"Position",property:[e,"position"],limitedUi:!0},{type:"vec3",label:"Rotation",property:[e,"rotation"],limitedUi:!0},{type:"vec3",label:"Scale",property:[e,"scale"]},{type:"input",label:"Render Order",property:[e,"renderOrder"]},{type:"button",label:"Auto Scale",prompt:["Auto Scale Radius: Object will be scaled to the given radius",e.userData.autoScaleRadius||"2",!0],value:t=>{if(!t)return;const i=parseFloat(t);Math.abs(i)>0&&(0,a.RG)(e,i)}},{type:"button",label:"Auto Center",value:()=>{confirm("Auto Center: Object will be centered, are you sure you want to proceed?")&&(0,a.HC)(e)}},{type:"folder",label:"Rotate model",children:["X +","X -","Y +","Y -","Z +","Z -"].map((t=>({type:"button",label:"Rotate "+t+"90",value:()=>{e.rotateOnAxis(new r.Pa4(t.includes("X")?1:0,t.includes("Y")?1:0,t.includes("Z")?1:0),Math.PI/2*(t.includes("-")?-1:1)),e.setDirty?.({sceneUpdate:!0,refreshUi:!1})}})))},void 0!==e.userData.license?{type:"input",label:"License/Credits",property:[e.userData,"license"],limitedUi:!0}:{}]},s=e;if(s?.isMesh&&!1!==t){const t=[()=>{const t=Object.entries(s.morphTargetDictionary||{});return t.length?{label:"Morph Targets",type:"folder",children:t.map((([t,i])=>({type:"slider",label:t,bounds:[0,1],stepSize:1e-4,property:[s.morphTargetInfluences,i],onChange:t=>{e.setDirty?.({sceneUpdate:t.last,frameFade:!1,refreshUi:!1})}})))}:void 0},()=>s.geometry?.uiConfig,()=>Array.isArray(s.material)?s.material.length<1?void 0:{label:"Materials",type:"folder",children:s.material.map((e=>e?.uiConfig)).filter((e=>e))}:s.material?.uiConfig];i.children.push(...t)}const n=e;if(n?.isCamera){const t=[{type:"button",label:"Set View",value:()=>{e.dispatchEvent({type:"setView",ui:!0,camera:e}),i.uiRefresh?.("postFrame",!0)}},{type:"button",label:"Activate main",hidden:()=>e.userData.iCamera?.isActiveCamera,value:()=>{e.dispatchEvent({type:"activateMain",ui:!0,camera:e}),i.uiRefresh?.("postFrame",!0)}},{type:"button",label:"Deactivate main",hidden:()=>!e.userData.iCamera?.isActiveCamera,value:()=>{e.dispatchEvent({type:"activateMain",ui:!0,camera:void 0}),i.uiRefresh?.("postFrame",!0)}},{type:"checkbox",label:"Auto LookAt Target",getValue:()=>e.userData.autoLookAtTarget??!1,setValue:t=>{e.userData.autoLookAtTarget=t,i.uiRefresh?.("postFrame",!0)}}];i.children.push(...t)}return e.uiConfig=i,i}function o(e){return{label:"Geometry",type:"folder",children:[{type:"input",property:[e,"uuid"],disabled:!0},{type:"input",property:[e,"name"]},{type:"button",label:"Center Geometry",value:()=>{e.center()}},{type:"button",label:"Center Geometry (keep position)",value:()=>{const t=new r.Pa4;e.center(t),t.negate();const i=e.userData.__appliedMeshes;for(const e of i)e.updateMatrix(),e.position.copy(t).applyMatrix4(e.matrix),e.setDirty&&e.setDirty()}},{type:"button",label:"Compute vertex normals",value:()=>{e.computeVertexNormals()}},{type:"button",label:"Compute vertex tangents",value:()=>{e.computeTangents()}},{type:"button",label:"Normalize normals",value:()=>{e.normalizeNormals()}},{type:"button",label:"Convert to indexed",hidden:()=>!!e.index,value:()=>{if(e.attributes.index)return;const t=parseFloat(prompt("Tolerance","-1")??"-1");(0,a.aP)(e,t)}},{type:"button",label:"Convert to non-indexed",hidden:()=>!e.index,value:()=>{e.attributes.index&&e.toNonIndexed()}},{type:"button",label:"Create uv1 from uv",value:()=>{e.hasAttribute("uv1")&&!confirm("uv1 already exists, replace with uv data?")||e.setAttribute("uv1",e.getAttribute("uv"))}},{type:"button",label:"Remove vertex color attribute",hidden:()=>!e.hasAttribute("color"),value:()=>{e.hasAttribute("color")?confirm("Remove color attribute?")&&e.deleteAttribute("color"):prompt("No color attribute found")}},{type:"button",label:"Auto GPU Instances",hidden:()=>!e.userData.__appliedMeshes||e.userData.__appliedMeshes.size<2,value:()=>{(0,s.Y)(e)}},{type:"input",label:"Mesh count",get value(){return e.userData?.__appliedMeshes?.size??0},set value(e){},disabled:!0}]}}},1375:function(e,t,i){i.d(t,{M:function(){return a}});var r=i(9008);class a{static _initializeStyles(){(0,r.createStyles)(r.css`
  .customContextGrid {
    background: #eeeeee55;
    border: 0.5px solid rgba(220, 220, 220, 0.2);
    width: auto;
    height: auto;
    position: absolute;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    z-index: 200;
    padding: 0.35rem 0.35rem;
    border-radius: 0.375rem;
    min-width: 5rem;
    pointer-events: auto;
    box-shadow: 0px 2px 6px rgba(12, 12, 12, 0.2);

    color: #111111;
    font-size: 0.65rem;
    font-family: Inter, "Roboto Mono", "Source Code Pro", Menlo, Courier, monospace;
    backdrop-filter: blur(20px);
  }
  .customContextGridItems {
    background-color: transparent;
    cursor: pointer;
    border-radius: 0.25rem;
    line-height: 1rem;
    font-weight: 500;
    overflow: hidden;
    margin: 0.12rem;
  }

  .customContextGridItems:hover {
    color: white;
    //background-color: #017AFF;
    box-shadow: 0 0 7px 0px rgba(64, 64, 64, 0.3);
  }
  .customContextGridItemImage{
    width: 100%;
    height: 100%;
  }
  .customContextGridHeading{
    width: 100%;
    padding: 5px;
    font-size: 0.85rem;
  }
  .customContextGridParent{
    position: absolute;
    top: 0;
    left: 0;
    width: 270px;
    height: calc(100% - 100px);
    overflow-y: scroll;
    z-index: 100;
    display: flex;
    flex-direction: column;
    margin-bottom: 50px;
    margin-top: 50px;
  }
  /* Hide scrollbar for Chrome, Safari and Opera */
  .customContextGridParent::-webkit-scrollbar {
    display: none;
  }
  /* Hide scrollbar for IE, Edge and Firefox */
  .customContextGridParent {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }

        `,this._container),this._container.style.position="absolute",this._container.style.top="0",this._container.style.left="0",this._container.style.width="270px",this._container.style.height="100%",this._container.style.pointerEvents="none",this._container.style.zIndex="100",this._container.style.overflowY="auto"}static Create(e,t,i,a,s,n,o){const l=(0,r.mobileAndTabletCheck)(),c=l?.15:.25,d=l?1.5:2.5,h=(0,r.createDiv)({classList:["customContextGrid"],addToBody:!1,innerHTML:`\n            <div class="customContextGridHeading"> ${t} </div>\n            `});h.style.top=s+"px",h.style.left=a+"px",h.style.gap=c+"rem",h.style.width=(d+c)*i-c+"rem",h.dataset.tag=e;for(const e of n){const t=(0,r.createDiv)({classList:["customContextGridItems"],addToBody:!1,innerHTML:`\n            <img src="${e.image}" class="customContextGridItemImage">\n            `});t.style.width=d+"rem",t.style.height=d+"rem",h.appendChild(t),t.onclick=()=>e.onClick?.(e.id),o(t,e,h)}return this.Elements?.push(h),h}static RemoveAll(e){if(e){const t=this.Elements.filter((t=>t.dataset.tag===e));for(const e of t)e.remove();this.Elements=this.Elements.filter((t=>t.dataset.tag!==e))}else{for(const e of this.Elements)e.remove();this.Elements=[]}}static RebuildUi(e){if(0===this.Elements.length)return;e||(e=(0,r.createDiv)({addToBody:!0,classList:["customContextGridParent"]}));for(const e of this.Elements)e.remove();this._container.innerHTML="",this._initializeStyles();let t=20;e.appendChild(this._container);for(const e of this.Elements)e.style.top=t+"px",this._container.appendChild(e),t+=e.clientHeight+20}}a.Elements=[],a._container=document.createElement("div")},589:function(e,t,i){i.d(t,{D:function(){return a}});var r=i(9008);class a{static _initialize(){this._inited=!0,(0,r.createStyles)(r.css`
          #customContextMenu {
            background: #2c2c2e99;
            backdrop-filter: blur(8px);
            border: 0.5px solid rgba(20, 20, 20, 0.3);
            width: auto;
            height: auto;
            position: absolute;
            display: flex;
            flex-direction: column;
            z-index: 9999;
            padding: 0.35rem 0.20rem;
            border-radius: 0.375rem;
            min-width: 6rem;
            pointer-events: auto;
            box-shadow: 0px 2px 10px rgba(12, 12, 12, 0.2);
          }

          .customContextMenuItems {
            color: white;
            font-size: 0.65rem;
            font-family: "Roboto Mono", "Source Code Pro", Menlo, Courier, monospace;
            background-color: transparent;
            cursor: pointer;
            padding: 0.12rem 0.35rem;
            border-radius: 0.25rem;
            line-height: 1rem;
            font-weight: 500;
          }

          .customContextMenuItems:hover {
            color: white;
            background-color: #017AFF;
          }
        `),document.addEventListener("mouseup",(e=>{this.Element&&!this.Element.contains(e.target)&&0===e.button&&this.Remove()}))}static Create(e,t,i){this._inited||this._initialize(),this.Element&&this.Remove();const a=(0,r.createDiv)({id:"customContextMenu",addToBody:!1});a.style.top=i+"px",a.style.left=t+"px";for(const[t,i]of Object.entries(e)){const e=(0,r.createDiv)({classList:["customContextMenuItems"],addToBody:!1,innerHTML:t});a.appendChild(e),e.onclick=i}return this.Element=a,a}static Remove(){this.Element?.remove(),this.Element=void 0}}a.Element=void 0,a._inited=!1},8160:function(e,t,i){i.d(t,{B:function(){return l}});var r=i(2988),a=i(4091),s=i(4107),n=i(7280),o=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class l extends a.qt{constructor(e,t,i,a){super(e,t),this._shadowParams={enabled:!0,radius:2,width:1024,height:1024,bias:-.001,normalBias:0,near:1.5,far:4,frustumSize:4},this._randomParams={focus:1,spread:.01,distanceScale:50,minDistanceScale:new r.Pa4(10,10,10),normalDirection:new r.Pa4(.01,.98,.01).normalize(),direction:new r.Pa4(-.9,.5,-1)},this.isRandomizedDirectionalLight=!0,this.shadowParams=i??{},this.randomParams=a??{},this.updateShadowParams=this.updateShadowParams.bind(this)}get shadowParams(){return this._shadowParams}set shadowParams(e){Object.keys(e).forEach((t=>void 0===e[t]&&delete e[t])),this._shadowParams={...this._shadowParams,...e},this.updateShadowParams()}get randomParams(){return this._randomParams}set randomParams(e){Object.keys(e).forEach((t=>void 0===e[t]&&delete e[t])),Object.assign(this._randomParams,e)}updateShadowParams(){this.castShadow=this._shadowParams.enabled,this.shadow.mapSize.x=this._shadowParams.width,this.shadow.mapSize.y=this._shadowParams.height,this.shadow.bias=this._shadowParams.bias,this.shadow.normalBias=this._shadowParams.normalBias,this.refreshShadowCamNearFar(),this.shadow.radius=this._shadowParams.radius,this.shadow.camera.right=this._shadowParams.frustumSize/2,this.shadow.camera.left=-this._shadowParams.frustumSize/2,this.shadow.camera.top=this._shadowParams.frustumSize/2,this.shadow.camera.bottom=-this._shadowParams.frustumSize/2,this.shadow.camera.updateProjectionMatrix(),this.matrixWorldNeedsUpdate=!0}randomizePosition(e,t=null,i=null){const a=new n.Z(e.toString()),s=new r.FM8(a.next()*Math.PI*2,Math.asin(2*a.next()-1));let o=new r.Pa4(Math.cos(s.x)*Math.cos(s.y),Math.sin(s.y),Math.sin(s.x)*Math.cos(s.y));const l=new r.FM8;for(let e=0;e<5;e++){l.set(a.next(),a.next()),o=c(l,this._randomParams.normalDirection,.4),a.next()<Math.sqrt(t??this._randomParams.focus)&&(l.set(a.next(),a.next()),o=c(l,this._randomParams.direction,Math.pow((i??this._randomParams.spread)/2,2)));const e=o.dot(this._randomParams.normalDirection);if(e>0&&e<.4)break}o.normalize(),o.multiplyScalar(this._randomParams.distanceScale),this.position.set(0,0,0),this.target.position.copy(o.normalize().negate()),this.target.updateMatrixWorld(),this.refreshShadowCamNearFar(),this.updateMatrixWorld()}refreshShadowCamNearFar(){const e=(new r.Pa4).subVectors(this.target.position,this.shadow.camera.position).length();this.shadow.camera.near=e-this._shadowParams.near*this._shadowParams.frustumSize/2,this.shadow.camera.far=e+this._shadowParams.far*this._shadowParams.frustumSize/2}dispose(){}get uiConfig(){if(this._uiConfig)return this._uiConfig}fromJSON(e,t){return super.fromJSON(e,t)?(this.updateShadowParams(),this):null}}function c(e,t,i){t=t.clone().normalize();const a=new r.Pa4(0,-t.z,t.y).normalize(),s=(new r.Pa4).crossVectors(t,a).normalize(),n=e;n.x=2*n.x*Math.PI,n.y=1-n.y*i;const o=Math.sqrt(1-n.y*n.y);return a.multiplyScalar(Math.cos(n.x)*o).add(s.multiplyScalar(Math.sin(n.x)*o)).add(t.multiplyScalar(n.y))}o([(0,s.qC)("shadowParams")],l.prototype,"_shadowParams",void 0),o([(0,s.qC)("randomParams")],l.prototype,"_randomParams",void 0)},4821:function(e,t,i){i.d(t,{k:function(){return C}});var r=i(9008),a=i(4107),s=i(8570),n=i(4379),o=i(1564),l=i(2988),c=i(9452),d=i(2860),h=i(8670);const p={...o._,color:"#ffffff",map:null,lightMap:null,lightMapIntensity:1,aoMap:null,aoMapIntensity:1,specularMap:null,alphaMap:null,envMap:null,combine:l.Ns1,reflectivity:1,refractionRatio:.98,wireframe:!1,wireframeLinewidth:1,wireframeLinecap:"round",wireframeLinejoin:"round",skinning:!1,fog:!0};class u extends l.vBJ{constructor(e){super(e),this.typeSlug=u.TypeSlug,this.assetType="material",this.materialObject=this,this.isMeshBasicMaterial2=!0,this.extraUniformsToUpload={},!this.defines&&(this.defines={}),this.fog=!1,this.setDirty=this.setDirty.bind(this),this.userData.setDirty=e=>{console.warn("userData.setDirty is deprecated. Use setDirty instead."),this.setDirty(e)},this.materialExtensions=c.K.RegisterExtensions(this,e?.customMaterialExtensions??[])}setDirty(e){this.needsUpdate=!0,this.dispatchEvent({...e,type:"materialUpdate"}),this._uiConfig?.uiRefresh?.("postFrame",!0,1)}registerMaterialExtensions(e){this.materialExtensions=[...this.materialExtensions,...c.K.RegisterExtensions(this,e)]}unregisterMaterialExtensions(e){}get uiConfig(){return this._uiConfigChildren||(this._uiConfigChildren=[{type:"input",property:[this,"name"]},{type:"checkbox",property:[this,"wireframe"]},{type:"color",property:[this,"color"],limitedUi:!0},{type:"image",property:[this,"map"]},(0,d.xX)(this,"map"),{type:"folder",label:"Blending",children:[{type:"slider",bounds:[0,1],property:[this,"opacity"]},{type:"checkbox",property:[this,"transparent"],onChange:this.setDirty},{type:"checkbox",property:[this,"depthWrite"],onChange:this.setDirty},{type:"checkbox",property:[this,"colorWrite"],onChange:this.setDirty},{type:"slider",bounds:[0,1],property:[this,"alphaTest"]},{type:"checkbox",property:[this,"dithering"]},{type:"dropdown",label:"Blending",property:[this,"blending"],children:[["None",l.jFi],["Normal",l.bdR],["Additive",l.WMw],["Subtractive",l.N4l],["Multiply",l.M5h]].map((e=>({label:e[0],value:e[1]})))},{type:"image",property:[this,"alphaMap"]},(0,d.xX)(this,"alphaMap"),{type:"checkbox",label:"Render to Depth",getValue:()=>!0===this.userData.renderToDepth,setValue:e=>{this.userData.renderToDepth=e||void 0,this.setDirty()}}]},{type:"folder",label:"AO/Lightmap",children:[{type:"slider",bounds:[0,2],property:[this,"aoMapIntensity"]},{type:"image",property:[this,"aoMap"]},(0,d.xX)(this,"aoMap"),{type:"slider",bounds:[0,2],property:[this,"lightMapIntensity"]},{type:"image",property:[this,"lightMap"]},(0,d.xX)(this,"lightMap")]},{type:"dropdown",label:"Side",property:[this,"side"],children:[["Front",l.Wl3],["Back",l._Li],["Double",l.ehD]].map((e=>({label:e[0],value:e[1]})))},{type:"input",label:"Mesh count",getValue:()=>this.userData?.__appliedMeshes?.size??0,setValue:e=>{},disabled:!0},{type:"button",label:`Download ${this.typeSlug}`,value:()=>{const e=new Blob([JSON.stringify((0,a.HD)(this,!1),null,2)],{type:"application/json"});(0,r.downloadBlob)(e,`unlit-material.${this.typeSlug}`)}}]),this._uiConfig||(this._uiConfig={type:"folder",label:"Unlit Material",expanded:!0,children:this._uiConfigChildren,uuid:"MBM2_"+this.uuid,limitedUi:!0}),this._uiConfig.children=[...this._uiConfigChildren,...this.materialExtensions.map((e=>e.getUiConfig?.(this)))].filter((e=>e)),this._uiConfig}onBeforeCompile(e,t){const i=[["vec3 outgoingLight = ","afterModulation"],["#include <aomap_fragment>","beforeModulation"],["ReflectedLight reflectedLight = ","beforeAccumulation"],["#include <clipping_planes_fragment>","mainStart"]],r=[["#include <uv_vertex>","mainStart"]];for(const t of r)e.vertexShader=(0,h.p)(e.vertexShader,t[0],"#glMarker "+t[1]+"\n"+t[0]);for(const t of i)e.fragmentShader=(0,h.p)(e.fragmentShader,t[0],"#glMarker "+t[1]+"\n"+t[0]);c.K.ApplyMaterialExtensions(this,e,this.materialExtensions,t),this.dispatchEvent({type:"beforeCompile",shader:e,renderer:t}),e.fragmentShader=e.fragmentShader.replaceAll("#glMarker","// "),e.vertexShader=e.vertexShader.replaceAll("#glMarker","// "),super.onBeforeCompile(e,t)}customProgramCacheKey(){return super.customProgramCacheKey()+c.K.CacheKeyForExtensions(this,this.materialExtensions)+this.userData.inverseAlphaMap}onBeforeRender(e,t,i,r,a){super.onBeforeRender(e,t,i,r,a),this.dispatchEvent({type:"beforeRender",renderer:e,scene:t,camera:i,geometry:r,object:a})}onAfterRender(e,t,i,r,a){super.onAfterRender(e,t,i,r,a),this.dispatchEvent({type:"afterRender",renderer:e,scene:t,camera:i,geometry:r,object:a})}copyProps(e,t=!1){if(!t&&!["MeshBasicMaterial",u.TYPE].includes(e.type))return console.error("Material type is not supported:",e.type),this;const i={},a=Array.from(Object.keys(p));(0,r.copyProps)(e,i,a);const s=i.userData;delete i.userData;for(const e of Object.keys(i))void 0===i[e]&&delete i[e];return this.setValues(i),s&&(0,d.aw)(this.userData,s),this.setDirty(),this}toJSON(e){const t=this.userData;this.userData={};const i=super.toJSON(e);this.userData=t,i.userData={},(0,d.aw)(i.userData,t),i.userData.uuid=this.userData.uuid;const r=e||{textures:Object.fromEntries(i.textures?.map((e=>[e.uuid,e]))||[]),images:Object.fromEntries(i.images?.map((e=>[e.uuid,e]))||[])};i.userData=(0,a.HD)(i.userData,!1,r),e||(Object.keys(r.textures).length>0&&(i.textures=Object.values(r.textures)),Object.keys(r.images).length>0&&(i.images=Object.values(r.images))),i.type=u.TYPE;for(const e of Object.keys(i))void 0===i[e]&&delete i[e];return i}fromJSON(e,t,i=!1){return this.copyProps(e,i)}clone(){return super.clone()}}u.TypeSlug="bmat",u.TYPE="MeshBasicMaterial2";const m={materialType:n.iu.TYPE,name:"standard",color:"#ffffff"},f={materialType:u.TYPE,name:"basic",color:"#ffffff"},g={[n.iu.TYPE]:m.name,MeshStandardMaterial:m.name,MeshPhysicalMaterial:m.name,[u.TYPE]:f.name,MeshBasicMaterial:f.name};class v extends r.SimpleEventDispatcher{constructor(){super(),this._templates=[m,f],this._materials=[],this._disposeMaterial=e=>{const t=e.target;if(!t||"material"!==t.assetType)return;this._refreshTextureRefs();const i=this._getMapsForMaterial(t),r=[];i.forEach((e=>{const i=e.userData.__appliedMaterials;i?.delete(t),i&&!1!==e.userData.disposeOnIdle&&0===i.size&&r.push(e)})),r.forEach((e=>{e.dispose()})),this.unregisterMaterial(t)},this._materialExtensions=[],this.processModel=this.processModel.bind(this),this.processMaterial=this.processMaterial.bind(this)}findOrCreate(e,t){let i=this.findMaterial(e);return i||(i=this.generateFromTemplate(e,t)),i}generateFromTemplate(e,t){const i=this.findTemplate(e);if(i)return this._generateFromTemplate(i,t??{})}generateFromTemplateType(e,t){const i=this._templates.find((t=>t.materialType===e));if(i)return this._generateFromTemplate(i,t??{})}findTemplate(e){return this._templates.find((t=>t.name===e))}_refreshTextureRefs(e){(e||this.getAllMaterials()).forEach((e=>{this._getMapsForMaterial(e).forEach((t=>{let i=t.userData.__appliedMaterials;i||(t.userData.__appliedMaterials=i=new Set),t.addEventListener("update",(()=>e.dispatchEvent({type:"textureUpdate",texture:t}))),i.add(e)}))}))}_getMapsForMaterial(e){const t=new Set;for(const i of Object.values(e))i&&i.isTexture&&t.add(i);for(const i of Object.values(e.userData??{}))i&&i.isTexture&&t.add(i);return t}registerMaterial(e){if(this._materials.includes(e))return;const t=this.findMaterial(e.uuid);t?console.warn("Material UUID already exists",e,t):(e.addEventListener("dispose",this._disposeMaterial),this._materials.push(e),this._refreshTextureRefs([e]))}registerMaterialObject(e){const t=e.materialObject?e:Object.assign(e,{assetType:"material",materialObject:e});return this.registerMaterial(t),t}unregisterMaterial(e){this._materials=this._materials.filter((t=>t.uuid!==e.uuid)),e.removeEventListener("dispose",this._disposeMaterial)}registerMaterialTemplate(e){e.templateUUID||(e.templateUUID=(0,s.Z)());const t=this._templates.find((t=>t.templateUUID===e.templateUUID));t?console.warn("MaterialTemplate already exists",e,t):this._templates.push(e)}unregisterMaterialTemplate(e){this._templates=this._templates.filter((t=>t.templateUUID!==e.templateUUID))}dispose(e=!0){const t=this._materials;this._materials=[];for(const i of t)e||!i.userData.runtimeMaterial?i.dispose():this._materials.push(i)}findMaterial(e){return e?this._materials.find((t=>t.uuid===e)):void 0}findMaterialsByName(e,t=!1){return this._materials.filter((i=>"string"!=typeof e||t?null!==i.name.match("string"==typeof e?"^"+e+"$":e):i.name===e))}getMaterialsOfType(e){return e?this._materials.filter((t=>t.typeSlug===e)):[]}getAllMaterials(){return[...this._materials]}processModel(e,t){const i=this._processModel(e,t);return(0,r.safeSetProperty)(e,"modelObject",i),e}_processMaterial(e,t){if(!e)return;if(e.materialObject?.isMaterial)return e;let i=e.mmMaterial;if(!i){const r=e.userData?.uuid||e.uuid;if(i=this.findMaterial(r),i)i.copyProps(e);else{const r=!1===t.useSourceMaterial||!e.isMaterial,a=t.materialTemplate||(r?"standard":g[e.type]||"standard");i=this.generateFromTemplate(a,r?{}:e)}e.mmMaterial=i}return i}processMaterial(e,t){return e.materialObject||(e=this._processMaterial(e,{...t,register:!1})),!1!==t.register&&this.registerMaterial(e),e}registerMaterialExtension(e){this._materialExtensions.includes(e)||this._materialExtensions.push(e)}unregisterMaterialExtension(e){const t=this._materialExtensions.indexOf(e);t>=0&&this._materialExtensions.splice(t,1)}exportMaterial(e,t,i=!0,s=!1){const n=(0,a.HD)(e,!1),o=JSON.stringify(n,null,i?0:2),l=(t||e.name||"physical_material")+"."+e.typeSlug,c=new File([o],l,{type:"application/json"});return s&&(0,r.downloadFile)(c),c}applyMaterial(e,t){const i=Object.getPrototypeOf(e).constructor.TYPE;let r=this.findMaterialsByName(t,!0);(!r||r.length<1)&&(r=[this.findMaterial(t)]);let a=!1;for(const t of r)if(t&&!t.userData.__isVariation&&t!==e)if(Object.getPrototypeOf(t).constructor.TYPE===i){const i=t.name;t.copyProps(e),t.name=i,a=!0}else{const r=t["__"+i]||this.generateFromTemplateType(i);if(!r)continue;const s=t.name;r.copyProps(e),r.name=s;const n=t.userData.__appliedMeshes;for(const e of[...n??[]])e?.setMaterial?.(r),e&&(a=!0);t["__"+i]=r}return a}}class _ extends v{_generateFromTemplate(e,t){let i;const a={...e};a.customMaterialExtensions=[...a.customMaterialExtensions??[],...this._materialExtensions];const s=t?.metadata&&t?.metadata.version<=4.5;s&&(l.epp.enabled=!1);let o={};switch(e.materialType){case"MeshStandardMaterial2":case"standard":t&&(0,r.copyProps)(t,a,Array.from(Object.keys(n.cU))),"MeshBasicMaterial"===t?.type&&(a.roughness=.9,a.metalness=0,a.userData?.uuid&&delete a.userData.uuid),o=a.userData?.uuid,o&&delete a.userData.uuid,i=new n.iu({customMaterialExtensions:a.customMaterialExtensions}).fromJSON(a,void 0,!0),o&&(i.uuid=o),i.userData.uuid=i.uuid,i.setDirty(),t?.isMaterial&&void 0!==t.userData&&(t.userData.iMaterial=i);break;case"MeshBasicMaterial2":case"basic":case"unlit":t&&(0,r.copyProps)(t,a,Array.from(Object.keys(p))),o=a.userData?.uuid,o&&delete a.userData.uuid,i=new u({customMaterialExtensions:a.customMaterialExtensions}).fromJSON(a,void 0,!0),o&&(i.uuid=o,a.userData.uuid=o),i.userData.uuid=i.uuid,i.setDirty();break;case"shadow":throw"TODO: Not implemented shadow material";default:o=null,t&&t.userData&&(o=t.userData,delete t.userData),i=e.generator?.(a,t)||void 0,t&&o&&(t.userData=o),o&&i&&((0,d.aw)(i.userData,o),o?.uuid&&(i.uuid=o.uuid),o=null),i&&(i.userData.uuid=i.uuid)}if(i){t.runtimeMaterial&&(i.userData.runtimeMaterial=!0);const r=i;if(i.clone=()=>{r.userData.cloneId||(r.userData.cloneId="0"),r.userData.cloneCount||(r.userData.cloneCount=0),r.userData.cloneCount+=1;const t=this.generateFromTemplate(e.name);return t&&(t.copyProps(r),t.userData.cloneId=t.userData.cloneId+"_"+r.userData.cloneCount,t.userData.cloneCount=0,t.name=t.name+"_"+t.userData.cloneId,t.userData.uuid=t.uuid),t?.materialObject},t){let e=this.findMaterial(t?.uuid);e&&this.unregisterMaterial(e),e=this.findMaterial(t?.materialObject?.uuid),e&&this.unregisterMaterial(e)}}return s&&(l.epp.enabled=!0),i?this.registerMaterialObject(i):void 0}_processModel(e,t){if(!e.modelObject)return console.error("MaterialManager: No modelObject found for ",e),e;let i=e.material;if(!i&&e.geometry&&(this._defaultMaterial||(this._defaultMaterial=this.generateFromTemplate("standard")),i=this._defaultMaterial,e.material=i),i){let r=!0;Array.isArray(i)||(i=[i],r=!1);const a=[];for(const e of i){const i=this._processMaterial(e,t);a.push(i?.materialObject)}e.setMaterial&&(e.modelObject.material=null,e.setMaterial(r?a:a[0]))}if(!1!==t.recursive)for(let i=0;i<e.modelObject.children.length;i++)e.modelObject.children[i]=this._processModel(e.modelObject.children[i],t);return e}}var y=i(2681),b=i(2354),w=i(8737);class x extends l.u7G{constructor(e){super(e)}async loadAsync(e,t){const i=new l.hH6(this.manager);i.setPath(this.path),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials);const r=await i.loadAsync(e,t);try{const e=JSON.parse(r);if(e.images&&this.importer){const t={};let i=e.images;Array.isArray(i)||(i=Object.values(i));for(const i of e.images){if(!i.url||!i.uuid)continue;const e=(await this.importer.importPath(i.url,{processImported:!1}))?.[0],r=e?.source;if(!e||!r)continue;const a=new l.Hw6(r.data);a.uuid=i.uuid,t[a.uuid]=a,e.dispose()}return await w.$.LoadRootPathTextures(e.textures,t||e.images,this.importer),this.parse(e,t)}return this.parse(e)}catch(t){throw console.error(t),this.manager.itemError(e),t}}parse(e,t){let i;const r={p:new Promise((e=>{i=e}))};if(e.images||e.textures){const a=new w.$(this.manager);let s={};const n=e=>{i(),r.p=void 0,Object.values(s).forEach((e=>{e.isTexture&&e.image?.complete&&(e.needsUpdate=!0)}))};let o=e.images||[];Array.isArray(o)||(o=Object.values(o));const l=t||a.parseImages(o,n);let c=e.textures;Array.isArray(c)||(c=Object.values(c)),s=a.parseTextures2(c,l,n),this.setTextures(s)}this.materials||console.warn("A Material Manager is not set to import three materials, trying standard materials");const s={...e};if(Object.entries(s).forEach((([e,t])=>{t&&"string"==typeof t&&this.textures[t]&&(s[e]=this.textures[t])})),void 0!==e.vertexColors&&("number"==typeof e.vertexColors?s.vertexColors=e.vertexColors>0:s.vertexColors=e.vertexColors),void 0!==e.normalScale){const t=e.normalScale;!1===Array.isArray(t)&&(s.normalScale=[t,t])}let o=e.type;"MeshPhysicalMaterial"!==o&&"MeshStandardMaterial"!==o&&"PhysicalMaterial"!==o||(o=n.iu.TYPE),s.userData=(0,a.Hx)(s.userData,void 0,!1,this);const l=this.materials?.generateFromTemplateType(o,s)??super.parse(e);return this.setTextures({}),l.userData.imageLoadAwaiter=r,l}}var D=i(4001),S=i(7485);class C extends r.SimpleEventDispatcher{constructor(e,t,{simpleCache:i=!1,storage:r}={}){if(super(),this._sceneUpdated=this._sceneUpdated.bind(this),this.addAsset=this.addAsset.bind(this),this.addProcessedAssets=this.addProcessedAssets.bind(this),this.addImported=this.addImported.bind(this),(i||r)&&(i&&(l.CtF.enabled=!0),r&&window.Cache&&"function"==typeof window.Cache&&r instanceof window.Cache)){const e={...l.CtF};l.CtF.get=(t,i,a)=>i?t.startsWith("data:")||t.startsWith("blob")||t.startsWith("chrome-extension")?Promise.resolve(void 0):r.match(t).then((e=>{if(e)switch(i){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,a??"text/html")));case"json":return e.json();default:if(void 0===a)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(a),i=t&&t[1]?t[1].toLowerCase():void 0,r=new TextDecoder(i);return e.arrayBuffer().then((e=>r.decode(e)))}}})):e.get(t),l.CtF.add=async(t,i,a)=>{if(!a)return e.add(t,i);t.startsWith("data:")||t.startsWith("blob")||t.startsWith("chrome-extension")||(await r.match(t)&&await r.delete(t),await r.put(t,new Response(i,{status:200})))},l.CtF.remove=(t,i)=>{if(!i)return e.remove(t);r.delete(t)}}this.storage=r,this._importer=e,this._materials=t}async addAsset(e,t={}){if(!this._importer||!this._viewer)return[];const i=await this._importer.importAsset(e,t);return i?(this.addProcessedAssets(i,t),i):(console.warn("Unable to import",e,i),[])}async addFromPath(e,t={}){if(!this._importer||!this._viewer)return[];const i=await this._importer.importPath(e,t);return i?(this.addProcessedAssets(i,t),i):(console.warn("Unable to import",e,i),[])}addProcessedAssets(e,t){return e.map((i=>this._viewer?.scene.addSceneObject(i,{...t,allImported:e})))}async addAssetSingle(e,t={}){return e?(await("string"==typeof e?this.addFromPath:this.addAsset).call(this,e,t))?.[0]:void 0}async addImported(e,t={}){return this._importer?.processImported(e,t).then((e=>(this.addProcessedAssets(e,t),e)))}async addImportedSingle(e,t={}){return this.addImported(e,t).then((e=>e?.[0]))}_sceneUpdated(e){if("addSceneObject"===e.type){const t=e.object;"material"===t.assetType&&this._materials?.processMaterial(t,{})}else console.error("Unexpected")}onAdded(e){this._viewer=e,this._materials||(this._materials=new _,this._viewer.scene.addEventListener("addSceneObject",this._sceneUpdated)),this._importer||(this._importer=new y.Q(e,!!e.getPluginByType("debug")),this._importer.processors.add("model",{forAssetType:"model",process:(e,t)=>((0,S.j)(e,(e=>this._materials?.processModel(e,{recursive:!1}))),e)}),this._importer.processors.add("model",{forAssetType:"model",process:this._materials.processModel}),this._importer.processors.add("material",{forAssetType:"material",process:(e,t)=>(this.materials?.findMaterial(e.uuid)&&(console.warn("imported material uuid already exists, creating new uuid"),e.uuid=l.M8C.generateUUID(),e.userData.uuid&&(e.userData.uuid=e.uuid)),this._materials.processMaterial(e,t))})),this._importer.Importers.push(new b.q(x,[n.iu.TypeSlug],!1,(e=>(e&&(e.materials=this._materials),e&&(e.importer=this._importer),e))));const t=this.importViewerConfig.bind(this);this._importer.Importers.push(new b.q(class extends D.v{async loadAsync(e,i){return t(await super.loadAsync(e,i))}},[C.ViewerTypeSlug],!0))}onRemove(e){e===this._viewer&&(this._importer?.dispose(),this._importer=void 0,this._viewer.scene.removeEventListener("addSceneObject",this._sceneUpdated),this._materials?.dispose(),this._materials=void 0)}get importer(){return this._importer}get exporter(){return this._viewer?.getPluginByType("AssetExporterPlugin")?.exporter}get materials(){return this._materials}exportViewerConfig(e=!0,t){if(!this._viewer)return{};const i={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},extras:{},...t},a=this._viewer.toJSON(i);return e||Object.values(i).forEach((e=>{e&&Object.values(e).forEach((e=>{e.url&&(e.url.data instanceof ArrayBuffer||Array.isArray(e.url.data))&&("Uint16Array"===e.url.type?(e.url.data instanceof Uint16Array||(e.url.data=new Uint16Array(e.url.data)),e.url.data="data:application/octet-stream;base64,"+(0,r.arrayBufferToBase64)(e.url.data.buffer)):"Uint8Array"===e.url.type?(e.url.data instanceof Uint8Array||(e.url.data=new Uint8Array(e.url.data)),e.url.data="data:application/octet-stream;base64,"+(0,r.arrayBufferToBase64)(e.url.data.buffer)):e.url.data instanceof ArrayBuffer?e.url.data="data:application/octet-stream;base64,"+(0,r.arrayBufferToBase64)(e.url.data.buffer):console.warn("Unsupported buffer type",e.url.type))}))})),a.resources=i,a}exportPluginPresets(e){const t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},extras:{}};return{plugins:this._viewer?.serializePlugins(t,e),resources:t}}exportPluginPreset(e){if(!e.toJSON)return;const t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},extras:{}},i=e.toJSON(t);return i.resources=t,i}async importPluginPreset(e,t){const i=e.type;if(!(t=t||this._viewer?.getPluginByType(i)))return void console.warn(`No plugin found for type ${i} to import preset`);if(!t.fromJSON)return void console.warn(`Plugin ${i} does not support importing presets`);const r=e.resources||{};e.resources&&delete e.resources;const a=await this.importConfigResources(r);return await t.fromJSON(e,a),a&&(e.resources=a),t}async importViewerConfig(e,t){if(!this._viewer||!this._importer)return void console.warn("No viewer or importer");const i=await this.importConfigResources(e.resources||{},t);this.applyViewerConfig(e,i)}applyViewerConfig(e,t){if(this._viewer&&this._importer)if((t=t||e.resources).__isLoadedResources){this._viewer.fromJSON(e,t);for(const e of Object.values(t.materials))e.__useCount?delete e.__useCount:this._materials?.unregisterMaterial(e);for(const e of Object.values(t.textures))e.__useCount&&delete e.__useCount}else console.error("Cannot load viewer config: resources not loaded",e);else console.warn("No viewer or importer")}async importConfigResources(e,t,i){if(!this._importer)throw"Importer not initialized yet.";if(e.__isLoadedResources)return e;const a={};Object.values(e).forEach((e=>{e&&Object.values(e).forEach((e=>{if(!e||!e.url)return;if("string"!=typeof e.url.data)return;const t=e.url.data.match(/^data:.*;base64,(.*)$/);t?.[1]?e.url.data=(0,r.base64ToArrayBuffer)(t?.[1]):("Uint8Array"!==e.url.type&&console.error("Unsupported buffer type string for ",e.url.type,"use base64"),e.url.data=(new TextEncoder).encode(e.url.data).buffer)}))})),t=t??new w.$(this._importer.loadingManager),a.animations=e.animations?t.parseAnimations(e.animations):{},i&&i.animations&&(a.animations={...a.animations,...i.animations}),a.shapes=e.shapes?t.parseShapes(e.shapes):{},i&&i.shapes&&(a.shapes={...a.shapes,...i.shapes}),a.geometries=e.geometries?t.parseGeometries(e.geometries,a.shapes):{},i&&i.geometries&&(a.geometries={...a.geometries,...i.geometries}),a.images=e.images?await t.parseImagesAsync(Object.values(e.images)):{},i&&i.images&&(a.images={...a.images,...i.images}),await w.$.LoadRootPathTextures(e.textures,a.images,this._importer),a.textures=e.textures?t.parseTextures2(Object.values(e.textures),a.images,(()=>{Object.values(a.textures).forEach((e=>{e.isTexture&&e.image?.complete&&(e.needsUpdate=!0)}))})):{};for(const e of Object.entries(a.textures))e[1]=(await this._importer.processImported(e[1],{}))?.[0],e[1]?a.textures[e[0]]=e[1]:delete a.textures[e[0]];i&&i.textures&&(a.textures={...a.textures,...i.textures});const s=e.materials?Object.values(e.materials):[];for(const e of s)Object.entries(e).forEach((([t,i])=>{i&&i.resource&&i.uuid&&"textures"===i.resource&&(e[t]=i.uuid)}));if(a.materials=t.parseMaterials2(s,a.textures,this._materials),i&&i.materials&&(a.materials={...a.materials,...i.materials}),e.object&&(a.object=t.parseObject(e.object,a.geometries,a.materials,a.textures,a.animations),e.skeletons&&(a.skeletons=t.parseSkeletons(e.skeletons,a.object),t.bindSkeletons(a.object,a.skeletons))),e.extras){a.extras=e.extras;for(const t of Object.values(e.extras))if(t.uuid&&t.url)if("string"==typeof t.url){const e=await(this._importer?.importPath(t.url));e?.length>0&&(a.extras[t.uuid]=e[0])}else if(t.url.data){const e=new File([(0,r.getTypedArray)(t.url.type,t.url.data)],t.url.path),i=await(this._importer?.importAsset({path:e.name,file:e}));i?.length>0&&(a.extras[t.uuid]=i[0])}else console.warn("invalid URL type while loading extra resource")}return i&&i.extras&&(a.extras={...a.extras,...i.extras}),a.__isLoadedResources=!0,a}}C.PluginType="AssetManager",C.ViewerTypeSlug="vjson"},6468:function(e,t,i){i.d(t,{d:function(){return a}});var r=i(9008);class a{get basePath(){return this._basePath}get assets(){return this._assets}constructor(e){this._basePath=e?.basePath??"",this._assets=e?.assets?.map((e=>this._resolveAsset(e)))??[]}find(e){return this._assets.find(e)??void 0}_resolveAsset(e){return{...e,path:(0,r.pathJoin)([this._basePath,e.path])}}}},223:function(e,t,i){i.d(t,{_:function(){return n}});var r=i(6468),a=i(9008);class s extends a.SimpleEventDispatcher{constructor(...e){super(),this._assets=e}addAssetList(e){this._assets.push(e)}removeAssetList(e){const t=this._assets.indexOf(e);t>=0&&this._assets.splice(t,1)}async findAssetRegex(e){for(const t of this._assets){const i=t.find((t=>t&&(e.test(t.path)||e.test(t.file?.name??""))));if(i)return i}console.warn("Asset not found:",e)}async findAsset(e){return this.findAssetRegex(e.query)}async findAssetSimple(e,t=!1){return this.findAssetRegex(new RegExp(e,t?"i":""))}}const n=new s(new r.d({basePath:"https://demo-assets.pixotronics.com/clients",assets:[{path:"dominik/showroom_bath/showroom_bath.glb"}]}),new r.d({basePath:"https://demo-assets.pixotronics.com/pixo",assets:[{path:"hdr/watch-hdri-environment-map.hdr"},{path:"hdr/paul_lobe_haus_1k.hdr"},{path:"hdr/metal_02.hdr"},{path:"hdr/metal_01.hdr"},{path:"textures/bg.jpeg"},{path:"gltf/classic_watch_anim.glb"},{path:"gltf/watch_bering_1.glb"},{path:"gltf/watch_rolex_1.glb"},{path:"hdr/gem_2.hdr"},{path:"hdr/p360-01.hdr"},{path:"gltf/mixeddiamonds.glb"},{path:"gltf/ringMultiple.glb"},{path:"gltf/ringsMultiple.glb"},{path:"gltf/ringRound1.glb"},{path:"gltf/earringScene1.glb"},{path:"gltf/sofascene1.glb"},{path:"gltf/sofascene2.glb"},{path:"gltf/sofascene3.glb"},{path:"gltf/sofascene4.glb"},{path:"gltf/sofascene5.glb"},{path:"gltf/sofascene6.glb"},{path:"gltf/bloomScene.glb"},{path:"gltf/anisotropyScene.glb"},{path:"gltf/aoScene.glb"},{path:"gltf/cameraMarkerScene.glb"},{path:"gltf/progressiveLightScene.glb"},{path:"gltf/keyFrameAnimScene.glb"},{path:"gltf/groundScene.glb"},{path:"gltf/ssrScene.glb"},{path:"gltf/dofScene.glb"},{path:"gltf/groundShadowScene.glb"},{path:"gltf/diamondShapesScrollScene.glb"},{path:"gltf/product_configurator.glb"},{path:"gltf/material_configurator.glb"}]}))},2681:function(e,t,i){i.d(t,{Q:function(){return b},g:function(){return w}});var r=i(2988),a=i(2354),s=i(9008),n=i(7485),o=i(5022),l=i(4001),c=i(7567),d=i(8124),h=i(5023),p=i(8781),u=i(4091),m=i(1483),f=i(3165),g=i(4107);let v=class{constructor({domainMax:e,domainMin:t,size:i,texture:a,texture3D:s,title:n}){this.userData={},this.type="LUTCubeTextureWrapper",this.assetType="lutTexture",this.domainMax=e,this.domainMin=t,this.size=i,this.texture=a,this.texture3D=s,this.title=n,this.uuid=r.M8C.generateUUID(),this.userData.__needsSourceBuffer=!0}fromJSON(e,t){return e.type!==this.type&&console.warn("type mismatch while import",e,this),console.error("not supported"),this}toJSON(e){return(0,g.Rg)(this,e,this.texture.name)}};v=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n}([(0,g.Bg)("LUTCubeTextureWrapper")],v);class _ extends f.X{parse(e){const t=super.parse(e);return new v(t)}}var y=i(6420);class b extends s.SimpleEventDispatcher{get cachedAssets(){return this._cachedAssets}get processors(){return this._processors}get loadingManager(){return this._loadingManager}constructor(e,t=!1){super(),this._processors=new o.z,this._logger=console.log,this.Importers=[new a.q(l.v,["json"],!1),new a.q(r.hH6,["txt"],!1),new a.q(p.F,["rgbe.png","hdr.png","hdrpng"],!1),new a.q(r.dpR,["webp","png","jpeg","jpg","svg","data:image"],!1),new a.q(_,["cube"],!1),new a.q(y.s,["zip"],!0)],this._loaderCache=[],this._fileDatabase=new Map,this._cachedAssets=[],t||(this._logger=()=>{}),this._viewer=e,this._onLoad=this._onLoad.bind(this),this._onProgress=this._onProgress.bind(this),this._onError=this._onError.bind(this),this._onStart=this._onStart.bind(this),this._urlModifier=this._urlModifier.bind(this),this._loadingManager=new r.lLk(this._onLoad,this._onProgress,this._onError),this._loadingManager.onStart=this._onStart,this._loadingManager.setURLModifier(this._urlModifier),this.Importers.push(function(e){return new a.q(class extends c.x{constructor(t){super(t),this.setDataType(w(e.renderer.rendererObject))}},["hdr"],!1)}(e)),this.Importers.push((0,d.Bk)(e)),this.Importers.push(new a.q(h.Q,["drc"],!0))}_onLoad(){this.dispatchEvent({type:"onLoad"})}_onProgress(e,t,i){this.dispatchEvent({type:"onProgress",url:e,loaded:t,total:i})}_onError(e){this.dispatchEvent({type:"onError",url:e})}_onStart(e,t,i){this.dispatchEvent({type:"onStart",url:e,loaded:t,total:i})}_urlModifier(e){let t=decodeURI(e);const i=this._rootContext?.rootUrl;t.includes("://")||!i||t.startsWith(i)||(t=i+t),t=t.replace("./",""),t=t.replace(/^(\/\/)/,"/"),t=t.replace(/\?.*$/,"");const r=this._fileDatabase.get(t);return r?r.ext?(r.objectUrl||(r.objectUrl=URL.createObjectURL(r)+"#"+t),r.objectUrl):(console.error("Unable to determine file extension",r),e):e}_createLoader(e){const t=this._getImporter(e),i=t?.ctor(this);return i&&t?.ext.forEach((e=>{const t=new RegExp(e.startsWith("data:")?"^"+e+"\\/":"\\."+e+"$","i");this._loadingManager.addHandler(t,i)})),i&&(this._loaderCache.push({loader:i,files:[]}),this.dispatchEvent({type:"loaderCreate",loader:i})),i}addEventListener(e,t){if(super.addEventListener(e,t),"loaderCreate"===e)for(const e of this._loaderCache)this.dispatchEvent({type:"loaderCreate",loader:e.loader})}async importFiles(e,t={}){const i=new Map;let{allowedExtensions:r}=t;if(r&&r.length<1&&(r=void 0),0===e.size)return i;this.dispatchEvent({type:"importFiles",files:Object.keys(e),state:"start"});const a=[],s=[];if(e.forEach(((e,t)=>{this.registerFile(t,e);const i=e.ext;i&&(r?.includes(i.toLowerCase())??1)&&(this._isRootFileExtension(i)?a.push(t):s.push(t))})),a.length>0)for(const e of a){let r=await this._importFile(e,void 0,t);r&&(r=await this.processImported(r,t)),i.set(e,r)}else for(const e of s){let r=await this._importFile(e,void 0,t);r&&(r=await this.processImported(r,t)),i.set(e,r)}return this.dispatchEvent({type:"importFiles",files:Object.keys(e),state:"end"}),e.forEach(((e,t)=>{this.unregisterFile(t)})),i}registerFile(e,t){e=e.replace(/\?.*$/,"");const i=t?.ext??(0,s.parseFileExtension)(t?.name??e.trim())?.toLowerCase();t&&(t.ext||(t.ext=i),this._fileDatabase.set(e,t));let r=this._getLoader(e);if(r||(r=this._createLoader(t??{name:e,ext:i})),r)for(const t of this._loaderCache)if(t.loader===r){t.files.push(e);break}return r}unregisterFile(e){e=e.replace(/\?.*$/,"");const t=this._fileDatabase.get(e);t?.objectUrl&&(URL.revokeObjectURL(t.objectUrl),t.objectUrl=void 0),t&&this._fileDatabase.delete(e)}_isRootFileExtension(e){return null!=this.Importers.find((t=>t.root&&t.ext.includes(e.toLowerCase())))}resolveURL(e){return this._loadingManager.resolveURL(e)}async _importFile(e,t,i={},a){if(t?.__imported)return t.__imported;let s;this.dispatchEvent({type:"importFile",path:e,state:"downloading",progress:0});try{this.registerFile(e,t);const n=this.resolveURL(e),o=e.replace(/\?.*$/,"").trim(),l=i.fileHandler??(await this._loadingManager.getHandler(o)||(t?await this._loadingManager.getHandler(t.name||t.ext||""):void 0));if(!l)throw new Error("AssetImporter: Unable to find loader for "+e);this._rootContext={path:e,url:n,rootUrl:r.Zp0.extractUrlBase(e),baseUrl:r.Zp0.extractUrlBase(n)},s=await l.loadAsync(e+(i.queryString?(e.includes("?")?"&":"?")+i.queryString:""),(t=>{a&&a(t),this.dispatchEvent({type:"importFile",path:e,state:"downloading",loadedBytes:t.loaded||void 0,totalBytes:t.total||void 0,progress:t.total>0?t.loaded/t.total:1})})),l.transform&&(s=await l.transform(s,i)),this._rootContext=void 0,this.dispatchEvent({type:"importFile",path:e,state:"downloading",progress:1}),this.dispatchEvent({type:"importFile",path:e,state:"adding"}),t?this._logger("AssetImporter: loaded",e):this._logger("AssetImporter: downloaded",e),t&&this.unregisterFile(e)}catch(i){return console.error("AssetImporter: Unable to import file",e,t),console.error(i),console.error(i?.stack),this.dispatchEvent({type:"importFile",path:e,state:"error",error:i}),t&&this.unregisterFile(e),[]}if(this.dispatchEvent({type:"importFile",path:e,state:"done"}),t){t.__imported=s;let e=[];Array.isArray(s)?e=s:s.userData?.rootSceneModelRoot?e.push(...s.children):e.push(s),e.forEach((e=>{e.addEventListener?.("dispose",(()=>{t.__imported=void 0}))}))}if(s&&"object"==typeof s){s.__rootPath=e;const i=t||this._fileDatabase.get(e);i&&(s.__rootBlob=i)}return s}_getImporter(e,t=!1){return this.Importers.find((i=>{if(t&&!i.root)return!1;const r=i.ext.find((t=>e.ext&&t===e.ext.toLowerCase()||e.name?.toLowerCase()?.endsWith("."+t.toLowerCase())||t?.startsWith("data:")&&e.name?.startsWith(t)));return!!r&&(e.ext=r,!0)}))}_getLoader(e){return this._loadingManager.getHandler(e.trim())??void 0}async importAsset(e,t={},i){if(!e)return[];if(!this._cachedAssets.includes(e)){if(1===Object.entries(e).length&&e.path){const t=this._cachedAssets.find((t=>t.path===e.path));t&&Object.assign(e,t)}const t=this._cachedAssets.findIndex((t=>t.path===e.path));t>=0&&this._cachedAssets.splice(t,1),this._cachedAssets.push(e)}let r;if(e?.preImported&&(r=await e.preImported),!t.forceImport&&r){const e=await this.processImported(r,t);let i=!1;for(const t of e){if(t.userData?.rootSceneModelRoot&&[...t.children,...t.__processedChildren||[]].find((e=>e.__disposed))){i=!0;break}if(t.__disposed){i=!0;break}}if(!i||!1===t.reimportDisposed)return e}const a=t.pathOverride||e.path;if(e.preImported=this._importFile(a,"function"==typeof e.file?.arrayBuffer?e.file:void 0,t,i),r=await e.preImported,r&&(this.dispatchEvent({type:"processFileStart",path:a,result:r}),r=await this.processImported(r,t),this.dispatchEvent({type:"processFileEnd",path:a,result:r})),r){const t=[];Array.isArray(r)?t.push(...r):r.userData?.rootSceneModelRoot?t.push(...r.children):t.push(r),t.forEach((t=>t.addEventListener?.("dispose",(()=>{e?.preImported&&(e.preImported=void 0)}))))}return r}async importSingle(e,t={}){return"string"==typeof e?await this.importSinglePath(e,t):(await this.importAsset(e,t))?.[0]}async importSinglePath(e,t){return(await this.importPath(e,t))?.[0]}async importPath(e,t={}){const i={...t};delete i.pathOverride,delete i.forceImport,delete i.reimportDisposed,delete i.fileHandler,delete i.importedFile;const r=JSON.stringify(i);let a;return a=this._cachedAssets.find((t=>t.path===e&&t._options===r))||{path:e},a._options=r,t.importedFile&&(a.file=t.importedFile),await this.importAsset(a,t)}async processImportedSingle(e,t={}){return(await this.processImported(e,t))[0]}async processImported(e,t={}){let i=e;if(!i)return[];if(!1===t.processImported)return[i];if(Array.isArray(i)){const e=[];for(const r of i)e.push(...await this.processImported(r,t));return e}if(i.userData?.rootSceneModelRoot){if(t._rootSceneImported=!0,i.__processedChildren&&!t.forceImporterReprocess)return i.__processedChildren;if(!(i.children.length<1))return i.animations&&(i.children[0].animations||(i.children[0].animations=[]),i.children[0].animations.push(...i.animations)),i.__importedViewerConfig&&(i.children[0].__importedViewerConfig=i.__importedViewerConfig),i.userData.__importData&&(i.children[0].userData.__importData=i.userData.__importData),i.__processedChildren=await this.processImported([...i.children],t),i.__processedChildren;if(i.animations?.length>0&&console.error("AssetImporter: animations in empty scene not supported yet. animations will be ignored",i.animations),!i.__importedViewerConfig)return[];i=i.__importedViewerConfig}if(i.userData?.iModel&&(i=i.userData.iModel),i.userData?.iMaterial&&(i=i.userData.iMaterial),i.assetImporterProcessed&&!t.forceImporterReprocess)return[i];const a=i.__rootPath,s=i.__rootBlob;if(!i.assetType){if(i.isBufferGeometry&&(i=new r.Kj0(i,new r.Wid)),i.isObject3D)if(i.isLight)i=x(i);else{const e=[];i.traverse((t=>{t!==i&&t.isLight&&e.push(t)}));for(const t of e)x(t);i=new n.N(i,t)}i.isTexture&&(i.assetType="texture",t._testDataTextureComplete&&(i.isDataTexture&&i.image?.data&&(i.image.complete=!0),i.image?.complete&&(i.needsUpdate=!0)),void 0!==t.generateMipmaps&&(i.generateMipmaps=t.generateMipmaps),i.generateMipmaps||i.isRenderTargetTexture||(i.minFilter=i.minFilter===r.D1R?r.wem:i.minFilter,i.magFilter=i.magFilter===r.D1R?r.wem:i.magFilter)),i.isMaterial&&(i.assetType="material")}if(null!=i.assetType)return i.userData&&(i.userData.rootPath||!a||a.startsWith("blob:")||a.startsWith("/")||(i.userData.rootPath=a),s&&(i.userData.__sourceBlob=s,i.userData.__needsSourceBuffer&&(i.userData.__sourceBuffer=await s.arrayBuffer(),delete i.userData.__needsSourceBuffer))),i=await this._processors.process(i.assetType,i,{}),i.assetImporterProcessed=!0,[i];if(i instanceof Map)return[...(await this.importFiles(i,t)).values()].flat();if(i.type&&"ViewerApp"!==i.type&&"ThreeViewer"!==i.type){const e=this._viewer.getPluginByType(i.type);if(e){let t=i._importedResources||{};return i.resources&&(t=await(this._viewer.getManager()?.importConfigResources(i.resources)),delete i.resources,i._importedResources=t),"function"==typeof e.fromJSON&&(await Promise.resolve(e.fromJSON(i,t)),i.assetImporterProcessed=!1),[]}}return i.plugins||"ViewerApp"===i.type||"ThreeViewer"===i.type?(i.resources=await(this._viewer.getManager()?.importConfigResources(i.resources)),await this._viewer.getManager().importViewerConfig(i),i.assetImporterProcessed=!1,[]):(console.warn("unknown/null asset type: ",i,i.plugins),[i])}dispose(){this.clearCache(),this._processors?.dispose()}clearLoaderCache(){this._loaderCache.forEach((e=>{e.loader.dispose&&e.loader.dispose()})),this._loaderCache=[]}clearCache(){this.clearLoaderCache(),this._cachedAssets=[]}}function w(e){if(!e)return r.ywz;const t=e.extensions.has("EXT_color_buffer_half_float")||e.capabilities.isWebGL2&&e.extensions.has("EXT_color_buffer_float"),i=e.capabilities.isWebGL2||e.extensions.has("OES_texture_float")||e.extensions.has("WEBGL_color_buffer_float");return t?r.cLu:i?r.VzW:r.ywz}function x(e){if(!e.isLight)return e;if("light"===e.assetType)return e;if(e.uiConfig)return console.warn("ui config already exists, not supported",e),e;let t;if(e.children.length,e.isDirectionalLight&&(t=new u.qt),e.isAmbientLight&&(t=new u.B$),e.isSpotLight&&(t=new u.iw),e.isPointLight&&(t=new u.qD),t){t.lightObject.copy?.(e);const i=e.parent;i?.isObject3D&&(i.remove(e),e.dispose(),e.userData.iModel=t,i.add(t.lightObject),t.uuid=e.uuid),(0,m.LC)(t.lightObject,i)}else console.warn("unknown light type: ",e);return t}},2354:function(e,t,i){i.d(t,{q:function(){return r}});class r{ctor(e){const t=this.cls&&new this.cls(e.loadingManager);return"function"==typeof this.onCtor?this.onCtor(t,e):t}constructor(e,t,i,r){this.cls=e,this.ext=t,this.root=i,this.onCtor=r}}},8124:function(e,t,i){i.d(t,{Hf:function(){return S},pn:function(){return x},tA:function(){return D},Eb:function(){return C},Bk:function(){return m},Pd:function(){return u},Tu:function(){return f},dR:function(){return v},RX:function(){return g}});var r=i(2354),a=i(1454),s=i(9008);class n extends a.EP{constructor(e){super(e),this.isGLTFLoader2=!0,this.preparsers=[],this.preparsers.push(o)}async preparse(e,t){for(const i of this.preparsers)e=await i.process(e,t);return e}parse(e,t,i,r,a){this.preparse.call(this,e,a||t).then((e=>e?super.parse(e,t,i,r):r&&r(new ErrorEvent("no data")))).catch((e=>{console.error(e),r&&r(e??new ErrorEvent("unknown error"))}))}transform(e,t){const i=e?e.scene||(e.scenes&&e.scenes.length>0?e.scenes[0]:void 0):void 0;return i&&e.animations.length>0&&(i.animations=e.animations),i?.traverse((e=>{e.userData.gltfUUID&&(e.uuid=e.userData.gltfUUID,delete e.userData.gltfUUID)})),i}register(e){return super.register(e)}}const o={key:(e,t,i)=>e.key||window&&window.prompt&&window.prompt("GLTFEncryption: Please enter the password/key for the model: "+i)||"",async process(e,t){if("string"==typeof e)return e;if(!(new TextDecoder).decode(new Uint8Array(e,0,100)).includes("WebGiGLBWrapper"))return e;const i=new a.EL(e),r=JSON.parse(i.content||"{}");let n=i.body||e;const o=r.asset?.encryption;if(!o)return n;const l=o.type,c=o.version;if("aesgcm"===l&&1===c){const e=await(0,s.getOrCall)(this.key,o,r,t)||"";try{n=(await(0,s.aesGcmDecrypt)(new Uint8Array(n),e)).buffer}catch(e){throw new ErrorEvent("decryption error")}}return n}};var l=i(8570),c=i(4821),d=i(8781),h=i(8737),p=i(4107);const u="WEBGI_viewer";function m(e){return new r.q(n,["gltf","glb","data:model/gltf"],!0,((t,i)=>{if(!t)return t;const r=t,a=new h.$(i.loadingManager);return r.register(y(a,e)),r.register(_(a)),r.register(b(a)),r.register((e=>new M(e))),r.register((e=>new T(e))),r.register((e=>new O(e))),r.register((e=>new P(e))),r.register((t=>{const s=t.getDependency;t.getDependency=async(e,i)=>{const r=await s.call(t,e,i);if(r&&r.userData){const e=r.userData.gltfExtensions;delete r.userData.gltfExtensions,r.userData=(0,p.Hx)(r.userData,{},!1,{}),r.userData.gltfExtensions=e}return r};const n=(0,l.Z)()+".drc",o=(0,l.Z)()+".ktx2",c=t.json?.extensionsRequired?.includes?.("KHR_draco_mesh_compression");if(c){const e=i.registerFile(n);e&&r.setDRACOLoader(e)}const d=t.json?.extensionsUsed?.includes?.("EXT_meshopt_compression");d&&(window.MeshoptDecoder?(r.setMeshoptDecoder(window.MeshoptDecoder),t.options.meshoptDecoder=window.MeshoptDecoder):console.error("Add GLTFMeshOptPlugin to viewer to enable EXT_meshopt_compression decode"));const h=t.json?.extensionsUsed?.includes?.("KHR_texture_basisu");if(h){const e=i.registerFile(o);e&&(r.setKTX2Loader(e),t.options.ktx2Loader=e)}return{name:"GLTF2_HELPER_PLUGIN",afterRoot:async r=>{c&&i.unregisterFile(n),h&&i.unregisterFile(o);const s=await w(t,e,a);r.scene&&(r.scene.__importedViewerConfig=s)}}})),r}))}const f="WEBGI_light_extras",g="WEBGI_object3d_extras",v="WEBGI_material_extras",_=e=>e=>({name:"__"+g,afterRoot:async e=>{(e.scenes||(e.scene?[e.scene]:[])).forEach((e=>{e.traverse((e=>{if(!e||!e.isObject3D)return;const t=e.userData?.gltfExtensions?.[g];if(!t)return void(e.isLight&&!e.isAmbientLight&&(e.castShadow=!0));const i=void 0!==t.castShadow||void 0!==t.receiveShadow;void 0!==t.castShadow&&(e.castShadow=t.castShadow),void 0!==t.receiveShadow&&(e.receiveShadow=t.receiveShadow),void 0!==t.visible&&(e.visible=t.visible),void 0!==t.frustumCulled&&(e.frustumCulled=t.frustumCulled),void 0!==t.renderOrder&&(e.renderOrder=t.renderOrder),void 0!==t.layers&&(e.layers.mask=t.layers),i&&(e.userData.__keepShadowDef=!0),delete e.userData.gltfExtensions[g]}))}))}}),y=(e,t)=>e=>({name:"__"+v,afterRoot:async e=>{const i=e.scenes||(e.scene?[e.scene]:[]);for(const e of i){const i=e.userData?.gltfExtensions?.[v],r=i&&await(t.getPlugin(c.k)?.importConfigResources(i.resources||{}))||{};e.traverse((e=>{const i=e?.material;if(!i?.isMaterial)return;const a=i.userData?.gltfExtensions?.[v];a&&(void 0!==a.emissiveIntensity&&(i.emissiveIntensity=a.emissiveIntensity),void 0!==a.fog&&(i.fog=a.fog),void 0!==a.flatShading&&(i.flatShading=a.flatShading),void 0!==a.blending&&(i.blending=a.blending),void 0!==a.side&&(i.side=a.side),void 0!==a.shadowSide&&(i.shadowSide=a.shadowSide),void 0!==a.depthFunc&&(i.depthFunc=a.depthFunc),void 0!==a.depthTest&&(i.depthTest=a.depthTest),void 0!==a.depthWrite&&(i.depthWrite=a.depthWrite),void 0!==a.colorWrite&&(i.colorWrite=a.colorWrite),void 0!==a.vertexColors&&(i.vertexColors=a.vertexColors),void 0!==a.alphaTest&&(i.alphaTest=a.alphaTest),void 0!==a.wireframe&&(i.wireframe=a.wireframe),void 0!==a.wireframeLinewidth&&(i.wireframeLinewidth=a.wireframeLinewidth),void 0!==a.wireframeLinecap&&(i.wireframeLinecap=a.wireframeLinecap),void 0!==a.wireframeLinejoin&&(i.wireframeLinejoin=a.wireframeLinejoin),void 0!==a.rotation&&(i.rotation=a.rotation),void 0!==a.polygonOffset&&(i.polygonOffset=a.polygonOffset),void 0!==a.polygonOffsetFactor&&(i.polygonOffsetFactor=a.polygonOffsetFactor),void 0!==a.polygonOffsetUnits&&(i.polygonOffsetUnits=a.polygonOffsetUnits),void 0!==a.dithering&&(i.dithering=a.dithering),void 0!==a.alphaToCoverage&&(i.alphaToCoverage=a.alphaToCoverage),void 0!==a.premultipliedAlpha&&(i.premultipliedAlpha=a.premultipliedAlpha),void 0!==a.toneMapped&&(i.toneMapped=a.toneMapped),void 0!==a.normalScale&&void 0!==i.normalScale&&(Array.isArray(a.normalScale)?i.normalScale.fromArray(a.normalScale):"number"==typeof a.normalScale?i.normalScale.set(a.normalScale,a.normalScale):t.console.warn("normalScale is not an array or number",a.normalScale)),void 0!==a.reflectivity&&(i.reflectivity=a.reflectivity),Object.entries(a).forEach((([e,t])=>{e.startsWith("_")||t&&t.resource&&"string"==typeof t.resource&&(i[e]=(0,p.Hx)(t,i[e],!1,r))})),delete i.userData.gltfExtensions[v])})),i&&delete e.userData.gltfExtensions[v]}}}),b=e=>t=>({name:"__"+f,afterRoot:async t=>{(t.scenes||(t.scene?[t.scene]:[])).forEach((t=>{t.traverse((t=>{if(!t.isLight)return;const i=t.userData?.gltfExtensions?.[f];i&&(!t.shadow&&i.shadow&&console.error("Light has no shadow, cannot import",t,i),i.shadow&&t.shadow&&(void 0!==i.shadow.bias&&(t.shadow.bias=i.shadow.bias),void 0!==i.shadow.normalBias&&(t.shadow.normalBias=i.shadow.normalBias),void 0!==i.shadow.radius&&(t.shadow.radius=i.shadow.radius),void 0!==i.shadow.mapSize&&t.shadow.mapSize.fromArray(i.shadow.mapSize),void 0!==i.shadow.camera&&(t.shadow.camera=e.parseObject(i.shadow.camera))),delete t.userData.gltfExtensions[f])}))}))}});async function w(e,t,i,r){if(!r){const a=e.json.scenes||[];if(1!==a.length){for(const r of a)await w(e,t,i,r);return}r=a[0]}const a=r.extensions?.[u];if(!a)return;const s=[];Object.values(a.resources).forEach((e=>{Object.values(e).forEach((e=>{e.url&&("Uint16Array"===e.url.type&&e.url.data&&s.push(e.url),"Uint8Array"===e.url.type&&e.url.data&&s.push(e.url))}))}));for(const t of s){const i=t.data.image,r=e.json.images[i],a=await e.getDependency("bufferView",r.bufferView);if(r.mimeType.startsWith("image/")&&"Uint16Array"===t.type&&"rgbe"===t.encoding){const e=new Blob([a]);let i=URL.createObjectURL(e);(t.encodingVersion||1)<2&&(i="data:image/png;base64,"+btoa(await e.text())),t.data=(await(new d.F).parseAsync(i,void 0,!0)).data,URL.revokeObjectURL(i),delete t.encoding,delete t.encodingVersion}else t.data=a}const n={textures:{},materials:{}},o=a.resources;if(o.textures&&e.json.textures)for(const[t,i]of[...Object.entries(o.textures)]){if(i.uuid||!t)continue;delete o.textures[t];const r=e.json.textures.findIndex((i=>i.extras?.uuid===t||e.json.samplers?.[i.sampler]?.extras?.uuid===t||e.json.images?.[i.source]?.extras?.t_uuid===t));r>=0&&(n.textures[t]=await e.getDependency("texture",r))}if(o.materials&&e.json.materials)for(const[i,r]of[...Object.entries(o.materials)]){if(r.uuid||!i)continue;delete o.materials[i];const a=e.json.materials.findIndex((e=>e.extras?.uuid===i));a>=0&&(n.materials[i]=await e.getDependency("material",a),n.materials[i]=t.getPlugin(c.k)?.materials?.processMaterial(n.materials[i],{}))}return a.resources=await t.getPlugin(c.k).importConfigResources(o||{},i,n),a}const x="WEBGI_materials_bumpmap",D="WEBGI_materials_displacementmap",S="WEBGI_materials_alphamap",C="WEBGI_materials_lightmap";class M{constructor(e){this.parser=e,this.name=x}async extendMaterialParams(e,t){const i=this.parser,r=i.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=[],s=r.extensions[this.name];return void 0!==s.bumpScale&&(t.bumpScale=s.bumpScale),void 0!==s.bumpTexture&&a.push(i.assignTexture(t,"bumpMap",s.bumpTexture)),Promise.all(a)}}class T{constructor(e){this.parser=e,this.name=D}async extendMaterialParams(e,t){const i=this.parser,r=i.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=[],s=r.extensions[this.name];return void 0!==s.displacementScale&&(t.displacementScale=s.displacementScale),void 0!==s.displacementBias&&(t.displacementBias=s.displacementBias),void 0!==s.displacementTexture&&a.push(i.assignTexture(t,"displacementMap",s.displacementTexture)),Promise.all(a)}}class O{constructor(e){this.parser=e,this.name=C}async extendMaterialParams(e,t){const i=this.parser,r=i.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=[],s=r.extensions[this.name];return void 0!==s.lightMapIntensity&&(t.lightMapIntensity=s.lightMapIntensity),void 0!==s.lightMapTexture&&a.push(i.assignTexture(t,"lightMap",s.lightMapTexture)),Promise.all(a)}}class P{constructor(e){this.parser=e,this.name=S}async extendMaterialParams(e,t){const i=this.parser,r=i.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=[],s=r.extensions[this.name];return void 0!==s.alphaTexture&&a.push(i.assignTexture(t,"alphaMap",s.alphaTexture)),Promise.all(a)}}},5023:function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{Q:function(){return DRACOLoader2}});var three_examples_jsm_loaders_DRACOLoader__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(9553),three__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2988);class DRACOLoader2 extends three_examples_jsm_loaders_DRACOLoader__WEBPACK_IMPORTED_MODULE_0__._{constructor(e){super(e),this.encoderPending=null,this.encoderConfig={type:"js"},this.setDecoderPath("https://cdn.jsdelivr.net/gh/google/draco@1.4.1/javascript/"),this.setDecoderConfig({type:"js"})}transform(e,t){return e?new three__WEBPACK_IMPORTED_MODULE_1__.Kj0(e,new three__WEBPACK_IMPORTED_MODULE_1__.Wid):void 0}preload(e=!0,t=!1){return e&&super.preload(),t&&this.initEncoder(),this}async initEncoder(){if(this.encoderPending)return this.encoderPending;const useJS="object"!=typeof WebAssembly||"js"===this.encoderConfig.type,librariesPending=[],libLoader=this._loadLibrary.bind(this);return useJS?librariesPending.push(libLoader("draco_encoder.js","text")):(librariesPending.push(libLoader("draco_wasm_wrapper.js","text")),librariesPending.push(libLoader("draco_encoder.wasm","arraybuffer"))),this.encoderPending=Promise.all(librariesPending).then((libraries=>{const jsContent=libraries[0];return useJS||(this.encoderConfig.wasmBinary=libraries[1]),eval(jsContent+"\nDracoEncoderModule;")?.()})),this.encoderPending}async initDecoder(){await this._initDecoder();const jsContent=await fetch(this.workerSourceURL).then((async e=>e.text())).then((e=>{const t=e.indexOf("/* worker */");if(t<1)throw new Error("unable to load decoder module");return e.substring(0,t-1)}));return eval(jsContent+"\nDracoDecoderModule;")?.()}async _loadLibrary(e,t){return DRACOLoader2.LibraryValueMap[e]?DRACOLoader2.LibraryValueMap[e]:DRACOLoader2.LibraryValueMap[e]=await super._loadLibrary(e,t)}static SetDecoderJsString(e){this.LibraryValueMap["draco_decoder.js"]=e}}DRACOLoader2.LibraryValueMap={}},8737:function(e,t,i){i.d(t,{$:function(){return s}});var r=i(2988),a=i(4107);class s extends r.Gql{constructor(e){super(e),this._imageLoader=new r.S3k(e)}static async LoadRootPathTextures(e,t,i,a=!0){const s=[];for(const n of Array.isArray(e)?e:Object.values(e??{})){const e=n?.userData?.rootPath,o=a&&n.image&&t[n.image];if(!e)continue;const l=i.importPath(e,{processImported:!1}).then((e=>{const i=e?.[0],a=i?.source;if(!i||!a)return null;const s=new r.Hw6(a.data);return n.image&&(s.uuid=n.image),n.image=s.uuid,o||(t[s.uuid]=s),i.dispose(),s})).catch((e=>(console.error(e),delete n.userData.rootPath,null)));o?n.rootPathPromise=l:s.push(l)}await Promise.allSettled(s)}parseTextures2(e,t,i){for(const s of e){const e=s?.userData?.rootPath;if(e&&(!s.image||!t[s.image])){const a=new r.Hw6(this._imageLoader.load(e,i));if(!a)continue;s.image&&(a.uuid=s.image),t[a.uuid]=a,s.image=a.uuid}s.userData=(0,a.Hx)(s.userData,void 0,!1,{images:t})}const s=super.parseTextures(e,t),n={...s};for(const t of e)t.rootPathPromise?.then((e=>{if(!e)return;const i=n[t.uuid];i.dispose(),i.source=e,i.source.needsUpdate=!0,i.needsUpdate=!0}));return s}parseMaterials2(e,t,i){const r={};return e.forEach((e=>{if(!e)return;const s={...e},n=Object.keys(s);for(const e of n)if("map"===e||e.endsWith("Map")){const i=s[e];"string"==typeof i&&(t[i]?s[e]=t[i]:(console.warn(`Texture ${i} not found`),delete s[e]))}s.userData&&(s.userData=(0,a.Hx)(s.userData,void 0,!1,{textures:t}),s.userData.cloneId&&s.userData.uuid!==e.uuid&&(s.userData.uuid=e.uuid));const o=i.generateFromTemplateType(s.type,s);o&&(r[e.uuid]=o)})),r}}},8781:function(e,t,i){i.d(t,{F:function(){return s}});var r=i(2988),a=i(9008);class s extends r.hH6{constructor(e){super(e),this.type=r.cLu}async loadAsync(e,t){const i=await this.parseAsync(e,t,!1),a=new r.IEO(i.data,i.width,i.height,r.wk1,this.type);return a.needsUpdate=!0,a.flipY=!0,a.colorSpace=r.KI_,a.minFilter=r.wem,a.magFilter=r.wem,a.source.data.complete=!0,a}async parseAsync(e,t,i=!1){let s=!1;if(!e.startsWith("data:")&&!e.startsWith("blob:")){this.responseType="blob";const i=await super.loadAsync(e,t);e=URL.createObjectURL(i),s=!0}const n=await(0,a.imageUrlToImageData)(e);s&&URL.revokeObjectURL(e);let o=Uint8Array;return this.type===r.cLu?o=Uint16Array:this.type===r.VzW&&(o=Uint32Array),{data:function(e,t=3,i=Uint16Array,a=!1){let s;const n=e.byteLength>>2,o=new i(n*t);for(let i=0;i<n;i++)s=Math.pow(2,e[4*i+3]-136),a?(o[i*t]=Math.min(e[4*i]*s,65504),o[i*t+1]=Math.min(e[4*i+1]*s,65504),o[i*t+2]=Math.min(e[4*i+2]*s,65504)):(o[i*t]=r.A5E.toHalfFloat(Math.min(e[4*i]*s,65504)),o[i*t+1]=r.A5E.toHalfFloat(Math.min(e[4*i+1]*s,65504)),o[i*t+2]=r.A5E.toHalfFloat(Math.min(e[4*i+2]*s,65504))),4===t&&(o[i*t+3]=r.A5E.toHalfFloat(1));return o}(n.data,4,o,i),width:n.width,height:n.height}}setDataType(e){return this.type=e,this}}},4001:function(e,t,i){i.d(t,{v:function(){return a}});var r=i(2988);class a extends r.hH6{load(e,t,i,r){return super.load(e,(e=>{try{if("string"!=typeof e)throw new Error("Invalid JSON");t?.(JSON.parse(e))}catch(e){r?.(e)}}),i,r)}}},6420:function(e,t,i){i.d(t,{s:function(){return s}});var r=i(2988),a=i(743);class s extends r.hH6{load(e,t,i,r){return this.setResponseType("arraybuffer"),super.load(e,(e=>{const i=(0,a.GZ)(new Uint8Array(e)),r=new Map(Object.entries(i).map((([e,t])=>[e,new File([t],e)])));t?.(r)}),i,r)}}},9452:function(e,t,i){i.d(t,{K:function(){return n}});var r=i(9008),a=i(8570),s=i(8670);class n{static ApplyMaterialExtensions(e,t,i,r){for(const a of i)this.ApplyMaterialExtension(e,t,a,r)}static ApplyMaterialExtension(e,t,i,a){let n=(0,r.getOrCall)(i.parsFragmentSnippet,a,e)??"";n.length&&(t.fragmentShader=(0,s.p)(t.fragmentShader,this.VoidMain,"\n"+n+"\n",{prepend:!0})),n=(0,r.getOrCall)(i.parsVertexSnippet,a,e)??"",n.length&&(t.vertexShader=(0,s.p)(t.vertexShader,this.VoidMain,"\n"+n+"\n",{prepend:!0})),i.extraUniforms&&(t.uniforms=Object.assign(t.uniforms,i.extraUniforms)),i.extraDefines&&function(e,t){let i=!1;t.materialObject&&void 0===t.materialObject.defines&&(t.materialObject.defines={});const r=Object.entries(e);for(const[e,a]of r)void 0===a?void 0!==t.materialObject.defines[e]&&(delete t.materialObject.defines[e],i=!0):t.materialObject.defines[e]!==a&&(t.materialObject.defines[e]=a,i=!0);i&&(t.materialObject.needsUpdate=!0)}(i.extraDefines,e),i.shaderExtender&&i.shaderExtender(t,e,a),e.lastShader=t}static CacheKeyForExtensions(e,t){let i="";for(const r of t)i+=this.CacheKeyForExtension(e,r);return i}static CacheKeyForExtension(e,t){let i="";return t.customCacheKey&&(i+=t.customCacheKey),t.computeCacheKey&&(i+=t.computeCacheKey(e)),t.extraDefines&&Object.values(t.extraDefines).forEach((e=>i+=e)),i}static RegisterExtensions(e,t){const i=[];if(t)for(const r of t)r.isCompatible&&r.isCompatible(e)&&(i.push(r),r.uuid||(r.uuid=(0,a.Z)()),r.__setDirty||(r.__setDirty=()=>{r.updateVersion||(r.updateVersion=0),r.updateVersion++}),r.setDirty||(r.setDirty=r.__setDirty));return e.materialExtensions=i,e.__ext_beforeRenderListen||(e.__ext_beforeRenderListen=!0,e.addEventListener("beforeRender",(t=>function(e,{object:t,renderer:i}){if(e.materialExtensions)for(const a of e.materialExtensions){if(a.onObjectRender?.(t,e,i),e.lastShader){const t=(0,r.getOrCall)(a.updaters)||[];for(const i of t)i&&i.updateShaderProperties(e.lastShader)}a.updateVersion!==e.materialObject.userData["_"+a.uuid+"_version"]&&(e.materialObject.userData["_"+a.uuid+"_version"]=a.updateVersion,e.materialObject.needsUpdate=!0)}}(e,t)))),e.__ext_afterRenderListen||(e.__ext_afterRenderListen=!0,e.addEventListener("afterRender",(t=>function(e,{object:t,renderer:i}){if(e.materialExtensions)for(const r of e.materialExtensions)r.onAfterRender?.(t,e,i)}(e,t)))),i}}n.VoidMain="void main()"},1564:function(e,t,i){i.d(t,{_:function(){return a}});var r=i(2988);const a={name:"",blending:r.bdR,side:r.Wl3,vertexColors:!1,opacity:1,transparent:!1,blendSrc:r.k74,blendDst:r.LgZ,blendEquation:r.bGH,blendSrcAlpha:null,blendDstAlpha:null,blendEquationAlpha:null,depthFunc:r.vCF,depthTest:!0,depthWrite:!0,stencilWriteMask:255,stencilFunc:r.cum,stencilRef:0,stencilFuncMask:255,stencilFail:r.x5V,stencilZFail:r.x5V,stencilZPass:r.x5V,stencilWrite:!1,clippingPlanes:null,clipIntersection:!1,clipShadows:!1,shadowSide:null,colorWrite:!0,precision:null,polygonOffset:!1,polygonOffsetFactor:0,polygonOffsetUnits:0,dithering:!1,alphaToCoverage:!1,premultipliedAlpha:!1,forceSinglePass:!1,visible:!0,toneMapped:!0,userData:{},alphaTest:0}},4379:function(e,t,i){i.d(t,{cU:function(){return h},iu:function(){return p},jc:function(){return d}});var r=i(2988),a=i(9452),s=i(1564),n=i(9008),o=i(4107),l=i(8670),c=i(2860);const d={...s._,color:"#ffffff",roughness:1,metalness:0,map:null,lightMap:null,lightMapIntensity:1,aoMap:null,aoMapIntensity:1,emissive:"#000000",emissiveIntensity:1,emissiveMap:null,bumpMap:null,bumpScale:1,normalMap:null,normalMapType:r.IOt,normalScale:new r.FM8(1,1),displacementMap:null,displacementScale:1,displacementBias:0,roughnessMap:null,metalnessMap:null,alphaMap:null,envMap:null,envMapIntensity:1,wireframe:!1,wireframeLinewidth:1,wireframeLinecap:"round",wireframeLinejoin:"round",flatShading:!1,fog:!0},h={...d,clearcoat:0,clearcoatMap:null,clearcoatRoughness:0,clearcoatRoughnessMap:null,clearcoatNormalScale:new r.FM8(1,1),clearcoatNormalMap:null,reflectivity:.5,iridescence:0,iridescenceMap:null,iridescenceIOR:1.3,iridescenceThicknessRange:[100,400],iridescenceThicknessMap:null,sheen:0,sheenColor:new r.Ilk(0),sheenColorMap:null,sheenRoughness:1,sheenRoughnessMap:null,transmission:0,transmissionMap:null,thickness:0,thicknessMap:null,attenuationDistance:1/0,attenuationColor:new r.Ilk(1,1,1),specularIntensity:1,specularIntensityMap:null,specularColor:new r.Ilk(1,1,1),specularColorMap:null};class p extends r.EJi{constructor(e){super(e),this.typeSlug=p.TypeSlug,this.assetType="material",this.materialObject=this,this.isMeshStandardMaterial2=!0,this.extraUniformsToUpload={},this.setDirty=this.setDirty.bind(this),this.userData.setDirty=e=>{console.warn("userData.setDirty is deprecated. Use setDirty instead."),this.setDirty(e)},this.fog=!1,this.attenuationDistance=0,this.materialExtensions=a.K.RegisterExtensions(this,e?.customMaterialExtensions??[])}setDirty(e){this.needsUpdate=!0,this.dispatchEvent({...e,type:"materialUpdate"}),this._uiConfig?.uiRefresh?.("postFrame",!0,1)}registerMaterialExtensions(e){this.materialExtensions=[...this.materialExtensions,...a.K.RegisterExtensions(this,e)]}unregisterMaterialExtensions(e){}get uiConfig(){return this._uiConfigChildren||(this._uiConfigChildren=[{type:"input",property:[this,"name"]},{type:"checkbox",property:[this,"wireframe"]},{type:"checkbox",property:[this,"vertexColors"]},{type:"color",property:[this,"color"],limitedUi:!0},{type:"image",property:[this,"map"]},(0,c.xX)(this,"map"),{type:"folder",label:"Rough/Metal",limitedUi:!0,children:[{type:"slider",bounds:[0,1],property:[this,"roughness"],limitedUi:!0},{type:"slider",bounds:[0,1],property:[this,"metalness"],limitedUi:!0},{type:"image",property:[this,"roughnessMap"]},(0,c.xX)(this,"roughnessMap"),{type:"image",property:[this,"metalnessMap"]},(0,c.xX)(this,"metalnessMap")]},{type:"folder",label:"Bump/Normal",limitedUi:!0,children:[{type:"slider",bounds:[-.1,.2],stepSize:.001,property:[this,"bumpScale"],hidden:()=>!this.bumpMap},{type:"image",property:[this,"bumpMap"]},(0,c.xX)(this,"bumpMap"),{type:"image",property:[this,"normalMap"]},{type:"vec2",property:[this,"normalScale"],hidden:()=>!this.normalMap},{type:"dropdown",hidden:()=>!this.normalMap,property:[this,"normalMapType"],children:[["TangentSpace",r.IOt],["ObjectSpace",r.PA7]].map((e=>({label:e[0],value:e[1]})))},(0,c.xX)(this,"normalMap"),{type:"input",property:[this,"displacementScale"],hidden:()=>!this.displacementMap},{type:"image",property:[this,"displacementMap"]},(0,c.xX)(this,"displacementMap")]},{type:"folder",label:"Sheen",children:[{type:"slider",bounds:[0,1],property:[this,"sheen"]},{type:"color",hidden:()=>this.sheen<.001,property:[this,"sheenColor"]},{type:"image",property:[this,"sheenColorMap"]},(0,c.xX)(this,"sheenColorMap"),{type:"slider",bounds:[0,1],property:[this,"sheenRoughness"]},{type:"image",property:[this,"sheenRoughnessMap"]},(0,c.xX)(this,"sheenRoughnessMap")]},{type:"folder",label:"Clearcoat",children:[{type:"slider",bounds:[0,1],property:[this,"clearcoat"]},{type:"slider",bounds:[0,1],hidden:()=>this.clearcoat<.001,property:[this,"clearcoatRoughness"]},{type:"image",property:[this,"clearcoatMap"]},(0,c.xX)(this,"clearcoatMap"),{type:"slider",bounds:[0,1],property:[this,"clearcoatRoughness"]},{type:"image",property:[this,"clearcoatRoughnessMap"]},(0,c.xX)(this,"clearcoatRoughnessMap"),{type:"image",property:[this,"clearcoatNormalMap"]},{type:"vec2",property:[this,"clearcoatNormalScale"],hidden:()=>!this.clearcoatNormalMap},(0,c.xX)(this,"clearcoatNormalMap")]},{type:"folder",label:"Emission",children:[{type:"color",property:[this,"emissive"]},{type:"slider",bounds:[0,10],property:[this,"emissiveIntensity"]},{type:"image",property:[this,"emissiveMap"]},(0,c.xX)(this,"emissiveMap")]},{type:"folder",label:"Refraction",children:[{type:"slider",bounds:[0,4],property:[this,"ior"]},{type:"slider",bounds:[0,1],property:[this,"transmission"],limitedUi:!0},{type:"slider",bounds:[0,1],stepSize:.001,property:[this,"thickness"]},{type:"image",property:[this,"transmissionMap"]},(0,c.xX)(this,"transmissionMap"),{type:"image",property:[this,"thicknessMap"]},(0,c.xX)(this,"thicknessMap"),{type:"input",property:[this,"attenuationDistance"]},{type:"color",property:[this,"attenuationColor"]}]},{type:"folder",label:"Blending",children:[{type:"slider",bounds:[0,1],property:[this,"opacity"]},{type:"checkbox",property:[this,"transparent"],onChange:this.setDirty},{type:"dropdown",property:[this,"depthFunc"],children:[["Never",r.BVF],["Always",r.Se2],["Less",r.Zr5],["LessEqual",r.vCF],["Equal",r.eD],["GreaterEqual",r.ksN],["Greater",r.w$m],["NotEqual",r.M6v]].map((e=>({label:e[0],value:e[1]})))},{type:"checkbox",property:[this,"depthTest"],onChange:this.setDirty},{type:"checkbox",property:[this,"depthWrite"],onChange:this.setDirty},{type:"checkbox",property:[this,"colorWrite"],onChange:this.setDirty},{type:"slider",bounds:[0,1],stepSize:.001,property:[this,"alphaTest"]},{type:"checkbox",property:[this,"dithering"]},{type:"dropdown",label:"Blending",property:[this,"blending"],children:[["None",r.jFi],["Normal",r.bdR],["Additive",r.WMw],["Subtractive",r.N4l],["Multiply",r.M5h]].map((e=>({label:e[0],value:e[1]})))},{type:"image",property:[this,"alphaMap"]},(0,c.xX)(this,"alphaMap"),{type:"checkbox",label:"Render to Depth",getValue:()=>!0===this.userData.renderToDepth,setValue:e=>{this.userData.renderToDepth=e||void 0,this.setDirty()}},{type:"checkbox",label:"Inverse AlphaMap",hidden:()=>!this.transparent,getValue:()=>!0===this.userData.inverseAlphaMap,setValue:e=>{this.userData.inverseAlphaMap=e||void 0,this.setDirty()}},{type:"checkbox",label:"Polygon Offset",property:[this,"polygonOffset"]},{type:"slider",label:"Polygon Offset Factor",bounds:[-10,10],property:[this,"polygonOffsetFactor"]},{type:"slider",label:"Polygon Offset Units",bounds:[-10,10],property:[this,"polygonOffsetUnits"]}]},{type:"folder",label:"AO/Lightmap",children:[{type:"slider",bounds:[0,2],property:[this,"aoMapIntensity"]},{type:"image",property:[this,"aoMap"]},(0,c.xX)(this,"aoMap"),{type:"slider",bounds:[0,2],property:[this,"lightMapIntensity"]},{type:"image",property:[this,"lightMap"]},(0,c.xX)(this,"lightMap")]},{type:"folder",label:"Iridescence",children:[{type:"slider",bounds:[0,3],label:"Intensity",property:[this,"iridescence"]},{type:"slider",bounds:[0,3],label:"IOR",property:[this,"iridescenceIOR"]},{type:"slider",bounds:[0,500],label:"Thickness0",property:[this.iridescenceThicknessRange,"0"],onChange:this.setDirty},{type:"slider",bounds:[0,500],label:"Thickness1",property:[this.iridescenceThicknessRange,"1"],onChange:this.setDirty},{type:"image",property:[this,"iridescenceMap"]},(0,c.xX)(this,"iridescenceMap"),{type:"image",property:[this,"iridescenceThicknessMap"]},(0,c.xX)(this,"iridescenceThicknessMap")]},{type:"dropdown",label:"Side",property:[this,"side"],children:[["Front",r.Wl3],["Back",r._Li],["Double",r.ehD]].map((e=>({label:e[0],value:e[1]})))},{type:"checkbox",property:[this,"flatShading"]},{type:"input",label:"Mesh count",getValue:()=>this.userData?.__appliedMeshes?.size??0,setValue:e=>{},disabled:!0},{type:"button",label:`Download ${this.typeSlug}`,value:()=>{const e=new Blob([JSON.stringify((0,o.HD)(this,!1),null,2)],{type:"application/json"});(0,n.downloadBlob)(e,`physical-material.${this.typeSlug}`)}}]),this._uiConfig||(this._uiConfig={type:"folder",label:"Physical Material",expanded:!0,children:this._uiConfigChildren,uuid:"MSM2_"+this.uuid,limitedUi:!0}),this._uiConfig.children=[...this._uiConfigChildren,...this.materialExtensions.map((e=>e.getUiConfig?.(this)))].filter((e=>e)),this._uiConfig}onBeforeCompile(e,t){const i=[["vec3 totalDiffuse = ","afterModulation"],["#include <aomap_fragment>","beforeModulation"],["#include <lights_physical_fragment>","beforeAccumulation"],["#include <clipping_planes_fragment>","mainStart"]],r=[["#include <uv_vertex>","mainStart"]];for(const t of r)e.vertexShader=(0,l.p)(e.vertexShader,t[0],"#glMarker "+t[1]+"\n"+t[0]);for(const t of i)e.fragmentShader=(0,l.p)(e.fragmentShader,t[0],"#glMarker "+t[1]+"\n"+t[0]);a.K.ApplyMaterialExtensions(this,e,this.materialExtensions,t),e.fragmentShader=e.fragmentShader.replaceAll("#glMarker","// "),e.vertexShader=e.vertexShader.replaceAll("#glMarker","// "),e.defines.INVERSE_ALPHAMAP=this.userData.inverseAlphaMap?1:0,super.onBeforeCompile(e,t)}customProgramCacheKey(){return super.customProgramCacheKey()+a.K.CacheKeyForExtensions(this,this.materialExtensions)+this.userData.inverseAlphaMap}onBeforeRender(e,t,i,r,a){super.onBeforeRender(e,t,i,r,a),void 0===this.envMapIntensity||this.userData.separateEnvMapIntensity||void 0===t.envMapIntensity||(this.userData.__envIntensity=this.envMapIntensity,this.envMapIntensity=t.envMapIntensity),void 0!==this.envMap&&void 0!==t.fixedEnvMapDirection&&(t.fixedEnvMapDirection?this.defines.FIX_ENV_DIRECTION||(this.defines.FIX_ENV_DIRECTION="1",this.needsUpdate=!0):void 0!==this.defines.FIX_ENV_DIRECTION&&(delete this.defines.FIX_ENV_DIRECTION,this.needsUpdate=!0)),this.dispatchEvent({type:"beforeRender",renderer:e,scene:t,camera:i,geometry:r,object:a});const s=this.userData.inverseAlphaMap?1:0;s!==this.defines.INVERSE_ALPHAMAP&&(this.defines.INVERSE_ALPHAMAP=s,this.needsUpdate=!0)}onAfterRender(e,t,i,r,a){super.onAfterRender(e,t,i,r,a),void 0!==this.userData.__envIntensity&&(this.envMapIntensity=this.userData.__envIntensity,delete this.userData.__envIntensity),this.dispatchEvent({type:"afterRender",renderer:e,scene:t,camera:i,geometry:r,object:a})}copyProps(e,t=!1,i=!0){if(!t&&!["MeshStandardMaterial",p.TYPE,"MeshPhysicalMaterial"].includes(e.type))return console.error("Material type is not supported:",e.type),this;const r={},a=Array.from(Object.keys(h));(0,n.copyProps)(e,r,a);const s=r.userData;delete r.userData;for(const e of Object.keys(r))void 0===r[e]&&delete r[e];if(this.setValues(r),i){const e={};for(const t of c.ep)void 0!==this.userData[t]&&(e[t]=this.userData[t])}return s&&(0,c.aw)(this.userData,s),isFinite(this.attenuationDistance)||(this.attenuationDistance=0),this.setDirty(),this}toJSON(e){const t=this.userData;this.userData={};const i=super.toJSON(e);this.userData=t,i.userData={},(0,c.aw)(i.userData,t),i.userData.uuid=this.userData.uuid;const r=e||{textures:Object.fromEntries(i.textures?.map((e=>[e.uuid,e]))||[]),images:Object.fromEntries(i.images?.map((e=>[e.uuid,e]))||[])};i.userData=(0,o.HD)(i.userData,!1,r),e||(Object.keys(r.textures).length>0&&(i.textures=Object.values(r.textures)),Object.keys(r.images).length>0&&(i.images=Object.values(r.images))),i.type=p.TYPE;for(const e of Object.keys(i))void 0===i[e]&&delete i[e];return i}fromJSON(e,t,i=!1){return this.copyProps(e,i)}clone(){return super.clone()}}p.TypeSlug="pmat",p.TYPE="MeshStandardMaterial2"},2860:function(e,t,i){i.d(t,{Mj:function(){return l},aw:function(){return n},ep:function(){return s},xX:function(){return a}});var r=i(2988);function a(e,t){return{type:"folder",label:t+" Sampler",hidden:()=>!e[t],children:[()=>({type:"vec2",label:"Repeat",bounds:[-100,100],stepSize:.001,property:[e[t],"repeat"],onChange:e?.setDirty}),()=>({type:"vec2",label:"Offset",bounds:[-2,2],stepSize:.001,property:[e[t],"offset"],onChange:e?.setDirty}),()=>({type:"vec2",label:"Center",bounds:[-2,2],stepSize:.001,property:[e[t],"center"],onChange:e?.setDirty}),()=>({type:"input",label:"Rotation",stepSize:.001,bounds:[-Math.PI,Math.PI],property:[e[t],"rotation"],onChange:e?.setDirty}),()=>({type:"dropdown",label:"Color Space",property:[e[t],"colorSpace"],children:[["Linear",r.GUF],["sRGB",r.KI_]].map((e=>({label:e[0],value:e[1]}))),onChange:[()=>{const i=e[t];i&&(i.needsUpdate=!0)},e?.setDirty]}),()=>({type:"checkbox",label:"Flip Y",getValue:()=>e[t]?.flipY??!1,setValue:i=>{const r=e[t];if(r&&r.flipY!==i)if(r.image&&ImageBitmap&&r.image instanceof ImageBitmap){const t=r,a=r.source.data;createImageBitmap(a,{imageOrientation:"flipY"}).then((r=>{a.close&&a.close(),t.flipY=i,t.source.data=r,t.source.needsUpdate=!0,t.needsUpdate=!0,e?.setDirty?.()}))}else r.flipY=i,r.needsUpdate=!0,e?.setDirty?.()}}),()=>({type:"dropdown",label:"Wrap S",property:[e[t],"wrapS"],children:[["ClampToEdge",r.uWy],["MirroredRepeat",r.OoA],["Repeat",r.rpg]].map((e=>({label:e[0],value:e[1]}))),onChange:[()=>{e[t]&&(e[t].needsUpdate=!0)},e?.setDirty]}),()=>({type:"dropdown",label:"Wrap T",property:[e[t],"wrapT"],children:[["ClampToEdge",r.uWy],["MirroredRepeat",r.OoA],["Repeat",r.rpg]].map((e=>({label:e[0],value:e[1]}))),onChange:[()=>{e[t]&&(e[t].needsUpdate=!0)},e?.setDirty]}),()=>({type:"input",label:"Anisotropy",bounds:[1,6],stepSize:1,property:[e[t],"anisotropy"],onChange:[()=>{e[t]&&(e[t].needsUpdate=!0),e.needsUpdate=!0},e?.setDirty]}),()=>({type:"dropdown",label:"Min Filter",property:[e[t],"minFilter"],children:[["Linear",r.wem],["Nearest",r.TyD],["NearestMipmapNearest",r.YLQ],["NearestMipmapLinear",r.vZf],["LinearMipmapNearest",r.qyh],["LinearMipmapLinear",r.D1R]].map((e=>({label:e[0],value:e[1]}))),onChange:[()=>{e[t]&&(e[t].needsUpdate=!0)},e?.setDirty]}),()=>({type:"dropdown",label:"Mag Filter",property:[e[t],"magFilter"],children:[["Linear",r.wem],["Nearest",r.TyD]].map((e=>({label:e[0],value:e[1]}))),onChange:[()=>{e[t]&&(e[t].needsUpdate=!0)},e?.setDirty]})]}}const s=["appliedMeshes","imageLoadAwaiter","inverseModelMatrix","uvTransform","uuid","iMaterial"];function n(e,t,i=!0){if(!t)return e;for(const r of Object.keys(t)){if(i&&s.includes(r))continue;if(r.startsWith("__"))continue;const a=t[r];if("function"==typeof e[r]||"function"==typeof a)continue;const o=!a||a.isTexture||a.isObject3D||a.isMaterial;o||"function"!=typeof a.clone?o||"object"!=typeof a&&!Array.isArray(a)?e[r]=a:e[r]=n(Array.isArray(a)?[]:{},a,!1):e[r]=a.clone()}return e}const o=["appliedMaterials","uuid"];function l(e,t){if(t)for(const i of Object.keys(t))o.includes(i)||i.startsWith("__")||"function"!=typeof e[i]&&"function"!=typeof t[i]&&(e[i]=t[i]);return e}},2815:function(e,t,i){i.d(t,{y:function(){return h}});var r=i(2988),a=i(6533),s=i(8539),n=i(9008),o=i(5551),l=i(2860),c=i(9452),d=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class h extends r.jyz{get mmMaterial(){return this}get materialObject(){return this}onBeforeRender(e,t,i,a,s){super.onBeforeRender(e,t,i,a,s),void 0===this.envMapIntensity||this.userData.separateEnvMapIntensity||void 0===t.envMapIntensity||(this.userData.__envIntensity=this.envMapIntensity,this.envMapIntensity=t.envMapIntensity),void 0!==this.envMap&&void 0!==t.fixedEnvMapDirection&&(t.fixedEnvMapDirection?this.defines.FIX_ENV_DIRECTION||(this.defines.FIX_ENV_DIRECTION="1",this.needsUpdate=!0):void 0!==this.defines.FIX_ENV_DIRECTION&&(delete this.defines.FIX_ENV_DIRECTION,this.needsUpdate=!0)),this.uniforms.envMapRotation.value=(this.envMap?.rotation||0)+this.envMapRotationOffset,this.uniforms.envMapRotationQuat.value.setFromEuler(new r.USm(this.envMapRotationOffsetX,this.envMapRotationOffsetY,this.envMapRotationOffsetZ)),this.extraUniformsToUpload.inverseModelMatrix.value.copy(s.matrixWorld).invert();const n=a.userData.normalsCaptureOffsets;n&&(this.extraUniformsToUpload.centerOffset.value.fromArray(n.centerOffset),this.extraUniformsToUpload.modelOffsetMatrix.value.fromArray(n.offsetMatrix).premultiply(s.matrixWorld),this.extraUniformsToUpload.modelOffsetMatrixInv.value.copy(this.extraUniformsToUpload.modelOffsetMatrix.value).invert(),this.extraUniformsToUpload.radius.value=n.radius);const o=a.userData._normalsCaptureMap?.texture;this.normalsCaptureMap!==o&&(this.normalsCaptureMap=o),this.dispatchEvent({type:"beforeRender",renderer:e,scene:t,camera:i,geometry:a,object:s})}onAfterRender(e,t,i,r,a){super.onAfterRender(e,t,i,r,a),void 0!==this.userData.__envIntensity&&(this.envMapIntensity=this.userData.__envIntensity,delete this.userData.__envIntensity),this.dispatchEvent({type:"afterRender",renderer:e,scene:t,camera:i,geometry:r,object:a})}constructor(e){super({side:r.ehD,defines:{DIA_ORIENT_ENVMAP:0,RAY_BOUNCES:5,ENV_MAP_TYPE:0,PI:3.1428},vertexShader:"#ifndef USE_ENVMAP\n#define USE_ENVMAP  \n#endif\nvarying vec3 vWorldPosition;varying vec3 vWorldNormal;varying vec3 vViewPosition;varying vec3 vNormal;varying vec2 vUv;\n#ifdef USE_INSTANCING\nuniform mat4 inverseModelMatrix;uniform mat4 modelOffsetMatrix;varying mat4 vModelInstanceOffsetMatrix;varying mat4 vModelInstanceOffsetMatrixInv;\n#endif\n#include <morphtarget_pars_vertex>\n#ifdef USE_MORPHTARGETS\nvarying vec3 vCenterOffset;\n#ifndef USE_INSTANCING\nuniform mat4 modelOffsetMatrixInv;\n#endif\n#endif\nvoid main(){\n#ifdef USE_INSTANCING\nvWorldNormal=(modelMatrix*instanceMatrix*vec4(normal,0.)).xyz;\n#else\nvWorldNormal=(modelMatrix*vec4(normal,0.)).xyz;\n#endif\n#include <beginnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#ifdef USE_MORPHTARGETS\nvCenterOffset=transformed;\n#include <morphtarget_vertex>\nvCenterOffset=transformed-vCenterOffset;\n#ifndef USE_INSTANCING\nvCenterOffset=(modelOffsetMatrixInv*modelMatrix*vec4(vCenterOffset,1.)).xyz;\n#endif\n#endif\n#include <project_vertex>\nvViewPosition=-mvPosition.xyz;vUv=uv;\n#include <worldpos_vertex>\nvWorldPosition=worldPosition.xyz;\n#ifdef USE_INSTANCING\nvModelInstanceOffsetMatrix=modelMatrix*instanceMatrix*inverseModelMatrix*modelOffsetMatrix;vModelInstanceOffsetMatrixInv=inverse(vModelInstanceOffsetMatrix);\n#ifdef USE_MORPHTARGETS\nvCenterOffset=(vModelInstanceOffsetMatrixInv*modelMatrix*vec4(vCenterOffset,1.)).xyz;\n#endif\n#endif\n}",fragmentShader:"varying vec3 vWorldNormal;varying vec3 vWorldPosition;varying vec3 vViewPosition;varying vec3 vNormal;varying vec2 vUv;uniform float radius;uniform vec3 centerOffset;\n#ifdef USE_INSTANCING\nvarying mat4 vModelInstanceOffsetMatrix;varying mat4 vModelInstanceOffsetMatrixInv;\n#define MODEL_OFFSET_MATRIX  vModelInstanceOffsetMatrix\n#define INV_MODEL_OFFSET_MATRIX  vModelInstanceOffsetMatrixInv\n#else\nuniform mat4 modelOffsetMatrixInv;uniform mat4 modelOffsetMatrix;\n#define MODEL_OFFSET_MATRIX  modelOffsetMatrix\n#define INV_MODEL_OFFSET_MATRIX  modelOffsetMatrixInv\n#endif\n#ifdef USE_MORPHTARGETS\nvarying vec3 vCenterOffset;\n#define CENTER_OFFSET  (centerOffset + vCenterOffset)\n#else\n#define CENTER_OFFSET  (centerOffset) \n#endif\nuniform mat4 projectionMatrix;uniform samplerCube tCubeMapNormals;\n#if ENV_MAP_TYPE == 0\nuniform samplerCube envMap;\n#elif ENV_MAP_TYPE == 1\nuniform sampler2D envMap;\n#endif\nuniform float envMapIntensity;uniform float transmission;uniform vec2 transmissionSamplerSize;uniform sampler2D transmissionSamplerMap;uniform float refractiveIndex;uniform float rIndexDelta;uniform float squashFactor;uniform float geometryFactor;uniform vec3 color;uniform vec3 colorCorrection;uniform vec3 boostFactors;uniform float gammaFactor;uniform float absorptionFactor;uniform float envMapRotation;uniform vec4 envMapRotationQuat;uniform float reflectivity;vec3 BRDF_Specular_GGX_Environment(const in vec3 viewDir,const in vec3 normal,const in vec3 specularColor,const in float roughness){float dotNV=abs(dot(normal,viewDir));const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec2 cartesianToPolar(vec3 n){vec2 uv;uv.x=atan(n.z,n.x)/(PI*2.)+0.5;uv.y=asin(n.y)/PI+0.5;return uv;}vec4 sampleEnvMap(vec3 direction){\n#if !defined(USE_ENVMAP)\nreturn vec4(direction,1);\n#else\nfloat cs=cos(envMapRotation);float sn=sin(envMapRotation);float temp=cs*direction.x+sn*direction.z;direction.z=-sn*direction.x+cs*direction.z;direction.x=temp;direction.x*=-1.;direction.y*=-1.;direction.z*=-1.;vec3 t=2.*cross(envMapRotationQuat.xyz,direction);direction+=envMapRotationQuat.w*t+cross(envMapRotationQuat.xyz,t);\n#if ENV_MAP_TYPE == 0\nreturn(textureCube(envMap,direction));\n#elif ENV_MAP_TYPE == 1\nreturn(texture2D(envMap,cartesianToPolar(direction)));\n#endif\nreturn vec4(1,0,1,1);\n#endif\n}vec4 SampleSpecularReflection(vec3 direction){\n#if defined(FIX_ENV_DIRECTION)\ndirection=(viewMatrix*vec4(direction,0.)).xyz;\n#endif\nreturn envMapIntensity*(sampleEnvMap(direction));}vec4 SampleSpecularContribution(vec3 direction){\n#if DIA_ORIENT_ENVMAP < 1\ndirection=mat3(MODEL_OFFSET_MATRIX)*direction;\n#endif\n#if defined(FIX_ENV_DIRECTION)\ndirection=(viewMatrix*vec4(direction,0.)).xyz;\n#endif\ndirection=normalize(direction);direction.x*=-1.;direction.z*=-1.;return envMapIntensity*(sampleEnvMap(direction));}vec4 SampleSpecularContributionRef(vec3 origin,int i){vec4 ndcPos=projectionMatrix*viewMatrix*vec4(origin,1.);vec2 refractionCoords=ndcPos.xy/ndcPos.w;refractionCoords+=1.;refractionCoords/=2.;return transmissionSamplerMapTexelToLinear(texture2D(transmissionSamplerMap,refractionCoords));}vec3 intersectSphere(vec3 origin,vec3 direction){origin-=CENTER_OFFSET;direction.y/=squashFactor;float A=dot(direction,direction);float B=2.*dot(origin,direction);float C=dot(origin,origin)-radius*radius;float disc=B*B-4.*A*C;if(disc>0.){disc=sqrt(disc);float t1=(-B+disc)*geometryFactor/A;float t2=(-B-disc)*geometryFactor/A;float t=(t1>t2)?t1:t2;direction.y*=squashFactor;return vec3(origin+CENTER_OFFSET+direction*t);}return vec3(0.);}vec3 linePlaneIntersect(in vec3 pointOnLine,in vec3 lineDirection,in vec3 pointOnPlane,in vec3 planeNormal){return lineDirection*(dot(planeNormal,pointOnPlane-pointOnLine)/dot(planeNormal,lineDirection))+pointOnLine;}vec4 getNormalDistance(vec3 d){return textureCube(tCubeMapNormals,d);}vec3 getSurfaceNormal(vec4 surfaceInfos){vec3 surfaceNormal=surfaceInfos.rgb;surfaceNormal=surfaceNormal*2.-1.;return-normalize(surfaceNormal);}vec3 intersect(vec3 rayOrigin,vec3 rayDirection){vec3 sphereHitPoint=intersectSphere(rayOrigin,rayDirection);vec3 direction1=normalize(sphereHitPoint-CENTER_OFFSET);vec4 normalDistanceData1=getNormalDistance(direction1);float distance1=normalDistanceData1.a*radius;vec3 pointOnPlane1=CENTER_OFFSET+direction1*distance1;vec3 planeNormal1=getSurfaceNormal(normalDistanceData1);vec3 hitPoint1=linePlaneIntersect(rayOrigin,rayDirection,pointOnPlane1,planeNormal1);vec3 direction2=normalize(hitPoint1-CENTER_OFFSET);vec4 normalDistanceData2=getNormalDistance(direction2);float distance2=normalDistanceData2.a*radius;vec3 pointOnPlane2=CENTER_OFFSET+direction2*distance2;vec3 hitPoint=hitPoint1;vec3 planeNormal2=getSurfaceNormal(normalDistanceData2);hitPoint=linePlaneIntersect(rayOrigin,rayDirection,pointOnPlane2,planeNormal2);return hitPoint;}vec3 debugBounces(int count){vec3 color=vec3(1.,1.,1.);if(count==1)color=vec3(0.,1.,0.);else if(count==2)color=vec3(0.,0.,1.);else if(count==3)color=vec3(1.,1.,0.);else if(count==4)color=vec3(0.,1.,1.);else color=vec3(0.,1.,0.);if(count==0)color=vec3(1.,0.,0.);return color;}vec3 getRefractionColor(vec3 origin,vec3 direction,vec3 normal){vec3 outColor=vec3(0.);const float n1=1.;const float epsilon=1e-4;float f0=(2.4-n1)/(2.4+n1);f0*=f0;vec3 attenuationFactor=vec3(1.);vec3 newDirection=refract(direction,normal,n1/refractiveIndex);vec3 brdfRefracted=BRDF_Specular_GGX_Environment(newDirection,-normal,vec3(f0),0.);attenuationFactor*=(vec3(1.)-brdfRefracted);int count=0;mat4 invModelOffsetMatrix=INV_MODEL_OFFSET_MATRIX;newDirection=normalize((invModelOffsetMatrix*vec4(newDirection,0.)).xyz);origin=(invModelOffsetMatrix*vec4(origin,1.)).xyz;for(int i=0;i<RAY_BOUNCES;i++){vec3 intersectedPos=intersect(origin,newDirection);vec3 dist=intersectedPos-origin;vec3 d=normalize(intersectedPos-CENTER_OFFSET);vec3 mappedNormal=getNormalDistance(d).rgb;mappedNormal=2.*mappedNormal-1.;mappedNormal=-normalize(mappedNormal);float r=length(dist)/radius*absorptionFactor;attenuationFactor*=exp(-r*(1.-color));origin=intersectedPos;vec3 origin2=(MODEL_OFFSET_MATRIX*vec4(intersectedPos,1)).xyz;vec3 oldDir=newDirection;newDirection=refract(newDirection,mappedNormal,refractiveIndex/n1);if(dot(newDirection,newDirection)<epsilon){newDirection=reflect(oldDir,mappedNormal);if(i==RAY_BOUNCES-1){vec3 brdfReflected=BRDF_Specular_GGX_Environment(-oldDir,mappedNormal,vec3(f0),0.);vec3 d1=mat3(MODEL_OFFSET_MATRIX)*oldDir;d1=normalize(d1);float cosT=1.-dot(direction,d1);outColor+=((transmission>0.&&cosT<transmission)?SampleSpecularContributionRef(origin2+0.5*d1*cosT,i).rgb:SampleSpecularContribution(oldDir).rgb)*attenuationFactor*colorCorrection*boostFactors*(vec3(1.)-brdfReflected);}}else{vec3 brdfRefracted=vec3(1.)-BRDF_Specular_GGX_Environment(newDirection,-mappedNormal,vec3(f0),0.);vec3 d1=normalize(mat3(MODEL_OFFSET_MATRIX)*newDirection);float cosT=1.-dot(direction,d1);if(transmission>0.&&cosT<transmission){outColor+=SampleSpecularContributionRef(origin2+0.5*d1*cosT,i).rgb*brdfRefracted*attenuationFactor*colorCorrection*boostFactors;}else{vec3 dir0=newDirection;vec3 dir1=refract(oldDir,mappedNormal,(refractiveIndex+rIndexDelta)/n1);vec3 dir2=refract(oldDir,mappedNormal,(refractiveIndex-rIndexDelta)/n1);outColor+=vec3(SampleSpecularContribution(dir1).r,SampleSpecularContribution(dir0).g,SampleSpecularContribution(dir2).b)*brdfRefracted*attenuationFactor*colorCorrection*boostFactors;}newDirection=reflect(oldDir,mappedNormal);vec3 brdfReflected=BRDF_Specular_GGX_Environment(newDirection,mappedNormal,vec3(f0),0.);attenuationFactor*=brdfReflected*boostFactors;count++;}}return outColor;}void main(){vec3 normalizedNormal=normalize(vWorldNormal);vec3 viewVector=normalize(vWorldPosition-cameraPosition);const float n1=1.;const float epsilon=1e-4;float f0=(2.4-n1)/(2.4+n1);f0*=f0;vec3 attenuationFactor=vec3(1.);vec3 reflectedDirection=reflect(viewVector,normalizedNormal);vec3 brdfReflected=BRDF_Specular_GGX_Environment(reflectedDirection,normalizedNormal,vec3(f0),0.);vec3 reflectionColor=SampleSpecularReflection(reflectedDirection).rgb*brdfReflected*reflectivity*2.;vec3 refractionColor=getRefractionColor(vWorldPosition,viewVector,normalizedNormal);vec3 normal=normalize(vNormal);vec3 diffuseColor=vec3(1.);\n#glMarker beforeAccumulation\ngl_FragColor=vec4((refractionColor.rgb+reflectionColor.rgb)*diffuseColor,1.);gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(gammaFactor));\n#include <encodings_fragment>\n}",uniforms:{envMap:{value:e.envMap||null},envMapRotation:{value:0},envMapRotationQuat:{value:new r._fP},transmission:{value:0},transmissionSamplerMap:{value:null},transmissionSamplerSize:{value:new r.FM8},normalOffset:{value:0},distanceOffset:{value:0},colorCorrection:{value:new r.Pa4(1,1,1)}}}),this.typeSlug=h.TypeSlug,this.assetType="material",this.__envMap=[],this.isDiamondMaterial=!0,this.color=new r.Ilk(1,1,1),this.envMapIntensity=1,this.envMapRotationOffset=0,this.envMapRotationOffsetX=0,this.envMapRotationOffsetY=0,this.envMapRotationOffsetZ=0,this.dispersion=.012,this.absorptionFactor=1,this.refractiveIndex=2.4,this.squashFactor=.98,this.geometryFactor=.5,this.gammaFactor=1,this.boostFactors=new r.Pa4(.892,.892,.98595025),this.transmission=0,this.reflectivity=.5,this.rayBounces=5,this.diamondOrientedEnvMap=0,this.normalsCaptureMap=null,this.extraUniformsToUpload={inverseModelMatrix:{value:(new r.yGw).identity()},radius:{value:1},centerOffset:{value:new r.Pa4(0,0,0)},modelOffsetMatrix:{value:(new r.yGw).identity()},modelOffsetMatrixInv:{value:(new r.yGw).identity()}},this.envMapIndex=0,this.setDirty=this.setDirty.bind(this),this.userData.setDirty=e=>{console.warn("userData.setDirty is deprecated. Use setDirty instead."),this.setDirty(e)},this.userData.separateEnvMapIntensity=!0,this.setValues(e),this.materialExtensions=c.K.RegisterExtensions(this,e?.customMaterialExtensions??[])}registerMaterialExtensions(e){this.materialExtensions=[...this.materialExtensions,...c.K.RegisterExtensions(this,e)]}unregisterMaterialExtensions(e){}onBeforeCompile(e,t){c.K.ApplyMaterialExtensions(this,e,this.materialExtensions,t),this.dispatchEvent({type:"beforeCompile",shader:e,renderer:t}),e.fragmentShader=e.fragmentShader.replaceAll("#glMarker","// "),e.vertexShader=e.vertexShader.replaceAll("#glMarker","// "),super.onBeforeCompile(e,t)}customProgramCacheKey(){return super.customProgramCacheKey()+c.K.CacheKeyForExtensions(this,this.materialExtensions)}setDirty(e){this.needsUpdate=!0,this.dispatchEvent({...e,type:"materialUpdate",frameFade:e?.last}),this._uiConfig?.uiRefresh?.("postFrame",!0,1)}set envMaps(e){this.__envMap=e,this.refreshEnvUniform()}refreshEnvUniform(){this.uniforms.envMap.value=this.envMap,this.defines.ENV_MAP_TYPE=this.uniforms.envMap.value?.isCubeTexture?0:1,this.needsUpdate=!0}get envMap(){return this.__envMap[this.envMapIndex]??this.__envMap[0]??null}set envMap(e){console.error("Setting separate envmap for indivisual diamond material not supported yet.")}clone(){return super.clone()}toJSON(e){const t={metadata:{version:4.6,type:"DiamondMaterial",generator:"DiamondMaterial.toJSON"}};return t.name=this.name,t.uuid=this.uuid,t.color=this.color.getHex(),t.envMapIntensity=this.envMapIntensity,t.envMapIndex=this.envMapIndex,t.envMapRotationOffset=this.envMapRotationOffset,t.dispersion=this.dispersion,t.squashFactor=this.squashFactor,t.geometryFactor=this.geometryFactor,t.gammaFactor=this.gammaFactor,t.absorptionFactor=this.absorptionFactor,t.reflectivity=this.reflectivity,t.refractiveIndex=this.refractiveIndex,t.rayBounces=this.rayBounces,t.diamondOrientedEnvMap=this.diamondOrientedEnvMap,t.boostFactors={x:this.boostFactors.x,y:this.boostFactors.y,z:this.boostFactors.z,isVector3:!0},t.transmission=this.transmission,t.isDiamondMaterialParameters=!0,t.type=h.TYPE,t.userData={},(0,l.aw)(t.userData,this.userData),t.userData.uuid=this.userData.uuid,t}get uiConfig(){const e=this;return this._uiConfigChildren||(this._uiConfigChildren=[{type:"input",property:[this,"name"]},{type:"checkbox",property:[this,"wireframe"]},{type:"dropdown",label:"Environment",property:[this,"envMapIndex"],children:[0,1,2].map((e=>({label:"env"+(e+1),value:e})))},...(0,o._t)(this),{type:"input",label:"Mesh count",get value(){return e.userData?.__appliedMeshes?.size??0},set value(e){},disabled:!0},{type:"input",label:"uuid",get value(){return e.uuid},set value(e){},disabled:!0},{type:"checkbox",label:"Render to Depth",hidden:()=>0===this.transmission,get value(){return!0===e.userData.renderToDepth},set value(t){e.userData.renderToDepth=t||void 0}},{type:"button",label:"Download .dmat",value:()=>{const t=new Blob([JSON.stringify(e.toJSON(),null,2)],{type:"application/json"});(0,n.downloadBlob)(t,"diamond-material.dmat")}}]),this._uiConfig||(this._uiConfig={type:"folder",label:"Diamond Material",expanded:!0,children:this._uiConfigChildren,limitedUi:!0}),this._uiConfig.children=[...this._uiConfigChildren,...this.materialExtensions.map((e=>e.getUiConfig?.(this)))].filter((e=>e)),this._uiConfig}copyProps(e){if(!e.isDiamondMaterialParameters&&!e.isDiamondMaterial&&!e.isDiamond&&e.type!==h.TYPE)return console.warn("Material type is not supported",e),this;const t={},i=Array.from(Object.keys(s.vZ));(0,n.copyProps)(e,t,i);const r=t.userData;return delete t.userData,this.setValues(t),(0,l.aw)(this.userData,r),this.setDirty(),this}fromJSON(e,t){return this.copyProps(e)}}h.TypeSlug="dmat",h.TYPE="DiamondMaterial",d([(0,o.s4)("Color",{limitedUi:!0}),(0,a.e5)()],h.prototype,"color",void 0),d([(0,o.t8)("Env Intensity",[0,5],.01,{limitedUi:!0}),(0,a.e5)()],h.prototype,"envMapIntensity",void 0),d([(0,o.t8)("Env Rotation Offset",[-Math.PI,Math.PI],.01),(0,n.onChange2)(h.prototype.setDirty)],h.prototype,"envMapRotationOffset",void 0),d([(0,o.t8)("Env Rotation Offset X",[-Math.PI,Math.PI],.01),(0,n.onChange2)(h.prototype.setDirty)],h.prototype,"envMapRotationOffsetX",void 0),d([(0,o.t8)("Env Rotation Offset Y",[-Math.PI,Math.PI],.01),(0,n.onChange2)(h.prototype.setDirty)],h.prototype,"envMapRotationOffsetY",void 0),d([(0,o.t8)("Env Rotation Offset Z",[-Math.PI,Math.PI],.01),(0,n.onChange2)(h.prototype.setDirty)],h.prototype,"envMapRotationOffsetZ",void 0),d([(0,o.t8)("Dispersion",[0,.1],1e-4,{limitedUi:!0}),(0,a.e5)({propKey:"rIndexDelta"})],h.prototype,"dispersion",void 0),d([(0,o.t8)("Absorption",[0,15],.01,{limitedUi:!0}),(0,a.e5)()],h.prototype,"absorptionFactor",void 0),d([(0,o.t8)("Refractive Index",[0,4],.01,{limitedUi:!0}),(0,a.e5)()],h.prototype,"refractiveIndex",void 0),d([(0,a.e5)()],h.prototype,"squashFactor",void 0),d([(0,a.e5)()],h.prototype,"geometryFactor",void 0),d([(0,o.t8)("Gamma",[.1,4],.01,{limitedUi:!0}),(0,a.e5)()],h.prototype,"gammaFactor",void 0),d([(0,o.KG)("RGB Boost",void 0,void 0,{limitedUi:!0}),(0,a.e5)()],h.prototype,"boostFactors",void 0),d([(0,o.t8)("Transmission",[0,1],.01,{limitedUi:!0}),(0,a.e5)()],h.prototype,"transmission",void 0),d([(0,o.t8)("Reflectivity",[0,2],.01,{limitedUi:!0}),(0,a.e5)()],h.prototype,"reflectivity",void 0),d([(0,a.lD)("RAY_BOUNCES",void 0,!0),(0,o.t8)("Ray Bounces",[1,16],1)],h.prototype,"rayBounces",void 0),d([(0,a.lD)("DIA_ORIENT_ENVMAP",void 0,!0),(0,o.t8)("Diamond Oriented Lighting",[0,1],1)],h.prototype,"diamondOrientedEnvMap",void 0),d([(0,a.e5)({propKey:"tCubeMapNormals"})],h.prototype,"normalsCaptureMap",void 0),d([(0,n.onChange)(h.prototype.refreshEnvUniform)],h.prototype,"envMapIndex",void 0)},418:function(e,t,i){i.d(t,{h:function(){return _}});var r=i(2988),a=i(3995);class s{constructor(e){this._normalsCache={},this._renderer=e,this._scene=new r.xsS,this._mesh=new r.Kj0,this._mesh.frustumCulled=!1,this._scene.add(this._mesh),this._mesh.position.set(0,0,0),this._mesh.material=new n}dispose(){this._mesh.geometry?.dispose(),this._mesh.material.dispose(),this.disposeAllTargets()}disposeTarget(e){e.split(";").forEach((e=>this._normalsCache[e]?.dispose()))}disposeAllTargets(){Object.values(this._normalsCache).forEach((e=>e.dispose()))}hasCapturedNormalMap(e){return!!e.userData._normalsCaptureMap}_getPrecisionType(e){return"low"===e?r.ywz:"medium"===e?r.cLu:"high"===e?r.VzW:r.cLu}captureNormalMap(e,t,i=512,a="medium",n){if(!e)throw"No geometry";if(this.hasCapturedNormalMap(e))return!1;const o=t?.split(";").find((e=>this._normalsCache[e]));if(o){const r=this._normalsCache[o];return t?.split(";").forEach((e=>e!==o&&(this._normalsCache[e]=r))),r.width!==i&&console.warn("last cacheKey normalMapRes mismatch, check model",i),e.userData._normalsCaptureMap=r,!1}const l=this._renderer.createTargetCustom({width:i,height:i},{minFilter:r.TyD,magFilter:r.TyD,generateMipmaps:!1,type:this._getPrecisionType(a)},r.oAp);if(l.attachedGeometries=[],l.autoDispose=s.AutoDisposeTargets,!l)throw"Unable to create render target";const c=()=>{const t=new r._am(1e-4,100,l);this._scene.add(t);const i=e.userData.normalsCaptureOffsets;void 0!==i.center&&this._mesh.material.uniforms.offsetCenter.value.fromArray(i.center),void 0!==i.offsetMatrixInv&&this._mesh.material.uniforms.offsetMatrixInv.value.fromArray(i.offsetMatrixInv),void 0!==i.radius&&(this._mesh.material.uniforms.radius.value=i.radius),this._mesh.geometry=e,n?.morphTargetInfluences&&e.morphAttributes?.position&&(this._mesh.morphTargetInfluences=n.morphTargetInfluences,this._mesh.morphTargetDictionary=n.morphTargetDictionary),t.update(this._renderer.rendererObject,this._scene),this._mesh.morphTargetInfluences=void 0,this._mesh.morphTargetDictionary=void 0,this._scene.remove(t),this._mesh.geometry=void 0,e.userData._normalsCaptureMap=l};return c(),this._renderer.addEventListener("contextRestored",c),l.attachedGeometries.push(e),e.addEventListener("dispose",(()=>{l.attachedGeometries=l.attachedGeometries?.filter((t=>t!==e))??[],delete e.userData._normalsCaptureMap,this._renderer.removeEventListener("contextRestored",c),l.autoDispose&&!l.attachedGeometries.length&&l.dispose()})),t?.split(";").forEach((e=>this._normalsCache[e]=l)),l.addEventListener("dispose",(()=>{t?.split(";").forEach((e=>delete this._normalsCache[e])),this._renderer.removeEventListener("contextRestored",c),delete e.userData._normalsCaptureMap})),!0}}s.AutoDisposeTargets=!0;class n extends r.jyz{constructor(){super({vertexShader:"varying vec3 vNormal;varying vec3 vecPosition;uniform mat4 offsetMatrixInv;uniform vec3 offsetCenter;\n#include <morphtarget_pars_vertex>\nvoid main(){vNormal=normalize((offsetMatrixInv*vec4(normal,0.)).xyz);\n#include <begin_vertex>\ntransformed-=offsetCenter;\n#include <morphtarget_vertex>\nvec4 offsetPos=offsetMatrixInv*vec4(transformed,1.);vecPosition=(modelMatrix*offsetPos).xyz;gl_Position=projectionMatrix*modelViewMatrix*offsetPos;}",fragmentShader:"varying vec3 vNormal;varying vec3 vecPosition;uniform float radius;void main(){vec3 color=normalize(vNormal);color=color*0.5+0.5;gl_FragColor=vec4(color.x,color.y,color.z,length(vecPosition)/radius);}",side:r.ehD,clipping:!1,uniforms:{radius:{value:1},offsetMatrixInv:{value:(new r.yGw).identity()},offsetCenter:{value:new r.Pa4}}})}}var o=i(2815),l=i(4821),c=i(8539),d=i(9008),h=i(2095),p=i(2354),u=i(4001),m=i(4107),f=i(4379),g=i(6453),v=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class _ extends a.Q{get envMapRotation(){return this.envMap?.rotation??0}set envMapRotation(e){const t=[this.envMap,this.envMap2,this.envMap3];for(const i of t)i&&(i.rotation=e,this._viewer?.scene.setDirty())}refreshEnvMaps(){if(!this._viewer)return;const e=this.getEnvMaps(),t=this._viewer.getPlugin(l.k)?.materials?.getMaterialsOfType(o.y.TypeSlug)||[];for(const i of t)i&&(i.envMaps=e);this._viewer?.scene.setDirty()}constructor(){super(),this.offsetCache={},this.enabled=!0,this.envMap=null,this.envMap2=null,this.envMap3=null,this.forceSceneEnvMap=!1,this.getEnvMaps=()=>{if(!this.forceSceneEnvMap&&this.envMap)return[this.envMap,this.envMap2,this.envMap3];const e=this._viewer?.scene.getEnvironment()||null;return[e,e,e]},this._modelProcessor={forAssetType:"model",processAsync:async(e,t)=>{const i=[];return e.modelObject.traverse((e=>{const t=e.userData?.gltfExtensions?.[_.DIAMOND_GLTF_EXTENSION];if(t&&e.geometry&&(this.prepareDiamondMesh(e,t),delete e.userData.gltfExtensions[_.DIAMOND_GLTF_EXTENSION]),e.material&&!i.includes(e.material)){const t=e.material.userData?.gltfExtensions?.[_.DIAMOND_GLTF_EXTENSION];t&&(e.material.materialObject||console.warn("material not processed",e.material),i.push(e.material))}})),i.forEach((e=>{const t=e.userData.gltfExtensions[_.DIAMOND_GLTF_EXTENSION];t&&this._convertToDiamondMaterial(e,t)})),e}},this.uiConfig={type:"folder",label:"Diamonds",children:[{type:"checkbox",label:"Use Scene Environment",property:[this,"forceSceneEnvironment"],limitedUi:!0},{type:"image",label:"Environment",hidden:()=>this.forceSceneEnvMap,property:[this,"envMap"],limitedUi:!0},{type:"slider",bounds:[0,2*Math.PI],hidden:()=>this.forceSceneEnvMap,label:"Env Rotation",property:[this,"envMapRotation"],limitedUi:!0},{type:"image",label:"Environment 2",hidden:()=>this.forceSceneEnvMap,property:[this,"envMap2"]},{type:"image",label:"Environment 3",hidden:()=>this.forceSceneEnvMap,property:[this,"envMap3"]},{type:"button",label:"Make Diamond",hidden:()=>{const e=this._viewer?.getPlugin(h.l)?.getSelectedObject()?.material;return!!Array.isArray(e)||e?.typeSlug!==f.iu.TypeSlug},value:async()=>{const e=this._viewer?.getPlugin(h.l)?.getSelectedObject();if(!e?.material)return;const t=await(this._viewer?.prompt("Cache key: Enter optional cache key unique to the diamond shape.","",!1)),i=(await(this._viewer?.prompt("Cache size: Enter size of the cache [64-1024]","512",!1))||"512").toLowerCase(),r=i.endsWith("high")?"high":i.endsWith("low")?"low":"medium";let a=parseInt(i);isFinite(a)||(a=512),a<64&&(a=64),e.material.userData?.__appliedMeshes.size>1&&await(this._viewer?.confirm("Convert all: Apply diamond material to all the meshes with the same material?"))?this.makeDiamond(e.material,{cacheKey:t||void 0,normalMapRes:a,normalMapPrecision:r},{}):this.makeDiamondMesh(e,{cacheKey:t||void 0,normalMapRes:a,normalMapPrecision:r},{}),this.refreshUi()},limitedUi:!0},{type:"button",label:"Make Standard",hidden:()=>{const e=this._viewer?.getPlugin(h.l)?.getSelectedObject()?.material;return!!Array.isArray(e)||e?.typeSlug!==o.y.TypeSlug},value:async()=>{const e=this._viewer?.getPlugin(h.l)?.getSelectedObject(),t=e?.material;if(!t)return;const i=t.userData._baseMaterial;let r=this._viewer?.getManager()?.materials?.findMaterial(i);if(r&&!r.isDiamondMaterial||(r=this._viewer?.createPhysicalMaterial({color:t.color})),r){const i=t.userData.__appliedMeshes.size>1&&await(this._viewer?.confirm("Convert all with this material?"))?Array.from(t.userData.__appliedMeshes):[e];for(const e of i)e?.setMaterial?.(r)}this.refreshUi()},limitedUi:!0},{type:"button",label:"Auto Instance Diamonds (dev)",hidden:()=>{const e=this._viewer?.getPlugin(h.l)?.getSelectedObject()?.material;return!!Array.isArray(e)||e?.typeSlug!==o.y.TypeSlug||e.userData.__appliedMeshes?.size<2},value:async()=>{const e=this._viewer?.getPlugin(h.l)?.getSelectedObject();if(!e)return;const t=e.material;t&&!Array.isArray(t)&&(0,g.Y)(t)}},{type:"button",label:"Clear Cache",value:()=>{this.disposeAllCacheMaps()}}]},this.refreshEnvMaps=this.refreshEnvMaps.bind(this),this.refreshUi=this.refreshUi.bind(this)}refreshUi(){this._viewer?.setDirty(),this.uiConfig?.uiRefresh?.("postFrame",!0)}async onAdded(e){this._normalCapture=new s(e.renderer),this.offsetCache={},e.scene.addEventListener("materialChanged",(e=>{if(e.material?.isDiamondMaterial){const t=e.material,i=e.mesh||e.object;if(i.geometry&&!this._normalCapture?.hasCapturedNormalMap(i)){const e=t?.userData?.gltfExtensions?.[_.DIAMOND_GLTF_EXTENSION]??{};void 0===e.cacheKey&&!i.userData._diamondCacheKey&&t?.name&&(e.cacheKey=t.name),this.prepareDiamondMesh(i,e)}const r=this.getEnvMaps();t.envMaps=r}})),e.scene.addEventListener("environmentChanged",this.refreshEnvMaps);const t=e.getPlugin(l.k);t?.importer?.processors.add("model",this._modelProcessor),e.getPlugin(h.l)?.addEventListener("selectedObjectChanged",this.refreshUi);const i=this.getEnvMaps,a=new p.q(class extends u.v{async loadAsync(e,r){const a=await super.loadAsync(e,r);return a.type===o.y.TYPE||a.isDiamondMaterialParameters?(a.envMap=i(),t?.materials?.generateFromTemplate("diamond",a)):(console.error("Invalid material type for Diamond Material.",a),null)}},[o.y.TypeSlug],!1);return t?.importer?.Importers.push(a),t?.exporter?.getExporter("gltf","glb")?.extensions?.push(y),t?.materials?.registerMaterialTemplate({name:"diamond",materialType:o.y.TYPE,isDiamondMaterialParameters:!0,generator:(e,t)=>{const i=!(t?.metadata||!t.isDiamondMaterialParameters)||t?.metadata&&t?.metadata.version<=4.5,a=t?.color;i&&"number"==typeof t.color&&(t.color=(new r.Ilk).setHex(t.color,r.GUF).getHex());const s=new o.y(e);return s.envMaps=this.getEnvMaps(),t&&s.copyProps(t),t.color=a,s}}),super.onAdded(e)}async onRemove(e){return this._normalCapture?.dispose(),this._normalCapture=void 0,this.offsetCache={},e.getPlugin(l.k)?.importer?.processors.remove("model",this._modelProcessor),e.getPlugin(h.l)?.removeEventListener("selectedObjectChanged",this.refreshUi),super.onRemove(e)}prepareDiamondMesh(e,{cacheKey:t,normalMapRes:i,normalMapPrecision:r}){e.userData._diamondCacheKey=t??e.userData._diamondCacheKey,e.userData._diamondNormalMapRes=i??e.userData._diamondNormalMapRes,e.userData._diamondNormalMapPrecision=r??e.userData._diamondNormalMapPrecision,t=t&&t.length>0?t.includes(";"+e.geometry.uuid)?t:t+";"+e.geometry.uuid:e.geometry.uuid,this._computeOffsets(e.geometry,e.geometry.uuid);const a=this._normalCapture?.captureNormalMap(e.geometry,t,i,r,e)??[void 0,!1],s=this._viewer?.getPluginByType("debug");s&&a&&(s.counters.normalsCapture||(s.counters.normalsCapture=0),s.counters.normalsCapture++,console.log("DEBUG: new normal map captured",s.counters.normalsCapture,t),s.addTexture("normal"+s.counters.normalsCapture,(()=>e.geometry?.userData._normalsCaptureMap?.texture),[40,110*s.counters.normalsCapture-100,200,100],void 0,void 0,"postRender",!0))}makeDiamond(e,t,i){Array.from(e?.userData.__appliedMeshes??[]).forEach((e=>{e?.isMesh&&e.geometry&&this.prepareDiamondMesh(e,t)})),this._convertToDiamondMaterial(e,i),this._viewer?.setDirty()}makeDiamondMesh(e,t,i){if(!e.modelObject.isMesh||!e.geometry||!e.setMaterial)return;this.prepareDiamondMesh(e.modelObject,t);const r=Array.isArray(e.material)?e.material[0]:e.material,a=this._convertToDiamondMaterial(r,i,!1);e.setMaterial(a)}_convertToDiamondMaterial(e,t={isDiamond:!0},i=!0){let a={...t??{}};a.isDiamond||a.isDiamondMaterialParameters?Array.isArray(a.boostFactors)&&(a.boostFactors=(new r.Pa4).fromArray(a.boostFactors)):a={isDiamondMaterialParameters:!0},a.color=a.color??e?.color??new r.Ilk(1,1,1),a.name=a.name??e?.name??"diamond";const s=this._viewer?.getManager()?.materials?.generateFromTemplate("diamond",a);if(s&&e&&!e.isDiamondMaterial&&(s.userData._baseMaterial=e.uuid),i){const i=e=>e.setMaterial??(t=>{e.material=t.materialObject});Array.from(e?.userData.__appliedMeshes??[]).forEach((e=>{i(e)(s),this.prepareDiamondMesh(e,t)}))}return s}_computeOffsets(e,t,i=!1){if(e.userData.normalsCaptureOffsets){if(null===(0,d.getUrlQueryParam)("recomputeOffsets"))return e.userData.normalsCaptureOffsets;console.warn("recomputeOffsets",e.userData.normalsCaptureOffsets)}let a;e.morphAttributes?.position&&(a=e.morphAttributes,e.morphAttributes={}),e.computeBoundingBox();const s=e.boundingBox.getCenter(new r.Pa4).toArray(),n=(0,c.CN)(e).toArray(),o=(new r.yGw).fromArray(n).invert(),l=(new r.Pa4).fromArray(s).applyMatrix4(o).toArray(),h={center:s,offsetMatrix:n,offsetMatrixInv:o.toArray(),radius:1,centerOffset:l};return e.userData.normalsCaptureOffsets=h,a&&(e.morphAttributes=a,e.computeBoundingBox()),null!==(0,d.getUrlQueryParam)("recomputeOffsets")&&console.warn("recomputeOffsets",h),h}disposeCacheMap(e){this._normalCapture?.disposeTarget(e)}disposeAllCacheMaps(){this._normalCapture?.disposeAllTargets()}}_.PluginType="Diamond",_.DIAMOND_GLTF_EXTENSION="WEBGI_materials_diamond",v([(0,d.onChange)(_.prototype.refreshEnvMaps),(0,m.qC)()],_.prototype,"envMap",void 0),v([(0,d.onChange)(_.prototype.refreshEnvMaps),(0,m.qC)()],_.prototype,"envMap2",void 0),v([(0,d.onChange)(_.prototype.refreshEnvMaps),(0,m.qC)()],_.prototype,"envMap3",void 0),v([(0,d.onChange)(_.prototype.refreshEnvMaps),(0,m.qC)()],_.prototype,"forceSceneEnvMap",void 0);const y=e=>({writeMaterial:(t,i)=>{t.isDiamondMaterial&&(i.extensions=i.extensions||{},i.extensions[_.DIAMOND_GLTF_EXTENSION]=t.toJSON(),e.extensionsUsed[_.DIAMOND_GLTF_EXTENSION]=!0)},writeMesh:(t,i)=>{if(!t?.material.isDiamondMaterial)return;i.extensions=i.extensions||{};const r={};delete t.userData?.gltfExtensions?.[_.DIAMOND_GLTF_EXTENSION],t.userData._diamondNormalMapRes&&(r.normalMapRes=t.userData._diamondNormalMapRes),t.userData._diamondNormalMapPrecision&&(r.normalMapPrecision=t.userData._diamondNormalMapPrecision),t.userData._diamondCacheKey&&(r.cacheKey=t.userData._diamondCacheKey),i.extensions[_.DIAMOND_GLTF_EXTENSION]=r,e.extensionsUsed[_.DIAMOND_GLTF_EXTENSION]=!0}})},8539:function(e,t,i){i.d(t,{CN:function(){return l},vZ:function(){return c}});var r=i(2988),a=i(1564),s=i(7654);function n(e,t,i){const a=(new r.Pa4).copy(e),s=(new r.Pa4).copy(t),n=(new r.Pa4).copy(i);return a.dot(s.cross(n))/6}function o(e,t,i){const a=(new r.Pa4).copy(e),s=(new r.Pa4).copy(t),n=(new r.Pa4).copy(i);return s.sub(a),n.sub(a),n.cross(s),.5*n.length()}function l(e){const t=e.getAttribute("position"),i=e.getAttribute("normal");if(t.count/3>500)return console.warn("DiamondPlugin:: Too many faces. Mirror/Topology issues will not be fixed",t.count/3),function(e){const t=new r.Pa4(0,0,0),i=new r.Pa4(0,0,0),a=new r.Pa4(0,0,0),s=new r.Pa4(0,0,0),n=e.getAttribute("position"),o=e.index;if(o)for(let r=Math.max(0,e.drawRange.start),l=Math.min(o.count,e.drawRange.start+e.drawRange.count)-1;r<l/3;r+=3){const e=o.getX(r),l=o.getX(r+1),c=o.getX(r+2);i.set(n.getX(e),n.getY(e),n.getZ(e)),a.set(n.getX(l),n.getY(l),n.getZ(l)),s.set(n.getX(c),n.getY(c),n.getZ(c)),a.sub(i),s.sub(i),s.cross(a),s.normalize(),t.add(s)}else for(let e=0;e<n.count;e+=3)i.set(n.getX(e),n.getY(e),n.getZ(e)),a.set(n.getX(e+1),n.getY(e+1),n.getZ(e+1)),s.set(n.getX(e+2),n.getY(e+2),n.getZ(e+2)),a.sub(i),s.sub(i),s.cross(a),s.normalize(),t.add(s);t.normalize();let l=!1,c=0;for(;!l;){const e=c/3,r=o?o.getX(e):e,s=o?o.getX(e+1):e+1;i.set(n.getX(r),n.getY(r),n.getZ(r)),a.set(n.getX(s),n.getY(s),n.getZ(s)),i.sub(a),i.normalize();const d=t.dot(i);Math.abs(d-1)>.001&&i.length()>.5&&(l=!0),c+=3}a.crossVectors(i,t),a.normalize(),i.crossVectors(t,a),i.normalize();const d=new r.yGw;d.elements[0]=i.x,d.elements[1]=i.y,d.elements[2]=i.z,d.elements[3]=0,d.elements[4]=t.x,d.elements[5]=t.y,d.elements[6]=t.z,d.elements[7]=0,d.elements[8]=a.x,d.elements[9]=a.y,d.elements[10]=a.z,d.elements[11]=0,d.elements[12]=0,d.elements[13]=0,d.elements[14]=0,d.elements[15]=1,e.computeBoundingSphere();const h=e.boundingSphere.radius,p=(new r.yGw).makeScale(h,h,h);return d.multiply(p),d}(e);const a=new r.Pa4(0,0,0),l=new r.Pa4(0,0,0),c=new r.Pa4(0,0,0),d=e.index,h=[];if(d)for(let i=Math.max(0,e.drawRange.start),r=Math.min(d.count,e.drawRange.start+e.drawRange.count)-1;i<r;i+=3){const e=d.getX(i),r=d.getX(i+1),s=d.getX(i+2);a.set(t.getX(e),t.getY(e),t.getZ(e)),l.set(t.getX(r),t.getY(r),t.getZ(r)),c.set(t.getX(s),t.getY(s),t.getZ(s)),h.push(a.toArray(),l.toArray(),c.toArray())}else for(let e=0;e<t.count;e++)a.set(t.getX(e),t.getY(e),t.getZ(e)),h.push(a.toArray());const p=function(e,t){const i=new r.Pa4;for(let t=0;t<e.length;t+=3)i.x+=e[t],i.y+=e[t+1],i.z+=e[t+2];i.multiplyScalar(1/(e.length/3));const a=new r.Pa4,s=new r.Pa4,l=new r.Pa4,c=new r.Pa4,d=new r.Pa4;let h=0,p=0;for(let e=0;e<t.length;e+=3){a.set(t[e][0],t[e][1],t[e][2]),s.set(t[e+1][0],t[e+1][1],t[e+1][2]),l.set(t[e+2][0],t[e+2][1],t[e+2][2]),d.copy(a).add(s).add(l);const i=o(a,s,l);d.multiplyScalar(i/3),c.add(d),h+=i,p+=n(a,s,l)}return c.multiplyScalar(1/h),{centre:i,com:c,volume:p,area:h}}(t.array,h);if(p.volume<0){console.warn("DiamondPlugin:: Negative Volume, Fixing Normals");for(let e=0;e<i.count;e++)i.setX(e,-i.getX(e)),i.setY(e,-i.getY(e)),i.setZ(e,-i.getZ(e));i.needsUpdate=!0}const u=[];for(let e=0;e<t.array.length;e+=3)u.push([t.array[e],t.array[e+1],t.array[e+2]]);const m=console.log;console.log=()=>{};const f=(0,s.getEigenVectors)(u);console.log=m;const g=new r.yGw;g.elements[0]=f[0].vector[0],g.elements[1]=f[0].vector[1],g.elements[2]=f[0].vector[2],g.elements[3]=0,g.elements[4]=f[1].vector[0],g.elements[5]=f[1].vector[1],g.elements[6]=f[1].vector[2],g.elements[7]=0,g.elements[8]=f[2].vector[0],g.elements[9]=f[2].vector[1],g.elements[10]=f[2].vector[2],g.elements[11]=0,g.elements[12]=0,g.elements[13]=0,g.elements[14]=0,g.elements[15]=1;const v=new r.Pa4;v.copy(p.com).sub(p.centre),v.normalize();const _=new r.Pa4(f[2].vector[0],f[2].vector[1],f[2].vector[2]);v.dot(_)<0&&(g.elements[4]=-f[1].vector[0],g.elements[5]=-f[1].vector[1],g.elements[6]=-f[1].vector[2],g.elements[8]=-f[2].vector[0],g.elements[9]=-f[2].vector[1],g.elements[10]=-f[2].vector[2]),e.computeBoundingSphere();const y=e.boundingSphere.radius,b=(new r.yGw).makeScale(y,y,y);return g.multiply(b),g}const c={...a._,color:new r.Ilk(1,1,1),envMapIntensity:1,envMapRotation:0,dispersion:.012,squashFactor:.98,geometryFactor:.5,gammaFactor:1,absorptionFactor:1,reflectivity:.5,refractiveIndex:2.4,boostFactors:new r.Pa4(.892,.892,.98595025),wireframe:!1,envMapRotationOffset:0,wireframeLinewidth:0,skinning:!1,transmission:0,morphTargets:!1,morphNormals:!1,rayBounces:1,diamondOrientedEnvMap:0,envMapIndex:0}},7926:function(e,t,i){i.d(t,{c:function(){return c}});var r=i(2988),a=i(1191),s=i(1217),n=i(8430),o=i(9854);class l extends r.ZAu{_updater(){const e=this._object;if(e){const t=(new a.q).expandByObject(e,!1);t.getCenter(this.position);const i=t.getBoundingSphere(new r.aLr).radius;this.scale.setScalar(i*this.boundingScaleMultiplier),this.setVisible(!0)}else this.setVisible(!1)}constructor(){super(),this.assetType="widget",this.modelObject=this,this._object=null,this.boundingScaleMultiplier=1,this.position.set(0,0,0),this.visible=!1,this.renderOrder=1,this.userData.bboxVisible=!1,this._updater=this._updater.bind(this)}_initGeometry(e){if(this._geometry)return;const t=new s.H(e);this._geometry=t;const i=new n.Y({color:"#ff2222",transparent:!0,opacity:.9,linewidth:5,resolution:new r.FM8(1024,1024),dashed:!1,toneMapped:!1}),a=new o.v(t,i);a.computeLineDistances(),a.scale.set(1,1,1),a.visible=!0,this.add(a)}setVisible(e){e!==this.visible&&(this.visible=e,this.setDirty?.({sceneUpdate:!1}))}attach(e){return this.detach(),e?(this._object=e,this._object.addEventListener("objectUpdate",this._updater),this._updater(),this):this}detach(){return this._object?(this._object?.removeEventListener("objectUpdate",this._updater),this._object=null,this._updater(),this):this}get object(){return this._object}}class c extends l{constructor(){super(),this.boundingScaleMultiplier=1/1.7,this._initGeometry(new r.DvJ(2,2,2,1,1,1))}_updater(){super._updater();const e=this.object;e&&((new a.q).expandByObject(e,!1).getSize(this.scale).multiplyScalar(this.boundingScaleMultiplier).clampScalar(.1,100),this.setVisible(!0))}}},2095:function(e,t,i){i.d(t,{l:function(){return u}});var r=i(3995),a=i(2988),s=i(9008);class n extends s.SimpleEventDispatcher{get scene(){return this._scene}set scene(e){this._scene?.removeEventListener("activeCameraChange",this._activeCameraChange),this._scene=e,this._scene.addEventListener("activeCameraChange",this._activeCameraChange)}constructor(e,t,i,r){super(),this.hoverEnabled=!1,this._mouseDownPos=new a.FM8,this._scene=e,this._camera=i??this._scene.activeCamera,this.domElement=t,this._time=this.time,this._mouseDownTime=0,this._mouseUpTime=1,this.selectionCondition=r??(e=>!1!==e.userData.userSelectable&&!1!==e.userData.bboxVisible&&null!=e.material&&"ShadowMaterial"!==e.material.type),this.raycaster=new a.iMs,this.mouse=new a.FM8,this._selected=[],this._hovering=[],this.cursorStyles={default:"grab",down:"grabbing"},this._activeCameraChange=this._activeCameraChange.bind(this),this._scene.addEventListener("activeCameraChange",this._activeCameraChange),this.domElement.style.touchAction="none",this.domElement.style.cursor=this.cursorStyles.default,this.domElement.addEventListener("pointermove",(e=>this.onPointerMove(e))),this.domElement.addEventListener("pointerleave",(e=>this.onPointerLeave(e))),this.domElement.addEventListener("pointerout",(e=>this.onPointerLeave(e))),this.domElement.addEventListener("pointercancel",(e=>this.onPointerCancel(e))),this.domElement.addEventListener("pointerenter",(e=>this.onPointerEnter(e))),this.domElement.addEventListener("pointerdown",(e=>this.onPointerDown(e))),this.domElement.addEventListener("pointerup",(e=>this.onPointerUp(e)))}_activeCameraChange(){this.camera=this._scene.activeCamera}get camera(){return this._camera}set camera(e){this._camera=e}get selectedObject(){return this._selected.length>0?this._selected[0]:null}set selectedObject(e){1===this._selected.length&&this._selected[0]===e||(this._selected=e?Array.isArray(e)?[...e]:[e]:[],this.dispatchEvent({type:"selectedObjectChanged",object:this.selectedObject}))}get hoverObject(){return this._hovering.length>0?this._hovering[0]:null}set hoverObject(e){this._hovering=e?Array.isArray(e)?[...e]:[e]:[],this.dispatchEvent({type:"hoverObjectChanged",object:this.hoverObject})}get time(){return this._time=(0,s.now)(),this._time}get isMouseDown(){return this.mouseDownDeltaTime<0}get mouseDownDeltaTime(){return this._mouseUpTime-this._mouseDownTime}onPointerMove(e){!1!==e.isPrimary&&(this.updateMouseFromEvent(e),this.hoverEnabled&&(this.hoverObject=this.checkIntersection()?.intersects[0].object??null))}onPointerLeave(e){!1!==e.isPrimary&&(this.domElement.style.cursor=this.cursorStyles.default,(this.hoverEnabled||this.hoverObject)&&(this.hoverObject=null))}onPointerEnter(e){}onPointerCancel(e){}updateMouseFromEvent(e){const t=this.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.x)/t.width*2-1,this.mouse.y=-(e.clientY-t.y)/t.height*2+1}onPointerDown(e){!1!==e.isPrimary&&(this.domElement.style.cursor=this.cursorStyles.down,this._mouseDownTime=this.time,this._mouseDownPos.copy(this.mouse))}onDoubleClick(e){console.log("double click")}onPointerUp(e){if(!1===e.isPrimary)return;this.domElement.style.cursor=this.cursorStyles.default,this._mouseUpTime=this.time;const t=this.mouseDownDeltaTime,i=this._mouseDownPos.distanceTo(this.mouse);t<n.PointerClickMaxTime&&i<n.PointerClickMaxDistance&&this.onPointerClick(e)}onPointerClick(e){if(!1===e.isPrimary)return;this.updateMouseFromEvent(e);const t=this.checkIntersection();t&&this.dispatchEvent({type:"hitObject",time:this._mouseUpTime,intersects:t}),this.selectedObject=t?.selectedObject||null}addPasses(){}checkIntersection(){const e=this._camera?.cameraObject;if(!e)return null;this.raycaster.setFromCamera(this.mouse,e);let t=this.raycaster.intersectObject(this._scene.modelRoot.modelObject,!0);const i=[],r=t.filter((e=>!i.includes(e.object.id)&&(i.push(e.object.id),!0)));t=r;let a,s=null;const n=[];for(const e of t){for(s=e.object,a=e;!(null==s||s.visible&&this.selectionCondition(s));)s=s.parent;null!=s&&n.push(e)}if(t=n,t.length>0){if(s=t[0].object,a=t[0],this._firstHit&&s.id!==this._firstHit.id)s=a.object;else for(let e=0;e<t.length;e++)if(this.selectedObject&&this.selectedObject.id===t[e].object.id){const i=e+1;if(!(i<t.length))return null;a=t[i],s=a.object}this._firstHit=t[0].object}return s&&a&&s?{selectedObject:s,intersect:a,intersects:t,mouse:this.mouse.toArray()}:null}isHovering(){return null!=this.hoverObject}isSelected(){return null!=this.selectedObject}}n.PointerClickMaxTime=200,n.PointerClickMaxDistance=.1;var o=i(7926),l=i(4107),c=i(7234),d=i(1672);class h extends c.Ys{_keyDownListener(e){if(this.enabled&&this.object){switch(e.keyCode){case 81:this.setSpace("local"===this.space?"world":"local");break;case 16:this.setTranslationSnap(100),this.setRotationSnap(a.M8C.degToRad(15)),this.setScaleSnap(.25);break;case 87:this.setMode("translate");break;case 69:this.setMode("rotate");break;case 82:this.setMode("scale");break;case 187:case 107:this.setSize(this.size+.1);break;case 189:case 109:this.setSize(Math.max(this.size-.1,.1));break;case 88:this.showX=!this.showX;break;case 89:this.showY=!this.showY;break;case 90:this.showZ=!this.showZ;break;case 32:this.enabled=!this.enabled;break;default:return}this._scene.setDirty({sceneUpdate:!0,frameFade:!0})}}_keyUpListener(e){this.enabled&&(16===e.keyCode&&(this.setTranslationSnap(null),this.setRotationSnap(null),this.setScaleSnap(null)),this.object&&e.keyCode)}constructor(e){super(e.scene.activeCamera.cameraObject,e.canvas),this.modelObject=this,this.assetType="widget",this._activeCameraChange=this._activeCameraChange.bind(this),this._scene=e.scene,this._scene.addEventListener("activeCameraChange",this._activeCameraChange),this.visible=!1,this.userData.bboxVisible=!1,this.addEventListener("objectChange",(()=>{this?.object?.dispatchEvent({type:"objectUpdate",fadeFrame:!1})})),this.addEventListener("dragging-changed",(t=>{const i=e?.getPlugin(d.$);i&&(t.value?i.disable("TransformControls"):i.enable("TransformControls")),this._scene.activeCamera.interactionsEnabled=!t.value})),this._keyDownListener=this._keyDownListener.bind(this),this._keyUpListener=this._keyUpListener.bind(this),window.addEventListener("keydown",this._keyDownListener),window.addEventListener("keyup",this._keyUpListener),this._scene.addWidget(this)}_activeCameraChange(){this.camera=this._scene.activeCamera.cameraObject}dispose(){window.removeEventListener("keydown",this._keyDownListener),window.removeEventListener("keyup",this._keyUpListener),this._scene.removeEventListener("activeCameraChange",this._activeCameraChange),this._scene.modelObject.remove(this),super.dispose()}}var p=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class u extends r.Q{get picker(){return this._picker}setDirty(){this._viewer?.setDirty()}constructor(e=o.c,t=!1,i=!0,r=!1){super(),this.enabled=!0,this._enableWidget=!0,this.autoFocus=!1,this._onObjectHit=e=>{this._viewer&&(this.enabled?this.dispatchEvent(e):e.intersects.selectedObject=null)},this._uiConfigChildren=[{label:"Enabled",type:"checkbox",property:[this,"enabled"]},{label:"AutoFocus",type:"checkbox",property:[this,"autoFocus"],onChange:()=>{const e=this.getSelectedObject();this.autoFocus&&e&&this.setSelectedObject(e,!0)}}],e&&(this._widget=new e),this._controls=t,this._pickUi=i,this.autoFocus=r}getSelectedObject(){if(this.enabled)return this._picker?.selectedObject||void 0}setSelectedObject(e,t=!1){if(!this.enabled)return;if(!this._picker)return;const i=this.autoFocus;this.autoFocus=!1,this._picker.selectedObject=e||null,this.autoFocus=i,(i||t)&&this.focusObject(e)}async onAdded(e){await super.onAdded(e),this._picker=new n(e.scene,e.canvas,void 0,(e=>{if(!e.material)return!1;let t=e,i=!1;for(;t;){if(!t.visible)return!1;if("model"===(t.userData.iModel??t).assetType&&(i=!0),"widget"===(t.userData.iModel??t).assetType)return!1;if(!1===t.userData.userSelectable)return!1;if(!1===t.userData.bboxVisible)return!1;t=t.parent}return i})),this._widget&&e.scene.addWidget(this._widget),this._transformControls=new h(e),this._transformControls.enabled=this._controls,this._picker.addEventListener("selectedObjectChanged",(t=>{this.dispatchEvent(t);const i=this._picker?.selectedObject||void 0;if(this._pickUi){const e=i?.uiConfig,t=this.uiConfig;t.children=[...this._uiConfigChildren],e&&t.children.push(e),t.uiRefresh?.()}const r=this._widget;r&&this._enableWidget&&(i?r.attach(i):r.detach());const a=this._transformControls;a&&this._viewer?.scene.activeCamera.controls&&(i&&a.enabled?a.attach(i):a.detach()),e.setDirty(),this.autoFocus&&this.focusObject(i)})),this._picker.addEventListener("hoverObjectChanged",this.dispatchEvent),this._picker.addEventListener("hitObject",this._onObjectHit),e.scene.addEventListener("select",(e=>{void 0===e.value?console.warn("e.value must be set for picking, can be null to unselect"):this.setSelectedObject(e.value,this.autoFocus||e.focusCamera)})),e.scene.addEventListener("addSceneObject",(async t=>{const i=t.object,r=this.getSelectedObject();if(r&&"material"===i?.assetType&&"function"==typeof r?.setMaterial&&r?.modelObject?.isMesh&&await e.confirm("Applying material: Apply material to the selected object?")){const t=r.material;if(Array.isArray(t))console.warn("Dropping on material array not yet fully supported."),r.setMaterial(i);else{let a=Array.from(t?.userData.__appliedMeshes??[]);(a.length>1?!await e.confirm("Applying material: Apply to all objects using this material?"):a.length<1)&&(a=[r]);for(const e of a)e&&e.setMaterial?.(i)}}})),e.scene.addEventListener("sceneUpdate",(t=>{if(!t.hierarchyChanged)return;const i=this.getSelectedObject();let r=!1;i?.traverseAncestors((t=>{t===e.scene.modelObject&&(r=!0)})),r||this.setSelectedObject(void 0)}))}async focusObject(e){const t=this._viewer?.getPluginByType("CameraViews");await(t?.animateToFitObject(e,1.25,1e3,"easeOut",{min:(this._viewer?.scene.activeCamera.getControls()?.minDistance??.5)+.5,max:50}))}enableWidget(e){if(this._enableWidget=e,e){const e=this._picker?.selectedObject||void 0;e&&this._widget?.attach(e)}else this._widget?.detach()}get uiConfig(){return this._pickUi?this._uiConfig?this._uiConfig:this._uiConfig={type:"panel",label:"Picker",expanded:!0,children:[...this._uiConfigChildren]}:{}}get transformControls(){return this._transformControls}get widget(){return this._widget}}u.PluginType="Picking",p([(0,l.qC)()],u.prototype,"enabled",void 0),p([(0,l.qC)()],u.prototype,"autoFocus",void 0)},5022:function(e,t,i){i.d(t,{z:function(){return r}});class r{constructor(){this._processors=new Map}add(e,t){this._processors.has(e)||this._processors.set(e,[]),this._processors.get(e)?.push(t)}remove(e,t){const i=this._processors.get(e),r=i?.indexOf(t)||i?.findIndex((e=>e.process&&e.process===t.process||e.processAsync&&e.processAsync===t.processAsync));!i||!r||r<0||i.splice(r,1)}get(e){return this._processors.get(e)??[]}async process(e,t,i){const r=this.get(e),a=t.assetType;for(const e of r)e.forAssetType===a&&(t=e.process?.(t,i)??t,t=await(e.processAsync?.(t,i))??t);return t}dispose(){this._processors.clear()}}},3206:function(e,t,i){i.d(t,{T0:function(){return l},q8:function(){return n},wB:function(){return o}});var r=i(4196),a=i(706),s=i(9008);const n={linear:r.GE,easeIn:r.YQ,easeOut:r.Vv,easeInOut:r.mZ,circIn:r.Z7,circOut:r.Bn,circInOut:r.X7,backIn:r.G2,backOut:r.CG,backInOut:r.XL,anticipate:r.LU,bounceOut:r.gJ,bounceIn:r.h9,bounceInOut:r.yD,easeInOutSine:function(e){return-(Math.cos(Math.PI*e)-1)/2}};async function o(e,t,i,r){t in e||console.error("invalid key",t,e);const a=function(e,t,i){const r=e[t],a=()=>{"function"==typeof e?.setDirty&&e.setDirty()};return r.isVector3||r.isVector2||r.isVector4?e=>{r.copy(e),a()}:i=>{e[t]=i,a()}}(e,t),n=e[t],o=e=>{a(e),i.onUpdate?.(e)};if("boolean"==typeof n){const{duration:e}=i;return(0,s.timeout)(e??0).then((()=>o(i.to)))}return"function"==typeof i.to&&(i={...i,to:i.to(n,e)}),l({...i,from:n,onUpdate:o},r)}async function l(e,t){const i=e.onComplete,r=e.onStop,s=e.onEnd;return e={...e},new Promise(((n,o)=>{e.onComplete=()=>{try{i?.()}catch(e){return s?.(),void o(e)}s?.(),n()},e.onStop=()=>{try{r?.()}catch(e){return s?.(),void o(e)}s?.(),n()};const l=(0,a.j)(e);t&&t.push(l)}))}},6453:function(e,t,i){i.d(t,{Y:function(){return s},c:function(){return n}});var r=i(2988),a=i(1483);function s(e){if(!e.isMaterial&&!e.isBufferGeometry)return;const t=Array.from(e.userData.__appliedMeshes).filter((e=>!e.isInstancedMesh&&!!e.parent&&0===e.children.length&&!Array.isArray(e.material)));if(t.length<2)return;const i=new Map;for(const e of t){const t=(s=e).parent.uuid+"_"+s.geometry.uuid+"_"+s.material?.uuid;i.has(t)||i.set(t,[]),i.get(t).push(e),e.updateMatrix()}var s;const n=i.keys();for(const e of n){const t=i.get(e),s=t[0];if(!s)continue;if(t.length<2)continue;const n=new r.SPe(s.geometry,s.material,t.length),o=s.userData;s.userData={},n.copy(s),(0,a.A)(n.userData,o);const l=s.parent;n.position.set(0,0,0),n.rotation.set(0,0,0),n.scale.set(1,1,1),n.updateMatrix();const c=new Float32Array(3*n.count),d=new Float32Array(4*n.count),h=new Float32Array(3*n.count);for(let e=0;e<t.length;e++){const i=t[e],r=i.matrix;r.determinant()<0&&(r.elements[0]*=-1,r.elements[1]*=-1,r.elements[2]*=-1),n.setMatrixAt(e,r),i.position.toArray(c,3*e),i.quaternion.toArray(d,4*e),i.scale.toArray(h,3*e),i.removeFromParent(),i.material?.userData?.__appliedMeshes?.delete(i),i.geometry?.userData?.__appliedMeshes?.delete(i)}n.material.userData?.__appliedMeshes?.add(n),n.geometry.userData.__appliedMeshes.add(n),n.sourceTrs={TRANSLATION:new r.TlE(c,3),ROTATION:new r.TlE(d,4),SCALE:new r.TlE(h,3)},n.instanceMatrix.needsUpdate=!0,l.add(n),l.setDirty()}}class n{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;const i=this.writer,a=e;let s=a.sourceTrs;if(!s){const e=new Float32Array(3*a.count),t=new Float32Array(4*a.count),i=new Float32Array(3*a.count),n=new r.yGw,o=new r.Pa4,l=new r._fP,c=new r.Pa4;for(let r=0;r<a.count;r++)a.getMatrixAt(r,n),n.decompose(o,l,c),o.toArray(e,3*r),l.toArray(t,4*r),c.toArray(i,3*r);s={TRANSLATION:new r.TlE(e,3),ROTATION:new r.TlE(t,4),SCALE:new r.TlE(i,3)}}s={TRANSLATION:i.processAccessor(s.TRANSLATION),ROTATION:i.processAccessor(s.ROTATION),SCALE:i.processAccessor(s.SCALE)},a.instanceColor&&(s.COLOR=i.processAccessor(new r.TlE(a.instanceColor.array,3))),i.extensionsUsed[this.name]=!0,i.extensionsRequired[this.name]=!0,t.extensions=t.extensions||{},t.extensions[this.name]={attributes:s}}}},8670:function(e,t,i){i.d(t,{p:function(){return a}});const r=!0;function a(e,t,i,{replaceAll:a=!1,prepend:s=!1,append:n=!1}={}){if(r&&!e.includes(t))return console.error(`${t} not found in shader`),e;let o=i;return s?o=i+t:n&&(o=t+i),a?e.replaceAll(t,o):e.replace(t,o)}},9354:function(e,t,i){function r(e,t,i){return e&~(1<<t)|(i?1:0)<<t}function a(e,t){return e&~(1<<t)}i.d(t,{o:function(){return a},s:function(){return r}})},8052:function(e,t,i){i.d(t,{$j:function(){return s},T9:function(){return n}});var r=i(2988),a=i(9008);function s(e,t,i){const s=i?.data??new Uint8ClampedArray(e.height*e.width*4),n=e.data instanceof Float32Array,o=e.data instanceof Uint16Array;for(let i=0;i<s.length;i++)s[i]=n?255*e.data[i]:o?255*r.A5E.fromHalfFloat(e.data[i]):e.data[i],t===r.GUF&&(s[i]=255*(0,a.LinearToSRGB)(s[i]/255));return i??new ImageData(s,e.width,e.height)}function n(e,t,i=!1){let r;return r=e.isDataTexture?s(e.image,e.colorSpace):e.image,function(e,t,i=!1){const r=document.createElement("canvas");r.width=Math.min(t,e.width),r.height=Math.floor(1+r.width*e.height/e.width);const s=r.getContext("2d");if(!s)return console.error("textureToDataUrl: could not get canvas context"),r;!0===i&&(s.translate(0,r.height),s.scale(1,-1));let n=!1;if(void 0!==e.data){const t=e;if(e.width!==r.width||e.height!==r.height){const i=document.createElement("canvas");i.width=e.width,i.height=e.height;const a=i.getContext("2d");a?(a.putImageData(t,0,0),s.drawImage(i,0,0,r.width,r.height)):(console.error("textureToDataUrl: could not get temp canvas context"),s.putImageData(t,0,0))}else s.putImageData(t,0,0),i&&(n=!0)}else s.drawImage(e,0,0,r.width,r.height);return n?(0,a.canvasFlipY)(r):r}(r,t,i)}String.prototype.replaceAll||(String.prototype.replaceAll=function(e,t){return"[object regexp]"===Object.prototype.toString.call(e).toLowerCase()?this.replace(e,t):this.replace(new RegExp(e,"g"),t)})},4107:function(e,t,i){i.d(t,{Bg:function(){return f},HD:function(){return p},Hx:function(){return u},Rg:function(){return g},qC:function(){return l}});var r=i(9008),a=i(2988),s=i(2860),n=i(8052);const o=new Map;function l(e){return(t,i)=>{const r=t.constructor;if(r===Object)throw new Error("All properties in an object are serialized by default");o.has(r)||o.set(r,[]),o.get(r).push([e||i,i])}}const c={obj:(e,t)=>Object.fromEntries(Object.entries(e).map((([e,i])=>[e,p(i,!1,t)]))),vec4:e=>({x:e.x,y:e.y,z:e.z,w:e.w,isVector4:!0}),vec3:e=>({x:e.x,y:e.y,z:e.z,isVector3:!0}),vec2:e=>({x:e.x,y:e.y,isVector2:!0}),color:e=>({r:e.r,g:e.g,b:e.b,isColor:!0}),quat:e=>({x:e.x,y:e.y,z:e.z,w:e.w,isQuaternion:!0}),texture:(e,t)=>{if(!e?.isTexture)throw new Error("Expected a texture");if(t?.textures[e.uuid])return{uuid:e.uuid,resource:"textures"};if(e.isRenderTargetTexture&&!e.userData?.serializableRenderTarget)return;const i=e.source.data,r=!e.isRenderTargetTexture&&e.userData.rootPath;r&&e.source.data&&(e.userData.__embedUrlImagePreviews?e.source.data=(0,n.T9)(e,16,e.flipY):e.source.data=null);const a=e.userData;e.userData={};const o={images:{}};let l={};try{l=e.toJSON(t||o),!t&&l.image&&(l.image=r&&!e.userData.__embedUrlImagePreviews?void 0:o.images[l.image]),l.userData=p((0,s.Mj)({},a),!1,t)}catch(e){console.error(e)}return e.userData=a,r&&(t&&!e.userData.__embedUrlImagePreviews&&delete t.images[e.source.uuid],e.source.data=i),t?.textures&&!l.resource&&(t.textures[l.uuid]||(t.textures[l.uuid]=l),l={uuid:l.uuid,resource:"textures"}),l},material:(e,t)=>{if(!e?.isMaterial)throw new Error("Expected a material");if(t?.materials[e.uuid])return{uuid:e.uuid,resource:"materials"};e.userData.rootPath&&console.error("TODO: handle material with root path with material inheritance/hierarchy");const i=t??{textures:{},images:{}},r={},a={};for(const[t,s]of Object.entries(e))if(s?.isTexture&&!t.startsWith("__")){const n=c.texture(s,i);r[t]=n,a[t]=s,e[t]=n?{isTexture:!0,toJSON:()=>n}:null}let s=e.toJSON(t);for(const[t,i]of Object.entries(a))e[t]=i,delete a[t];if(t){for(const[e,t]of Object.entries(r))t&&(s[e]=t);t?.materials&&(t.materials[s.uuid]||(t.materials[s.uuid]=s),s={uuid:s.uuid,resource:"materials"})}else{for(const[e,t]of Object.entries(r))t&&(s[e]=t.uuid);s.textures=Object.values(i.textures),s.images=Object.values(i.images)}return s}},d=e=>(t,i)=>i?.copy?.(t)??(new e).copy(t),h={obj:(e,t,i)=>Object.assign(t,Object.fromEntries(Object.entries(e).map((([e,r])=>[e,u(r,t?.[e],!1,i)])))),vec4:d(a.Ltg),vec3:d(a.Pa4),vec2:d(a.FM8),color:d(a.Ilk),quat:d(a._fP)};function p(e,t,i){if("function"==typeof e)return;if(Array.isArray(e))return e.map((e=>p(e,!1,i)));if("object"!=typeof e){if("number"==typeof e){if(e===1/0)return"Infinity";if(e===-1/0)return"-Infinity";if(isNaN(e))return"NaN"}return e}if(!e)return e;let r=e.constructor??Object;if(r===Object)return c.obj(e,i);if(e.isVector2)return c.vec2(e);if(e.isVector3)return c.vec3(e);if(e.isVector4)return c.vec4(e);if(e.isColor)return c.color(e);if(e.isQuaternion)return c.quat(e);if(e.isTexture)return c.texture(e,i);if(e.isMaterial)return c.material(e,i);if(!t&&"function"==typeof e.toJSON){const t=e.toJSON(i);return e.serializableClassId&&t&&(t.serializableClassId=e.serializableClassId),t}const a={};for(;r&&r!==Object;)o.get(r)?.forEach((([t,r])=>{const s=e[r];a[t]=p(s,!1,i)})),r=Object.getPrototypeOf(r);return e.serializableClassId&&(a.serializableClassId=e.serializableClassId),a}function u(e,t,i,a){let s=t;if(void 0===e)return s;if("number"==typeof t){if("Infinity"===e)return 1/0;if("-Infinity"===e)return-1/0;if("NaN"===e)return NaN;if("number"==typeof e||!e)return e}if(Array.isArray(e)){const t=e.length;Array.isArray(s)||(s=[]);for(let i=0;i<t;i++){const t=e[i],r=s.length>i?u(t,s[i],!1,a):u(t,void 0,!1,a);s.length<=i?s.push(r):s[i]=r}return s}let n=!1;if(e&&e.resource&&"string"==typeof e.resource&&(e=a[e.resource]?.[e.uuid],n=!0),!s&&e&&!n)if(e.serializableClassId){const t=m.get(e.serializableClassId);t&&(s=t.DataInConstructor?new t(e):new t)}else"object"!=typeof e||e.constructor&&e.constructor!==Object||(s={});if("function"==typeof s)return console.error("cannot deserialize over function",s,e),s;if(e&&"object"==typeof e&&!n){if(e.isVector2)return h.vec2(e,s);if(e.isVector3)return h.vec3(e,s);if(e.isVector4)return h.vec4(e,s);if(e.isColor)return h.color(e,s);if(e.isQuaternion)return h.quat(e,s)}if(null==e||null==s||"object"!=typeof s||s.isTexture)return n&&(e?e.__useCount=e.__useCount?e.__useCount+1:1:console.warn("probable error deserialize: resource not found.")),e;let l=s.constructor??Object;if(l===Object)return h.obj(e,s,a);if(!i&&"function"==typeof s.fromJSON)return s.isMaterial&&(Object.entries(e).forEach((([t,i])=>{if(!i||!i.resource||"string"!=typeof i.resource)return;const r=a[i.resource]?.[i.uuid];e[t]=r||null})),e.userData&&(e.userData=u(e.userData,void 0,!1,a))),s.fromJSON(e,a),s;for(;l&&l!==Object;)o.get(l)?.forEach((([t,i])=>{const n=s[i],o=u(e[t],n,!1,a);o!==n&&(0,r.safeSetProperty)(s,i,o,!0)})),l=Object.getPrototypeOf(l);return s}const m=new Map;function f(e){return t=>(t=class extends t{constructor(){super(...arguments),this.serializableClassId=e}},m.set(e,t),t)}function g(e,t,i,r){if(t?.extras[e.uuid])return{uuid:e.uuid,resource:"extras"};let a="";if(e.source?._sourceImgBuffer||e.userData.__sourceBuffer){const t=new Uint8Array(e.source?._sourceImgBuffer||e.userData.__sourceBuffer),i=r||e.userData.mimeType||"";a={data:Array.from(t),type:t.constructor.name,path:e.userData.__sourceBlob?.name||e.userData.rootPath||"file."+i.split("/")[1]},i&&(a.mimeType=i)}else e.userData.rootPath?a=e.userData.rootPath:console.error("Unable to serialize LUT texture, not loaded through asset manager.");const n={uuid:e.uuid,url:a,userData:(0,s.Mj)({},e.userData),type:e.type,name:i||e.name};return t?.extras?(t.extras[e.uuid]=n,{uuid:e.uuid,resource:"extras"}):n}},1191:function(e,t,i){i.d(t,{q:function(){return a}});var r=i(2988);class a extends r.ZzF{expandByObject(e,t=!1,i=!1,r){if(!1===e.userData?.bboxVisible)return this;if(!e.visible&&i)return this;if(r&&r(e))return this;if(e.updateWorldMatrix(!1,!1),void 0!==e.boundingBox)null===e.boundingBox&&e.computeBoundingBox(),s.copy(e.boundingBox),s.applyMatrix4(e.matrixWorld),this.union(s);else{const i=e.geometry;if(void 0!==i)if(t&&null!=i.attributes&&void 0!==i.attributes.position){const t=i.attributes.position;for(let i=0,r=t.count;i<r;i++)n.fromBufferAttribute(t,i).applyMatrix4(e.matrixWorld),this.expandByPoint(n)}else null===i.boundingBox&&i.computeBoundingBox(),s.copy(i.boundingBox),s.applyMatrix4(e.matrixWorld),this.union(s)}const a=e.children;for(let e=0,s=a.length;e<s;e++)this.expandByObject(a[e],t,i,r);return this}expandByObjects(e,t=!1,i=!1,r){for(let a=0,s=e.length;a<s;a++)this.expandByObject(e[a],t,i,r);return this}getPoints(){return[new r.Pa4(this.min.x,this.min.y,this.min.z),new r.Pa4(this.min.x,this.min.y,this.max.z),new r.Pa4(this.min.x,this.max.y,this.min.z),new r.Pa4(this.min.x,this.max.y,this.max.z),new r.Pa4(this.max.x,this.min.y,this.min.z),new r.Pa4(this.max.x,this.min.y,this.max.z),new r.Pa4(this.max.x,this.max.y,this.min.z),new r.Pa4(this.max.x,this.max.y,this.max.z)]}getScreenSpaceBounds(e){const t=this.getPoints(),i=new r.TUj;for(const r of t){const t=r.project(e);i.min.min(t),i.max.max(t)}return i}}const s=new a,n=new r.Pa4},776:function(e,t,i){i.d(t,{B:function(){return s}});var r=i(2988),a=i(6594);class s{constructor(e){this.viewer=e,this._lights=[],this.shapes={sphere:new r.Kj0(new r.xo$(1)),cube:new r.Kj0(new r.DvJ(1,1,1)),cylinder:new r.Kj0(new r.fHI(.5,.5,1))};const t=new r.xsS;this._channel=7;const i=new r.vmT(16777215,4473924,1);i.position.set(0,10,0),i.layers.set(this._channel),t.add(i),this._lights.push(i),this._scene=t}dispose(){[...this._lights].forEach((e=>e.dispose())),Object.values(this.shapes).forEach((e=>{e.geometry&&e.geometry.dispose()}))}generate(e,t="sphere"){const i=this.shapes[t]||new r.Kj0(new r.xo$(1));i.material=e.materialObject,i.geometry.attributes.tangent||i.geometry.computeTangents(),this._scene.add(i),this._scene.environment=this.viewer.scene.getEnvironment();const s=i.material.envMapIntensity;"number"==typeof s&&(i.material.envMapIntensity=Math.max(s,2));const n=(0,a.V)(this.viewer,i,this._scene,this._channel,new r.Pa4(0,0,1.5));return"number"==typeof s&&(i.material.envMapIntensity=s),this._scene.remove(i),i.material=void 0,n}}},6594:function(e,t,i){i.d(t,{V:function(){return n}});var r=i(2988),a=i(1191);const s=new r.cPb(45,1,.1,1e3);function n(e,t,i,n=7,o=new r.Pa4(0,0,1.5)){i=i??e.scene.modelObject;const l=(new a.q).expandByObject(i??t,!0,!0),c=l.getCenter(new r.Pa4),d=l.getSize(new r.Pa4);s.position.copy(c).add(o.clone().multiplyScalar(Math.max(d.x,d.y,d.z))),s.lookAt(c),t&&t.traverseVisible((e=>{e.layers.enable(n)})),n>0?s.layers.set(n):s.layers.enableAll();const h=t?.visible;t&&(t.visible=!0),e.renderer.rendererObject.setRenderTarget(null),e.renderer.rendererObject.render(i,s);const p=e.renderer.rendererObject.domElement.toDataURL("image/png");return t&&(t.visible=h,t.traverseVisible((e=>{e.layers.disable(n)})),s.layers.enableAll()),e.setDirty(),p}},6533:function(e,t,i){i.d(t,{HC:function(){return m},N3:function(){return o},N6:function(){return c},RG:function(){return f},Ux:function(){return d},aP:function(){return g},e5:function(){return h},lD:function(){return p},of:function(){return u}});var r=i(2988),a=i(9008),s=i(1191),n=i(2504);const o="rgbm-16";function l(e,t){const i=function(e){switch(e){case r.aCh:case r.GUF:return["Linear","( value )"];case r.KI_:return["sRGB","( value )"];case o:return["RGBM","( value, 16.0 )"];default:return console.warn("utils: Unsupported colorSpace:",e),["Linear","( value )"]}}(t);return"vec4 "+e+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function c(e,t,i){return l(e+"TexelToLinear",function(e,t){let i;return e&&e.isTexture?i=e.colorSpace:e&&e.isWebGLRenderTarget?(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),i=e.texture.colorSpace):i=r.GUF,t&&e&&e.isTexture&&e.format===r.wk1&&e.type===r.ywz&&e.colorSpace===r.KI_&&(i=r.GUF),i}(t,i))+"\n"}function d(e,t){return l(e+"TexelToLinear",t)+"\n"}function h({uniforms:e,propKey:t,thisTarget:i=!1}={}){const r=!!e,s=!!t,n=i;return(i,o)=>{const l=i=>{const a=n?i:r?e:i.uniforms||i._uniforms;let l=s?t:o;n&&(l="_"+l);let c=a[l];return c||(c={value:null},a[l]=c),c};Object.defineProperty(i,o,{get(){return l(this).value},set(e){l(this).value=e,(0,a.safeSetProperty)(this,"uniformsNeedUpdate",!0,!0)}})}}function p(e,t,i=!1,r){const s=!!t,n=!!e;return(o,l)=>{const c=i=>({t:s?t:i.defines||i._defines,p:n?e:l});Object.defineProperty(o,l,{get(){const{t:e,p:t}=c(i?this:this.material);return e[t]},set(e){const{t:t,p:s}=c(i?this:this.material);if((0,a.safeSetProperty)(t,s,e,!0),"function"==typeof r){const t=[s,e];if(r.name){const e=this[r.name];e===r?r.call(this,...t):e.name===`bound ${r.name}`?e(...t):r(...t)}else r(...t)}else(0,a.safeSetProperty)(i?this:this.material,"needsUpdate",!0,!0)}})}}function u(e,t,i){const r=e.userData,{backgroundRender:a,transparentRender:s,shadowMapRender:n,mainRenderPass:o,opaqueRender:l,transmissionRender:c,sceneRender:d,screenSpaceRendering:h}=r;void 0!==t.backgroundRender&&(r.backgroundRender=t.backgroundRender),void 0!==t.transparentRender&&(r.transparentRender=t.transparentRender),void 0!==t.shadowMapRender&&(r.shadowMapRender=t.shadowMapRender),void 0!==t.mainRenderPass&&(r.mainRenderPass=t.mainRenderPass),void 0!==t.opaqueRender&&(r.opaqueRender=t.opaqueRender),void 0!==t.sceneRender&&(r.sceneRender=t.sceneRender),void 0!==t.transmissionRender&&(r.transmissionRender=t.transmissionRender),void 0!==t.screenSpaceRendering&&(r.screenSpaceRendering=t.screenSpaceRendering),i(),r.backgroundRender=a,r.transparentRender=s,r.shadowMapRender=n,r.mainRenderPass=o,r.opaqueRender=l,r.sceneRender=d,r.transmissionRender=c,r.screenSpaceRendering=h}function m(e){const t=(new s.q).expandByObject(e,!0,!0).getCenter(new r.Pa4);e.position.sub(t),e.updateMatrix(),e.userData.autoCentered=!0,e.userData.isCentered=!0}function f(e,t,i){const a=.5*(new s.q).expandByObject(e,!0,!0).getSize(new r.Pa4).length();void 0===t&&(t=e.userData.autoScaleRadius||1);const n=t/a;return isFinite(n)&&(e.userData.pseudoCentered?e.children.forEach((e=>{e.scale.multiplyScalar(n)})):e.scale.multiplyScalar(n),(i||e.userData.isCentered)&&e.position.multiplyScalar(n),e.traverse((e=>{e.isLight&&e.shadow?.camera?.right&&(e.shadow.camera.right*=n,e.shadow.camera.left*=n,e.shadow.camera.top*=n,e.shadow.camera.bottom*=n),e.isCamera&&e.right&&(e.right*=n,e.left*=n,e.top*=n,e.bottom*=n)})),e.userData.autoScaled=!0,e.userData.autoScaleRadius=t,e.dispatchEvent({type:"objectUpdate"})),e}function g(e,t=-1){return(0,n.$1)(e,t)}},6755:function(e,t,i){i.d(t,{J:function(){return o}});var r=i(2988),a=i(6265),s=i(7245),n=i(9008);class o extends s.Hl{constructor(e){super({vertexShader:a.C.vertexShader,fragmentShader:n.glsl`
                uniform vec4 weight;
                uniform vec4 weight2;
                varying vec2 vUv;
                void main() {
                    vec4 texel = clamp(weight * tDiffuseTexelToLinear ( texture2D( tDiffuse, vUv ) ) + weight2 * tDiffuse2TexelToLinear ( texture2D( tDiffuse2, vUv ) ), vec4(0), vec4(8));
                    gl_FragColor = texel;
                    #include <encodings_fragment>
                }
            `,uniforms:{tDiffuse:{value:null},tDiffuse2:{value:e},weight:{value:new r.Ltg(1,1,1,1)},weight2:{value:new r.Ltg(1,1,1,1)}}},"tDiffuse","tDiffuse2"),this.clear=!1,this.needsSwap=!0}set weights2(e){this.uniforms.weight2.value.copy(e)}get weights2(){return this.uniforms.weight2.value}set weights1(e){this.uniforms.weight.value.copy(e)}get weights1(){return this.uniforms.weight.value}set blendTexture(e){this.uniforms.tDiffuse2.value=e}}},8284:function(e,t,i){i.d(t,{$:function(){return c}});var r=i(7245),a=i(2988),s=i(6265),n=i(6533),o=i(4107),l=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class c extends r.Hl{constructor(e,t,i="rgba"){super({vertexShader:s.C.vertexShader,fragmentShader:t+"uniform vec2 tDiffuseSize;uniform vec2 bilDirection;varying vec2 vUv;uniform bool smoothEnabled;uniform float edgeSharpness;vec4 bilaterialAO(){vec4 color=clamp((texture2D(tDiffuse,vUv.xy)).B_SRC_ACCESSOR,0.,5.);if(!smoothEnabled)return color;float depth;vec3 normal;getDepthNormal(vUv.xy,depth,normal);float gaussianWeights[4];gaussianWeights[0]=0.153170;gaussianWeights[1]=0.144893;gaussianWeights[2]=0.122649;gaussianWeights[3]=0.092902;float Z=gaussianWeights[0]+0.03;vec4 final_colour=Z*color;vec2 nuv;vec4 cc;float dp;vec3 nor;vec2 direction=bilDirection/tDiffuseSize.xy;\n#pragma unroll_loop_start\nfor(int i=0;i<6;i++){direction*=-1.;nuv=vUv+2.*direction*float(UNROLLED_LOOP_INDEX/2+1);getDepthNormal(nuv,dp,nor);if(dp<0.999){float normalCloseness=dot(normal,nor);normalCloseness*=normalCloseness;float normalError=(1.-normalCloseness)*8.;float normalWeight=max((1.-normalError*edgeSharpness),0.00);float depthWeight=max(0.,1.-edgeSharpness*4000.*abs(depth-dp));float kernelWeight=gaussianWeights[UNROLLED_LOOP_INDEX/2]+0.03;float bilateralWeight=kernelWeight*depthWeight*normalWeight;Z+=bilateralWeight;cc=clamp((texture2D(tDiffuse,nuv)).B_SRC_ACCESSOR,0.,5.);final_colour+=bilateralWeight*cc;}}\n#pragma unroll_loop_end\nfinal_colour/=Z;return final_colour;}void main(){vec4 ao=clamp(bilaterialAO(),vec4(0.),vec4(1.));gl_FragColor=ao;}",uniforms:{bilDirection:{value:new a.FM8(1,0)},tNormalDepth:{value:null},tDiffuse:{value:e.texture},tDiffuseSize:{value:new a.FM8}},defines:{B_SRC_ACCESSOR:i}},"tDiffuse"),this.smoothEnabled=!0,this.edgeSharpness=.1,this._target=e,this.clear=!1,this.needsSwap=!1}render(e,t,i,r,a){this.enabled&&(this.uniforms.bilDirection.value.set(1,0),this.uniforms.tDiffuse.value=this._target.texture,this.uniforms.tDiffuseSize.value.set(this.uniforms.tDiffuse.value?.image.width||0,this.uniforms.tDiffuse.value?.image.height||0),super.render(e,t,this._target,r,a),this.uniforms.bilDirection.value.set(0,1),this.uniforms.tDiffuse.value=t.texture,this.uniforms.tDiffuseSize.value.set(this.uniforms.tDiffuse.value?.image.width||0,this.uniforms.tDiffuse.value?.image.height||0),super.render(e,this._target,t,r,a))}}l([(0,o.qC)(),(0,n.e5)()],c.prototype,"smoothEnabled",void 0),l([(0,o.qC)(),(0,n.e5)()],c.prototype,"edgeSharpness",void 0)},3770:function(e,t,i){i.d(t,{J:function(){return n}});var r=i(2988),a=i(4915),s=i(6533);class n extends a.C{constructor(e,t,i=new r.Ilk(1,1,1),a=1){super(void 0,void 0,t,i,a),this.target=e,this._transparentMats=new Set,this._transmissiveMats=new Set}render(e,t,i,r,a){const n=e.getRenderTarget(),o=e.getActiveCubeFace(),l=e.getActiveMipmapLevel();this.scene?.traverse((({material:e})=>{e&&((e.transparent&&e.userData.renderToDepth||!e.transparent&&0===e.transmission&&!1===e.userData.renderToDepth)&&(this._transparentMats.add(e),e.transparent=!e.transparent),Math.abs(e.transmission||0)>0&&e.userData.renderToDepth&&(this._transmissiveMats.add([e,e.transmission]),e.transmission=0))})),(0,s.of)(e,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!0,transparentRender:!1,transmissionRender:!1,mainRenderPass:!1},(()=>super.render(e,t,this.target,r,a))),this._transparentMats.forEach((e=>e.transparent=!e.transparent)),this._transparentMats.clear(),this._transmissiveMats.forEach((([e,t])=>e.transmission=t)),this._transmissiveMats.clear(),e.setRenderTarget(n,o,l)}}},7245:function(e,t,i){i.d(t,{Hl:function(){return u},_y:function(){return p},mT:function(){return d}});var r=i(7848),a=i(2988),s=i(6533),n=i(4107),o=i(5551),l=i(9452);class c extends a.jyz{constructor(e,t=!1){super(e),this.typeSlug="shaderMat",this.assetType="material",this.materialObject=this,this.materialExtensions=[],this.isRawShaderMaterial=!1,this.extraUniformsToUpload={},t&&(this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"),this.materialExtensions=l.K.RegisterExtensions(this,e?.customMaterialExtensions??[])}registerMaterialExtensions(e){this.materialExtensions=[...this.materialExtensions,...l.K.RegisterExtensions(this,e)]}unregisterMaterialExtensions(e){}onBeforeCompile(e,t){l.K.ApplyMaterialExtensions(this,e,this.materialExtensions,t),this.dispatchEvent({type:"beforeCompile",shader:e,renderer:t}),e.fragmentShader=e.fragmentShader.replaceAll("#glMarker","// "),super.onBeforeCompile(e,t)}customProgramCacheKey(){return super.customProgramCacheKey()+l.K.CacheKeyForExtensions(this,this.materialExtensions)}onBeforeRender(e,t,i,r,a){super.onBeforeRender(e,t,i,r,a),this.dispatchEvent({type:"beforeRender",renderer:e,scene:t,camera:i,geometry:r,object:a})}onAfterRender(e,t,i,r,a){super.onAfterRender(e,t,i,r,a),this.dispatchEvent({type:"afterRender",renderer:e,scene:t,camera:i,geometry:r,object:a})}setDirty(e){this.needsUpdate=!0,this.dispatchEvent({...e,type:"materialUpdate"})}}class d extends c{constructor(){super(...arguments),this.typeSlug="shaderMat"}toJSON(e){throw new Error("Method not supported for this material.")}fromJSON(e,t){throw new Error("Method not supported for this material.")}copyProps(e){throw new Error("Method not supported for this material.")}}class h extends d{constructor(e,t){super(e),this.typeSlug="shaderMat",this.textures=[],this.setTextureIds(t)}setTextureIds(e){this.textures.map((e=>e.id)).join(";")!==e.join(";")&&(this.textures=e.map((e=>({id:e,colorSpace:a.aCh}))),this.setDirty())}_setUniformTexSize(e,t){if(!t||!e)return;const i=t.image?.width??512,r=t.image?.height??512,a=e.value;a.isVector2||console.warn("uniform is not a Vector2"),a&&Math.abs(a.x-i)+Math.abs(a.y-r)>.1&&(a.x=i,a.y=r,this.uniformsNeedUpdate=!0)}onBeforeRender(e,t,i,r,a){this._setUniformTexSize(this.uniforms.screenSize,e.getRenderTarget()?.texture);for(const e of this.textures){const t=e.id,i=this.uniforms[t]?.value;i&&(this._setUniformTexSize(this.uniforms[t+"Size"],i),i.colorSpace!==e.colorSpace&&(e.colorSpace=i.colorSpace,this.needsUpdate=!0))}super.onBeforeRender(e,t,i,r,a)}onBeforeCompile(e,t){e.fragmentShader=this.textures.map((e=>`uniform sampler2D ${e.id}; \n`+(0,s.Ux)(e.id??"input",e.colorSpace??a.aCh))).join("\n")+e.fragmentShader,super.onBeforeCompile(e,t)}customProgramCacheKey(){return super.customProgramCacheKey()+this.textures.map((e=>e.id+e.colorSpace)).join(";")}}function p(e,...t){const i=e.fragmentShader;return new h({defines:Object.assign({},e.defines),uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:i},t)}class u extends r.T{constructor(e,...t){super(e.isMaterial?e:p(e,...t),t.length<1?u.DEFAULT_TEX_ID:t[0]),this.onDirty=[],this.isShaderPass2=!0,this.enabled=!0,this.setDirty=this.setDirty.bind(this)}dispose(){this.material?.dispose?.(),this.fsQuad?.dispose?.(),this.onDirty=[]}setDirty(){this.onDirty.forEach((e=>e()))}updateShaderProperties(e){e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>e?.updateShaderProperties(this.material))))}render(e,t,i,r,a){this.enabled&&super.render(e,t||null,i,r,a)}}u.DEFAULT_TEX_ID="tDiffuse",function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);s>3&&n&&Object.defineProperty(t,i,n)}([(0,o.Q7)("Enabled"),(0,n.qC)()],u.prototype,"enabled",void 0)},4722:function(e,t,i){i.d(t,{$:function(){return m}});var r=i(3995),a=i(2988),s=i(9008),n=i(4821),o=i(6533),l=i(3198),c=i(2095),d=i(4107),h=i(5551),p=i(8670),u=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};let m=class extends r.Q{makeAnisotropic(e){const t=e.materialObject?.userData;if(!t)return!1;if(void 0===t._isAnisotropic){const e=t.__appliedMeshes;let i=!0;if(e)for(const{geometry:t}of e)!t||t.index&&t.attributes.position&&t.attributes.normal&&t.attributes.uv||(i=!1),i&&!t.attributes.tangent&&t.computeTangents();if(!i)return!1}return t._isAnisotropic=!0,void 0===t._anisotropyFactor&&(t._anisotropyFactor=1),void 0===t._anisotropyNoise&&(t._anisotropyNoise=0),void 0===t._anisotropyDirectionMode&&(t._anisotropyDirectionMode="DIRECTION"),e.materialObject.needsUpdate=!0,!0}_loaderCreate({loader:e}){e.isGLTFLoader2&&e.register((e=>new f(e)))}constructor(){super(),this.enabled=!0,this.dependencies=[n.k],this._defines={ANISOTROPY_DEBUG:!1},this._uniforms={anisotropyFactor:{value:1},anisotropyNoise:{value:1},anisotropyDirection:{value:1},anisotropyDirectionMap:{value:null},frameCount:{value:0}},this.materialExtension={shaderExtender:(e,t,i)=>{if(!this.enabled||!t.materialObject.userData._isAnisotropic)return;const r=t.materialObject.userData?._anisotropyDirectionMap,n=s.glsl`
                //#if ANISOTROPY_ENABLED
                ${l.Z}
                ${"uniform float anisotropyFactor;uniform float anisotropyNoise;\n#if ANISOTROPY_TEX_MODE == 0\nuniform float anisotropyDirection;\n#else\nuniform sampler2D anisotropyDirectionMap;\n#endif\nconst float MIN_ROUGHNESS=0.05;float D_GGX_Anisotropy(float at,float ab,float ToH,float BoH,float NoH){float a2=at*ab;highp vec3 d=vec3(ab*ToH,at*BoH,a2*NoH);highp float d2=dot(d,d);float b2=a2/d2;return a2*b2*b2*(1./PI);}float V_GGX_SmithCorrelated_Anisotropy(float at,float ab,float ToV,float BoV,float ToL,float BoL,float NoV,float NoL){float lambdaV=NoL*length(vec3(at*ToV,ab*BoV,NoV));float lambdaL=NoV*length(vec3(at*ToL,ab*BoL,NoL));float v=0.5/(lambdaV+lambdaL);return saturate(v);}vec3 indirectAnisotropyBentNormal(const in vec3 normal,const in vec3 viewDir,const in float roughness,const in vec3 anisotropicT,const in vec3 anisotropicB){vec3 aDirection=anisotropyFactor>=0.?anisotropicB:anisotropicT;vec3 aTangent=cross(aDirection,viewDir);vec3 aNormal=cross(aTangent,aDirection);float bendFactor=abs(anisotropyFactor)*saturate(5.*max(roughness,MIN_ROUGHNESS));return normalize(mix(normal,aNormal,bendFactor));}vec3 BRDF_GGX_Anisotropy(const in vec3 lightDir,const in vec3 viewDir,const in vec3 normal,const in vec3 f0,const in float f90,const in float roughness,const in vec3 anisotropicT,const in vec3 anisotropicB){float alpha=pow2(roughness);vec3 halfDir=normalize(lightDir+viewDir);float dotNL=saturate(dot(normal,lightDir));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float dotVH=saturate(dot(viewDir,halfDir));float dotTV=dot(anisotropicT,viewDir);float dotBV=dot(anisotropicB,viewDir);float dotTL=dot(anisotropicT,lightDir);float dotBL=dot(anisotropicB,lightDir);float dotTH=dot(anisotropicT,halfDir);float dotBH=dot(anisotropicB,halfDir);float aspect=sqrt(1.-min(1.-MIN_ROUGHNESS,abs(anisotropyFactor)*0.9));if(anisotropyFactor>0.)aspect=1./aspect;float at=roughness*aspect;float ab=roughness/aspect;vec3 F=F_Schlick(f0,f90,dotVH);float V=V_GGX_SmithCorrelated_Anisotropy(at,ab,dotTV,dotBV,dotTL,dotBL,dotNV,dotNL);float D=D_GGX_Anisotropy(at,ab,dotTH,dotBH,dotNH);return F*(V*D);}"}
            `+(r?(0,o.N6)("anisotropyDirectionMap",r,i.capabilities.isWebGL2):"")+"\n";e.fragmentShader=(0,p.p)(e.fragmentShader,"#include <common>",n,{append:!0}),e.fragmentShader=e.fragmentShader.replace("#include <lights_fragment_begin>",a.WdD.lights_fragment_begin),e.fragmentShader=(0,p.p)((0,p.p)(e.fragmentShader,"IncidentLight directLight;","float rnd=(random2(vUv.xy,frameCount)-0.5)*anisotropyNoise*material.roughness;\n#if ANISOTROPY_TEX_MODE < 2\n#if ANISOTROPY_TEX_MODE == 0 \nfloat rot=saturate(anisotropyDirection);\n#else \nfloat rot=(anisotropyDirectionMapTexelToLinear(texture2D(anisotropyDirectionMap,vUv)).r);\n#endif\nrot=rot*2.*PI+rnd;vec2 rot2=vec2(sin(rot),cos(rot));\n#else \nvec2 rot2=(anisotropyDirectionMapTexelToLinear(texture2D(anisotropyDirectionMap,vUv)).rg*2.-1.)+vec2(rnd,rnd);rot2=normalize(rot2);const float anisoSpecMultiplier=0.25;float matSpecAniso=(length(material.specularColor.rgb))*2.*PI;rot2=mix(rot2,vec2(sin(matSpecAniso),cos(matSpecAniso)),anisoSpecMultiplier);rot2=normalize(rot2);\n#endif\nvec3 anisotropicT=(tbn[0]*rot2.x+tbn[1]*rot2.y);anisotropicT=normalize(anisotropicT-normal*dot(anisotropicT,normal));vec3 anisotropicB=normalize(cross(normal,anisotropicT));",{prepend:!0}),"RE_Direct( directLight, geometry, material, reflectedLight )","RE_Direct( directLight, geometry, material, reflectedLight, anisotropicT, anisotropicB )",{replaceAll:!0});let c=(0,p.p)(a.WdD.lights_physical_pars_fragment,"void RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {","void RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight, const in vec3 anisotropicT, const in vec3 anisotropicB ) {");c=(0,p.p)(c,"BRDF_GGX( directLight.direction, geometry.viewDir, geometry.normal, material )","BRDF_GGX_Anisotropy( directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularF90, material.roughness, anisotropicT, anisotropicB )"),e.fragmentShader=(0,p.p)(e.fragmentShader,"#include <lights_physical_pars_fragment>",c),e.fragmentShader=(0,p.p)(e.fragmentShader,"#include <normal_fragment_begin>",a.WdD.normal_fragment_begin),e.fragmentShader=(0,p.p)(e.fragmentShader,"#ifdef USE_NORMALMAP_TANGENTSPACE","#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_TANGENT )");let d=s.glsl`
                #if defined( USE_ENVMAP )
                vec3 anisotropyBentNormal = indirectAnisotropyBentNormal(geometry.normal, geometry.viewDir, material.roughness, anisotropicT, anisotropicB);
                #endif
            `+a.WdD.lights_fragment_maps;d=(0,p.p)(d,"getIBLIrradiance( geometry.normal )","getIBLIrradiance( anisotropyBentNormal )"),d=(0,p.p)(d,"getIBLRadiance( geometry.viewDir, geometry.normal, material.roughness )","getIBLRadiance( geometry.viewDir, anisotropyBentNormal, material.roughness )"),e.fragmentShader=(0,p.p)(e.fragmentShader,"#include <lights_fragment_maps>",d),e.defines.USE_UV="",e.vertexTangents=!0},onObjectRender:(e,t)=>{const i=t.materialObject.userData;if(!i?._isAnisotropic)return;const r=e;if(!r.isMesh||!r.geometry)return;if(!r.geometry.attributes.tangent)throw new Error("No tangents on the geometry");this._uniforms.anisotropyFactor.value=i._anisotropyFactor,this._uniforms.anisotropyNoise.value=i._anisotropyNoise,this._uniforms.anisotropyDirectionMap.value=i._anisotropyDirectionMap?.isTexture?i._anisotropyDirectionMap:null,this._uniforms.anisotropyDirection.value=i._anisotropyDirection;let a=this.enabled?1:0;t.materialObject.defines.ANISOTROPY_ENABLED!==a&&(t.materialObject.defines.ANISOTROPY_ENABLED=a,t.materialObject.needsUpdate=!0),a=+this._defines.ANISOTROPY_DEBUG,t.materialObject.defines.ANISOTROPY_DEBUG!==a&&(t.materialObject.defines.ANISOTROPY_DEBUG=a,t.materialObject.needsUpdate=!0),a=i._anisotropyDirectionMode,this._uniforms.anisotropyDirectionMap.value||(a="CONSTANT"),a="DIRECTION"===a?2:"ROTATION"===a?1:0,t.materialObject.defines.ANISOTROPY_TEX_MODE!==a&&(t.materialObject.defines.ANISOTROPY_TEX_MODE=a,t.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:e=>(this.enabled?"1":"0")+(e.materialObject.userData?._isAnisotropic?"1":"0")+e.materialObject.userData?._anisotropyDirectionMap?.uuid,isCompatible:e=>e.isMeshStandardMaterial2,updaters:()=>[this._viewer?.renderer],getUiConfig:e=>{const t=this._viewer,i=this.makeAnisotropic,r={type:"folder",label:"Anisotropy",children:[{type:"checkbox",label:"Enabled",get value(){return e.materialObject.userData._isAnisotropic||!1},set value(a){a!==e.materialObject.userData._isAnisotropic&&(a?i(e)||t.alert("One or more geometries cannot be made anisotropic."):(e.materialObject.userData._isAnisotropic=!1,e.materialObject.needsUpdate=!0),r.uiRefresh?.("postFrame",!0))},onChange:this.setDirty},{type:"slider",label:"Factor",bounds:[-2,2],hidden:()=>!e.materialObject.userData._isAnisotropic,property:[e.materialObject.userData,"_anisotropyFactor"],onChange:this.setDirty},{type:"slider",label:"Noise",bounds:[0,2],hidden:()=>!e.materialObject.userData._isAnisotropic,property:[e.materialObject.userData,"_anisotropyNoise"],onChange:this.setDirty},{type:"image",label:"Texture",hidden:()=>!e.materialObject.userData._isAnisotropic,property:[e.materialObject.userData,"_anisotropyDirectionMap"],onChange:()=>{e.materialObject.needsUpdate=!0,this.setDirty()}},{type:"dropdown",label:"Mode",hidden:()=>!e.materialObject.userData._isAnisotropic,property:[e.materialObject.userData,"_anisotropyDirectionMode"],children:["CONSTANT","ROTATION","DIRECTION"].map((e=>({label:e}))),onChange:()=>{e.materialObject.needsUpdate=!0,this.setDirty()}}]};return r}},this.setDirty=()=>{this.materialExtension.setDirty?.(),this._viewer?.setDirty()},this.makeSelectedAnisotropic=()=>{const e=this._viewer?.getPlugin(c.l)?.getSelectedObject()?.material;return"material"===e?.assetType&&this.makeAnisotropic(e)},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(e){await super.onAdded(e);const t=e.getPlugin(n.k);t?.materials?.registerMaterialExtension(this.materialExtension),t?.importer?.addEventListener("loaderCreate",this._loaderCreate),t?.exporter?.getExporter("gltf","glb")?.extensions?.push(g)}async onRemove(e){return e.getPlugin(n.k)?.materials?.unregisterMaterialExtension(this.materialExtension),e.getPlugin(n.k)?.importer?.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(e)}};m.PluginType="AnisotropyPlugin",m.ANISOTROPY_GLTF_EXTENSION="WEBGI_materials_anisotropy",u([(0,h.Q7)("Enabled",(e=>({onChange:e.setDirty}))),(0,d.qC)()],m.prototype,"enabled",void 0),u([(0,h.M)("Make Anisotropy",(e=>({hidden:()=>!e._viewer?.getPlugin(c.l)})))],m.prototype,"makeSelectedAnisotropic",void 0),m=u([(0,h.Sp)("Anisotropy Materials")],m);class f{constructor(e){this.parser=e,this.name=m.ANISOTROPY_GLTF_EXTENSION}async extendMaterialParams(e,t){const i=this.parser,r=i.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const s=[],n=r.extensions[this.name];t.userData||(t.userData={}),t.userData._isAnisotropic=!0,t.userData._anisotropyFactor=n.anisotropyFactor??0,t.userData._anisotropyNoise=n.anisotropyNoiseFactor??n.anisotropyNoise??0;let{anisotropyDirectionMode:o,anisotropyDirection:l}=n;return o||(o=n.anisotropyTextureMode),l||(l=n.anisotropyRotation),t.userData._anisotropyDirectionMode=o&&"number"==typeof l?.index?o:"CONSTANT","ROTATION"===o||"DIRECTION"===o?s.push(i.assignTexture(t.userData,"_anisotropyDirectionMap",l).then((e=>{e.colorSpace=a.KI_}))):t.userData._anisotropyDirection=l??0,Promise.all(s)}afterRoot(e){return e.scene?.traverse((e=>{const t=e.material?.userData?._isAnisotropic;if(!t)return;const i=e.geometry;i.attributes.tangent||(i.computeTangents(),i.attributes.tangent.needsUpdate=!0)})),null}}const g=e=>({writeMaterial:(t,i)=>{if(!t.isMeshStandardMaterial||!t.userData._isAnisotropic)return;if((t.userData._anisotropyFactor||0)<.001)return;i.extensions=i.extensions||{};const r={};if(r.anisotropyFactor=t.userData._anisotropyFactor||1,r.anisotropyNoiseFactor=t.userData._anisotropyNoise||0,r.anisotropyDirectionMode=t.userData._anisotropyDirectionMode||"CONSTANT",t.userData._anisotropyDirectionMap&&"CONSTANT"!==r.anisotropyDirectionMode){const i={index:e.processTexture(t.userData._anisotropyDirectionMap)};e.applyTextureTransform(i,t.userData._anisotropyDirectionMap),r.anisotropyDirection=i}else r.anisotropyDirectionMode="CONSTANT",r.anisotropyDirection=t.userData._anisotropyDirection||0;i.extensions[m.ANISOTROPY_GLTF_EXTENSION]=r,e.extensionsUsed[m.ANISOTROPY_GLTF_EXTENSION]=!0}})},9228:function(e,t,i){i.d(t,{g:function(){return c}});var r=i(2988),a=i(3995),s=i(4107),n=i(4821),o=i(9008),l=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class c extends a.Q{get enabled(){return this.visible}set enabled(e){this.visible=e}get material(){return this._material}get mesh(){return this._iMesh}constructor(e={}){super(),this._transformNeedRefresh=!0,this.dependencies=[n.k],this.visible=!0,this.size=8,this.yOffset=0,this.renderToDepth=!0,this.tonemapGround=!0,this.limitCameraAboveGround=!1,this.enableRefreshTransform=!0,this._cameraLimitsSet=!1,this._cameraLastMaxPolarAngle=Math.PI,this._refreshMaterial=this._refreshMaterial.bind(this),this._refreshTransform=this._refreshTransform.bind(this),this._refreshCameraLimits=this._refreshCameraLimits.bind(this),this.refreshOptions=this.refreshOptions.bind(this),this._refreshOptions2=this._refreshOptions2.bind(this),this._onSceneUpdate=this._onSceneUpdate.bind(this),this._preRender=this._preRender.bind(this),this._postFrame=this._postFrame.bind(this),this._geometry=new r._12(1,1,1,1),this._geometry.attributes.uv2=this._geometry.attributes.uv.clone(),this._geometry.attributes.uv2.needsUpdate=!0,this._options={shape:"",up:[0,100,0],autoAdjustTransform:!0},this.setOptions(e)}get autoAdjustTransform(){return this._options.autoAdjustTransform}set autoAdjustTransform(e){this._options.autoAdjustTransform=e,this.refreshTransform()}_createMesh(){return new r.Kj0(this._geometry)}async onAdded(e){await super.onAdded(e),e.getPluginByType("TweakpaneUi")&&console.error("TweakpaneUiPlugin must be added after Ground Plugin"),this._manager=e.getPlugin(n.k);const t=this._createMesh();t.userData.physicsMass=0,this._iMesh=await(this._manager?.addImportedSingle(t,{pseudoCenter:!1,autoScale:!1,addToRoot:!0})),this._mesh=this._iMesh?.modelObject,this._mesh&&(this._mesh.userData.userSelectable=!1,this._mesh.castShadow=!0,this._mesh.receiveShadow=!0,this._mesh.name="Ground Plane"),e.scene.addEventListener("sceneUpdate",this._onSceneUpdate),e.scene.addEventListener("addSceneObject",this._onSceneUpdate),e.addEventListener("preRender",this._preRender),e.addEventListener("postFrame",this._postFrame),this.refreshOptions()}_postFrame(){this._transformNeedRefresh&&this._refreshTransform(),this._viewer}_preRender(){this._viewer}async onDispose(e){return this._removeMaterial(),this._geometry.dispose(),this._material?.dispose(),this._iMesh?.dispose?.(),super.onDispose(e)}async onRemove(e){return this._removeMaterial(),e.scene.removeEventListener("sceneUpdate",this._onSceneUpdate),e.scene.removeEventListener("addSceneObject",this._onSceneUpdate),e.removeEventListener("postFrame",this._postFrame),e.removeEventListener("preRender",this._preRender),this._manager=void 0,super.onRemove(e)}_removeMaterial(){this._material&&(this._material.userData.renderToDepth=this._material.userData.__renderToDepth,this._material.userData.__renderToDepth=void 0,this._material=void 0)}_onSceneUpdate(e){!1!==e?.geometryChanged&&!1!==e?.updateGround&&this.refreshTransform()}refreshTransform(){this.enableRefreshTransform&&(this._transformNeedRefresh=!0)}_refreshOptions2(){this.refreshOptions()}refreshOptions(){this._viewer&&(this._refreshMaterial(),this.refreshTransform(),this._refreshCameraLimits())}_refreshCameraLimits(){const e=this._viewer?.scene.activeCamera.controls;e&&(void 0!==e.maxPolarAngle?this.limitCameraAboveGround?(this._cameraLimitsSet||(this._cameraLastMaxPolarAngle=e.maxPolarAngle),e.maxPolarAngle=Math.PI/2,this._cameraLimitsSet=!0):this._cameraLimitsSet&&(e.maxPolarAngle=this._cameraLastMaxPolarAngle,this._cameraLimitsSet=!1):console.warn("refreshCameraLimits only available with orbit controls."))}_refreshTransform(){if(!this._mesh)return;if(!this._viewer)return;let e=!1;if(this.visible!==this._mesh.visible&&(this._mesh.visible=this.visible,e=!0),this.enabled){if(this._options.autoAdjustTransform){this._mesh.userData.bboxVisible=!1;const t=this._viewer.scene.getBounds(!0);this._mesh.userData.bboxVisible=!0;const i=t.getCenter(new r.Pa4).sub(new r.Pa4(0,t.getSize(new r.Pa4).y/2+this.yOffset,0));e=e||i.clone().sub(this._mesh.position).length()>1e-4,e&&this._mesh.position.copy(i)}e=e||Math.abs(this._mesh.scale.x-this.size)>1e-4,e&&(this._mesh.scale.setScalar(this.size),this._mesh.setRotationFromEuler(new r.USm(-Math.PI/2,0,this._mesh.rotation.z)),this._mesh.matrixWorldNeedsUpdate=!0,this._mesh.setDirty?.()),this._transformNeedRefresh=!1}else e&&this._viewer?.scene.setDirty()}_refreshMaterial(){if(!this._viewer)return!1;if(!this.enabled)return!1;this._manager||console.error("GroundPlugin requires asset manager");const e=this._material??this._manager?.materials?.findOrCreate("standard",{name:"BaseGroundMaterial",runtimeMaterial:!0,color:16777215});e&&e.userData.runtimeMaterial;let t=!1;if(e!==this._material){this._removeMaterial(),e&&(this._material=e);const i=this._material?.uuid;i||console.warn("No material found for ground"),this._viewer.scene.setDirty(),this._mesh&&this._material&&(this._material.roughness=.2,this._material.metalness=.5,(this._mesh?.setMaterial??(e=>{this._mesh&&(this._mesh.material=e.materialObject)}))(this._material)),t=!0}return this._material&&(void 0===this._material.userData.__renderToDepth&&(this._material.userData.__renderToDepth=this._material.userData.renderToDepth),this._material.userData.renderToDepth!==this.renderToDepth&&(this._material.userData.renderToDepth=this.renderToDepth),void 0===this._material.userData.__postTonemap&&(this._material.userData.__postTonemap=this._material.userData.postTonemap),this._material.userData.postTonemap!==this.tonemapGround&&(this._material.userData.postTonemap=this.tonemapGround),this._material.materialObject.userData.ssaoDisabled=!0,this._material.materialObject.userData.sscsDisabled=!0),this._viewer.setDirty(this),t}setOptions(e){Object.assign(this._options,e),this.refreshOptions()}fromJSON(e,t){return super.fromJSON(e,t)?(this.refreshOptions(),this):null}_extraUiConfig(){return[()=>this._material?.uiConfig]}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Ground",children:[{label:"Visible",type:"checkbox",property:[this,"visible"],limitedUi:!0},{label:"Size",type:"input",property:[this,"size"],limitedUi:!0},{label:"Render to Depth",type:"checkbox",property:[this,"renderToDepth"]},{label:"Limit Camera",type:"checkbox",property:[this,"limitCameraAboveGround"]},{label:"Tonemap",type:"checkbox",property:[this,"tonemapGround"]},{label:"Height",type:"slider",bounds:[-2,2],property:[this,"yOffset"]},{label:"Auto adjust transform",type:"checkbox",property:[this,"autoAdjustTransform"]},...this._extraUiConfig()]}}}l([(0,s.qC)("material")],c.prototype,"_material",void 0),l([(0,o.onChange)(c.prototype.refreshTransform),(0,s.qC)()],c.prototype,"visible",void 0),l([(0,o.onChange2)(c.prototype._onSceneUpdate),(0,s.qC)()],c.prototype,"size",void 0),l([(0,o.onChange2)(c.prototype._onSceneUpdate),(0,s.qC)()],c.prototype,"yOffset",void 0),l([(0,o.onChange)(c.prototype._refreshOptions2),(0,s.qC)()],c.prototype,"renderToDepth",void 0),l([(0,o.onChange)(c.prototype._refreshOptions2),(0,s.qC)()],c.prototype,"tonemapGround",void 0),l([(0,o.onChange)(c.prototype._refreshCameraLimits),(0,s.qC)()],c.prototype,"limitCameraAboveGround",void 0)},5254:function(e,t,i){i.d(t,{d:function(){return y}});var r,a=i(6265),s=i(2988),n=i(7245),o=i(9008),l=i(6533),c=i(4107),d=i(5551),h=i(9033),p=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};let u=r=class extends n.Hl{constructor(){super({vertexShader:a.C.vertexShader,defines:{PASS_STEP:1},uniforms:{tSource:{value:null},tDiffuse:{value:null},opacity:{value:1},tDiffuseSize:{value:new s.FM8},weight:{value:1},tNormalDepth:{value:null},tGBufferFlags:{value:null}},fragmentShader:h.Z+"\nuniform float intensity;uniform float opacity;uniform vec2 tDiffuseSize;varying vec2 vUv;uniform float weight;\n#if PASS_STEP == 0\nuniform vec4 prefilter;vec4 Prefilter(vec4 c){if(getDepth(vUv)>0.999){return vec4(0.);}float brightness=max(c.r,max(c.g,c.b));float soft=brightness+prefilter.x*(prefilter.y-1.);soft=clamp(soft,0.,prefilter.z);soft=soft*soft*prefilter.w;float contribution=max(soft,brightness-prefilter.x);contribution/=max(brightness,0.001);return vec4(c.rgb*contribution,c.a);}\n#endif\nvec4 Sample(vec2 uv){return tDiffuseTexelToLinear(texture2D(tDiffuse,uv));}vec4 SampleBox(vec2 uv,float delta){vec4 o=vec2(-delta,delta).xxyy/tDiffuseSize.xyxy;vec4 s=Sample(uv+o.xy)+Sample(uv+o.zy)+Sample(uv+o.xw)+Sample(uv+o.zw);return s*0.25;}int getBloomBit(in int number){\n#ifdef WebGL2Context\nreturn(number/4)%2;\n#else\nreturn int(mod(floor(float(number)/4.),2.));\n#endif\n}void main(){\n#if PASS_STEP == 0 \nint doBloom=getBloomBit(getGBufferFlags(vUv).a);gl_FragColor=float(doBloom)*weight*Prefilter(SampleBox(vUv,1.));gl_FragColor.a=1.;\n#elif PASS_STEP == 1 \ngl_FragColor=weight*(SampleBox(vUv,1.));gl_FragColor.a=1.;\n#elif PASS_STEP == 2 \ngl_FragColor=(SampleBox(vUv,0.5));gl_FragColor.a=1.;\n#elif PASS_STEP == 3 \nvec4 texel=tSourceTexelToLinear(texture2D(tSource,vUv));vec4 bloom=intensity*SampleBox(vUv,0.5).rgba;float brightness=max(bloom.r,max(bloom.g,bloom.b));texel.rgb+=bloom.rgb;texel.a=min(1.,texel.a+brightness);gl_FragColor=texel;\n#elif PASS_STEP == 4 \nvec4 texel=vec4(0.);texel.rgb+=intensity*SampleBox(vUv,0.5).rgb;texel.a=1.;gl_FragColor=texel;\n#endif\n#include <encodings_fragment>\n}"},"tDiffuse","tSource"),this.uiConfig=void 0,this.prefilter=new s.Ltg(2,.5,0,0),this.threshold=2,this.softThreshold=.5,this.intensity=.2,this.bloomIterations=4,this.radius=.6,this.power=1,this.bloomDebug=!1,this._weights=[],this._updateWeights=this._updateWeights.bind(this),this._thresholdsUpdated=this._thresholdsUpdated.bind(this),this._updateWeights(),this._thresholdsUpdated(),this.clear=!0,this.userData={setDirty:()=>{this.setDirty()}}}_thresholdsUpdated(){this.prefilter.x=this.threshold,this.prefilter.y=this.softThreshold,this.prefilter.z=2*this.prefilter.x*this.prefilter.y,this.prefilter.w=.125/(this.uniforms.prefilter.value.z+1e-5)}render(e,t,i,r,a){const n=e.baseRenderer;this.material.defines.PASS_STEP=0,this.clear=!0;const o=i;let l=.5,c=o.width*l,d=o.height*l;const h=[];let p=n.getTempTarget({sizeMultiplier:1,type:s.cLu});h.push(p);let u=o;this.material.needsUpdate=!0,this.material.uniforms.weight.value=this._weights[0],super.render(e,p,u,r,a),u=p;let m=1;for(;m<this.bloomIterations&&(c/=2,d/=2,l/=2,!(d<2||c<2));m++){p=n.getTempTarget({sizeMultiplier:l,type:s.cLu}),h.push(p),this.material.defines.PASS_STEP=1;let t=this._weights[m];t=0!==this._weights[m-1]?this._weights[m]/this._weights[m-1]:this._weights[m],this.material.uniforms.weight.value=t,this.material.needsUpdate=!0,super.render(e,p,u,r,a),u=p}this.clear=!1;const f=e.autoClear;for(e.autoClear=!1,m-=2;m>=0;m--)p=h[m],h[m]=void 0,this.material.defines.PASS_STEP=2,this.material.transparent=!0,this.material.blending=s.WMw,this.material.needsUpdate=!0,e.autoClear=!1,super.render(e,p,u,r,a),this.material.blending=s.jFi,n.releaseTempTarget(u),u=p;this.clear=!0,e.autoClear=f,e.autoClear=!0,this.bloomDebug?(this.material.defines.PASS_STEP=4,this.material.needsUpdate=!0,super.render(e,t,u,r,a)):(this.uniforms.tSource.value=o.texture,this.material.defines.PASS_STEP=3,this.material.needsUpdate=!0,super.render(e,t,u,r,a),this.uniforms.tSource.value=null),n.releaseTempTarget(u)}_updateWeights(){if(!this._weights)return;const e=Math.max(Math.min(this.radius,1),0),t=1/(this.bloomIterations-1);for(let i=0;i<this.bloomIterations;i++){let r=i*t+.1,a=1.2-r;r=Math.pow(r,this.power),a=Math.pow(a,this.power),this._weights[i]=a*(1-e)+r*e}this.setDirty()}};p([(0,l.e5)()],u.prototype,"prefilter",void 0),p([(0,d.t8)("Threshold",[0,2]),(0,o.onChange)(r.prototype._thresholdsUpdated),(0,c.qC)()],u.prototype,"threshold",void 0),p([(0,d.t8)("Soft Threshold",[0,1]),(0,o.onChange)(r.prototype._thresholdsUpdated),(0,c.qC)()],u.prototype,"softThreshold",void 0),p([(0,d.t8)("Intensity",[0,3]),(0,c.qC)(),(0,l.e5)()],u.prototype,"intensity",void 0),p([(0,d.t8)("Iterations",[0,7],1),(0,o.onChange)(r.prototype._updateWeights),(0,c.qC)()],u.prototype,"bloomIterations",void 0),p([(0,d.t8)("Radius",[0,1],.01),(0,o.onChange)(r.prototype._updateWeights),(0,c.qC)()],u.prototype,"radius",void 0),p([(0,d.t8)("Power",[.2,10],.01),(0,o.onChange)(r.prototype._updateWeights),(0,c.qC)()],u.prototype,"power",void 0),p([(0,d.Q7)("Debug")],u.prototype,"bloomDebug",void 0),u=r=p([(0,d.Sp)("Bloom")],u);var m=i(4895),f=i(6757),g=i(9354),v=i(8570),_=i(4821);class y extends m.G{constructor(){super(...arguments),this.passId="bloom",this._beforeFilters=["combinedPost","screen"],this._afterFilters=["render","progressive"],this._requiredFilters=["render"],this.materialExtension={uuid:(0,v.Z)(),getUiConfig:e=>{if(e.__uiConfigs||(e.__uiConfigs={}),e.__uiConfigs[this.materialExtension.uuid])return e.__uiConfigs[this.materialExtension.uuid];const t=this._getUiConfig(e);return e.__uiConfigs[this.materialExtension.uuid]=t,t},isCompatible:e=>!0}}setDirty(){this.pass.dirty=!0}_getUiConfig(e){const t={type:"folder",label:"Bloom",children:[{type:"checkbox",label:"Enabled",get value(){return e.materialObject.userData[y.PluginType]?.enable??!0},set value(i){const r=e.materialObject.userData[y.PluginType];i!==r?.enable&&(r||function(e){const t=e?.userData;t&&(t[y.PluginType]||(t[y.PluginType]={}),t[y.PluginType].enable=!0,e.isMaterial&&(e.needsUpdate=!0))}(e.materialObject),e.materialObject.userData[y.PluginType].enable=i,t.uiRefresh?.("postFrame",!0))},onChange:this.setDirty}]};return t}passCtor(e){const t=new u;return this.updateGBuffer=this.updateGBuffer.bind(this),this.setDirty=this.setDirty.bind(this),t}async onAdded(e){await super.onAdded(e),e.getPlugin(f.m)?.registerGBufferUpdater(this.updateGBuffer);const t=e.getPlugin(_.k);t?.materials?.registerMaterialExtension(this.materialExtension)}updateGBuffer(e,t){if(e instanceof s.Kj0&&e.material?.userData){const i=e.material?.userData[y.PluginType],r=!1===i?.enable?0:1;t.w=(0,g.s)(t.w,2,r)}}_update(e){return e.getPlugin(f.m)?.updateShaderProperties(this.pass?.passObject.material),super._update(e)}get uiConfig(){return this.pass?.passObject.uiConfig}}y.PluginType="Bloom"},3036:function(e,t,i){i.d(t,{it:function(){return u},pQ:function(){return f},qK:function(){return m},td:function(){return g}});var r=i(3995),a=i(2988),s=i(4107),n=i(2307),o=i(5551),l=i(3206),c=i(9008),d=i(1191),h=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};let p=1,u=class{constructor(e,t,i,r,s){this.position=new a.Pa4,this.target=new a.Pa4,this.quaternion=new a._fP,this.up=new a.Pa4,this.name="Camera View",this.snap="",this.focusView=()=>{},this.deleteView=()=>{},this.updateView=()=>{},this.uiConfig=(0,o.YH)(this.name,this),e&&(this.position=e),t&&(this.target=t),i&&(this.up=i),r&&(this.quaternion=r),s&&(this.snap=s),this.name="#view"+p++}_nameChanged(){this.uiConfig&&(this.uiConfig.label=this.name,this.uiConfig.uiRefresh?.())}};h([(0,s.qC)(),(0,o.KG)()],u.prototype,"position",void 0),h([(0,s.qC)(),(0,o.KG)()],u.prototype,"target",void 0),h([(0,s.qC)(),(0,o.KG)()],u.prototype,"quaternion",void 0),h([(0,s.qC)(),(0,o.KG)()],u.prototype,"up",void 0),h([(0,s.qC)(),(0,o.ri)()],u.prototype,"name",void 0),h([(0,o.w8)()],u.prototype,"snap",void 0),h([(0,o.M)()],u.prototype,"focusView",void 0),h([(0,o.M)()],u.prototype,"deleteView",void 0),h([(0,o.M)()],u.prototype,"updateView",void 0),u=h([(0,s.Bg)("CameraView")],u);class m extends r.Q{get animationLooping(){return this._animationLooping}get animating(){return this._animating}constructor(){super(),this.enabled=!0,this._cameraViews=[],this.viewLooping=!1,this.viewPauseTime=200,this.animEase="easeInOutSine",this.animDuration=1e3,this.rotationOffset=.25,this.interpolateMode="spherical",this.animateOnScroll=!1,this.seekOnScroll=!1,this._animating=!1,this.dependencies=[],this._scrollAnimationState=0,this.scrollAnimationDamping=.1,this._updaters=[],this._lastFrameTime=0,this._fadeDisabled=!1,this._viewQueue=[],this._animationLooping=!1,this._infiniteLooping=!0,this._driver=e=>({start:()=>this._updaters.push({u:e,time:0}),stop:()=>this._updaters.splice(this._updaters.findIndex((t=>t.u===e)),1)}),this.focusNext=(e=!0)=>{if(this._animating)return;if(this._cameraViews.length<2)return;let t=this._cameraViews.findIndex((e=>e===this._currentView));t<0&&(t=-1),t+=1,e?t%=this._cameraViews.length:t=Math.min(t,this._cameraViews.length-1),this.focusView(this._cameraViews[t])},this.focusPrevious=(e=!0)=>{if(this._animating)return;if(this._cameraViews.length<2||!this._currentView)return;let t=this._cameraViews.findIndex((e=>e===this._currentView));t<0&&(t=0),t-=1,t=e?(t+this._cameraViews.length)%this._cameraViews.length:Math.max(t,0),this.focusView(this._cameraViews[t])},this._popAnimations=[],this.uiConfig={type:"folder",label:"Camera Views",children:[()=>[...this._cameraViews.map((e=>e.uiConfig))],...(0,o._t)(this)]},this.addCurrentView=this.addCurrentView.bind(this),this.animateAllViews=this.animateAllViews.bind(this),this.recordAllViews=this.recordAllViews.bind(this),this.resetToFirstView=this.resetToFirstView.bind(this),this._wheel=this._wheel.bind(this),this._pointerMove=this._pointerMove.bind(this),this._postFrame=this._postFrame.bind(this)}get camViews(){return this._cameraViews}_wheel(e){this.enabled&&(this.seekOnScroll&&!this._animating||Math.abs(e.deltaY)>.001&&(this._scrollAnimationState=-1*Math.sign(e.deltaY)))}_pointerMove(e){if(this.enabled&&!this._animating&&this.seekOnScroll){const t=this._viewer?.scene.activeCamera;if(!t)return;const i=new a.$V,r=t.position,s=t.target,n=(new a._fP).setFromUnitVectors(t.cameraObject.up,new a.Pa4(0,1,0)),o=n.clone().invert(),l=r.clone().sub(s);l.applyQuaternion(n),i.setFromVector3(l),i.theta+=this.rotationOffset*e.movementX/this._viewer.canvas.clientWidth,i.phi+=this.rotationOffset*e.movementY/this._viewer.canvas.clientHeight,i.makeSafe(),l.setFromSpherical(i),l.applyQuaternion(o),r.copy(s).add(l),t.positionUpdated(!1),t.targetUpdated()}}async onAdded(e){await super.onAdded(e);let t=!1;e.addEventListener("preFrame",(e=>{this.seekOnScroll||this._animating?this._viewer.scene.activeCamera.interactionsEnabled&&(this._viewer.scene.activeCamera.interactionsEnabled=!1,t=!0):t&&(this._viewer.scene.activeCamera.interactionsEnabled=!0,t=!1)})),e.addEventListener("postFrame",this._postFrame),window.addEventListener("wheel",this._wheel),window.addEventListener("pointermove",this._pointerMove)}_postFrame(){if(!this._viewer)return;if(!this.enabled||!this._animating)return this._lastFrameTime=0,void(this._fadeDisabled&&(this._viewer.getPluginByType("FrameFade")?.enable(m.PluginType),this._fadeDisabled=!1));const e=(0,c.now)()/1e3;this._lastFrameTime<1&&(this._lastFrameTime=e-1/60);let t=e-this._lastFrameTime;this._lastFrameTime=e,t*=this.animateOnScroll?this._scrollAnimationState:1;const i=this._viewer.getPluginByType("Progressive")?.postFrameConvergedRecordingDelta();if(i&&i>0&&(t=i),0!==i&&(t*=1e3,!(t<=0||(this._updaters.forEach((e=>{let i=t;e.time+i<0&&(i=-e.time),e.time+=i,Math.abs(i)>.001&&e.u(i)})),this._scrollAnimationState<.001?this._scrollAnimationState=0:this._scrollAnimationState*=1-this.scrollAnimationDamping,this._fadeDisabled)))){const e=this._viewer.getPluginByType("FrameFade");e&&(e.disable(m.PluginType),this._fadeDisabled=!0)}}async onRemove(e){return e.removeEventListener("postFrame",this._postFrame),window.removeEventListener("wheel",this._wheel),window.removeEventListener("pointermove",this._pointerMove),super.onRemove(e)}async _animationLoop(){if(!this._animationLooping){for(this._animationLooping=!0;(this.viewLooping||!this._infiniteLooping)&&this.enabled&&!(this._cameraViews.length<1);){if(0===this._viewQueue.length){if(!this._infiniteLooping)break;this._viewQueue.push(...this._cameraViews)}await this.animateToView(this._viewQueue.shift()),await(0,c.timeout)(2+this.viewPauseTime)}this._animationLooping=!1}}async animateAllViews(){if(this.enabled&&!(this.viewLooping||this._cameraViews.length<2)){for(;this._viewQueue.length>0;)this._viewQueue.pop();this._viewQueue.push(...this._cameraViews),this._viewQueue.push(this._viewQueue.shift()),this._infiniteLooping=!1,await this._animationLoop(),this._infiniteLooping=!0}}async resetToFirstView(e=100){this.enabled&&(this._currentView=void 0,await this.animateToView(this._cameraViews[0],e),await(0,c.timeout)(2))}async recordAllViews(e,t=!0){if(!this.enabled)return;const i=this._viewer?.getPluginByType("CanvasRecorder");if(i&&i.enabled&&!(this._cameraViews.length<1)){if(await this.resetToFirstView(),!i.isRecording())return new Promise(((r,a)=>{const s=()=>{i.removeEventListener("start",n),i.removeEventListener("stop",s),i.removeEventListener("error",o)},n=async()=>{s(),e?.(),await this.animateAllViews();const a=await i.stopRecording();if(t){const e=await(this._viewer?.prompt("Canvas Recorder: Save file as","recording.mp4"));null!==e&&a&&await this._downloadBlob(a,e||"recording.mp4")}r(a)},o=async()=>{s(),a()};i.addEventListener("start",n),i.addEventListener("stop",s),i.addEventListener("error",o),i.startRecording()||console.error("cannot start recording")}));console.error("CanvasRecorderPlugin is already recording")}}async addCurrentView(){if(!this.enabled)return;const e=this.getCurrentCameraView();e.snap=await(this._viewer?.getPlugin(n.G)?.getDataUrl({displayPixelRatio:.25,mimeType:"image/jpg"}))||"",this.addView(e)}addView(e){this._cameraViews.push(e),this.uiConfig.uiRefresh?.(),this.dispatchEvent({type:"viewAdd",view:e})}getCurrentCameraView(e,t=!0,i){if(e||(e=this._viewer?.scene.activeCamera),!e)return new u;const r=new a.Pa4;e.cameraObject.updateWorldMatrix(!0,!1);const s=e.cameraObject.matrixWorld;r.x=s.elements[4],r.y=s.elements[5],r.z=s.elements[6],r.normalize();const n=e.target.clone(),o=e.position.clone(),l=e.cameraObject.parent;l&&(t?o.applyMatrix4(l.matrixWorld):r.transformDirection(l.matrixWorld.clone().invert()));const c=t?e.cameraObject.getWorldQuaternion(new a._fP):e.cameraObject.quaternion.clone();return i?(i.position.copy(o),i.target.copy(n),i.up.copy(r),i.quaternion.copy(c)):((i=new u(o,n,r,c,"")).focusView=async()=>i&&this.focusView(i),i.deleteView=()=>i&&this.deleteView(i),i.updateView=()=>this.getCurrentCameraView(e,t,i)),i.uiConfig.uiRefresh?.("postFrame",!0),i}setCurrentCameraView(e){const t=this._viewer?.scene.activeCamera;t&&(t.position.copy(e.position),t.target.copy(e.target),t.cameraObject.up.copy(e.up),t.cameraObject.quaternion.copy(e.quaternion),t.positionUpdated())}async focusView(e){return this.animateToView(e)}deleteView(e){const t=this._cameraViews.indexOf(e);t>=0&&this._cameraViews.splice(t,1),this.uiConfig.uiRefresh?.(),this.dispatchEvent({type:"viewDelete",view:e})}async stopAllAnimations(){for(this.viewLooping=!1,this._popAnimations.forEach((e=>e?.stop?.())),this._popAnimations=[];this._animating||this._animationLooping;)await(0,c.timeout)(100)}async animateToView(e,t,i,r=!1){const s=this._viewer?.scene.activeCamera;if(!s)return;if(this._animating){this._popAnimations.forEach((e=>e?.stop&&e.stop())),this._popAnimations=[];let e=0;for(;this._animating&&(await(0,c.timeout)(100),!(e++>20)););if(this._animating)return void console.warn("Unable to stop all animations, maybe because of viewLooping?")}this._currentView=e,this._animating=!0,this.dispatchEvent({type:"startViewChange",view:e}),void 0===t&&(t=this.animDuration),t=Math.max(10,t);const n="function"==typeof i?i:l.q8[i||this.animEase],o=this._driver,d=[];this._popAnimations=[];const h=this._popAnimations;if("spherical"===this.interpolateMode)d.push(async function(e,t,i,r,s,n,o){const c=e.target.clone(),d=new a.Pa4,h=new a.Pa4,p=e.cameraObject.parent,u=e.cameraObject.up.clone(),m=f({position:e.cameraObject.getWorldPosition(new a.Pa4),up:p?u.transformDirection(p.matrixWorld):u},c),v=f(t,t.target),_=new a.$V;function y(){e.position.copy(p?p.worldToLocal(h):h),e.target.copy(d),e.positionUpdated()}return(0,l.T0)({from:0,to:1,duration:i,ease:r,driver:s,onUpdate:e=>{_.phi=g(m.phi,v.phi,e),_.theta=g(m.theta,v.theta,e),_.radius=a.M8C.lerp(m.radius,v.radius,e),d.copy(c).lerp(t.target,e),h.setFromSpherical(_),h.add(d),y()},onComplete:()=>{h.copy(t.position),d.copy(t.target),y()},onStop:()=>{throw new Error("Animation Stopped")}},n)}(s,e,t,n,o,h));else if("linear"===this.interpolateMode){d.push((0,l.T0)({from:s.position.clone(),to:e.position.clone(),duration:t,ease:n,driver:o,onUpdate:e=>s.position=e,onComplete:()=>s.position=e.position,onStop:()=>{throw new Error("Animation stopped")}},h)),d.push((0,l.T0)({from:s.target.clone(),to:e.target.clone(),duration:t,ease:n,driver:o,onUpdate:e=>{s.target=e,s.targetUpdated()},onComplete:()=>{s.target=e.target,s.targetUpdated()}},h));const i=s.cameraObject.quaternion.clone(),r=new a._fP;d.push((0,l.T0)({from:0,to:1,duration:t,ease:n,driver:o,onUpdate:t=>{r.copy(i).slerp(e.quaternion,t),s.cameraObject.quaternion.copy(r),s.cameraObject.updateProjectionMatrix()},onComplete:()=>{s.cameraObject.quaternion.copy(e.quaternion),s.cameraObject.updateProjectionMatrix()}},h))}await Promise.allSettled(d).catch((e=>{if(r)throw e})),this._viewer?.setDirty(),this._animating=!1,this.dispatchEvent({type:"viewChange",view:e}),await(0,c.timeout)(10)}fromJSON(e,t){return this._cameraViews.forEach((e=>this.deleteView(e))),super.fromJSON(e,t)?(this._cameraViews.forEach((e=>e.focusView=async()=>this.focusView(e))),this._cameraViews.forEach((e=>e.deleteView=()=>this.deleteView(e))),this._cameraViews.forEach((e=>e.updateView=()=>this.getCurrentCameraView(void 0,void 0,e))),this.uiConfig.uiRefresh?.(),this):null}async animateToObject(e,t=4,i,r,s={min:.5,max:5}){if(!this._viewer)return;const n=(new d.q).expandByObject(e||this._viewer.scene.modelRoot.modelObject,!1,!0),o=n.getCenter(new a.Pa4),l=n.getSize(new a.Pa4).length()/2;await this.animateToTarget(Math.min(s.max,Math.max(s.min,l*t)),o,i,r)}async animateToFitObject(e,t=1.5,i=1e3,r,s={min:.5,max:50}){if(!this._viewer)return;const n=(new d.q).expandByObject(e||this._viewer.scene.modelRoot.modelObject,!1,!0),o=n.getCenter(new a.Pa4),l=n.getSize(new a.Pa4);let c=this._viewer.scene.activeCamera.cameraObject,h=1;if(c.isPerspectiveCamera){const e=c.fov*(Math.PI/180),t=2*Math.atan(Math.tan(e/2)*c.aspect),i=l.z/2+Math.abs(l.x/2/Math.tan(t/2)),r=l.z/2+Math.abs(l.y/2/Math.tan(e/2));h=Math.max(i,r)}await this.animateToTarget(Math.min(s.max,Math.max(s.min,h*t)),o,i,r)}async animateToTarget(e,t,i,r){const s=this.getCurrentCameraView();s.target.copy(t);const n=(new a.Pa4).subVectors(s.target,s.position).normalize();s.position.copy(n.multiplyScalar(-e).add(s.target)),await this.animateToView(s,i,r)}async _downloadBlob(e,t){const i=this._viewer?.getPluginByType("FileTransferPlugin");i?await i.exportFile(e,t):this._viewer?.console.error("FileTransferPlugin required to export/download file")}}function f(e,t){const i=e.position.clone();i.sub(t);const r=(new a.$V).setFromVector3(i);return r.makeSafe(),r}function g(e,t,i){const r=t-e;return r>=Math.PI?e+(r-2*Math.PI)*i:r<=-Math.PI?e+(r+2*Math.PI)*i:e+r*i}m.PluginType="CameraViews",h([(0,s.qC)("cameraViews")],m.prototype,"_cameraViews",void 0),h([(0,c.onChange)(m.prototype._animationLoop),(0,s.qC)(),(0,o.Q7)("Loop All Views",{limitedUi:!0})],m.prototype,"viewLooping",void 0),h([(0,s.qC)(),(0,o.ri)("View Pause Time")],m.prototype,"viewPauseTime",void 0),h([(0,s.qC)(),(0,o.vI)("Ease",Object.keys(l.q8).map((e=>({label:e}))))],m.prototype,"animEase",void 0),h([(0,s.qC)(),(0,o.t8)("Duration",[10,1e4],10,{limitedUi:!0})],m.prototype,"animDuration",void 0),h([(0,s.qC)(),(0,o.t8)("RotationOffset",[.2,.75],.01)],m.prototype,"rotationOffset",void 0),h([(0,s.qC)(),(0,o.vI)("Interpolation",["spherical","linear"].map((e=>({label:e}))))],m.prototype,"interpolateMode",void 0),h([(0,o.Q7)(),(0,s.qC)()],m.prototype,"seekOnScroll",void 0),h([(0,o.M)("Animate All Views",{limitedUi:!0})],m.prototype,"animateAllViews",null),h([(0,o.M)("Record All Views")],m.prototype,"recordAllViews",null),h([(0,o.M)("Add Current View")],m.prototype,"addCurrentView",null),h([(0,o.M)("Focus Next")],m.prototype,"focusNext",void 0),h([(0,o.M)("Focus Previous")],m.prototype,"focusPrevious",void 0),new a.Pa4},2307:function(e,t,i){i.d(t,{G:function(){return d}});var r=i(3995),a=i(9008);class s{static async GetClonedCanvas(e,{rect:t={x:0,y:0,width:e.width,height:e.height,assumeClientRect:!1},displayPixelRatio:i=1,scale:r=1}){const a=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");a.width=t.width*r*i,a.height=t.height*r*i,t.assumeClientRect&&(t.x*=e.width/(i*e.clientWidth),t.y*=e.height/(i*e.clientHeight),t.width*=e.width/(i*e.clientWidth),t.height*=e.height/(i*e.clientHeight));const s=a.getContext("2d");if(!s)return console.error("snapshot: cannot create context"),a;const n=e.style.background||e.parentElement?.style.background||"";if(n.includes("url")){const r=/url\("(.*)"\)/gi.exec(n)?.[1];if(r){const n=new Image;n.src=r,await new Promise(((e,t)=>{n.onload=()=>e(),n.onerror=()=>t(),n.complete&&e()})),s.drawImage(n,n.width*t.x*i/e.width,n.height*t.y*i/e.height,n.width*t.width*i/e.width,n.height*t.height*i/e.height,0,0,a.width,a.height)}}else s.fillStyle=e.style.background||e.parentElement?.style.backgroundColor||"#00000000",s.fillRect(0,0,a.width,a.height);return s?.drawImage(e,t.x*i,t.y*i,t.width*i,t.height*i,0,0,a.width,a.height),this.Debug&&(document.body.appendChild(a),a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.borderWidth="2px",a.style.borderColor="#ff00ff",setTimeout((()=>a.remove()),5e3)),a}static async GetDataUrl(e,{mimeType:t="image/png",...i}){const r=await this.GetClonedCanvas(e,i),a=r.toDataURL(t);return this.Debug||r.remove(),a}static async GetImage(e,{mimeType:t="image/png",...i}={}){const r=await this.GetDataUrl(e,i);return new Promise(((e,t)=>{const i=new Image;i.onload=()=>{e(i)},i.src=r}))}static async GetBlob(e,t={}){const i=await this.GetClonedCanvas(e,t),r=await new Promise(((e,r)=>{i.toBlob((t=>{t?e(t):r()}),t.mimeType??"image/png")}));return this.Debug||i.remove(),r}static async GetFile(e,t="image.png",i={}){return i.getDataUrl?await this.GetDataUrl(e,i):new File([await this.GetBlob(e,i)],t,{type:i.mimeType??"image/png",lastModified:(0,a.now)()})}}s.Debug=!1;var n=i(439),o=i(5551),l=i(4107),c=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};let d=class extends r.Q{constructor(){super(),this.enabled=!0,this.filename="snapshot.png",this.downloadSnapshot=this.downloadSnapshot.bind(this)}async getFile(e,t={waitForProgressive:!0}){return t.getDataUrl=!1,await this._getFile(e||this.filename,t)}async getDataUrl(e={}){return e.getDataUrl=!0,await this._getFile("",e)??""}async _getFile(e,t={}){const i=this._viewer?.canvas;if(i){const r=this._viewer.renderer.displayCanvasScaling;void 0!==t.displayPixelRatio&&t.displayPixelRatio!==r&&(this._viewer.renderer.displayCanvasScaling=t.displayPixelRatio);const o=this._viewer?.getPlugin(n.E);if(t.waitForProgressive&&o&&void 0===t.timeout)for(;!o.isConverged(!0);)await(0,a.timeout)(64);else await(0,a.timeout)(t.timeout??200);t.displayPixelRatio=1;const l=await s.GetFile(i,e,t);return t.displayPixelRatio=this._viewer.renderer.displayCanvasScaling,this._viewer.renderer.displayCanvasScaling=r,l}}async downloadSnapshot(e,t={waitForProgressive:!0}){const i=await this.getFile(e,t);i&&await this._downloadBlob(i,i.name)}async _downloadBlob(e,t){const i=this._viewer?.getPluginByType("FileTransferPlugin");i?await i.exportFile(e,t):this._viewer?.console.error("FileTransferPlugin required to export/download file")}};d.PluginType="CanvasSnipper",c([(0,o.ri)("Filename"),(0,l.qC)()],d.prototype,"filename",void 0),c([(0,o.M)("Download .png",{limitedUi:!0})],d.prototype,"downloadSnapshot",null),d=c([(0,o.Sp)("Image Export")],d)},7398:function(e,t,i){i.d(t,{z:function(){return n}});var r=i(9008),a=i(2988),s=i(6265);class n extends r.SimpleEventDispatcher{constructor(){super(...arguments),this.dirty=!1,this.counters={},this._generators=new Map,this._preRender=()=>this._showDebug("preRender"),this._postRender=()=>this._showDebug("postRender")}async onAdded(e){this._viewer=e,e.addEventListener("preRender",this._preRender),e.addEventListener("postFrame",this._postRender)}addTexture(e,t,i,r,n,o="postRender",l=!1){this._generators.has(o)||this._generators.set(o,[]),this._generators.get(o)?.push({key:e,fn:t,rect:i?[...i]:void 0,frag:n||r||l?new a.jyz({vertexShader:s.C.vertexShader,uniforms:{tDiffuse:{value:null},opacity:{value:1}},fragmentShader:n??`\n        #include <common>\n        #include <packing>\n        uniform float opacity;\n\t\tuniform ${l?"samplerCube":"sampler2D"} tDiffuse;\n\t\tvarying vec2 vUv;\n\t\tvoid main() {\n\t\t\tvec4 texel = ${l?"textureCube( tDiffuse, vec3(cos(vUv.y * PI2) * cos(vUv.x * PI2), sin(vUv.y * PI2), cos(vUv.y * PI2) * sin(vUv.x * PI2)) )":"texture2D( tDiffuse, vUv )"};\n\t\t\t${r??""}\n\t\t\tgl_FragColor = opacity * texel;\n\t\t}\n            `}):void 0})}removeTexture(e,t="postRender"){this._generators.set(t,this._generators.get(t)?.filter((t=>t.key!==e))??[])}async onDispose(e){return Promise.resolve(void 0)}async onRemove(e){return e.removeEventListener("preRender",this._preRender),e.removeEventListener("postRender",this._postRender),this._viewer=void 0,Promise.resolve(void 0)}_showDebug(e){const t=this._viewer,i=t?.renderer;i&&t&&this._generators.get(e)?.forEach((({key:e,fn:r,rect:a,frag:s})=>{const n=r(t);if(n){if(n.image&&a){const e=n.image.width/n.image.height;a[2]<1&&a[3]<1&&(a[2]=200),a[2]<1&&(a[2]=a[3]*e),a[3]<1&&(a[3]=a[2]/e)}i.blit(n,void 0,{viewport:a,clear:!1,material:s})}}))}}n.PluginType="debug"},8112:function(e,t,i){i.d(t,{y:function(){return o}});var r=i(9008);class a{get inputEl(){return this._inputEl}get el(){return this._el}constructor(e,t,i){this._el=e,this._inputEl=t,this._listeners={drop:[],dropstart:[],droperror:[]},this._onDragover=this._onDragover.bind(this),this._onDrop=this._onDrop.bind(this),this._onSelect=this._onSelect.bind(this),e?.addEventListener("dragover",this._onDragover,!1),e?.addEventListener("drop",this._onDrop,!1),t?.addEventListener("change",this._onSelect),i&&Object.entries(i).forEach((([e,t])=>t&&this.on(e,t)))}on(e,t){return this._listeners[e].push(t),this}_emit(e,t){return this._listeners[e].forEach((e=>e(t))),this}destroy(){const e=this._el,t=this._inputEl;e?.removeEventListener("dragover",this._onDragover),e?.removeEventListener("drop",this._onDrop),t?.removeEventListener("change",this._onSelect)}_onDrop(e){e.stopPropagation(),e.preventDefault(),this._emit("dropstart");const t=Array.from(e.dataTransfer?.files||[]),i=Array.from(e.dataTransfer?.items||[]);if(0!==t.length||0!==i.length)if(i.length>0){const e=i.map((e=>e.webkitGetAsEntry()));this._loadNextEntry(new Map,e)}else this._emit("drop",{files:new Map(t.map((e=>(e.filePath=e.name,[e.filePath,e]))))});else this._fail("Required drag-and-drop APIs are not supported in this browser.")}_onDragover(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="copy")}_onSelect(e){if(!this._inputEl)return void console.warn("Invalid Dropzone event ",e);this._emit("dropstart");const t=[].slice.call(this._inputEl.files??new FileList),i=new Map;t.forEach((e=>{e.filePath=e.webkitRelativePath||e.name,i.set(e.filePath,e)})),this._emit("drop",{files:i})}_loadNextEntry(e,t){const i=t.pop();if(i)if(i.isFile)i.file((r=>{r.filePath=i.fullPath,e.set(i.fullPath,r),this._loadNextEntry(e,t)}),(()=>console.error("Could not load file: %s",i.fullPath)));else if(i.isDirectory){const r=i.createReader(),a=i=>{i.length?(t=t.concat(i),r.readEntries(a)):this._loadNextEntry(e,t)};r.readEntries(a)}else console.warn("Unknown asset type: "+i.fullPath),this._loadNextEntry(e,t);else this._emit("drop",{files:e})}_fail(e){this._emit("droperror",{message:e})}}var s=i(4821),n=i(2988);class o extends r.SimpleEventDispatcher{constructor(e){super(),this._domElement=e,this._allowedExtensions=void 0,this.importerParams={autoScale:!0,autoScaleRadius:2,pseudoCenter:!1,autoCenter:!0,autoImport:!0,autoAdd:!0,centerOffset:new n.Pa4(.5,.5,3)},this.dependencies=[s.k],this.uiConfig={type:"folder",label:"Drop Options",expanded:!0,children:[{label:"Auto Center",type:"checkbox",property:[this.importerParams,"autoCenter"],limitedUi:!0},{label:"Auto Scale",type:"checkbox",property:[this.importerParams,"autoScale"],limitedUi:!0},{label:"Auto scale radius",type:"slider",bounds:[.5,100],property:[this.importerParams,"autoScaleRadius"]},{label:"Select local file",type:"button",value:()=>this.promptForFile()}]}}onAdded(e){this._inputEl=document.createElement("input"),this._viewer=e,this._inputEl.type="file",this._dropzone=new a(this._domElement||e.canvas,this._inputEl,{drop:this._onFileDrop.bind(this)})}async _onFileDrop({files:e}){if(!e)return;const t=this._viewer;if(!t)return;if(void 0!==this._allowedExtensions)for(const t of e.keys())this._allowedExtensions.includes(t.split(".").pop()?.toLowerCase()??"")||e.delete(t);if(e.size<1)return;const i=t.getPlugin(s.k),r={type:"drop",files:e};if(this.importerParams.autoImport){const t={allowedExtensions:this.allowedExtensions,...this.importerParams};if(r.imported=await(i.importer?.importFiles(e,t)),this.importerParams.autoAdd){const e=[...r.imported?.values()??[]].flat(2).filter((e=>!!e))??[];if(r.assets=i.addProcessedAssets(e,{...this.importerParams}),!t._rootSceneImported)for(const e of r.assets)e.modelObject&&e.modelObject.dispatchEvent({type:"select",value:e.modelObject})}}this.dispatchEvent(r)}promptForFile(){this._inputEl?.click()}onRemove(e){this._dropzone?.destroy(),this._dropzone=void 0,this._viewer=void 0}get allowedExtensions(){return this._allowedExtensions}set allowedExtensions(e){this._allowedExtensions=e,this._inputEl&&(this._inputEl.accept=e?e.map((e=>"."+e)).join(", "):"")}}o.PluginType="Dropzone"},1672:function(e,t,i){i.d(t,{$:function(){return c}});var r=i(4895),a=i(6755),s=i(2988),n=i(439),o=i(9008),l=i(5551);class c extends r.G{async startTransition(e){this._viewer&&this._pass&&!this.isDisabled()&&(this._target||(this._target=this._viewer.renderer.getTempTarget({sizeMultiplier:1,minFilter:s.wem,magFilter:s.wem,colorSpace:this._viewer.renderer.composerTarget.texture.colorSpace})),this._fadeTimeState<500&&(this._toSaveFrame=!0),this._fadeTimeState=Math.max(e,this._fadeTimeState),this._fadeTime=this._fadeTimeState,this.setDirty(),await(0,o.timeout)(e))}stopTransition(){this._fadeTimeState=0}constructor(){super(),this.passId="frameFade",this._fadeTime=0,this._fadeTimeState=0,this._toSaveFrame=!1,this._beforeFilters=["progressive","taa"],this._afterFilters=["render"],this._requiredFilters=["render","progressive"],this.dependencies=[n.E],this.fadeOnActiveCameraChange=!0,this.fadeOnMaterialUpdate=!0,this.fadeOnSceneUpdate=!0,this.pointerEnabled=!0,this._fadeCam=e=>!1!==e.frameFade&&this.fadeOnActiveCameraChange&&this.startTransition(e.fadeDuration||1e3),this._fadeMat=e=>{!1!==e.frameFade&&this.fadeOnMaterialUpdate&&this.startTransition(e.fadeDuration||200)},this._fadeScene=e=>{!1!==e.frameFade&&this.fadeOnSceneUpdate&&this.startTransition(e.fadeDuration||500)},this._onPointerMove=e=>{const t=this._viewer?.canvas;if(!t)return void(this.pointerEnabled=!1);if(!e.buttons||e.target!==t)return void(this.pointerEnabled=!0);const i=t.getBoundingClientRect(),r=(e.clientX-i.left)/i.width,a=(e.clientY-i.top)/i.height;this.pointerEnabled=r<0||r>1||a<0||a>1},this._disabledBy=[],this.startTransition=this.startTransition.bind(this),this.stopTransition=this.stopTransition.bind(this),this._fadeCam=this._fadeCam.bind(this),this._fadeMat=this._fadeMat.bind(this)}async onAdded(e){await super.onAdded(e),e.scene.addEventListener("activeCameraChange",this._fadeCam),e.scene.addEventListener("activeCameraUpdate",this.stopTransition),e.scene.addEventListener("sceneMaterialUpdate",this._fadeMat),e.scene.addEventListener("sceneUpdate",this._fadeScene),window.addEventListener("pointermove",this._onPointerMove)}async onRemove(e){return e.scene.removeEventListener("activeCameraChange",this._fadeCam),e.scene.removeEventListener("activeCameraUpdate",this.stopTransition),e.scene.removeEventListener("sceneMaterialUpdate",this._fadeMat),e.scene.removeEventListener("sceneUpdate",this._fadeScene),window.removeEventListener("pointermove",this._onPointerMove),super.onRemove(e)}passCtor(e){const t=this,i=e.getPlugin(n.E),r=new class extends a.J{constructor(){super(...arguments),this._lastTime=0,this._saveNextFrame=!1,this.uiConfig=(0,l.YH)("Frame Fade",this)}render(r,a,s,n,l){this.needsSwap=!1;const c=t._target;if(!c||!t.pointerEnabled||!this.enabled||!t.dirty||t._fadeTimeState<.001||e.scene.renderCamera!==e.scene.activeCamera)return;t._toSaveFrame&&(this._saveNextFrame=!0,t._toSaveFrame=!1),this._saveNextFrame&&i.lastFrame&&(e.renderer.blit(i.lastFrame.texture,c),this._lastTime=0,this._saveNextFrame=!1),this.blendTexture=c?.texture;const d=t._fadeTimeState/t._fadeTime;this.weights2.setScalar(d),this.weights2.w=1,this.weights1.setScalar(1-d),this.weights1.w=1,super.render(r,a,s,n,l),this.needsSwap=!0;const h=(0,o.now)();this._lastTime<10&&(this._lastTime=h-10);const p=h-this._lastTime;this._lastTime=h,t._fadeTimeState-=p}};return r.enabled=!0,r}setDirty(){this.enabled&&this._viewer?.setDirty()}get dirty(){return this.enabled&&this._fadeTimeState>0}set dirty(e){console.warn("FrameFadePlugin.dirty is readonly")}_update(e){return!!super._update(e)&&(this.isDisabled()&&this.stopTransition(),this._fadeTimeState<1&&(this._toSaveFrame=!1,this._target&&this._viewer&&(this._viewer.renderer.releaseTempTarget(this._target),this._target=void 0)),!0)}get uiConfig(){return this.pass?.passObject?.uiConfig}disable(e){this._disabledBy.includes(e)||this._disabledBy.push(e)}enable(e){const t=this._disabledBy.indexOf(e);t>=0&&this._disabledBy.splice(t,1)}isDisabled(){return!this.pointerEnabled||this._disabledBy.length>0||!this.enabled}}c.PluginType="FrameFade"},6757:function(e,t,i){i.d(t,{m:function(){return c}});var r=i(2988),a=i(7245);class s extends a.mT{constructor(e=!0){super({vertexShader:"#define DEPTH_NORMAL \n#if IS_GLSL3 > 0\nout vec3 vViewPosition;\n#else\nvarying vec3 vViewPosition;\n#endif\n#ifdef USE_ALPHAMAP\n#define USE_UV \n#endif\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;}",fragmentShader:"#define DEPTH_NORMAL \n#if IS_GLSL3 > 0\nin vec3 vViewPosition;\n#else\nvarying vec3 vViewPosition;\n#endif\n#ifdef USE_ALPHAMAP\n#define USE_UV \n#include <packing>\n#endif\n#if IS_GLSL3 > 0\n#ifndef gl_FragColor \nlayout(location=0)out vec4 A;layout(location=1)out vec4 B;\n#endif\n#endif\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nuniform vec2 cameraNearFar;uniform vec4 flags;vec2 pack16(float value){float f=clamp(value,0.,1.)*255.;float digitLow=fract(f);float digitHigh=floor(f)/255.;return vec2(digitHigh,digitLow);}vec2 packNormal(vec3 n){float p=sqrt(n.z*8.+8.);return vec2(n.xy/p+0.5);}float linstep(float edge0,float edge1,float value){return clamp((value-edge0)/(edge1-edge0),0.,1.);}void main(){\n#glMarker mainStart\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(1.);\n#include <map_fragment>\n#ifdef USE_ALPHAMAP\nfloat alphaMapValue=\n#ifdef ALPHA_I_RGBA_PACKING\n1.-unpackRGBAToDepth(texture2D(alphaMap,vAlphaMapUv));\n#else\ntexture2D(alphaMap,vAlphaMapUv).g;\n#endif\n#if defined(INVERSE_ALPHAMAP) && INVERSE_ALPHAMAP >= 1\ndiffuseColor.a*=1.-alphaMapValue;\n#else\ndiffuseColor.a*=alphaMapValue;\n#endif\n#endif\n#include <alphatest_fragment>\n#include <logdepthbuf_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#ifdef FORCED_LINEAR_DEPTH\nfloat linearZ=float(FORCED_LINEAR_DEPTH);\n#else\nfloat linearZ=linstep(-cameraNearFar.x,-cameraNearFar.y,-vViewPosition.z);\n#endif\nvec2 packedZ=pack16(pow(linearZ,0.5));vec2 packedNormal=packNormal(normal);\n#if IS_GLSL3 > 0\n#ifndef gl_FragColor \nA=vec4(packedZ.x,packedZ.y,packedNormal.x,packedNormal.y);B=flags;\n#else\ngl_FragColor=vec4(packedZ.x,packedZ.y,packedNormal.x,packedNormal.y);\n#endif\n#else\ngl_FragColor=vec4(packedZ.x,packedZ.y,packedNormal.x,packedNormal.y);\n#endif\n}",uniforms:r.rDY.merge([r.rBU.common,r.rBU.bumpmap,r.rBU.normalmap,r.rBU.displacementmap,{cameraNearFar:{value:new r.FM8(.1,1e3)},flags:{value:new r.Ltg(255,255,255,255)}}]),defines:{IS_GLSL3:e?"1":"0"},glslVersion:e?r.LSk:r.v9Y}),this.normalMapType=r.IOt,this.flatShading=!1,this._updaters=[]}onBeforeRender(e,t,i,a,s){super.onBeforeRender(e,t,i,a,s);let n=s.material;Array.isArray(n)&&(n=n[0]),this.uniforms.map.value=n?.map??null,this.uniforms.map.value&&e.materials.refreshTransformUniform(this.uniforms.map.value,this.uniforms.mapTransform),this.uniforms.alphaMap.value=n?.alphaMap??null,this.uniforms.alphaMap.value&&e.materials.refreshTransformUniform(this.uniforms.alphaMap.value,this.uniforms.alphaMapTransform),this.uniforms.alphaTest.value=!n||!n.alphaTest||n.alphaTest<1e-7?.001:n.alphaTest,this.uniforms.displacementMap.value=n?.displacementMap??null,this.uniforms.displacementMap.value&&e.materials.refreshTransformUniform(this.uniforms.displacementMap.value,this.uniforms.displacementMapTransform),this.uniforms.displacementScale.value=n?.displacementScale??1,this.uniforms.displacementBias.value=n?.displacementBias??0,this.uniforms.bumpMap.value=n?.bumpMap??null,this.uniforms.bumpMap.value&&e.materials.refreshTransformUniform(this.uniforms.bumpMap.value,this.uniforms.bumpMapTransform),this.uniforms.bumpScale.value=n?.bumpScale??1,this.uniforms.normalMap.value=n?.normalMap??null,this.uniforms.normalMap.value&&e.materials.refreshTransformUniform(this.uniforms.normalMap.value,this.uniforms.normalMapTransform),this.uniforms.normalScale.value&&this.uniforms.normalScale.value.copy(n?.normalScale??new r.FM8(1,1)),this.normalMapType=n?.normalMapType??r.IOt,this.flatShading=n?.flatShading??!1,this.uniforms.flags.value.set(255,255,255,255),this.uniforms.flags.value.z=(n?.userData.matId?n?.userData.matId:0)/255,this._updaters.forEach((e=>{e(s,this.uniforms.flags.value)})),this.uniforms.flags.value.y/=255,this.uniforms.flags.value.w/=255,this.uniformsNeedUpdate=!0;let o=this.uniforms.alphaMap.value?1:void 0;o!==this.defines.USE_ALPHAMAP&&(void 0===o?(delete this.defines.USE_ALPHAMAP,delete this.defines.ALPHAMAP_UV):(this.defines.USE_ALPHAMAP=o,this.defines.ALPHAMAP_UV="uv"),this.needsUpdate=!0),o=this.uniforms.displacementMap.value?1:void 0,o!==this.defines.USE_DISPLACEMENTMAP&&(void 0===o?(delete this.defines.USE_DISPLACEMENTMAP,delete this.defines.DISPLACEMENTMAP_UV):(this.defines.USE_DISPLACEMENTMAP=o,this.defines.DISPLACEMENTMAP_UV="uv"),this.needsUpdate=!0),o=n.userData.ALPHA_I_RGBA_PACKING?1:void 0,o!==this.defines.ALPHA_I_RGBA_PACKING&&(void 0===o?delete this.defines.ALPHA_I_RGBA_PACKING:this.defines.ALPHA_I_RGBA_PACKING=o,this.needsUpdate=!0),o=n.userData.forcedLinearDepth??void 0,o!==this.defines.FORCED_LINEAR_DEPTH&&(void 0===o?delete this.defines.FORCED_LINEAR_DEPTH:this.defines.FORCED_LINEAR_DEPTH=o,this.needsUpdate=!0),this.side=n.side??r.ehD}addGBufferUpdater(e){this._updaters.push(e)}removeGBufferUpdater(e){const t=this._updaters.indexOf(e);-1!==t&&this._updaters.splice(t,1)}}var n=i(9033),o=i(4895),l=i(3770);class c extends o.G{get material(){return this._material}passCtor(e){const t=this._viewer?.renderer.isWebGL2&&this.renderFlagsBuffer,i=e.renderer.createTarget({depthBuffer:!0,samples:this._viewer?.useGBufferDepth&&this._viewer?.renderer.composerTarget.samples||0,type:r.ywz,textureCount:t?2:1,depthTexture:this.renderDepthTexture,depthTextureType:this.depthTextureType});return Array.isArray(i.texture)?(i.texture[0].name="gbufferDepthNormal",i.texture[1].name="gbufferFlags",this._gbufferTextures=i.texture):(i.texture.name="gbufferDepthNormal",this._gbufferTextures.push(i.texture)),this._gbufferTarget=i,this._material=new s(t),this._material.userData.isGBufferMaterial=!0,new l.J(i,this._material)}_update(e){if(!super._update(e))return!1;const t=this.pass.passObject;return t.scene=e.scene.modelObject,e.scene.renderCamera.updateShaderProperties(t.overrideMaterial),t.camera=e.scene.renderCamera.cameraObject,!0}constructor(e=!0,t=!1,i=r.JQ4){super(),this.renderFlagsBuffer=e,this.renderDepthTexture=t,this.depthTextureType=i,this.passId="gbuffer",this._beforeFilters=["render"],this._afterFilters=[],this._requiredFilters=["render"],this._gbufferTextures=[]}getDepthNormal(){return this._gbufferTextures.length>0?this._gbufferTextures[0]:void 0}getFlagsTexture(){return this._gbufferTextures.length>1?this._gbufferTextures[1]:void 0}async onDispose(e){}async onRemove(e){return this._gbufferTarget&&(e.renderer.disposeTarget(this._gbufferTarget),this._gbufferTarget=void 0),super.onRemove(e)}getTarget(){return this._gbufferTarget}getDepthTexture(){return this._gbufferTarget?.depthTexture}getUnpackSnippet(){return n.Z}updateShaderProperties(e){if(e.uniforms.tNormalDepth?e.uniforms.tNormalDepth.value=this.getDepthNormal()??void 0:this._viewer?.console.warn("BaseRenderer: no uniform: tNormalDepth"),e.uniforms.tGBufferFlags){e.uniforms.tGBufferFlags.value=this.getFlagsTexture()??void 0;const t=e.uniforms.tGBufferFlags.value?1:0;t!==e.defines.GBUFFER_HAS_FLAGS&&(e.defines.GBUFFER_HAS_FLAGS=t,e.needsUpdate=!0)}return this}registerGBufferUpdater(e){this._material&&this._material.addGBufferUpdater(e)}}c.PluginType="GBuffer"},1233:function(e,t,i){i.d(t,{L:function(){return p}});var r,a=i(3995),s=i(4821),n=i(2988),o=i(9008),l=i(4107),c=i(5551),d=i(8570),h=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};let p=r=class extends a.Q{get animationState(){return this._animationState}get animationTime(){return this._animationTime}get animationDuration(){return this._animationDuration}setTime(e){this._animationTime=Math.max(0,Math.min(e,this._animationDuration))}_wheel({deltaY:e}){this.enabled&&Math.abs(e)>.001&&(this._scrollAnimationState=-1*Math.sign(e))}_drag(e){this.enabled&&this._viewer&&("x"===this.dragAxis?this._dragAnimationState=e.delta.x*this._viewer.canvas.width/4:this._dragAnimationState=e.delta.y*this._viewer.canvas.height/4)}_postFrame(){if(!this._viewer)return;const e=this._viewer,t=this.animateOnScroll,i=this.animateOnDrag;if(!this.enabled||this.animations.length<1||"playing"!==this._animationState&&!t&&!i)return this._lastFrameTime=0,void(this._fadeDisabled&&(this._viewer.getPluginByType("FrameFade")?.enable(r.PluginType),this._fadeDisabled=!1));if(this._animationTime<1e-4&&this.dispatchEvent({type:"checkpointBegin"}),this.autoIncrementTime){const e=(0,o.now)()/1e3;this._lastFrameTime<1&&(this._lastFrameTime=e-1/30);let r=e-this._lastFrameTime;if(r*=this.animationSpeed,this._lastFrameTime=e,t&&i?r*=(0,o.absMax)(this._scrollAnimationState,this._dragAnimationState):t?r*=this._scrollAnimationState:i&&(r*=this._dragAnimationState),Math.abs(r)<1e-4)return;const a=this._viewer.getPluginByType("Progressive")?.postFrameConvergedRecordingDelta();if(a&&a>0&&(r=a),0===a)return;const s=Math.abs(this.timeScale);this._animationTime+=r*(s>0?s:1)}const a=this._animationTime-this._lastAnimationTime;this._lastAnimationTime=this._animationTime;const s=this.timeScale<0?(isFinite(this._animationDuration)?this._animationDuration:0)-this._animationTime:this._animationTime;if(this.animations.map((e=>{e.mixer.setTime(s)})),!(Math.abs(a)<1e-5)){if(Math.abs(this._scrollAnimationState)<.001?this._scrollAnimationState=0:this._scrollAnimationState*=1-this.scrollAnimationDamping,Math.abs(this._dragAnimationState)<.001?this._dragAnimationState=0:this._dragAnimationState*=1-this.dragAnimationDamping,this.dispatchEvent({type:"animationStep",delta:a,time:s}),e.scene.activeCamera.cameraObject.userData.__animatingCamera&&e.scene.activeCamera.setDirty(),e.scene.refreshActiveCameraNearFar(),e.renderer.resetShadows(),e.setDirty(),!this._fadeDisabled){const e=this._viewer.getPluginByType("FrameFade");e&&(e.disable(r.PluginType),this._fadeDisabled=!0)}this._animationTime>=this._animationDuration&&this.dispatchEvent({type:"checkpointEnd"})}}constructor(){super(),this.enabled=!0,this._lastAnimationTime=0,this.autoIncrementTime=!0,this.animations=[],this.loopAnimations=!0,this.loopRepetitions=1/0,this.timeScale=1,this.animationSpeed=1,this.animateOnScroll=!1,this._scrollAnimationState=0,this.scrollAnimationDamping=.1,this.animateOnDrag=!1,this.dragAxis="y",this.autoplayOnLoad=!1,this.syncMaxDuration=!1,this._dragAnimationState=0,this.dragAnimationDamping=.3,this.dependencies=[s.k],this._pointerDragHelper=new o.PointerDragHelper,this._lastFrameTime=0,this._fadeDisabled=!1,this._objectAdded=e=>{const t=e.object;if("model"!==t.assetType||!t.modelObject)return;if(!this._viewer)return;let i=!1;t.modelObject.traverse((e=>{const r=e.animations;if(r.length<1)return;const a=Math.max(...r.map((e=>e.duration)));(t.modelObject.userData.gltfAnim_SyncMaxDuration??this.syncMaxDuration)&&(r.forEach((e=>e.duration=a)),t.modelObject.userData.gltfAnim_SyncMaxDuration=!0);const s=new n.Xcj(this._viewer.scene.modelRoot.modelObject),o=r.map((e=>s.clipAction(e).setLoop(this.loopAnimations?n.YKA:n.jAl,this.loopRepetitions)));o.forEach((e=>e.clampWhenFinished=!0)),this.animations.push({mixer:s,clips:r,actions:o,duration:a}),i=!0})),i&&(this._onPropertyChange(!this.autoplayOnLoad),this.autoplayOnLoad&&this.playAnimation())},this._animationTime=0,this._animationDuration=0,this._animationState="none",this.uiConfig=void 0,this._lastAnimId="",this.timelineMarkers=[],this._postFrame=this._postFrame.bind(this),this._wheel=this._wheel.bind(this),this.playClips=this.playClips.bind(this),this.playClip=this.playClip.bind(this),this.playAnimation=this.playAnimation.bind(this),this.playPauseAnimation=this.playPauseAnimation.bind(this),this.pauseAnimation=this.pauseAnimation.bind(this),this.stopAnimation=this.stopAnimation.bind(this),this.resetAnimation=this.resetAnimation.bind(this),this._onPropertyChange=this._onPropertyChange.bind(this),this._loaderCreate=this._loaderCreate.bind(this),this._pointerDragHelper.addEventListener("drag",this._drag.bind(this))}_loaderCreate({loader:e}){e.isGLTFLoader2&&e.register((e=>new u(e,this)))}async onAdded(e){e.getPlugin(s.k)?.importer?.addEventListener("loaderCreate",this._loaderCreate),e.scene.addEventListener("addSceneObject",this._objectAdded),e.getPlugin(s.k)?.exporter?.getExporter("gltf","glb")?.extensions?.push(m),e.addEventListener("postFrame",this._postFrame),window.addEventListener("wheel",this._wheel),this._pointerDragHelper.element=e.canvas;let t=-1;return Object.defineProperty(e.scene.modelRoot,"currentTimelineMarker",{get:()=>t,set:i=>e.scene.modelRoot.dispatchEvent({type:"animationTimelineMarker",marker:this.timelineMarkers[t=i]})}),e.scene.modelRoot.addEventListener("animationTimelineMarker",(({marker:e})=>{if(!this._viewer)return;if(!e)return this._viewer.scene.activeCamera=this._viewer?.scene.defaultCamera,void this._viewer.setDirty();const t=e.camera;t&&(t.userData.__animatingCamera=!0,this._viewer.scene.activeCamera=this._viewer.createCamera(t))})),super.onAdded(e)}async onRemove(e){for(;this.animations.length;)this.animations.pop();return e.scene.removeEventListener("addSceneObject",this._objectAdded),e.getPlugin(s.k)?.importer?.addEventListener("loaderCreate",this._loaderCreate),e.removeEventListener("postFrame",this._postFrame),window.removeEventListener("wheel",this._wheel),this._pointerDragHelper.element=void 0,super.onRemove(e)}_onPropertyChange(e=!0){this._animationDuration=Math.max(...this.animations.map((({duration:e})=>e)))*(this.loopAnimations?this.loopRepetitions:1),"playing"===this._animationState&&e&&this.playAnimation()}onStateChange(){this.uiConfig?.children?.map((e=>e&&(0,o.getOrCall)(e))).flat(2).forEach((e=>e?.uiRefresh?.()))}playPauseAnimation(){"playing"===this._animationState?this.pauseAnimation():this.playAnimation()}async playClip(e,t=!1){return this.playClips([e],t)}async playClips(e,t=!1){const i=[];return this.animations.forEach((({actions:t})=>{t.forEach((t=>{e.includes(t.getClip().name)&&i.push(t)}))})),this.playAnimation(t,i)}async playAnimation(e=!1,t){if(!this.enabled)return;let i=!1;"playing"===this._animationState&&(this.stopAnimation(!1),i=!0);let r=0;const a=!t;t||(t=[],this.animations.forEach((({mixer:e,actions:i,clips:r})=>{t.push(...i)}))),i?this.resetAnimation():"paused"!==this.animationState&&(t.forEach((e=>{e.reset()})),this._animationTime=0);const s=(0,d.Z)();this._lastAnimId=s;for(const e of t)e.setLoop(this.loopAnimations?n.YKA:n.jAl,this.loopRepetitions),e.play(),r=Math.max(r,e.getClip().duration/Math.abs(e.timeScale));if(this._animationState="playing",this._viewer?.setDirty(),a){if(!isFinite(this._animationDuration))return;await new Promise(((e,t)=>{const i=()=>{this.removeEventListener("checkpointEnd",i),e()};this.addEventListener("checkpointEnd",i)}))}else{const e=this.loopAnimations?this.loopRepetitions:1;if(r*=e,!isFinite(r))return;await new Promise(((e,t)=>{const i=t=>{t.time>=r&&(this.removeEventListener("animationStep",i),e())};this.addEventListener("animationStep",i)}))}s===this._lastAnimId&&this.stopAnimation(e)}pauseAnimation(){"playing"===this._animationState?(this._animationState="paused",this._viewer?.setDirty()):console.warn("pauseAnimation called when animation was not playing.")}resumeAnimation(){"paused"===this._animationState?(this._animationState="playing",this._viewer?.setDirty()):console.warn("resumeAnimation called when animation was not paused.")}stopAnimation(e=!1){this._animationState="stopped",e?this.resetAnimation():this._viewer?.setDirty(),this._lastAnimId="",this._viewer&&this._fadeDisabled&&(this._viewer.getPluginByType("FrameFade")?.enable(r.PluginType),this._fadeDisabled=!1)}resetAnimation(){"stopped"===this._animationState||"none"===this._animationState?(this.animations.forEach((({mixer:e,actions:t,clips:i})=>{e.stopAllAction(),e.setTime(0)})),this._animationTime=0,this._viewer?.setDirty()):this.stopAnimation(!0)}};p.PluginType="GLTFAnimation",p.AnimationMarkersExtension="WEBGI_animation_markers",h([(0,l.qC)()],p.prototype,"autoIncrementTime",void 0),h([(0,c.Kb)()],p.prototype,"animationState",null),h([(0,c.Kb)()],p.prototype,"animationTime",null),h([(0,c.Kb)()],p.prototype,"animationDuration",null),h([(0,o.onChange2)(r.prototype._onPropertyChange),(0,c.Q7)("Loop",{limitedUi:!0}),(0,l.qC)()],p.prototype,"loopAnimations",void 0),h([(0,o.onChange2)(r.prototype._onPropertyChange),(0,l.qC)()],p.prototype,"loopRepetitions",void 0),h([(0,c.t8)("Timescale",[-2,2],.01),(0,l.qC)()],p.prototype,"timeScale",void 0),h([(0,c.t8)("Speed",[.1,4],.1,{limitedUi:!0}),(0,l.qC)()],p.prototype,"animationSpeed",void 0),h([(0,c.Q7)(),(0,l.qC)()],p.prototype,"animateOnScroll",void 0),h([(0,c.Q7)(),(0,l.qC)()],p.prototype,"animateOnDrag",void 0),h([(0,c.vI)("Drag Axis",[{label:"x"},{label:"y"}]),(0,l.qC)()],p.prototype,"dragAxis",void 0),h([(0,c.Q7)(),(0,l.qC)()],p.prototype,"autoplayOnLoad",void 0),h([(0,c.Q7)("syncMaxDuration(dev)"),(0,l.qC)()],p.prototype,"syncMaxDuration",void 0),h([(0,o.onChange)(r.prototype.onStateChange)],p.prototype,"_animationState",void 0),h([(0,c.M)("Play/Pause",(e=>({label:()=>"playing"===e.animationState?"Pause":"Play",limitedUi:!0})))],p.prototype,"playPauseAnimation",null),h([(0,c.M)("Stop",{limitedUi:!0})],p.prototype,"stopAnimation",null),h([(0,c.M)("Reset",{limitedUi:!0})],p.prototype,"resetAnimation",null),p=r=h([(0,c.Sp)("GLTF Animations")],p);class u{constructor(e,t){this.parser=e,this.name=p.AnimationMarkersExtension,this.plugin=t}async afterRoot(e){let t=[];for(const e of this.parser.json.scenes||[]){if(!e.extensions)continue;const i=e.extensions[this.name];for(const e of i?.markers||[]){const i=void 0!==e.camera?await this.parser.getDependency("camera",e.camera):void 0;if(void 0===e.time){const t=30;e.time=e.frame/t,console.error("Update timeline markers plugin for correct times.")}t.push({name:e.name,frame:e.frame,time:e.time,camera:i})}}if(t.length<1)return;t=t.sort(((e,t)=>e.frame-t.frame));const i=e.scene??e.scenes[0];if(!i)return;i.userData.__markers=t;const r=this.plugin.timelineMarkers,a=t.map((e=>e.time));let s=r.length;const o=t.map((e=>s++)),l=Math.max(...a)+.01;r.push(...t);const c=new n.dUE(".currentTimelineMarker",a,o,n.Syv),d=new n.m7l("animationTimelineMarker",l,[c]);d.__gltfExport=!1,e.animations.push(d)}}const m=e=>({afterParse(t){const i=e.json.scenes[e.json.scene||0];i.extensions=i.extensions||{};const r={markers:[]},a=[];if((Array.isArray(t)?t:[t]).forEach((e=>e.traverse((e=>{e.userData.__markers&&a.push(...e.userData.__markers)})))),a.sort(((e,t)=>e.frame-t.frame)),!(a.length<1)){for(const t of a){const i=t.camera;if(i){const a=e.nodeMap.get(i);if(void 0===a){console.warn("Camera not found in gltf export",i,e.nodeMap);continue}const s=e.json.nodes[a].camera;t.camera=s,r.markers.push(t)}}i.extensions[p.AnimationMarkersExtension]=r,e.extensionsUsed[p.AnimationMarkersExtension]=!0}}})},3278:function(e,t,i){i.d(t,{a:function(){return o}});var r=i(4107),a=i(3995),s=i(5008),n=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class o extends a.Q{constructor(){super(...arguments),this.enabled=!0,this.dependencies=[s.x]}get uiConfig(){return this._extension?.uiConfig}get config(){return this._extension}disposeExtension(){}async onAdded(e){await super.onAdded(e),this._extension=this.generateExtension(e),e.getPlugin(s.x)?.addExtension(this._extension)}async onRemove(e){this.disposeExtension(),this._extension=void 0,await super.onRemove(e)}}n([(0,r.qC)("extension")],o.prototype,"_extension",void 0),n([(0,r.qC)()],o.prototype,"enabled",void 0)},4895:function(e,t,i){i.d(t,{G:function(){return s}});var r=i(3995),a=i(4107);class s extends r.Q{_update(e){return this._pass?.enabled&&this.enabled||!1}get enabled(){return this._pass?.passObject?.enabled??this._enabledTemp}set enabled(e){this._pass?.passObject&&(this._pass.passObject.enabled=e),this._enabledTemp=e}constructor(){super(),this._enabledTemp=!0}async onAdded(e){await super.onAdded(e);const t={enabled:!0,passId:this.passId,passObject:this.passCtor(e),after:this._afterFilters,before:this._beforeFilters,required:this._requiredFilters,set dirty(t){t&&e.setDirty()},get dirty(){return!1},update:()=>this._update(e)};this._pass=(0,r.M)(e,t),void 0!==t.passObject.onDirty&&t.passObject.onDirty.push((()=>t.dirty=!0)),e.renderer.registerPass(this._pass),this.enabled=this._enabledTemp}async onRemove(e){this._pass&&e.renderer.unregisterPass(this._pass),this._pass?.dispose?.(),this._pass=void 0,await super.onRemove(e)}get pass(){return this._pass}toJSON(e){const t=super.toJSON(e);if(!t.type)return t;const i=this.pass;return i&&(t.pass=(0,a.HD)(i?.passObject??i,!1,e)),t}fromJSON(e,t){if(!super.fromJSON(e,t))return null;if(e.pass){const i=this.pass;i&&(0,a.Hx)(e.pass,i?.passObject??i,!1,t)}return this}}!function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);s>3&&n&&Object.defineProperty(t,i,n)}([(0,a.qC)()],s.prototype,"enabled",null)},9280:function(e,t,i){i.d(t,{C:function(){return w}});var r=i(9008),a=i(2988),s=i(7398),n=i(8160),o=i(6533);class l extends a.Tn7{constructor(){super(...arguments),this.typeSlug="fsShadow",this.assetType="material",this._uniforms={},this.lastFrameTexture=null}get materialObject(){return this}onBeforeCompile(e,t){e.vertexShader=e.vertexShader.replace("#include <project_vertex>","\n#include <project_vertex>\ngl_Position = vec4(uv*2.-1., 0, 1.); \n        "),e.vertexShader=e.vertexShader.replace("void main() {","\nvarying vec2 vUv;\nvoid main() {\n    vUv = uv;\n        "),e.fragmentShader=e.fragmentShader.replace("void main() {","\nvarying vec2 vUv;\nuniform sampler2D tLastThis;\nvoid main() {\n        "),e.fragmentShader=e.fragmentShader.replace("gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );",r.glsl`
float shadow = getShadowMask();

//shift the color by dither_shift
shadow = clamp(shadow + mix(-1./512., 1./512., rand( gl_FragCoord.xy )), 0., 1.);

float last = unpackRGBAToDepth(texture2D(tLastThis, vUv));
gl_FragColor = packDepthToRGBA(mix(last, shadow, opacity));
//if not useMovingAverage:
//gl_FragColor = packDepthToRGBA(shadow * opacity + last);
        `),Object.assign(e.uniforms,this._uniforms),super.onBeforeCompile(e,t)}customProgramCacheKey(){return super.customProgramCacheKey()}toJSON(e){throw new Error("Method not supported for this material.")}fromJSON(e,t){throw new Error("Method not supported for this material.")}copyProps(e){throw new Error("Method not supported for this material.")}setDirty(e){this.needsUpdate=!0,this.dispatchEvent({...e,type:"materialUpdate"})}}!function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);s>3&&n&&Object.defineProperty(t,i,n)}([(0,o.e5)({propKey:"tLastThis"})],l.prototype,"lastFrameTexture",void 0);var c=i(4107),d=i(8670),h=i(7320),p=i(7245),u=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class m extends r.SimpleEventDispatcher{get attachedMesh(){return this._attachedMesh}set attachedMesh(e){this._attachedMesh!==e&&(this._attachedMesh&&this.cleanupMaterial(),this._attachedMesh=e,this._attachedMesh&&this._updateMaterial())}get target(){return this._target}get light(){return this._light}constructor(e){super(),this.enabled=!0,this._lightLayer=5,this._frameNumber=0,this.maxFrameNumber=400,this.smoothShadow=!1,this.shadowMapType=a._MY,this.groundMapMode="aoMap",this.alphaVignette=!0,this.alphaVignetteAxis="xy",this.shadowAutoUpdate=!0,this._bakeCounter=0,this.maxBakeCount=1/0,this.materialExtension={parsFragmentSnippet:(e,t)=>r.glsl`
            uniform float transitionOpacity;
            `,extraUniforms:{transitionOpacity:{value:1}},shaderExtender:(e,t,i)=>{"aoMap"===this.groundMapMode?e.fragmentShader=(0,d.p)(e.fragmentShader,"#include <aomap_fragment>",(0,d.p)(a.WdD.aomap_fragment,"float ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;","float ambientOcclusion = ( mix(1., unpackRGBAToDepth(texture2D( aoMap, vAoMapUv ) ), transitionOpacity) - 1.0) * aoMapIntensity + 1.0;")):"map"===this.groundMapMode?e.fragmentShader=(0,d.p)(e.fragmentShader,"#include <map_fragment>",(0,d.p)(a.WdD.map_fragment,"diffuseColor *= texture2D( map, vMapUv );","float groundShadow = mix(1., unpackRGBAToDepth(texture2D( map, vMapUv )), transitionOpacity); diffuseColor.rgb *= groundShadow; diffuseColor.a *= max(0., 1.-groundShadow) * transitionOpacity;")):"alphaMap"===this.groundMapMode&&(e.fragmentShader=(0,d.p)(e.fragmentShader,"#include <alphamap_fragment>",(0,d.p)(a.WdD.alphamap_fragment,"texture2D( alphaMap, vAlphaMapUv ).g","1. - unpackRGBAToDepth( texture2D( alphaMap, vAlphaMapUv ) )",{replaceAll:!0}))),e.fragmentShader=(0,d.p)(e.fragmentShader,"#include <output_fragment>",r.glsl`#include <output_fragment>
                #ifndef OPAQUE
                    #ifdef USE_AOMAP
                        #if NUM_DIR_LIGHT_SHADOWS > 0
                            // TODO find a better solution
                            float alphaMod = length(reflectedLight.directDiffuse)*4./float(NUM_DIR_LIGHT_SHADOWS);
                        #else
                            float alphaMod = 1.;
                        #endif
                        float t1 = 1. - ambientOcclusion;
                        float t2 = max(1. - alphaMod, 0.);
                        float t = t1 + t2;
                        gl_FragColor.a *= max(t, 0.);
                    #endif
                #endif
            `),this.alphaVignette&&i.capabilities.isWebGL2&&(e.defines.USE_UV="",e.fragmentShader=(0,d.p)(e.fragmentShader,"#include <output_fragment>",r.glsl`#include <output_fragment>
                    #ifndef OPAQUE
                    float weight = 0.;
                    #ifdef USE_UV // why are we checking for this? this is always supposed to be true
                    weight = 2.*abs(length(0.5 - vUv.${this.alphaVignetteAxis}));
                    #endif
                    #if defined(USE_LIGHTMAP) || defined(USE_AOMAP)
                    weight = 2.*abs(length(0.5 - vAoMapUv.${this.alphaVignetteAxis}));
                    #endif
                    weight = min(1., max(0., weight))-0.5;
                    weight = min(1., max(0., 1.0-2.*weight));
                    weight = pow(weight, 1.5);
                    gl_FragColor.a *= weight;
                    //gl_FragColor.rgb /= max(0.01, weight);
                    gl_FragColor = saturate(gl_FragColor);
                    //gl_FragColor.a = 0.5;
                    #endif
                    `))},computeCacheKey:()=>this.groundMapMode+"."+this.alphaVignette+"."+this.alphaVignetteAxis,onObjectRender:(e,t)=>{t.materialObject.userData.gMapMode!==this.groundMapMode&&(t.materialObject.userData.gMapMode=this.groundMapMode,t.materialObject.needsUpdate=!0)},isCompatible:e=>e.isMeshStandardMaterial2},this._viewer=e;const t=new n.B(16777215,10,{near:1.5,far:20,bias:0,frustumSize:4,width:1024,height:1024,enabled:!0,radius:10,normalBias:0},{direction:new a.Pa4(.2,1,.2).normalize(),spread:.9,focus:1,distanceScale:20,minDistanceScale:new a.Pa4(10,10,10),normalDirection:new a.Pa4(0,1,0)});t.shadow.camera.updateProjectionMatrix(),t.layers.disableAll(),t.layers.set(this._lightLayer),this._light=t,e.scene.addLight(this._light,{addToRoot:!0}),this._shadowMat=new l({color:"#ffffff",toneMapped:!1,depthWrite:!1,depthTest:!1,premultipliedAlpha:!1,opacity:1,transparent:!1,blending:a.jFi}),this._shadowBlurMat=new p.mT({uniforms:{colorTexture:{value:null},step:{value:.1},size:{value:new a.FM8(.5,.5)},direction:{value:new a.FM8(.5,.5)}},vertexShader:h.Z,fragmentShader:"#include <packing>\nuniform sampler2D colorTexture;uniform vec2 size;uniform vec2 direction;uniform float step;varying vec2 vUv;void main(){float sum=0.;vec2 uvDelta=step*direction/size;sum+=unpackRGBAToDepth(texture2D(colorTexture,vUv-1.*uvDelta))*0.3333;sum+=unpackRGBAToDepth(texture2D(colorTexture,vec2(vUv.x,vUv.y)))*0.3333;sum+=unpackRGBAToDepth(texture2D(colorTexture,vUv+1.*uvDelta))*0.3333;gl_FragColor=packDepthToRGBA(sum);}"})}dispose(){this._shadowMat.dispose(),this._target=void 0,this.reset()}cleanupMaterial(){this._updateMaterial(!0)}_groundMapModeChanged(){this._attachedMesh&&(this.cleanupMaterial(),this._updateMaterial(),"alphaMap"===this.groundMapMode?this._attachedMesh.material.transparent=!0:this._attachedMesh.material.transparent=!1),this.reset()}_alphaVignetteChanged(){this.materialExtension?.setDirty?.(),this._viewer?.setDirty()}fromJSON(e,t){return(0,c.Hx)(e,this,!0,t),this.reset(),this}reset(){this._frameNumber=0}get frameNumber(){return this._frameNumber}autoUpdateShadow(){return!(!this.shadowAutoUpdate||this._bakeCounter>=this.maxBakeCount||!this.updateShadow()||(this._frameNumber===this.maxFrameNumber?this.dispatchEvent({type:"shadowBaked",bakeCount:++this._bakeCounter}):this._frameNumber>0&&this._frameNumber<this.maxFrameNumber&&this.dispatchEvent({type:"shadowBaking",progress:this._frameNumber/this.maxFrameNumber,bakeCount:this._bakeCounter}),0))}updateShadow(){if(!this.enabled)return!1;const e=this._attachedMesh;if(!e)return!1;if(++this._frameNumber>this.maxFrameNumber)return!1;const t=1024;this._target||(this._target=this._viewer.renderer.createTarget({type:a.ywz,depthBuffer:!1,size:new a.FM8(t,t),sizeMultiplier:void 0,colorSpace:a.aCh,format:a.wk1})),this._frameNumber<3?this._light.randomizePosition(0,1,0):this._light.randomizePosition(this._frameNumber),e.castShadow=!1;const i=this._viewer.renderer.rendererObject,r=i.shadowMap,s=r.type,n=r.needsUpdate,l=r.autoUpdate;r.type=this.shadowMapType,r.needsUpdate=!0,r.autoUpdate=!1;const c=this._viewer.scene,d=new a.S9g;d.disableAll(),c.modelObject.traverse((e=>{e.isLight&&e!==this._light.lightObject&&(e.userData.__gp_layers=e.layers,e.layers=d)}));const h=c.activeCamera.cameraObject;if(0!=(h.layers.mask&1<<this._lightLayer))throw"Camera can render pseudo directional light, check layers";h.layers.enable(this._lightLayer),e.layers.disable(this._lightLayer),(0,o.of)(i,{shadowMapRender:!0,backgroundRender:!1,sceneRender:!1},(()=>this._viewer.renderer.renderScene(c))),h.layers.disable(this._lightLayer);const p=h.layers.mask;h.layers.set(this._lightLayer),e.layers.enable(this._lightLayer);const u=this._viewer.renderer.getTempTarget({type:a.ywz,depthBuffer:!1,size:new a.FM8(t,t),colorSpace:a.aCh,format:a.wk1}),m=u.texture.colorSpace;u.texture.colorSpace=a.aCh,this._viewer.renderer.blit(this._target.texture,u,{clear:!0});{const t=e.material,r=e.frustumCulled,a=i.getRenderTarget(),s=i.getActiveCubeFace(),n=i.getActiveMipmapLevel();e.material=this._shadowMat,e.frustumCulled=!1,i.setRenderTarget(this._target);const l=!1;this._shadowMat.opacity=l?1/this.maxFrameNumber:Math.max(1/this.maxFrameNumber,1/this._frameNumber),this._shadowMat.lastFrameTexture=u.texture,this._shadowMat.needsUpdate=!0,(0,o.of)(i,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!0,transparentRender:!1,transmissionRender:!1},(()=>this._viewer.renderer.renderScene(c))),i.setRenderTarget(a,s,n),e.frustumCulled=r,e.material=t,this.smoothShadow&&this._applySmoothFilter(this._target,u)}return u.texture.colorSpace=m,this._viewer.renderer.releaseTempTarget(u),e.layers.disable(this._lightLayer),h.layers.mask=p,c.modelObject.traverse((e=>{e.isLight&&e!==this._light.lightObject&&(e.layers=e.userData.__gp_layers,delete e.userData.__gp_layers)})),r.type=s,r.needsUpdate=n,r.autoUpdate=l,e.castShadow=!0,(this._frameNumber<3||this._frameNumber>Math.min(100,this.maxFrameNumber)&&this._frameNumber%4==0)&&(this._updateMaterial(),this._viewer.setDirty(),e.dispatchEvent({type:"materialUpdate"})),!0}_updateMaterial(e=!1){this._attachedMesh&&(e?(this._attachedMesh.material.alphaMap===this._target?.texture&&(this._attachedMesh.material.alphaMap=null),this._attachedMesh.material.aoMap===this._target?.texture&&(this._attachedMesh.material.aoMap=null),this._attachedMesh.material.map===this._target?.texture&&(this._attachedMesh.material.map=null)):this._target&&("alphaMap"===this.groundMapMode&&(this._attachedMesh.material.alphaMap=this._target.texture),"aoMap"===this.groundMapMode&&(this._attachedMesh.material.aoMap=this._target.texture),"map"===this.groundMapMode&&(this._attachedMesh.material.map=this._target.texture)),this._attachedMesh.material&&(this._attachedMesh.material.userData.ALPHA_I_RGBA_PACKING=!e&&"alphaMap"===this.groundMapMode,this._attachedMesh.material.alphaTest=e||"alphaMap"!==this.groundMapMode?0:.01,this._attachedMesh.material.needsUpdate=!0))}_applySmoothFilter(e,t){this._shadowBlurMat.uniforms.colorTexture.value=e.texture,this._shadowBlurMat.uniforms.direction.value.set(1,0),this._shadowBlurMat.uniforms.size.value.set(e.width,e.height),this._viewer.renderer.blit(void 0,t,{material:this._shadowBlurMat}),this._shadowBlurMat.uniforms.colorTexture.value=t.texture,this._shadowBlurMat.uniforms.direction.value.set(0,1),this._shadowBlurMat.uniforms.size.value.set(t.width,t.height),this._viewer.renderer.blit(void 0,e,{material:this._shadowBlurMat})}}u([(0,c.qC)("randomizedLight")],m.prototype,"_light",void 0),u([(0,r.onChange)(m.prototype.reset),(0,c.qC)()],m.prototype,"maxFrameNumber",void 0),u([(0,r.onChange)(m.prototype.reset),(0,c.qC)()],m.prototype,"smoothShadow",void 0),u([(0,c.qC)(),(0,r.onChange)(m.prototype.reset)],m.prototype,"shadowMapType",void 0),u([(0,r.onChange)(m.prototype._groundMapModeChanged),(0,c.qC)()],m.prototype,"groundMapMode",void 0),u([(0,c.qC)(),(0,r.onChange)(m.prototype._alphaVignetteChanged)],m.prototype,"alphaVignette",void 0),u([(0,c.qC)(),(0,r.onChange)(m.prototype._alphaVignetteChanged)],m.prototype,"alphaVignetteAxis",void 0),u([(0,c.qC)()],m.prototype,"maxBakeCount",void 0);var f=i(3198),g=i(9389),v=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class _ extends a.Kj0{_updateExtension(){this.transparentReflectionBackground=this.reflectorModePhysical,this.materialExtension?.setDirty?.()}constructor(e,t,i=0){super(e),this.type="Reflector",this.isReflector2=!0,this.enabled=!0,this.reflectorModePhysical=!0,this.reflectionTargetNeedsUpdate=!0,this.transparentReflectionBackground=!0,this.materialExtension={extraUniforms:{tRefDiffuse:{value:null},tRefDiffuseSize:{value:new a.FM8},refTextureMatrix:{value:null},frameCount:{value:0},sceneBoundingRadius:{value:0}},extraDefines:{USE_UV:""},updaters:[],shaderExtender:(e,t,i)=>{if(this.enabled){e.vertexShader=(0,d.p)(e.vertexShader,"void main() {","void main() {\nvRefUv = refTextureMatrix * vec4( position, 1.0 );");const t="#glMarker beforeModulation";e.fragmentShader=(0,d.p)(e.fragmentShader,t,"\n                    if(roughnessFactor < 0.95) {\n                        float d = 0.;//textureProj(tRefDepth, vRefUv).r;\n                        // d = min(2., max(0., (d-0.06) * ((7./3.-ior)) * sceneBoundingRadius));\n                        vec4 refBaseColor = getReflectionColor(material.roughness, material.roughness * d);\n                        // refBaseColor.rgb = vec3(refBaseColor.a);\n                        // refBaseColor.a *= 1.0 - clamp(material.roughness * .3, 0., 1.);\n                        "+(this.reflectorModePhysical?"\n                        #if !defined(SSR_ENABLED) || SSR_ENABLED < 1 \n                        vec3 specularColor = EnvironmentBRDF(geometry.normal, geometry.viewDir, material.specularColor.rgb, material.specularF90, material.roughness);\n                        #endif\n                        reflectedLight.indirectSpecular = mix(vec3(reflectedLight.indirectSpecular), saturate(specularColor.rgb * refBaseColor.rgb), refBaseColor.a);\n                        ":"\n                        reflectedLight.indirectSpecular = saturate(diffuseColor.rgb * refBaseColor.rgb);\n                        diffuseColor.a *= refBaseColor.a;\n                        ")+"}\n"+t)}},parsVertexSnippet:()=>this.enabled?"\n\t\tuniform mat4 refTextureMatrix;\n\t\tvarying vec4 vRefUv;\n":"",parsFragmentSnippet:()=>this.enabled?g.Z+"\n"+f.Z+"\n#ifndef D_sceneBoundingRadius\n#define D_sceneBoundingRadius \nuniform float sceneBoundingRadius;\n#endif\nvarying vec4 vRefUv;uniform sampler2D tRefDiffuse;uniform vec2 tRefDiffuseSize;float getSpecularMIPLevel(const in float roughness,const in float maxMIPLevel){float sigma=PI*roughness*roughness/(1.+roughness);float desiredMIPLevel=maxMIPLevel+log2(sigma);return clamp(desiredMIPLevel,0.,maxMIPLevel);}vec4 getReflectionColor(const in float roughness,const in float depthModifier){float mip=getSpecularMIPLevel(roughness+depthModifier,5.);vec4 color=texture2D(tRefDiffuse,vRefUv.xy/vRefUv.w,mip);float blurDist=saturate(2./(1.+pow(abs(vViewPosition.z),0.25)))*mip*32.*color.a;float rnd=PI2*interleavedGradientNoise(vUv.xy,frameCount);vec4 rotationMatrix=vec4(cos(rnd),-sin(rnd),0.,0.);rotationMatrix.z=-rotationMatrix.y;rotationMatrix.w=rotationMatrix.x;vec3 colorSum=color.rgb*color.a;float weightSum=0.001+color.a;vec2 ofs;setPds();\n#pragma unroll_loop_start\nfor(int i=0;i<16;i++){ofs=poisson_disk_samples[UNROLLED_LOOP_INDEX];ofs=vec2(dot(ofs,rotationMatrix.xy),dot(ofs,rotationMatrix.zw));ofs=vRefUv.xy+vRefUv.w*blurDist*ofs/tRefDiffuseSize.xy;color=texture2D(tRefDiffuse,ofs/vRefUv.w,mip);colorSum+=color.rgb*color.a;weightSum+=color.a;}\n#pragma unroll_loop_end\nreturn vec4(colorSum/weightSum,1.);}":"",computeCacheKey:e=>this.enabled+" "+e.materialObject.transparent+" "+this.reflectorModePhysical+" ",onObjectRender:(e,{materialObject:t})=>{t.userData.__lastTransparent!==t.transparent&&(t.needsUpdate=!0,t.userData.__lastTransparent=t.transparent)},isCompatible:e=>e.isMeshStandardMaterial2},this.material=void 0,this._renderTarget=t;const r=new a.JOQ,s=new a.Pa4,n=new a.Pa4,l=new a.Pa4,c=new a.yGw,h=new a.Pa4(0,0,-1),p=new a.Ltg,u=new a.Pa4,m=new a.Pa4,v=new a.Ltg,_=new a.yGw,y=new a.cPb;a.M8C.isPowerOfTwo(t.texture.image.width)&&a.M8C.isPowerOfTwo(t.texture.image.height)||(this._renderTarget.texture.generateMipmaps=!1),this.onBeforeRender=(e,t,a)=>{if(!this.enabled||!e.userData.mainRenderPass)return;if(!this.reflectionTargetNeedsUpdate)return;const d=a.view?Object.assign({},a.view):null;if(d&&a.clearViewOffset&&a.clearViewOffset(),n.setFromMatrixPosition(this.matrixWorld),l.setFromMatrixPosition(a.matrixWorld),c.extractRotation(this.matrixWorld),s.set(0,0,1),s.applyMatrix4(c),u.subVectors(n,l),u.dot(s)>0)return;u.reflect(s).negate(),u.add(n),c.extractRotation(a.matrixWorld),h.set(0,0,-1),h.applyMatrix4(c),h.add(l),m.subVectors(n,h),m.reflect(s).negate(),m.add(n),y.position.copy(u),y.up.set(0,1,0),y.up.applyMatrix4(c),y.up.reflect(s),y.lookAt(m),y.far=2,y.near=0,y.updateMatrixWorld(),y.projectionMatrix.copy(a.projectionMatrix),_.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),_.multiply(y.projectionMatrix),_.multiply(y.matrixWorldInverse),_.multiply(this.matrixWorld),r.setFromNormalAndCoplanarPoint(s,n),r.applyMatrix4(y.matrixWorldInverse),p.set(r.normal.x,r.normal.y,r.normal.z,r.constant);const f=y.projectionMatrix;v.x=(Math.sign(p.x)+f.elements[8])/f.elements[0],v.y=(Math.sign(p.y)+f.elements[9])/f.elements[5],v.z=-1,v.w=(1+f.elements[10])/f.elements[14],p.multiplyScalar(2/p.dot(v)),f.elements[2]=p.x,f.elements[6]=p.y,f.elements[10]=p.z+1-i,f.elements[14]=p.w,this.visible=!1;const g=e.getRenderTarget(),b=e.xr.enabled,w=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(this._renderTarget),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear();const x=t.background;this.transparentReflectionBackground&&(t.background=null);const D=!this.transparentReflectionBackground;x?.isTexture&&D&&(x.userData||(x.userData={}),x.userData.flipX=!x.userData.flipX),(0,o.of)(e,{shadowMapRender:!1,backgroundRender:D,opaqueRender:!0,transparentRender:!0,transmissionRender:!1,screenSpaceRendering:!1},(()=>e.render(t,y))),x?.isTexture&&D&&(x.userData.flipX=!x.userData.flipX||void 0),this.transparentReflectionBackground&&(t.background=x),e.xr.enabled=b,e.shadowMap.autoUpdate=w,e.setRenderTarget(g),d?.enabled&&a.setViewOffset&&a.setViewOffset(d.fullWidth,d.fullHeight,d.offsetX,d.offsetY,d.width,d.height);const S=a.viewport;void 0!==S&&e.state.viewport(S),this.visible=!0,this.reflectionTargetNeedsUpdate=!1},this.textureMatrix=_,this.materialExtension.extraUniforms.tRefDiffuse.value=this._renderTarget.texture,this.materialExtension.extraUniforms.tRefDiffuseSize.value=new a.FM8(this._renderTarget.width,this._renderTarget.height),this.materialExtension.extraUniforms.refTextureMatrix.value=_}getRenderTarget(){return this._renderTarget}}v([(0,r.onChange)(_.prototype._updateExtension)],_.prototype,"enabled",void 0),v([(0,r.onChange)(_.prototype._updateExtension)],_.prototype,"reflectorModePhysical",void 0),_.prototype.isReflector=!0;var y=i(9228),b=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class w extends y.g{get shadowBaker(){return this._shadowBaker}bakeShadows(){this._shadowBaker?.reset()}constructor(e={},t=!1){super(e),this.bakedShadows=!0,this.groundReflection=!1,this.physicalReflections=!1,this.autoBakeShadows=!0,this._showDebug=t,t&&this.dependencies.push(s.z),this._onSceneUpdate=this._onSceneUpdate.bind(this)}_createMesh(){const e=new _(this._geometry,this._viewer.renderer.createTarget({type:a.ywz,format:a.wk1,colorSpace:a.aCh,size:{width:1024,height:1024},generateMipmaps:!0,depthBuffer:!0,minFilter:a.D1R,magFilter:a.wem})),t=e.onBeforeRender;return e.onBeforeRender=(...e)=>{let i=this._viewer?.getPluginByType("SSReflection")?.passes.ssr.passObject;i&&!i.enabled&&(i=void 0),i&&(i.enabled=!1);let r=this._viewer?.getPluginByType("SSBevelPlugin")?.pass?.passObject;r&&!r.enabled&&(r=void 0),r&&(r.enabled=!1),t(...e),i&&(i.enabled=!0),r&&(r.enabled=!0)},e}async onAdded(e){await super.onAdded(e),this._showDebug&&(e.getPlugin(s.z)?.addTexture("bake_ground_1",(()=>this._shadowBaker?.light.shadow.map?.texture),[100,100,200,200]),e.getPlugin(s.z)?.addTexture("bake_ground_2",(()=>this._shadowBaker?.target?.texture),[100,400,400,400],"texel = vec4(vec3(unpackRGBAToDepth(texel)), 1.0);"))}_postFrame(){super._postFrame(),this._viewer&&this.enabled&&this._shadowBaker&&this.bakedShadows&&this._shadowBaker.autoUpdateShadow()}_preRender(){super._preRender(),this._viewer&&(this._mesh.reflectionTargetNeedsUpdate=this._viewer.renderer.frameCount<1)}async onDispose(e){return super.onDispose(e)}async onRemove(e){return super.onRemove(e)}_removeMaterial(){if(this._material){if(this._shadowBaker&&this._material.groundMatExtension&&(this._material.unregisterMaterialExtensions?.([this._shadowBaker.materialExtension]),delete this._material.groundMatExtension),this._material.reflectorMatExtension){const e=this._mesh.materialExtension;e||console.warn("unable to find the extension to unregister"),this._material.unregisterMaterialExtensions?.([e]),delete this._material.reflectorMatExtension}super._removeMaterial()}}_onSceneUpdate(e){super._onSceneUpdate(e),!1!==e.geometryChanged&&this.autoBakeShadows&&this._shadowBaker?.reset()}refreshOptions(){if(!this._viewer)return;this.bakedShadows&&!this._shadowBaker?(this._shadowBaker=new m(this._viewer),this._shadowBaker.attachedMesh=this._mesh):!this.bakedShadows&&this._shadowBaker&&(this._shadowBaker.reset(),this._shadowBaker.cleanupMaterial());const e=this._mesh;e.isReflector2&&(e.enabled=this.groundReflection,e.reflectorModePhysical=this.physicalReflections),super.refreshOptions(),this._viewer.setDirty(this)}_refreshMaterial(){if(!this._viewer)return!1;const e=super._refreshMaterial();if(!this._material)return e;if(this.groundReflection&&this._mesh.isReflector2&&!this._material.reflectorMatExtension){const e=this._mesh.materialExtension;e.updaters=[this._viewer.scene,this._viewer.renderer],this._material.registerMaterialExtensions?.([e]),this._material.reflectorMatExtension=!0}return this.bakedShadows&&this._shadowBaker&&!this._material.groundMatExtension&&(this._material.registerMaterialExtensions?.([this._shadowBaker.materialExtension]),this._material.groundMatExtension=!0),this._material.materialObject.userData.ssreflDisabled=this.groundReflection,this._material.materialObject.userData.ssreflNonPhysical=!this.physicalReflections,this._viewer.setDirty(this),e}_extraUiConfig(){return[{label:"Baked Shadows",type:"checkbox",property:[this,"bakedShadows"]},{label:"Shadow Frames",type:"input",hidden:()=>!this._shadowBaker,stepSize:1,bounds:[1,1e3],property:[this._shadowBaker,"maxFrameNumber"]},{label:"Alpha Vignette",type:"checkbox",hidden:()=>!this._material||this._material.transmission<1e-4&&!this._material.transparent,property:[this._shadowBaker,"alphaVignette"],limitedUi:!0,onChange:()=>this._uiConfig?.uiRefresh?.("postFrame",!0)},{label:"Alpha Vignette Axis",type:"dropdown",hidden:()=>!this._shadowBaker?.alphaVignette||!this._material||this._material.transmission<1e-4&&!this._material.transparent,property:[this._shadowBaker,"alphaVignetteAxis"],children:["x","y","xy"].map((e=>({label:e,value:e}))),limitedUi:!0},{label:"Planar Reflections",type:"checkbox",property:[this,"groundReflection"],limitedUi:!0},{label:"Physical Reflections",type:"checkbox",property:[this,"physicalReflections"],limitedUi:!0},{label:"Shadow type",type:"dropdown",hidden:()=>!this._shadowBaker,property:[this._shadowBaker,"groundMapMode"],children:[{label:"aoMap"},{label:"map"},{label:"alphaMap"}],limitedUi:!0},{label:"Smooth Shadow",type:"checkbox",property:[this._shadowBaker,"smoothShadow"]},{label:"Baked shadow type",type:"dropdown",children:[["Basic",a._MY],["PCF",a._iA],["PCFSoft",a.ntZ],["VSM",a.dwk]].map((e=>({label:e[0].toString(),value:e[1]}))),property:[this._shadowBaker,"shadowMapType"]},{type:"folder",label:"Randomized Light",hidden:()=>!this._shadowBaker,limitedUi:!0,children:[{type:"color",label:"Color",property:[this._shadowBaker?.light,"color"]},{type:"slider",label:"Intensity",bounds:[0,100],property:[this._shadowBaker?.light,"intensity"]},{type:"checkbox",label:"Shadow Enabled",property:[this._shadowBaker?.light?.shadowParams,"enabled"],onChange:[this._shadowBaker?.light?.updateShadowParams,this._onSceneUpdate]},{type:"slider",bounds:[0,1],property:[this._shadowBaker?.light?.randomParams,"focus"],onChange:[this._onSceneUpdate]},{type:"slider",bounds:[0,1],property:[this._shadowBaker?.light?.randomParams,"spread"],onChange:[this._onSceneUpdate],limitedUi:!0},{type:"slider",bounds:[.01,60],property:[this._shadowBaker?.light?.randomParams,"distanceScale"],onChange:[this._shadowBaker?.light?.updateShadowParams,this._onSceneUpdate]},{type:"vec3",bounds:[-1,1],property:[this._shadowBaker?.light?.randomParams,"direction"],onChange:[this._onSceneUpdate],limitedUi:!0},{type:"vec3",bounds:[-1,1],property:[this._shadowBaker?.light?.randomParams,"normalDirection"],onChange:[this._onSceneUpdate],limitedUi:!0},{type:"slider",bounds:[.01,10],property:[this._shadowBaker?.light?.shadowParams,"radius"],onChange:[this._shadowBaker?.light?.updateShadowParams,this._onSceneUpdate]},{type:"input",property:[this._shadowBaker?.light?.shadowParams,"frustumSize"],onChange:[this._shadowBaker?.light?.updateShadowParams,this._onSceneUpdate]},{type:"slider",bounds:[-.1,.1],property:[this._shadowBaker?.light?.shadowParams,"bias"],onChange:[this._shadowBaker?.light?.updateShadowParams,this._onSceneUpdate]}]},...super._extraUiConfig()]}}w.PluginType="Ground",b([(0,r.onChange)(w.prototype.refreshOptions),(0,c.qC)()],w.prototype,"bakedShadows",void 0),b([(0,r.onChange)(w.prototype.refreshOptions),(0,c.qC)()],w.prototype,"groundReflection",void 0),b([(0,r.onChange)(w.prototype.refreshOptions),(0,c.qC)()],w.prototype,"physicalReflections",void 0),b([(0,c.qC)("shadowBaker")],w.prototype,"_shadowBaker",void 0)},1213:function(e,t,i){i.d(t,{h:function(){return h}});var r,a=i(2988),s=i(5551),n=i(3995),o=i(4107),l=i(9008),c=i(8670),d=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};let h=r=class extends n.Q{constructor(e=!1){super(),this.enabled=!1,this.worldRadius=100,this.tripodHeight=10,this.originPosition=new a.Pa4(0,0,0),this._paramsChanged=this._paramsChanged.bind(this),this.enabled=e,this.addEventListener("deserialize",this._paramsChanged)}_paramsChanged(){if(!this._viewer)return;const e=this._viewer.scene.background;if(this.enabled&&e!==this._viewer.scene.environment&&"environment"!==e)if(e&&e.isDataTexture)e.mapping=a.dSO;else if(confirm("Background must be same as environment, do you want to change it?")){const e=this._viewer.getPluginByType("SimpleBackgroundEnvUiPlugin1");e?(e.envmapBg=!0,e.uiConfig.uiRefresh?.("postFrame",!0)):this._viewer.scene.setBackground("environment")}else this.enabled=!1;const t=this._viewer.renderer.rendererObject.background.getBoxMesh2()?.material,i=t?.uniforms??a.Vj0.backgroundCube.uniforms;i.tripodHeight||(i.tripodHeight={value:1}),i.worldRadius||(i.worldRadius={value:1}),i.originPosition||(i.originPosition={value:new a.Pa4}),i.tripodHeight.value=this.tripodHeight,i.worldRadius.value=this.worldRadius,i.originPosition.value.copy(this.originPosition),t&&(!this.enabled&&t.defines.HDRi_GROUND_PROJ?delete t.defines.HDRi_GROUND_PROJ:this.enabled&&(t.defines.HDRi_GROUND_PROJ="1"),t.needsUpdate=!0),this._viewer.setDirty()}async onAdded(e){await super.onAdded(e),this._viewer?.renderer?.rendererObject?.background.getBoxMesh()&&e.console.error("HDRi Ground Plugin must be added before setting any cube or env map"),a.Vj0.backgroundCube.fragmentShader.includes("#ifdef HDRi_GROUND_PROJ")||(a.Vj0.backgroundCube.fragmentShader=(0,c.p)(a.Vj0.backgroundCube.fragmentShader,"void main() {","#ifdef HDRi_GROUND_PROJ\nfloat intersectPlane1(const in vec3 r0,const in vec3 rd,const in vec3 n,const in vec3 p0){float t=dot(p0-r0,n)/(dot(n,rd)+1e-6);return t<0.?1000.:t;}float intersectSphere1(in vec3 ro,in vec3 rd,in vec3 sph,in float rad){vec3 oc=ro-sph;float b=dot(oc,rd);float c=dot(oc,oc)-rad*rad;float t=b*b-c;return t<0.?t:-b+sqrt(t);}\n#define PI_HALF  1.5707963267948966\nuniform float worldRadius;uniform float tripodHeight;uniform vec3 originPosition;vec3 hdriProject(){vec3 p=normalize(vWorldDirection);vec3 camPos=cameraPosition;camPos.y-=tripodHeight;float t=intersectSphere1(camPos,p,originPosition,worldRadius);if(t>0.){float t2=intersectPlane1(camPos,p,vec3(0,-1,0),originPosition+vec3(0.,-tripodHeight,0.));p=(camPos+min(t,t2)*p)/worldRadius;}else p=vec3(0.,1.,0.);return p;}\n#endif\n",{prepend:!0}),a.Vj0.backgroundCube.fragmentShader=(0,c.p)(a.Vj0.backgroundCube.fragmentShader,"vec3 vReflect = vWorldDirection;","\nvec3 vReflect = \n#ifdef HDRi_GROUND_PROJ\nhdriProject()\n#else\nvWorldDirection\n#endif\n;\n")),e.scene.addEventListener("environmentChanged",this._paramsChanged)}};h.PluginType="HDRiGroundPlugin",d([(0,o.qC)(),(0,l.onChange)(r.prototype._paramsChanged),(0,s.Q7)("Enabled")],h.prototype,"enabled",void 0),d([(0,o.qC)(),(0,l.onChange)(r.prototype._paramsChanged),(0,s.t8)("World Radius",[1,1e3],.01)],h.prototype,"worldRadius",void 0),d([(0,o.qC)(),(0,l.onChange)(r.prototype._paramsChanged),(0,s.t8)("Tripod height",[0,50],.01)],h.prototype,"tripodHeight",void 0),d([(0,o.qC)(),(0,l.onChange)(r.prototype._paramsChanged),(0,s.KG)("Origin Position",void 0,.001,(e=>({onChange:e._paramsChanged})))],h.prototype,"originPosition",void 0),h=r=d([(0,s.Sp)("HDRi Ground")],h)},9923:function(e,t,i){i.d(t,{z:function(){return u}});var r=i(9008),a=i(3995),s=i(776),n=i(4821),o=i(4107),l=i(4379);class c extends a.Q{constructor(){super(...arguments),this.enabled=!0,this._uiNeedRefresh=!1,this._refreshUiConfig=()=>{this.enabled&&this.uiConfig.uiRefresh?.()},this.dependencies=[n.k],this.variations=[],this._selectedMaterial=()=>this._picking?.getSelectedObject()?.material||void 0,this.uiConfig={label:"Material Configurator",type:"folder",children:[()=>[{type:"input",label:"uuid",property:[this._selectedMaterial(),"uuid"],hidden:()=>!this._selectedMaterial(),disabled:!0},{type:"input",label:"title",hidden:()=>!this._selectedMaterial(),property:()=>[this.getSelectedVariation(),"title"],onChange:async()=>this.refreshUi()},{type:"dropdown",label:"Preview Type",hidden:()=>!this._selectedMaterial(),property:()=>[this.getSelectedVariation(),"preview"],onChange:async()=>this.refreshUi(),children:["generate:sphere","generate:cube","color","map","emissive",...Object.keys(l.jc).filter((e=>e.endsWith("Map")))].map((e=>({label:e,value:e})))},...this.getSelectedVariation()?.materials.map((e=>e.uiConfig?Object.assign(e.uiConfig,{expanded:!1}):{}))||[],{type:"button",label:"Remove variations",hidden:()=>!this._selectedMaterial(),value:async()=>{const e=this.getSelectedVariation();e&&await this._viewer.confirm("Material configurator: Remove all variations for this material?")&&(e.materials=[]),this.refreshUi()}},{type:"button",label:"Remove completely",hidden:()=>!this._selectedMaterial(),value:async()=>{const e=this.getSelectedVariation();e&&await this._viewer.confirm("Material configurator: Remove this variation?")&&this.removeVariation(e)}},{type:"button",label:"Add Variation",hidden:()=>!this._selectedMaterial(),value:()=>this.addVariation(this._selectedMaterial())},{type:"button",label:"Refresh Ui",value:()=>this.refreshUi()},{type:"button",label:"Apply All",value:()=>{this.variations.forEach((e=>this.applyVariation(e,e.materials[0].uuid)))}}]]}}async onAdded(e){await super.onAdded(e),this.refreshUi=this.refreshUi.bind(this),this._refreshUi=this._refreshUi.bind(this),this._picking=this._viewer?.getPluginByType("Picking"),this._previewGenerator=new s.B(this._viewer),this._picking?.addEventListener("selectedObjectChanged",this._refreshUiConfig),e.addEventListener("preFrame",this._refreshUi),this.addEventListener("deserialize",this.refreshUi)}fromJSON(e,t){return this.variations=[],super.fromJSON(e,t)}async onRemove(e){return this._previewGenerator?.dispose(),this._previewGenerator=void 0,this._picking?.removeEventListener("selectedObjectChanged",this._refreshUiConfig),this.removeEventListener("deserialize",this.refreshUi),e.removeEventListener("preFrame",this._refreshUi),this._picking=void 0,super.onRemove(e)}findVariation(e){return e?this.variations.find((t=>t.uuid===e)):void 0}getSelectedVariation(){return this.findVariation(this._selectedMaterial()?.uuid)||this.findVariation(this._selectedMaterial()?.name)}applyVariation(e,t){const i=e.materials.find((e=>e.uuid===t)),r=this._viewer?.getManager()?.materials;return!!r&&!!i&&r.applyMaterial(i,e.uuid)}refreshUi(){this.enabled&&(this._uiNeedRefresh=!0)}async _refreshUi(){return!(!this.enabled||!this._viewer||!this._uiNeedRefresh||(this._uiNeedRefresh=!1,this._refreshUiConfig(),0))}removeVariationForMaterial(e){let t=this.findVariation(e.uuid);!t&&e.name.length>0&&(t=this.findVariation(e.name)),t&&this.removeVariation(t)}removeVariation(e){e&&(this.variations.splice(this.variations.indexOf(e),1),this.refreshUi())}addVariation(e){const t=e?.clone?.();if(e&&t){let i=this.findVariation(e.uuid);!i&&e.name.length>0&&(i=this.findVariation(e.name)),i||this.variations.push(i={uuid:e.name.length>0?e.name:e.uuid,title:e.name.length>0?e.name:"No Name",preview:"generate:sphere",materials:[]}),i.materials.push(t),this.refreshUi()}}}c.PluginType="MaterialConfiguratorBasePlugin",function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);s>3&&n&&Object.defineProperty(t,i,n)}([(0,o.qC)()],c.prototype,"variations",void 0);var d=i(1375),h=i(7162),p=i(589);class u extends c{constructor(){super(...arguments),this.enableEditContextMenus=!1}async _refreshUi(){if(!await super._refreshUi())return!1;d.M.RemoveAll(u.PluginType);for(const e of this.variations)d.M.Create(u.PluginType,e.title+(this.enableEditContextMenus?" ("+e.uuid+")":""),5,20,0,e.materials.map((t=>{let i;if(e.preview.startsWith("generate:"))i=this._previewGenerator.generate(t,e.preview.split(":")[1]);else{const a=t[e.preview]||"#ff00ff";i=a.image?(0,r.imageBitmapToBase64)(a.image,100):void 0,i||(i=(0,r.makeColorSvgCircle)(a?.isColor?a.getHexString():a))}return{id:t.uuid,image:i,onClick:t=>this.applyVariation(e,t),tooltip:t.name||t.uuid}})),((t,i,r)=>{(0,h.ZP)(t,{placement:"bottom",content:i.tooltip}),t.oncontextmenu=t=>{if(!this.enableEditContextMenus)return;t.preventDefault(),t.stopPropagation();const r=p.D.Create({Remove:async()=>{await(this._viewer?.confirm("Remove material: Remove material from this variation list?"))&&(e.materials=e.materials.filter((e=>e.uuid!==i.id)),this.refreshUi(),p.D.Remove())},"Remove All":async()=>{await(this._viewer?.confirm("Remove all: Remove all materials from this variation list?"))&&(e.materials=[],this.refreshUi(),p.D.Remove())}},t.clientX,t.clientY);document.body.appendChild(r)},r.oncontextmenu=t=>{if(!this.enableEditContextMenus)return;t.preventDefault(),t.stopPropagation();const i=p.D.Create({"Rename mapping":async()=>{const t=await(this._viewer?.prompt("Change name: New material name to map to",e.uuid,!0));t&&(e.uuid=t,this.refreshUi())},"Rename title":async()=>{const t=await(this._viewer?.prompt("Change name: New material name to map to",e.title,!0));t&&(e.title=t,this.refreshUi())},"Remove Section":async()=>{await(this._viewer?.confirm("Remove variations: Remove this category of variations?"))&&(this.removeVariation(e),p.D.Remove())}},t.clientX,t.clientY);document.body.appendChild(i)}}));return d.M.RebuildUi(this._viewer?.container),!0}}u.PluginType="MaterialConfiguratorPlugin"},1358:function(e,t,i){i.d(t,{M:function(){return m}});var r=i(3995),a=i(776),s=i(4821),n=i(5551);class o extends r.Q{constructor(){super(...arguments),this.enabled=!0,this._uiNeedRefresh=!1,this._refreshUiConfig=()=>{this.enabled&&this.uiConfig?.uiRefresh?.("postFrame",!0)},this.dependencies=[s.k],this._selectedObject=()=>this._picking?.getSelectedObject()||void 0,this._selectedMaterial=()=>this._selectedObject()?.material||void 0}async onAdded(e){await super.onAdded(e),this.refreshUi=this.refreshUi.bind(this),this._refreshUi=this._refreshUi.bind(this),this._picking=this._viewer?.getPluginByType("Picking"),this._previewGenerator=new a.B(this._viewer),this._picking?.addEventListener("selectedObjectChanged",this._refreshUiConfig),e.addEventListener("preFrame",this._refreshUi),this.addEventListener("deserialize",this.refreshUi)}async onRemove(e){return this._previewGenerator?.dispose(),this._previewGenerator=void 0,this._picking?.removeEventListener("selectedObjectChanged",this._refreshUiConfig),this.removeEventListener("deserialize",this.refreshUi),e.removeEventListener("preFrame",this._refreshUi),this._picking=void 0,super.onRemove(e)}refreshUi(){this.enabled&&(this._uiNeedRefresh=!0)}async _refreshUi(){return this._uiNeedRefresh&&this.enabled&&this._refreshUiConfig(),this._uiNeedRefresh=!1,!1}}o.PluginType="MaterialLibraryBasePlugin",function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);s>3&&n&&Object.defineProperty(t,i,n)}([(0,n.Q7)("Enabled")],o.prototype,"enabled",void 0);var l=i(9008),c=i(4379),d=i(2815),h=i(1375),p=i(8570),u=i(7162);class m extends o{constructor(){super(...arguments),this.replaceMaterial=!1,this.uiConfig={type:"folder",label:"Material Library",uuid:(0,p.Z)(),children:[...(0,n._t)(this),()=>({type:"dropdown",label:"Apply Material",limitedUi:!0,hidden:()=>!this._selectedObject(),children:[{label:"select one",value:""},[...this._viewer.getPlugin(s.k).materials.getAllMaterials().map((e=>({label:e.name||e.uuid,value:e.uuid})))||[]]],getValue:()=>this._selectedMaterial()?.uuid,setValue:e=>{const t=this._viewer?.getPlugin(s.k)?.materials?.findMaterial(e);if(t)if(this.replaceMaterial)this._selectedObject()?.setMaterial?.(t);else{const e=this._selectedMaterial();if(e){const i=e.name,r=e.uuid;e.copyProps(t),e.name=i,e.uuid=r,e.userData.uuid&&(e.userData.uuid=r)}}this._refreshUi()}})]}}async _refreshUi(){if(!await super._refreshUi())return!1;const e=[c.iu.TypeSlug,d.y.TypeSlug],t=this._viewer?.getPlugin(s.k)?.materials,i=e.map((e=>[e,t?.getMaterialsOfType(e)]));h.M.RemoveAll(m.PluginType);for(const[e,r]of i)h.M.Create(m.PluginType,e,5,20,0,r?.filter((e=>!e.userData.runtimeMaterial)).map((e=>{let i;const r="generate:sphere";if(r.startsWith("generate:"))i=this._previewGenerator.generate(e,r.split(":")[1]);else{const t=e[r]||"#ff00ff";i=t.image?(0,l.imageBitmapToBase64)(t.image,100):void 0,i||(i=(0,l.makeColorSvg)(t))}return{id:e.uuid,image:i,onClick:e=>{const i=t?.findMaterial(e);if(i){const e=i.userData.__appliedMeshes;if(e?.size){const t=e.keys().next().value;t.dispatchEvent({type:"select",value:t})}}},tooltip:e.name||e.uuid}})),((e,t)=>(0,u.ZP)(e,{placement:"bottom",content:t.tooltip})));return h.M.RebuildUi(this._viewer?.container),!0}}m.PluginType="MaterialLibraryPlugin",function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);s>3&&n&&Object.defineProperty(t,i,n)}([(0,n.Q7)("Replace Material")],m.prototype,"replaceMaterial",void 0)},3415:function(e,t,i){i.d(t,{q:function(){return n}});var r=i(3995),a=i(8570),s=i(4107);class n extends r.Q{get passes(){if(!this._passes)throw"Plugin not yet added to the viewer";return this._passes}get pipeline(){return this._pipeline}set pipeline(e){this._pipeline=e}constructor(){super(),this._pipeline=[]}async onAdded(e){await super.onAdded(e);const t=this.createPasses(e);this._passes=Object.fromEntries(t.map((t=>(t.passId||(console.warn("no id found for pass",t),t.passId=(0,a.Z)()),e.renderer.registerPass(t,!0),[t.passId,t]))))}async onRemove(e){if(this._passes){for(const t of[...Object.values(this._passes)]){const i=t;e.renderer.unregisterPass(i),i?.dispose?.()}this._passes=void 0}await super.onRemove(e)}toJSON(e){const t=super.toJSON(e);if(!t.type)return t;const i=Object.entries(this.passes);t.passes={};for(const[r,a]of i)t.passes[r]=(0,s.HD)(a?.passObject??a,!1,e);return t}fromJSON(e,t){if(!super.fromJSON(e,t))return null;if(e.passes){const i=Object.entries(this.passes);for(const[r,a]of i)(0,s.Hx)(e.passes[r],a?.passObject??a,!1,t)}return this}}},7697:function(e,t,i){i.d(t,{i:function(){return _}});var r=i(6757),a=i(3415),s=i(7245),n=i(8284),o=i(2988),l=i(7320),c=i(3198),d=i(5130),h=i(9008),p=i(6533),u=i(4107),m=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class f extends s.Hl{constructor(e,t,i){super({defines:{LINEAR_DEPTH:1,NUM_SAMPLES:11,NUM_SPIRAL_TURNS:3,DEPTH_NORMAL_TEXTURE:1,DEPTH_PACKING_MODE:2,PERSPECTIVE_CAMERA:1},uniforms:{tLastThis:{value:null},tNormalDepth:{value:null},tGBufferFlags:{value:null},screenSize:{value:new o.FM8(512,512)},saoData:{value:new o.Ltg},frameCount:{value:0},cameraNearFar:{value:new o.FM8(.1,1e3)},projection:{value:new o.yGw},saoBiasEpsilon:{value:new o.Pa4(1,1,1)}},vertexShader:l.Z,fragmentShader:`\n\n${c.Z}\n\n${i}\n\n#include <common>\n#include <packing>\nvarying vec2 vUv;uniform vec2 cameraNearFar;uniform mat4 projection;uniform sampler2D tLastThis;uniform vec4 saoData;uniform vec3 saoBiasEpsilon;uniform vec2 screenSize;const float INV_NUM_SAMPLES=1./float(NUM_SAMPLES);int getSelectionBit(in int number){\n#ifdef WebGL2Context\nreturn(number/4)%2;\n#else\nreturn int(mod(floor(float(number)/4.),2.));\n#endif\n}float getViewZFromNDCZ(const in float depth){\n#if PERSPECTIVE_CAMERA == 1\nreturn perspectiveDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);\n#else\nreturn orthographicDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);\n#endif\n}vec3 packFloatToRGB(const in float x){const vec3 code=vec3(1.,255.,65025.);vec3 pack=vec3(code*x);pack.gb=fract(pack.gb);pack.rg-=pack.gb*(1./256.);return pack;}vec3 getViewPositionFromViewZ(const in vec2 uv,const in float viewDepth){vec2 uv_=2.*uv-1.;float xe=-(uv_.x+projection[2][0])*viewDepth/projection[0][0];float ye=-(uv_.y+projection[2][1])*viewDepth/projection[1][1];return vec3(xe,ye,viewDepth);}float decodeDepth(const in vec2 uv){vec4 uncodedDepth;\n#if DEPTH_PACKING_MODE == 2\nuncodedDepth=texture2D(tNormalDepth,uv);\n#else\nuncodedDepth=texture2D(tDepth,uv);\n#endif\n#if DEPTH_PACKING_MODE == 0\nreturn uncodedDepth.x;\n#elif DEPTH_PACKING_MODE == 1\n#if LINEAR_DEPTH == 1\nreturn pow2(unpackRGBAToDepth(uncodedDepth));\n#else\nreturn unpackRGBAToDepth(uncodedDepth);\n#endif\n#else\nreturn pow2(unpack16(uncodedDepth.xy));\n#endif\n}vec3 getPositionFromOffset(const in vec2 uv,const in vec2 offset,const in float screenSpaceRadius){vec2 uvOffset=uv+floor(screenSpaceRadius*offset)/screenSize;float d=decodeDepth(uvOffset);\n#if LINEAR_DEPTH == 0\nfloat centerViewZ=getViewZFromNDCZ(d);return getViewPositionFromViewZ(uvOffset,centerViewZ);\n#else\nd=mix(-cameraNearFar.x,-cameraNearFar.y,d);return getViewPositionFromViewZ(uvOffset,d);\n#endif\n}float getOcclusion(const in vec2 uv,const in int id,const in float randomAngle,const in float occlusionSphereRadius,const in vec3 centerPosition,const in vec3 centerNormal){float screenSpaceRadius=(float(id)+mod(randomAngle,1.)+0.5)*INV_NUM_SAMPLES;float angle=screenSpaceRadius*(float(NUM_SPIRAL_TURNS)*6.28)+randomAngle;screenSpaceRadius=(screenSpaceRadius*occlusionSphereRadius);vec2 offset=vec2(cos(angle),sin(angle));vec3 samplePosition=getPositionFromOffset(uv,offset,screenSpaceRadius);vec3 direction=samplePosition-centerPosition;float d2=dot(direction,direction);float ao=max((dot(centerNormal,direction)+centerPosition.z*saoBiasEpsilon.x)/(saoBiasEpsilon.z*d2+saoBiasEpsilon.y),0.);return ao;}void main(){float centerDepth;vec3 centerNormal;getDepthNormal(vUv,centerDepth,centerNormal);\n#if LINEAR_DEPTH == 0\nfloat centerViewZ=getViewZFromNDCZ(centerDepth);\n#else\nfloat centerViewZ=mix(-cameraNearFar.x,-cameraNearFar.y,centerDepth);\n#endif\nvec3 centerPosition=getViewPositionFromViewZ(vUv,centerViewZ);float occlusionSphereScreenRadius=200.*saoData.z/(-centerPosition.z);float randomAngle=6.2*random3(vec3(vUv,frameCount*0.1));float sum=0.;sum+=getOcclusion(vUv,0,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#if NUM_SAMPLES > 1\nsum+=getOcclusion(vUv,1,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#endif\n#if NUM_SAMPLES > 2\nsum+=getOcclusion(vUv,2,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#endif\n#if NUM_SAMPLES > 3\nsum+=getOcclusion(vUv,3,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#endif\n#if NUM_SAMPLES > 4\nsum+=getOcclusion(vUv,4,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#endif\n#if NUM_SAMPLES > 5\nsum+=getOcclusion(vUv,5,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#endif\n#if NUM_SAMPLES > 6\nsum+=getOcclusion(vUv,6,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#endif\n#if NUM_SAMPLES > 7\nsum+=getOcclusion(vUv,7,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#endif\n#if NUM_SAMPLES > 8\nsum+=getOcclusion(vUv,8,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#endif\n#if NUM_SAMPLES > 9\nsum+=getOcclusion(vUv,9,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#endif\n#if NUM_SAMPLES > 10\nsum+=getOcclusion(vUv,10,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);\n#endif\nfloat aoValue=sum*saoData.y*INV_NUM_SAMPLES;bool disableAO=getSelectionBit(getGBufferFlags(vUv).a)>0?true:false;aoValue=clamp(1.-max(aoValue,0.),0.,1.);gl_FragColor.gba=packFloatToRGB(centerDepth);gl_FragColor.r=(vec4(aoValue)).r;}\n\n            `},"tDiffuse"),this.parameters={intensity:.25,occlusionWorldRadius:1,bias:.001,falloff:1.3},this._smoothEnabled=!0,this.materialExtension={shaderExtender:(e,t,i)=>{e.defines.SSAO_ENABLED&&(e.fragmentShader=e.fragmentShader.replace("#include <aomap_fragment>","#ifndef USE_TRANSMISSION\n#if defined(SSAO_ENABLED) && SSAO_ENABLED > 0\nfloat ambientOcclusion=tSSAOMapTexelToLinear(texture2D(tSSAOMap,viewToScreen(vViewPosition.xyz).xy)).r;reflectedLight.indirectDiffuse*=ambientOcclusion;\n#if defined( USE_ENVMAP )\nfloat dotNV=saturate(dot(geometry.normal,geometry.viewDir));reflectedLight.indirectSpecular*=computeSpecularOcclusion(dotNV,ambientOcclusion,material.roughness);\n#endif\n#else\n#include <aomap_fragment>\n#endif\n#endif\n"))},onObjectRender:(e,t,i)=>{this.materialExtension.extraUniforms.tSSAOMap.value=this._target?.texture;const r=t.materialObject,a=!r.transparent&&r.transmission<.001;let s=this.enabled&&a&&!1!==i.userData.screenSpaceRendering&&!t.userData?.ssaoDisabled?1:0;r.defines.SSAO_ENABLED!==s&&(r.defines.SSAO_ENABLED=s,r.needsUpdate=!0),s=this._target.texture,this.materialExtension.extraUniforms.tSSAOMap.value!==s&&(this.materialExtension.extraUniforms.tSSAOMap.value=s,r.needsUpdate=!0)},parsFragmentSnippet:e=>h.glsl`
             uniform sampler2D tSSAOMap;
             ${(0,p.N6)("tSSAOMap",this._target?.texture,e.capabilities.isWebGL2)}
            ${d.Z}
        `,extraUniforms:{tSSAOMap:{value:null}},computeCacheKey:e=>this.enabled?"1":"0"+this._target?.texture?.colorSpace,isCompatible:e=>!e.materialObject.userData?.ssaoDisabled&&e.isMeshStandardMaterial2},this._renderer=e,this._target=t,this.needsSwap=!1,this.clear=!0,this.bilateralPass=new n.$(this._target,i,"rrrr")}get smoothEnabled(){return this._smoothEnabled}set smoothEnabled(e){this._smoothEnabled=e,this.bilateralPass.enabled=e,this.bilateralPass.uniforms.smoothEnabled.value=e}render(e,t,i,r,a){this.enabled&&(this._updateParameters(),this._renderer.blit(this._target.texture,t,{}),this.uniforms.tLastThis.value=t.texture,super.render(e,this._target,i,r,a),this._smoothEnabled&&this.bilateralPass.render(e,t,i,r,a))}_updateParameters(){const e=this.material.uniforms.saoData.value;e.y=this.parameters.intensity,e.z=this.parameters.occlusionWorldRadius;const t=this.material.uniforms.saoBiasEpsilon.value;t.x=this.parameters.bias,t.y=.001,t.z=this.parameters.falloff}}m([(0,u.qC)()],f.prototype,"bilateralPass",void 0),m([(0,u.qC)()],f.prototype,"parameters",void 0);var g=i(4821),v=i(3995);class _ extends a.q{get aoTarget(){return this._aoTarget}constructor(){super(),this.dependencies=[g.k,r.m],this.setDirty=this.setDirty.bind(this)}async onAdded(e){return e.getPluginByType("Ground")&&console.error("GroundPlugin must be added after SSAOPlugin"),super.onAdded(e)}createPasses(e){return this._aoTarget=e.renderer.createTarget({sizeMultiplier:1}),[(0,v.M)(e,{passId:"ssao",after:["gbuffer"],before:["render"],required:["render","gbuffer"],passObject:new f(e.renderer,this._aoTarget,e.getPlugin(r.m)?.getUnpackSnippet()??""),update(){this.passObject.bilateralPass.updateShaderProperties([e.getPlugin(r.m)])}},(()=>[e.getPlugin(r.m),e.scene.activeCamera,e.renderer]))]}async onRemove(e){return e.renderer.disposeTarget(this._aoTarget),super.onRemove(e)}setDirty(){this._viewer?.setDirty()}get enabled(){return this.passes.ssao?.passObject?.enabled||!1}set enabled(e){this.passes.ssao?.passObject&&(this.passes.ssao.passObject.enabled=e)}get uiConfig(){if(this._uiConfig)return this._uiConfig;const e=this,t=e.passes.ssao.passObject;return this._uiConfig={type:"folder",label:"SS Ambient Occlusion",children:[{type:"checkbox",label:"Enabled",property:[t,"enabled"],onChange:e.setDirty},{type:"slider",label:"Intensity",bounds:[0,4],property:[t.parameters,"intensity"],onChange:e.setDirty},{type:"slider",label:"Radius",bounds:[.1,8],property:[t.parameters,"occlusionWorldRadius"],onChange:e.setDirty},{type:"slider",label:"Bias",bounds:[1e-5,.01],property:[t.parameters,"bias"],onChange:e.setDirty},{type:"slider",label:"Falloff",bounds:[.01,3],property:[t.parameters,"falloff"],onChange:e.setDirty},{type:"slider",label:"Num samples",stepSize:1,bounds:[1,11],property:[t.material?.defines,"NUM_SAMPLES"],onChange:[()=>t.material.needsUpdate=!0,e.setDirty]},{type:"checkbox",property:[t.bilateralPass,"smoothEnabled"],onChange:e.setDirty},{type:"vec4",property:[t.bilateralPass,"edgeSharpness"],onChange:e.setDirty}]}}}_.PluginType="SSAO"},6493:function(e,t,i){i.d(t,{i:function(){return C}});var r=i(6757),a=i(3415),s=i(439),n=i(7245),o=i(7320),l=i(3138),c=i(5804),d=i(3198),h=i(9698),p=i(7337),u="uniform float objectRadius;uniform float radius;uniform float tolerance;uniform bool autoRadius;\n#ifndef D_sceneBoundingRadius\n#define D_sceneBoundingRadius \nuniform float sceneBoundingRadius;\n#endif\nvec3 ComputeReflectionL(vec3 N,vec2 E,vec3 V,float rough){float rough4=rough*rough*rough*rough;float phi=2.*PI*E.x;float cos_theta=pow(max(E.y,0.000001),rough4/(2.-rough4));float sin_theta=sqrt(max(0.,1.-cos_theta*cos_theta));vec3 half_vec=vec3(sin_theta*cos(phi),sin_theta*sin(phi),cos_theta);vec3 tangentX=normalize(cross(abs(N.z)<0.999?vec3(0.,0.,1.):vec3(1.,0.,0.),N));vec3 tangentY=cross(N,tangentX);half_vec=half_vec.x*tangentX+half_vec.y*tangentY+half_vec.z*N;vec3 ray_dir=(2.*dot(V,half_vec))*half_vec-V;return ray_dir;}vec2 GetRandomE(float seed){vec2 rand_e;rand_e.x=interleavedGradientNoise(gl_FragCoord.xy,frameCount*117.);rand_e.y=fract(rand_e.x*38.65435);rand_e.y=mix(rand_e.y,1.,0.7);return rand_e;}vec4 calculateSSR(in float seed,in vec3 screenPos,in vec3 normal,in float radiusFactor,in float roughness){vec3 viewPos=screenToView(screenPos.xy,screenPos.z);normal=normalize(normal);vec2 E=GetRandomE(seed);vec3 L=ComputeReflectionL(normal,E,-normalize(viewPos),roughness);L=normalize(L);float cameraDist=length(cameraPositionWorld);float rayLen=autoRadius?mix((cameraDist+objectRadius*sceneBoundingRadius)+viewPos.z,-viewPos.z-max(0.,cameraDist-objectRadius*sceneBoundingRadius),L.z*0.5+0.5):objectRadius*sceneBoundingRadius;rayLen*=radiusFactor;float r=interleavedGradientNoise(gl_FragCoord.xy,frameCount+seed);rayLen=max(rayLen,0.001);int steps=SSR_STEP_COUNT/(frameCount<float(SSR_LOW_QUALITY_FRAMES)?2:1);vec3 state=vec3(0.,(r+0.5)/float(steps),2.);viewPos+=normal*max(-0.0001*viewPos.z,0.001);vec3 screenHitP=traceRay(viewPos,L*rayLen,tolerance*rayLen,state,steps);if(state.z<0.99){vec3 hitColor=(tLastFrameTexelToLinear(texture2D(tLastFrame,screenHitP.xy))).rgb;float ssrWeight=1.;return vec4(hitColor*ssrWeight,1.);}return vec4(0.);}",m=i(5130),f=i(9033),g=i(2988),v=i(6533),_=i(4107),y=i(5551),b=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};let w=class extends n.Hl{constructor(e,t,i,r=!0){super({vertexShader:o.Z,fragmentShader:`\n\nvarying vec2 vUv;\n\n${c.Z}\n${l.Z}\n${d.Z}\n${h.Z}\n${i}\n\n${p.Z}\n\n${u}\n\nuniform sampler2D tLastThis;void main(){vec4 texel=tDiffuseTexelToLinear(texture2D(tDiffuse,vUv));vec4 lastAO=tLastThisTexelToLinear(texture2D(tLastThis,vUv));float depth;vec3 normal;getDepthNormal(vUv,depth,normal);if(depth>=0.999){discard;}float viewZ=depthToViewZ(depth);vec3 screenPos=vec3(vUv.x,vUv.y,viewZ);vec3 viewPos=screenToView(screenPos.xy,screenPos.z);viewPos.z=viewZ/viewPos.z;vec4 ao=vec4(0.);ao+=calculateSSR(8.,screenPos,normal,1.,0.1);ao.rgb=min(vec3(3.),ao.rgb);ao.rgb=max(vec3(0.),ao.rgb);if(frameCount<1.){gl_FragColor=ao;return;}if(ao.a<0.01){gl_FragColor.rgb=lastAO.rgb;gl_FragColor.a=(((lastAO.a)*frameCount)/(frameCount+1.));}else{gl_FragColor=((ao+(lastAO)*frameCount)/(frameCount+1.));}\n#include <encodings_fragment>\n}\n\n\n            `,uniforms:{tLastThis:{value:null},tDiffuse:{value:null},tNormalDepth:{value:null},tLastFrame:{value:null},opacity:{value:1},intensity:{value:0},boost:{value:new g.Pa4(0,0,0)},objectRadius:{value:0},autoRadius:{value:!1},power:{value:0},maskFrontFactor:{value:-.1},tolerance:{value:0},frameCount:{value:0},projection:{value:new g.yGw},cameraPositionWorld:{value:new g.Pa4},cameraNearFar:{value:new g.FM8(.1,1e3)},sceneBoundingRadius:{value:0}},defines:{PERSPECTIVE_CAMERA:1,SSR_STEP_COUNT:16,SSR_LOW_QUALITY_FRAMES:2,SSR_MASK_FRONT_RAYS:!0,SSR_INLINE:r?"1":"0",SSR_NON_PHYSICAL:"0"}},"tDiffuse","tLastThis","tLastFrame"),this.uiConfig=void 0,this.materialExtension={shaderExtender:(e,t,i)=>{let r=this.enabled&&!1!==i.userData.screenSpaceRendering&&!t.materialObject.userData?.ssreflDisabled?1:0;if(t.materialObject.defines.SSR_ENABLED!==r&&(t.materialObject.defines.SSR_ENABLED=r,t.materialObject.needsUpdate=!0),!e.defines.SSR_ENABLED)return;r=this.material.defines.SSR_STEP_COUNT,t.materialObject.defines.SSR_STEP_COUNT!==r&&(t.materialObject.defines.SSR_STEP_COUNT=r,t.materialObject.needsUpdate=!0),r=this.material.defines.SSR_LOW_QUALITY_FRAMES,t.materialObject.defines.SSR_LOW_QUALITY_FRAMES!==r&&(t.materialObject.defines.SSR_LOW_QUALITY_FRAMES=r,t.materialObject.needsUpdate=!0),r=this.material.defines.PERSPECTIVE_CAMERA,t.materialObject.defines.PERSPECTIVE_CAMERA!==r&&(t.materialObject.defines.PERSPECTIVE_CAMERA=r,t.materialObject.needsUpdate=!0),r=this.material.defines.SSR_INLINE,t.materialObject.defines.SSR_INLINE!==r&&(t.materialObject.defines.SSR_INLINE=r,t.materialObject.needsUpdate=!0),r=this.material.defines.SSR_MASK_FRONT_RAYS?1:0,t.materialObject.defines.SSR_MASK_FRONT_RAYS!==r&&(t.materialObject.defines.SSR_MASK_FRONT_RAYS=r,t.materialObject.needsUpdate=!0),r=t.materialObject.userData?.ssreflNonPhysical?"1":"0",t.materialObject.defines.SSR_NON_PHYSICAL!==r&&(t.materialObject.defines.SSR_NON_PHYSICAL=r,t.materialObject.needsUpdate=!0),r=this._target?.texture??null,this.materialExtension.extraUniforms.tSSRMap.value!==r&&(this.materialExtension.extraUniforms.tSSRMap.value=r,t.materialObject.needsUpdate=!0);const a="#glMarker beforeModulation";e.fragmentShader=e.fragmentShader.replace(a,`\n\n            \n            #if defined(SSR_ENABLED) && SSR_ENABLED > 0\nvec3 screenPos=viewToScreen(geometry.position);vec4 ssrColor=vec4(0,0,0,0);float alphaModifier=1.-clamp(material.roughness*.3,0.,1.);alphaModifier*=ssrIntensity;\n#if defined(SSR_MASK_FRONT_RAYS) && SSR_MASK_FRONT_RAYS > 0\nalphaModifier*=clamp(-4.*dot(geometry.viewDir,normal)+(4.+ssrMaskFrontFactor),0.,1.);\n#endif\n#ifdef USE_TRANSMISSION\nalphaModifier*=1.-transmission;\n#endif\nfloat vignette=1.;if(true){float fadeStrength=0.1;float dist=min(min(1.-screenPos.x,1.-screenPos.y),min(screenPos.x,screenPos.y));float fade=dist*dist/(fadeStrength+0.001);fade=clamp(fade,0.,1.);fade=pow(fade,0.3);vignette=fade;}alphaModifier*=vignette;vec3 specularColor=EnvironmentBRDF(geometry.normal,geometry.viewDir,material.specularColor.rgb,material.specularF90,material.roughness);if(length(specularColor.rgb)*alphaModifier>0.01&&roughnessFactor<0.9){\n#if defined(SSR_INLINE) && SSR_INLINE > 0\nssrColor=calculateSSR(8.,vec3(screenPos.xy,geometry.position.z),geometry.normal,1.,material.roughness);\n#else\nssrColor=tSSRMapTexelToLinear(texture2D(tSSRMap,screenPos.xy));\n#endif \n}ssrColor.rgb*=ssrBoost;ssrColor.a*=alphaModifier;ssrColor.a=min(ssrColor.a,1.);\n#if defined(SSR_NON_PHYSICAL) && SSR_NON_PHYSICAL > 0\ndiffuseColor.a=max(ssrColor.a,diffuseColor.a*diffuseColor.a);reflectedLight.indirectSpecular=mix(reflectedLight.indirectSpecular,saturate(diffuseColor.rgb*ssrColor.rgb),1.);reflectedLight.indirectDiffuse=diffuseColor.rgb*(1.-ssrColor.a);reflectedLight.directDiffuse=vec3(0.);reflectedLight.directSpecular=vec3(0.);\n#else\nreflectedLight.indirectSpecular=mix(reflectedLight.indirectSpecular,saturate(specularColor.rgb*ssrColor.rgb),ssrColor.a);\n#endif\n#endif\n\n            \n            // reflectedLight.directDiffuse = vec3(0.);\n            // reflectedLight.indirectDiffuse = vec3(0.);\n            // reflectedLight.directSpecular = vec3(0.);\n            // reflectedLight.indirectSpecular = vec3(0.);\n            \n            \n${a}`)},onObjectRender:(e,t,i)=>{const r=this.enabled&&!1!==i.userData.screenSpaceRendering&&!t.materialObject.userData?.ssreflDisabled?1:0;t.materialObject.defines.SSR_ENABLED!==r&&(t.materialObject.defines.SSR_ENABLED=r,t.materialObject.needsUpdate=!0)},parsFragmentSnippet:(e,t)=>!this.enabled||!1===e.userData.screenSpaceRendering||t?.materialObject.userData?.ssreflDisabled?"":"\nuniform float ssrPower;\nuniform float ssrIntensity;\nuniform float ssrMaskFrontFactor;\nuniform vec3 ssrBoost;\nuniform sampler2D tSSRMap;\nuniform sampler2D tLastFrame;\n"+(0,v.N6)("tSSRMap",this._target?.texture,e.capabilities.isWebGL2)+(0,v.N6)("tLastFrame",this.materialExtension.extraUniforms.tLastFrame.value,e.capabilities.isWebGL2)+(this._inline?`\n#if 1\n// #if SSR_INLINE\n    ${c.Z}\n    \n    #define THREE_PACKING_INCLUDED\n    ${l.Z}\n    \n    ${d.Z}\n    ${h.Z}\n    ${f.Z}\n    \n    ${p.Z}\n    \n    ${u}\n// #endif // SSR_INLINE\n#endif\n`:"")+`\n${m.Z}\n        `,extraUniforms:{tSSRMap:{value:null},ssrPower:this.material.uniforms.power,ssrIntensity:this.material.uniforms.intensity,ssrMaskFrontFactor:this.material.uniforms.maskFrontFactor,ssrBoost:this.material.uniforms.boost,tNormalDepth:this.material.uniforms.tNormalDepth,tLastFrame:this.material.uniforms.tLastFrame,objectRadius:this.material.uniforms.objectRadius,autoRadius:this.material.uniforms.autoRadius,tolerance:this.material.uniforms.tolerance,frameCount:this.material.uniforms.frameCount,projection:this.material.uniforms.projection,cameraPositionWorld:this.material.uniforms.cameraPositionWorld,cameraNearFar:this.material.uniforms.cameraNearFar,sceneBoundingRadius:this.material.uniforms.sceneBoundingRadius},computeCacheKey:e=>this.enabled?"1":"0"+this._target?.texture?.colorSpace+(this.enabled&&!e.materialObject.userData?.ssreflDisabled?1:0)+Object.values(this.material.defines).map((e=>e+"")).join(","),isCompatible:e=>!e.materialObject.userData?.ssreflDisabled&&e.isMeshStandardMaterial2},this.intensity=1,this.boost=new g.Pa4(1,1,1),this.objectRadius=1,this.autoRadius=!0,this.power=1.1,this.tolerance=.5,this.stepCount=16,this.lowQualityFrames=0,this.maskFrontRays=!0,this.maskFrontFactor=-.2,this._renderer=e,this._target=t,this.needsSwap=!1,this._inline=r}render(e,t,i,r,a){if(this._inline)this.needsSwap=!1;else{if(!this._target)throw"Target must be set when inline = false";this._renderer.blit(this._target.texture,t,{}),this.uniforms.tLastThis.value=t.texture,super.render(e,this._target,i,r,a),this.needsSwap=!1}}};b([(0,y.t8)("Intensity",[0,4]),(0,_.qC)(),(0,v.e5)()],w.prototype,"intensity",void 0),b([(0,y.KG)("Boost"),(0,_.qC)(),(0,v.e5)()],w.prototype,"boost",void 0),b([(0,y.t8)("Object Radius",[.01,2]),(0,_.qC)(),(0,v.e5)()],w.prototype,"objectRadius",void 0),b([(0,y.Q7)("Auto radius"),(0,_.qC)(),(0,v.e5)()],w.prototype,"autoRadius",void 0),b([(0,y.t8)("Power",[0,3]),(0,_.qC)(),(0,v.e5)()],w.prototype,"power",void 0),b([(0,y.t8)("Tolerance",[.1,5]),(0,_.qC)(),(0,v.e5)()],w.prototype,"tolerance",void 0),b([(0,y.t8)("Step count",[1,32],1),(0,_.qC)(),(0,v.lD)("SSR_STEP_COUNT")],w.prototype,"stepCount",void 0),b([(0,y.t8)("Low Quality Frames",[0,4],1),(0,_.qC)(),(0,v.lD)("SSR_LOW_QUALITY_FRAMES")],w.prototype,"lowQualityFrames",void 0),b([(0,y.Q7)("Ignore front rays"),(0,_.qC)(),(0,v.lD)("SSR_MASK_FRONT_RAYS")],w.prototype,"maskFrontRays",void 0),b([(0,y.t8)("Mask front rays factor",[-1,1],.01,(e=>({hidden:()=>!e.maskFrontRays}))),(0,_.qC)(),(0,v.e5)()],w.prototype,"maskFrontFactor",void 0),w=b([(0,y.Sp)("Screen Space Reflections")],w);var x=i(4821),D=i(9008),S=i(3995);class C extends a.q{get ssrTarget(){return this._ssrTarget}constructor(){super(),this.dependencies=[x.k,r.m,s.E],this.inlineSSR=!0,this.setDirty=this.setDirty.bind(this)}get enabled(){return this.passes.ssr?.passObject?.enabled||!1}set enabled(e){this.passes.ssr?.passObject&&(this.passes.ssr.passObject.enabled=e)}async onAdded(e){e.getPluginByType("Ground")&&console.error("GroundPlugin must be added after SSRPlugin"),await super.onAdded(e),this.uiConfig.uiRefresh?.("postFrame",!0)}createPasses(e){return this._ssrTarget=this.inlineSSR?void 0:e.renderer.createTarget({sizeMultiplier:1}),[(0,S.M)(e,{passId:"ssr",after:["gbuffer"],before:["render"],required:["render","gbuffer","progressive"],passObject:new w(e.renderer,this._ssrTarget,e.getPlugin(r.m)?.getUnpackSnippet()??"",this.inlineSSR)},(()=>[e.getPlugin(r.m),e.getPlugin(s.E),e.scene.activeCamera,e.renderer,e.scene]))]}async onRemove(e){return this._ssrTarget&&e.renderer.disposeTarget(this._ssrTarget),super.onRemove(e)}setDirty(){this._viewer?.setDirty()}get uiConfig(){const e=this.passes.ssr?.passObject?.uiConfig??{};return e.children?.map((e=>(0,D.getOrCall)(e)))?.flat(2).forEach((e=>e&&(e.onChange=this.setDirty))),e}}C.PluginType="SSReflection"},1948:function(e,t,i){i.d(t,{e:function(){return h}});var r=i(2988),a=i(6594),s=i(1375),n=i(7162),o=i(3995),l=i(4821),c=i(4107);class d extends o.Q{constructor(){super(...arguments),this.enabled=!0,this._uiNeedRefresh=!1,this._isVisibleChanged=!1,this.dependencies=[l.k],this.variations=[],this._selectedSwitchNode=()=>{const e=this._picking?.getSelectedObject();if(!e)return;const t=this.variations.map((e=>e.name));let i;return e.traverseAncestors((e=>{i||e.name&&t.includes(e.name)&&(i=e)})),i},this.uiConfig={label:"Switch Node",type:"folder",children:[{type:"checkbox",label:"Enabled",property:[this,"enabled"]},()=>[{type:"folder",label:"All nodes",expanded:!0,children:[this.variations.map((e=>({type:"input",label:e.title,property:[e,"name"],onChange:()=>this.refreshUi()})))]},{type:"button",label:"Add Node",value:()=>{this.variations.push({name:"switch_node",selected:"",title:"Switch Node",camView:"front",camDistance:1}),this.refreshUi()}},{type:"button",label:"Refresh UI",value:()=>this.refreshUi()},{type:"input",label:"Selected node title",hidden:()=>!this._selectedSwitchNode(),property:()=>{const e=this._selectedSwitchNode();return e?[this.variations.find((t=>t.name===e.name)),"title"]:[]},onChange:()=>this.refreshUi()},{type:"slider",bounds:[.01,2],stepSize:.01,label:"Cam Distance",hidden:()=>!this._selectedSwitchNode(),property:()=>{const e=this._selectedSwitchNode();return e?[this.variations.find((t=>t.name===e.name)),"camDistance"]:[]}},{type:"dropdown",label:"Cam View",hidden:()=>!this._selectedSwitchNode(),property:()=>{const e=this._selectedSwitchNode();return e?[this.variations.find((t=>t.name===e.name)),"camView"]:[]},onChange:()=>this.refreshUi(),children:["top","bottom","front","back","left","right"].map((e=>({label:e,value:e})))}]]}}async onAdded(e){await super.onAdded(e),this._picking=this._viewer?.getPluginByType("Picking"),this._picking?.addEventListener("selectedObjectChanged",(()=>{this.uiConfig.uiRefresh?.()})),e.addEventListener("postFrame",(()=>{this._uiNeedRefresh&&this._refreshUi()})),e.addEventListener("preRender",(()=>{if(this._viewer&&this.enabled){for(const e of this.variations){if(!e.name)continue;const t=this._viewer.scene.getObjectByName(e.name);if(!t||t.children.length<1)return;e.selected||(e.selected=t.children[0].name||t.children[0].uuid);for(const i of t.children)i.userData.__oldVisible=i.visible,i.visible=(i.name||i.uuid)===e.selected}this._isVisibleChanged=!0}})),e.addEventListener("postRender",(()=>{if(this._viewer&&this._isVisibleChanged){for(const e of this.variations){if(!e.name)continue;const t=this._viewer.scene.getObjectByName(e.name);if(!t||t.children.length<1)return;for(const e of t.children){if(void 0===e.userData.__oldVisible)return;e.visible=e.userData.__oldVisible,delete e.userData.__oldVisible}}this._isVisibleChanged=!1}})),this.addEventListener("deserialize",(async()=>{this.refreshUi()}))}refreshUi(){this.enabled&&(this._uiNeedRefresh=!0)}_refreshUi(){return!!this.enabled&&!!this._viewer&&(this._uiNeedRefresh=!1,this.uiConfig.uiRefresh?.(),!0)}}!function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);s>3&&n&&Object.defineProperty(t,i,n)}([(0,c.qC)()],d.prototype,"variations",void 0);class h extends d{_refreshUi(){if(!super._refreshUi())return!1;s.M.RemoveAll(h.PluginType);for(const e of this.variations){const t=this._viewer.scene.getObjectByName(e.name);t?(t.children.length<1&&console.warn("SwitchNode does not have enough children",e),s.M.Create(h.PluginType,e.title,Math.min(5,t.children.length),20,0,t.children.map((t=>{const i=e.camView,s=new r.Pa4((i.includes("right")?1:0)-(i.includes("left")?1:0),(i.includes("top")?1:0)-(i.includes("bottom")?1:0),(i.includes("front")?1:0)-(i.includes("back")?1:0));e.camDistance||(e.camDistance=1);const n=(0,a.V)(this._viewer,t,void 0,7,s.multiplyScalar(.5*e.camDistance));return{id:t.uuid,image:n,onClick:()=>{e.selected=t.name||t.uuid,this._viewer?.scene.setDirty({sceneUpdate:!0,frameFade:!0})},tooltip:t.name||t.uuid}})),((e,t)=>(0,n.ZP)(e,{placement:"bottom",content:t.tooltip})))):console.warn("no object found for variation, skipping",e)}return s.M.RebuildUi(this._viewer?.container),!0}}h.PluginType="SwitchNodePlugin"},4352:function(e,t,i){i.d(t,{N:function(){return u}});var r=i(4895),a=i(439),s=i(6757),n=i(7245),o=i(2988),l=i(6265),c=i(3138),d=i(6533),h=i(4107);class p extends n.Hl{constructor(e,t){super({vertexShader:l.C.vertexShader,fragmentShader:t+"\n"+c.Z+"\n#include <common>\nvarying vec2 vUv;uniform vec2 previousRTSize;uniform mat4 lastProjectionViewMatrix;uniform mat4 currentProjectionViewMatrix;uniform mat4 inverseViewMatrix;uniform vec2 jitterSample;uniform vec2 feedBack;uniform bool firstFrame;\n#if HAS_VELOCITY_BUFFER == 1\nuniform sampler2D tVelocity;\n#endif\nvec3 find_closest_fragment_3x3(const in vec2 uv){const vec3 offset=vec3(-1.,1.,0.);vec2 texelSize=1./previousRTSize;vec3 dtr=vec3(1,1,getDepth(uv+offset.yy*texelSize));vec3 dtc=vec3(0,1,getDepth(uv+offset.zy*texelSize));vec3 dtl=vec3(-1,1,getDepth(uv+offset.xy*texelSize));vec3 dml=vec3(-1,0,getDepth(uv+offset.xz*texelSize));vec3 dmc=vec3(0,0,getDepth(uv));vec3 dmr=vec3(1,0,getDepth(uv+offset.yz*texelSize));vec3 dbl=vec3(-1,-1,getDepth(uv+offset.xx*texelSize));vec3 dbc=vec3(0,-1,getDepth(uv+offset.zx*texelSize));vec3 dbr=vec3(1,-1,getDepth(uv+offset.yx*texelSize));vec3 dmin=dtl;if(dmin.z>dtc.z)dmin=dtc;if(dmin.z>dtr.z)dmin=dtr;if(dmin.z>dml.z)dmin=dml;if(dmin.z>dmc.z)dmin=dmc;if(dmin.z>dmr.z)dmin=dmr;if(dmin.z>dbl.z)dmin=dbl;if(dmin.z>dbc.z)dmin=dbc;if(dmin.z>dbr.z)dmin=dbr;return vec3(uv+texelSize.xy*dmin.xy,dmin.z);}vec3 find_closest_fragment_5tap(const in vec2 uv){vec2 texelSize=1./previousRTSize;vec2 offset=vec2(1.,-1.);vec3 dtl=vec3(-1,1,getDepth(uv+offset.yx*texelSize));vec3 dtr=vec3(1,1,getDepth(uv+offset.xx*texelSize));vec3 dmc=vec3(0,0,getDepth(uv));vec3 dbl=vec3(-1,-1,getDepth(uv+offset.yy*texelSize));vec3 dbr=vec3(1,-1,getDepth(uv+offset.xy*texelSize));vec3 dmin=dtl;if(dmin.z>dtr.z)dmin=dtr;if(dmin.z>dmc.z)dmin=dmc;if(dmin.z>dbl.z)dmin=dbl;if(dmin.z>dbr.z)dmin=dbr;return vec3(uv+dmin.xy*texelSize,dmin.z);}vec4 clip_aabb(const in vec4 aabb_min,const in vec4 aabb_max,vec4 p){const float FLT_EPS=1e-8;vec4 p_clip=0.5*(aabb_max+aabb_min);vec4 e_clip=0.5*(aabb_max-aabb_min)+FLT_EPS;vec4 v_clip=p-p_clip;vec4 v_unit=abs(v_clip/e_clip);float ma_unit=max(v_unit.x,max(v_unit.y,v_unit.z));if(ma_unit>1.)return p_clip+v_clip/ma_unit;else return p;}\n#if HAS_VELOCITY_BUFFER == 0\nvec2 computeScreenSpaceVelocity(const in vec3 worldPosition){vec4 currentPositionClip=currentProjectionViewMatrix*vec4(worldPosition,1.);vec4 prevPositionClip=lastProjectionViewMatrix*vec4(worldPosition,1.);vec2 currentPositionNDC=currentPositionClip.xy/currentPositionClip.w;vec2 prevPositionNDC=prevPositionClip.xy/prevPositionClip.w;if(prevPositionNDC.x>=1.||prevPositionNDC.x<=-1.||prevPositionNDC.x>=1.||prevPositionNDC.y<=-1.){return vec2(0.);}return 0.5*(currentPositionNDC-prevPositionNDC);}\n#endif\nvec4 computeTAA(const in vec2 uv,const in vec2 screenSpaceVelocity){vec2 jitterOffset=jitterSample/previousRTSize;vec2 uvUnJitter=uv;vec4 currentColor=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter));vec4 previousColor=previousRTTexelToLinear(texture2D(previousRT,uv-screenSpaceVelocity));const vec3 offset=vec3(1.,-1.,0.);vec2 texelSize=1./previousRTSize;float texelSpeed=length(screenSpaceVelocity);vec4 tl=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.yx*texelSize));vec4 tc=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.zx*texelSize));vec4 tr=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.xx*texelSize));vec4 ml=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.yz*texelSize));vec4 mc=currentColor;vec4 mr=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.xz*texelSize));vec4 bl=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.yy*texelSize));vec4 bc=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.zy*texelSize));vec4 br=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.xy*texelSize));vec4 corners=2.*(tr+bl+br+tl)-2.*mc;mc+=(mc-(corners*0.166667))*2.718282*0.3;mc=max(vec4(0.),mc);vec4 min5=min(tc,min(ml,min(mc,min(mr,bc))));vec4 max5=max(tc,max(ml,max(mc,max(mr,bc))));vec4 cmin=min(min5,min(tl,min(tr,min(bl,br))));vec4 cmax=max(min5,max(tl,max(tr,max(bl,br))));;cmin=0.5*(cmin+min5);cmax=0.5*(cmax+max5);previousColor=clip_aabb(cmin,cmax,previousColor);float lum0=luminance(currentColor.rgb);float lum1=luminance(previousColor.rgb);float unbiased_diff=abs(lum0-lum1)/max(lum0,max(lum1,0.2));float unbiased_weight=1.-unbiased_diff;float unbiased_weight_sqr=unbiased_weight*unbiased_weight;float k_feedback=mix(feedBack.x,feedBack.y,unbiased_weight_sqr);return mix(currentColor,previousColor,k_feedback);}vec3 getWorldPositionFromViewZ(const in vec2 uv,const in float viewDepth){vec2 uv_=2.*uv-1.;float xe=-(uv_.x+projection[2][0])*viewDepth/projection[0][0];float ye=-(uv_.y+projection[2][1])*viewDepth/projection[1][1];return(inverseViewMatrix*vec4(xe,ye,viewDepth,1.)).xyz;}void main(){vec2 jitterOffset=jitterSample/previousRTSize;\n#if QUALITY == 1\nvec3 c_frag=find_closest_fragment_3x3(vUv);\n#else\nvec3 c_frag=find_closest_fragment_5tap(vUv);\n#endif\nif(c_frag.z>=0.999){gl_FragColor=currentRTTexelToLinear(texture2D(currentRT,vUv-jitterOffset));}else{float sampleViewZ=mix(-cameraNearFar.x,-cameraNearFar.y,c_frag.z);vec3 worldPosition=getWorldPositionFromViewZ(c_frag.xy,sampleViewZ);\n#if HAS_VELOCITY_BUFFER == 0\nvec2 screenSpaceVelocity=computeScreenSpaceVelocity(worldPosition);\n#else\nvec2 screenSpaceVelocity=texture2D(tVelocity,c_frag.xy).xy*2.-1.;screenSpaceVelocity=sign(screenSpaceVelocity)*pow(abs(screenSpaceVelocity),vec2(4.));\n#endif\ngl_FragColor=firstFrame?currentRTTexelToLinear(texture2D(currentRT,vUv)):computeTAA(vUv,screenSpaceVelocity);}\n#include <encodings_fragment>\n}",uniforms:{currentRT:{value:null},previousRT:{value:null},previousRTSize:{value:new o.FM8},cameraNearFar:{value:new o.FM8},lastProjectionViewMatrix:{value:new o.yGw},currentProjectionViewMatrix:{value:new o.yGw},projection:{value:new o.yGw},inverseViewMatrix:{value:new o.yGw},jitterSample:{value:new o.FM8},firstFrame:{value:!0},tNormalDepth:{value:null},tVelocity:{value:null}},defines:{HAS_VELOCITY_BUFFER:0,QUALITY:1,UNJITTER:0}},"currentRT","previousRT"),this.taaEnabled=!0,this.feedBack=new o.FM8(.88,.97),this.uiConfig={type:"folder",label:"Temporal AA",children:[{type:"checkbox",label:"Enabled",property:[this,"enabled"],onChange:()=>this.onSizeUpdate()},{type:"input",label:"Feedback",stepSize:1e-4,property:[this,"feedBack"],onChange:this.setDirty}]},this.onSizeUpdate=this.onSizeUpdate.bind(this),this.target=e,this.clear=!1,this.needsSwap=!0}render(e,t,i,r,a){if(!this.taaEnabled||!this.enabled)return void(this.needsSwap=!1);this.needsSwap=!0;const s=this.uniforms.tVelocity.value?1:0;s!==this.material.defines.HAS_VELOCITY_BUFFER&&(this.material.defines.HAS_VELOCITY_BUFFER=s,this.material.needsUpdate=!0),this.uniforms.previousRT.value=this.target.texture,super.render(e,t,i,r,a),this.uniforms.lastProjectionViewMatrix.value.copy(this.uniforms.currentProjectionViewMatrix.value),this.uniforms.firstFrame.value=!1}updateCameraProperties(e){e&&(this.uniforms.currentProjectionViewMatrix.value.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this.uniforms.inverseViewMatrix.value.copy(e.matrixWorld))}onSizeUpdate(){this.uniforms.firstFrame.value=!0,this.setDirty()}setSize(e,t){super.setSize(e,t),this.onSizeUpdate()}}!function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);s>3&&n&&Object.defineProperty(t,i,n)}([(0,h.qC)(),(0,d.e5)()],p.prototype,"feedBack",void 0);class u extends r.G{constructor(){super(...arguments),this.passId="taa",this._beforeFilters=["progressive"],this._afterFilters=[],this._requiredFilters=["render","progressive"],this.dependencies=[s.m],this._stableNoise=!0,this._stableNoiseConfig={label:"Stable Noise (Use Total Frame Count)",type:"checkbox",property:[this,"stableNoise"]}}passCtor(e){if(!e.getPlugin(a.E))throw"Add ProgressivePlugin before TAA";const t=new p(e.getPlugin(a.E).lastFrame,e.getPlugin(s.m).getUnpackSnippet());return e.renderer.addEventListener("resize",t.onSizeUpdate),t}setDirty(){this._viewer?.setDirty()}async onDispose(e){return this.pass&&e.renderer.removeEventListener("resize",this.pass.passObject.onSizeUpdate),super.onDispose(e)}_update(e){if(!super._update(e))return!1;const t=e.renderer.frameCount,i=this._pass.passObject;if(i.taaEnabled=t<=1&&e.scene.renderCamera===e.scene.activeCamera,!i.taaEnabled)return!1;const r=e.scene.renderCamera;return i.updateShaderProperties([e.getPlugin(s.m),r,e.getPluginByType("VelocityBuffer")]),i.target=e.getPlugin(a.E).lastFrame,i.updateCameraProperties(r?.cameraObject),!0}async onAdded(e){await super.onAdded(e),this.stableNoise=this._stableNoise}get stableNoise(){return this._viewer?.renderer.stableNoise??this._stableNoise}set stableNoise(e){this._viewer&&(this._viewer.renderer.stableNoise=e),this._stableNoise=e}get uiConfig(){const e=this.pass?.passObject.uiConfig;if(e&&e.children)return e.children.includes(this._stableNoiseConfig)||e.children.push(this._stableNoiseConfig),e}}u.PluginType="TAA"},5008:function(e,t,i){i.d(t,{x:function(){return d}});var r=i(4895),a=i(6757),s=i(9008),n=i(6265),o=i(2988),l=i(7245);class c extends l.Hl{constructor(e){super({vertexShader:n.C.vertexShader,uniforms:{tDiffuse:{value:null},tNormalDepth:{value:null},tGBufferFlags:{value:null},tTransparent:{value:null}},defines:{},fragmentShader:`\n                varying vec2 vUv;\n                ${e[0]}\n                void main() {\n                    gl_FragColor = tDiffuseTexelToLinear (texture2D(tDiffuse, vUv));\n                    #glMarker\n                    ${e[1]}\n                    \n                    gl_FragColor.rgb *= gl_FragColor.a; // premultiply alpha\n                }\n                `},"tDiffuse","tTransparent"),this.uiConfig=void 0,this.material.transparent=!1,this.material.side=o.Wl3}render(e,t,i,r,a){super.render(e,t,i,r,a),this._lastReadBuffer=i,this.needsSwap=!0}reRender(e,t,i,r){this._lastReadBuffer&&this.render(e,t,this._lastReadBuffer,i,r)}dispose(){this._lastReadBuffer=void 0,super.dispose()}}class d extends r.G{get renderToScreen(){return this._renderToScreen}constructor(e=!0,t=!0){super(),this.depthTonemap=e,this.passId="combinedPost",this.dependencies=[a.m],this.toJSON=void 0,this._beforeFilters=[],this._afterFilters=["render","screen"],this._requiredFilters=["render"],this._renderToScreen=!0,this._postFrame=()=>{this._needsReRender&&this._renderToScreen&&this._viewer&&this.pass&&(this._needsReRender=!1,this.pass.update?.(),this.pass.passObject.reRender(this._viewer.renderer.rendererObject,null))},this._needsReRender=!1,this._setDirty=this._setDirty.bind(this),this._renderToScreen=t}async onAdded(e){return this._viewer?.screenShader?.isShaderPass2&&(this._renderToScreen=!1),this._renderToScreen&&(0,s.safeSetProperty)(e.renderer.passes.find((e=>"screen"===e.passId)),"enabled",!1,!0,!0),e.addEventListener("postFrame",this._postFrame),super.onAdded(e)}async onRemove(e){return this._renderToScreen&&(0,s.safeSetProperty)(e.renderer.passes.find((e=>"screen"===e.passId)),"enabled",!0,!0,!0),super.onRemove(e)}passCtor(e){const t=e.screenShader,i=["",""];this._renderToScreen&&!t.isShaderPass2&&(i[0]=Array.isArray(t)?t[0]:t?.pars||"",i[1]=Array.isArray(t)?t[1]:"string"==typeof t?t:t?.main||"");const r=new c(i);return(0,s.safeSetProperty)(r.uiConfig?.children?.find((e=>"Enabled"===e?.label)),"hidden",!0,!0),r}_update(e){return!!super._update(e)&&(this._pass.passObject.updateShaderProperties(this._viewer?.getPlugin(a.m)),this._pass.passObject.material.uniforms.tTransparent.value=this._viewer?.renderFilter.passObject.transparentTarget?.texture||null,!0)}_setDirty(){this.pass&&(this.pass.dirty=!0)}get uiConfig(){return this.pass?.passObject?.uiConfig??{}}addExtension(e){this.pass.passObject.material.registerMaterialExtensions([e])}reRender(){this._renderToScreen?this._needsReRender=!0:this._setDirty()}}d.PluginType="CombinedPostPlugin"},939:function(e,t,i){i.d(t,{s:function(){return n}});var r=i(8670),a=i(3278);class s{constructor(){this.uiConfig=void 0,this.enabled=!0}shaderExtender(e,t,i){this.enabled&&(e.fragmentShader=(0,r.p)(e.fragmentShader,"#glMarker"," \n            gl_FragColor = LinearTosRGB(gl_FragColor);\n            #glMarker\n        "))}computeCacheKey(e){return this.enabled?"1":"0"}isCompatible(e){return!0}}class n extends a.a{generateExtension(e){return new s}}n.PluginType="GammaCorrection"},439:function(e,t,i){i.d(t,{E:function(){return d}});var r=i(6755),a=i(3415),s=i(3995),n=i(4107),o=i(5551),l=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};const c=[{x:0,y:0},{x:-.5,y:0},{x:-.375,y:-.25},{x:-.1875,y:-.125},{x:-.125,y:-.375},{x:.0625,y:-.0625},{x:.125,y:-.3125},{x:.375,y:-.4375},{x:.3125,y:-.1875},{x:.25,y:.0625},{x:.4375,y:.25},{x:.1875,y:.3125},{x:0,y:.4375},{x:-.0625,y:.1875},{x:-.25,y:.375},{x:-.4375,y:.5},{x:-.3125,y:.125}];class d extends a.q{constructor(e=2*c.length){super(),this._lastFrames=new Map,this.enabled=!0,this.jitter=!0,this._hasSetOffset=!1,this.trackedJitterCameras=new Set,this._addSceneObject=e=>{const t=e.object;(t.modelObject||t.lightObject)&&(t.modelObject||t.lightObject).traverse((e=>{e?.shadow?.camera&&e.shadow.mapSize&&this.trackedJitterCameras.add([e.shadow.camera,e.shadow.mapSize])}))},this._jitterCamera=e=>{const t=e.target;if(this.jitter&&t.renderer.frameCount>1){const e=(e,i)=>{const r={...c[t.renderer.frameCount%c.length]};e.setViewOffset(i.width,i.height,r.x,r.y,i.width,i.height)},i=t.scene.activeCamera.cameraObject;e(i,{width:t.canvas.clientWidth*t.renderer.displayCanvasScaling,height:t.canvas.clientHeight*t.renderer.displayCanvasScaling}),this.trackedJitterCameras.forEach((t=>e(...t))),this._hasSetOffset=!0,this._viewer?.renderer.resetShadows()}},this._resetCameraJitter=e=>{const t=e.target;this._hasSetOffset&&(t.scene.activeCamera.cameraObject.clearViewOffset(),this._hasSetOffset=!1)},this.uiConfig=(0,o.YH)("Progressive",this),this.maxFrameCount=e}async onAdded(e){return await super.onAdded(e)}async onRemove(e){e.removeEventListener("preRender",this._jitterCamera),e.removeEventListener("postRender",this._resetCameraJitter),e.scene.removeEventListener("addSceneObject",this._addSceneObject),this._lastFrames.forEach((t=>e.renderer.disposeTarget(t))),this._lastFrames.clear(),await super.onRemove(e)}get lastFrame(){return this._lastFrames.get(this._viewer?.scene.renderCamera.cameraObject.uuid)}getLastFrame(e){return e?this._lastFrames.get(e.cameraObject.uuid):this.lastFrame}createPasses(e){e.addEventListener("preRender",this._jitterCamera),e.addEventListener("postRender",this._resetCameraJitter),e.scene.addEventListener("addSceneObject",this._addSceneObject);const t=this;return[(0,s.M)(e,{passId:"progressive",get dirty(){return t.jitter&&(t._viewer?.renderer.frameCount||0)<t.maxFrameCount},after:["render"],before:["combinedPost","screen"],required:["render"],passObject:new class extends r.J{render(i,r,a,s,n){if(t.lastFrame){if(e.renderer.frameCount<1)return this.needsSwap=!1,void(a?.texture&&e.renderer.blit(a.texture,t.lastFrame,{}));this.needsSwap=!0,super.render(i,r,a,s,n),e.renderer.blit(r.texture,t.lastFrame,{})}else e.console.error("lastFrame render target undefined")}},update(){if(!t.lastFrame&&e.scene.renderCamera&&t._lastFrames.set(e.scene.renderCamera.cameraObject.uuid,e.renderer.composerTarget.clone(!0)),!t.lastFrame)return void console.error("lastFrame render target undefined");let i=1/(Math.max(e.renderer.frameCount,0)+1);this.passObject.weights1.set(i,i,i,i),i=1-i,this.passObject.weights2.set(i,i,i,i),this.passObject.blendTexture=t.lastFrame.texture,this.passObject.material.uniformsNeedUpdate=!0}})]}isConverged(e=!1){return(this._viewer?.renderer.frameCount||0)>=this.maxFrameCount-1+(e?1:0)}updateShaderProperties(e){return e.uniforms.tLastFrame&&(e.uniforms.tLastFrame.value=this.lastFrame?.texture??void 0),this}postFrameConvergedRecordingDelta(e="CanvasRecorder"){const t=this._viewer.getPluginByType(e);return t&&t.isRecording()&&t.convergeMode?this.isConverged(!0)?1/t.videoFrameRate:0:-1}}d.PluginType="Progressive",l([(0,n.qC)(),(0,o.ri)("Frame count")],d.prototype,"maxFrameCount",void 0),l([(0,n.qC)(),(0,o.Q7)("Jitter")],d.prototype,"jitter",void 0)},2278:function(e,t,i){i.d(t,{I:function(){return v}});var r,a=i(2988),s=i(5551),n=i(4107),o=i(9033),l=i(9008),c=i(8670),d=i(3278),h=i(5008),p=i(6757),u=i(9354),m=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};const f=a.dZ3;let g=r=class{constructor(e,t=!0){this.depthTonemap=t,this.toneMapping=a.LY2,this.tonemapBackground=!0,this.clipBackground=!1,this.exposure=1,this.saturation=1,this.contrast=1,this.renderDepth=!1,this.enabled=!0,this._rendererState={},this.extraUniforms={opacity:{value:1},toneMappingContrast:{value:1},toneMappingSaturation:{value:1}},this.parsFragmentSnippet=(e,t)=>this.enabled?l.glsl`
            ${this.depthTonemap?o.Z:""}
            #define USE_DEPTH_TONEMAP ${this.depthTonemap?"1":"0"}
            uniform float opacity;
            uniform float toneMappingContrast;
            uniform float toneMappingSaturation;
            ${"int getToneMapBit(in int number){\n#ifdef WebGL2Context\nreturn(number/2)%2;\n#else\nreturn int(mod(floor(float(number)/2.),2.));\n#endif\n}vec3 TonemappingSaturation(vec3 rgb){const vec3 W=vec3(0.2125,0.7154,0.0721);vec3 intensity=vec3(dot(rgb,W));return mix(intensity,rgb,toneMappingSaturation);}vec3 TonemappingContrast(vec3 color){return(color-vec3(0.5))*toneMappingContrast+vec3(0.5);}vec4 ToneMapping(in vec4 color){vec4 outColor=opacity*color;\n#if USE_DEPTH_TONEMAP > 0\nbool doTonemap=getToneMapBit(getGBufferFlags(vUv).a)>0;float depth=getDepth(vUv);vec4 transparentCol=tTransparentTexelToLinear(texture2D(tTransparent,vUv));\n#if TONEMAP_BACKGROUND < 1 || TRANSPARENT_BACKGROUND > 0\nbool isBackground=depth>0.99&&transparentCol.a<0.001;if(isBackground)doTonemap=false;\n#endif\nif(doTonemap){\n#endif\n#if defined( TONE_MAPPING )\noutColor.rgb=toneMapping(outColor.rgb);outColor.rgb=TonemappingContrast(outColor.rgb);outColor.rgb=TonemappingSaturation(outColor.rgb);\n#endif\n#if USE_DEPTH_TONEMAP > 0\n}\n#if TRANSPARENT_BACKGROUND > 0\nif(isBackground)outColor.a=0.;if(depth>0.99&&transparentCol.a>=0.001)outColor.a=transparentCol.a;\n#endif\nif(depth<0.00001)outColor.a=0.;\n#if defined(DEBUG_DEPTH) && DEBUG_DEPTH > 0\noutColor.rgb=vec3(sRGBToLinear(vec4((1.-depth))).x);\n#endif\n#endif\nreturn outColor;}"}
        `:"",this._combinedPostPlugin=e.getPlugin(h.x),this._setDirty=this._setDirty.bind(this),this.depthTonemap=t}shaderExtender(e,t,i){this.enabled&&(e.fragmentShader=(0,c.p)(e.fragmentShader,"#glMarker","\ngl_FragColor = ToneMapping(gl_FragColor);\n",{prepend:!0}))}onObjectRender(e,t,i){if(!this.enabled)return;const{toneMapping:r,toneMappingExposure:s,outputColorSpace:n}=i;this._rendererState.toneMapping=r,this._rendererState.toneMappingExposure=s,this._rendererState.outputColorSpace=n;let o=this.tonemapBackground?"1":"0";t.materialObject.defines.TONEMAP_BACKGROUND!==o&&(t.materialObject.defines.TONEMAP_BACKGROUND=o,t.materialObject.needsUpdate=!0),o=this.clipBackground?"1":"0",t.materialObject.defines.TRANSPARENT_BACKGROUND!==o&&(t.materialObject.defines.TRANSPARENT_BACKGROUND=o,t.materialObject.needsUpdate=!0),o=this.renderDepth?"1":"0",t.materialObject.defines.DEBUG_DEPTH!==o&&(t.materialObject.defines.DEBUG_DEPTH=o,t.materialObject.needsUpdate=!0),i.toneMapping=this.toneMapping,i.toneMappingExposure=this.exposure,i.outputColorSpace=a.KI_,t.materialObject.toneMapped=!0,t.materialObject.needsUpdate=!0,this.extraUniforms.toneMappingContrast.value=this.contrast,this.extraUniforms.toneMappingSaturation.value=this.saturation}onAfterRender(e,t,i){i.toneMapping=this._rendererState.toneMapping,i.toneMappingExposure=this._rendererState.toneMappingExposure,i.outputColorSpace=this._rendererState.outputColorSpace}getUiConfig(){return this.uiConfig}computeCacheKey(e){return this.enabled?"1":"0"}isCompatible(e){return!0}_setDirty(){this._combinedPostPlugin&&(this._combinedPostPlugin.pass.dirty=!0)}setDirty(){this.__setDirty?.(),this._setDirty()}};g.PluginType="Tonemap",m([(0,s.vI)("Mode",[["Linear",a.EoG],["Reinhard",a.CdI],["Cineon",a.YGz],["ACESFilmic",a.LY2],["Uncharted2",f]].map((e=>({label:e[0],value:e[1]}))),{limitedUi:!0}),(0,l.onChange)(r.prototype._setDirty),(0,n.qC)()],g.prototype,"toneMapping",void 0),m([(0,l.onChange)(r.prototype._setDirty),(0,s.Q7)("Tonemap Background",{limitedUi:!0}),(0,n.qC)()],g.prototype,"tonemapBackground",void 0),m([(0,l.onChange)(r.prototype._setDirty),(0,s.Q7)("Clip Background"),(0,n.qC)()],g.prototype,"clipBackground",void 0),m([(0,l.onChange)(r.prototype._setDirty),(0,s.t8)("Exposure",[0,2*Math.PI],.01,{limitedUi:!0}),(0,n.qC)()],g.prototype,"exposure",void 0),m([(0,l.onChange)(r.prototype._setDirty),(0,s.t8)("Saturation",[0,2],.01,{limitedUi:!0}),(0,n.qC)()],g.prototype,"saturation",void 0),m([(0,l.onChange)(r.prototype._setDirty),(0,s.t8)("Contrast",[0,2],.01,{limitedUi:!0}),(0,n.qC)()],g.prototype,"contrast",void 0),m([(0,l.onChange)(r.prototype._setDirty),(0,s.Q7)("Render Depth")],g.prototype,"renderDepth",void 0),g=r=m([(0,s.Sp)("Tonemapping")],g);class v extends d.a{constructor(e=!0){super(),this.depthTonemap=e,this.depthTonemap=e,this.updateGBuffer=this.updateGBuffer.bind(this)}fromJSON(e,t){return e.pass&&((e={...e}).extension={...e.pass},delete e.extension.enabled,delete e.pass),super.fromJSON(e,t)}async onAdded(e){await super.onAdded(e),e.getPlugin(p.m)?.registerGBufferUpdater(this.updateGBuffer)}generateExtension(e){return new g(e,this.depthTonemap)}get exposure(){return this._extension?.exposure??1}set exposure(e){this._extension&&(this._extension.exposure=e,this._extension.setDirty())}get saturation(){return this._extension?.saturation??1}set saturation(e){this._extension&&(this._extension.saturation=e,this._extension.setDirty())}get contrast(){return this._extension?.contrast??1}set contrast(e){this._extension&&(this._extension.contrast=e,this._extension.setDirty())}get toneMapping(){return this._extension?.toneMapping??a.EoG}set toneMapping(e){this._extension&&(this._extension.toneMapping=e,this._extension.setDirty())}updateGBuffer(e,t){if(e instanceof a.Kj0&&e.material?.userData){const i=!1===e.material?.userData.postTonemap?0:1;t.w=(0,u.s)(t.w,1,i)}}}v.PluginType="Tonemap",a.WdD.tonemapping_pars_fragment=a.WdD.tonemapping_pars_fragment.replace("vec3 CustomToneMapping( vec3 color ) { return color; }","\n\n// source: http://filmicworlds.com/blog/filmic-tonemapping-operators/\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n\n\t// John Hable's filmic operator from Uncharted 2 video game\n\tcolor *= toneMappingExposure;\n\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( 1.0 ) ) );\n\n}\n\nvec3 CustomToneMapping( vec3 color ) { return Uncharted2ToneMapping( color ); }\n\n")},5551:function(e,t,i){i.d(t,{BF:function(){return _},FJ:function(){return s},KG:function(){return c},Kb:function(){return o},M:function(){return h},Q7:function(){return n},Sp:function(){return v},YH:function(){return g},_t:function(){return f},ri:function(){return p},s4:function(){return u},t8:function(){return l},vI:function(){return d},w8:function(){return m}});var r=i(8570);const a=new Map;function s(e,t){return(i,r)=>{const s=i.constructor;if(s===Object)throw new Error("All properties in an object are serialized by default");a.has(s)||a.set(s,[]);const n=a.get(s);if(!(n.findIndex((e=>e.propKey===r))<0))throw new Error(`Property ${r} already has a uiConfig decorator`);n.push({params:t||{},propKey:r,uiType:e})}}function n(e,t){return s("checkbox",{label:e,params:t})}function o(e,t){return s("monitor",{label:e,params:t})}function l(e,t,i,r){return s("slider",{label:e,bounds:t,stepSize:i,params:r})}function c(e,t,i,r){return s("vec",{label:e,bounds:t,stepSize:i,params:r})}function d(e,t,i){return s("dropdown",{label:e,children:t,params:i})}function h(e,t){return s("button",{label:e,params:t})}function p(e,t){return s("input",{label:e,params:t})}function u(e,t){return s("color",{label:e,params:t})}function m(e,t){return s("image",{label:e,params:t})}function f(e){let t=e?.constructor;if(!e||!t)return[];const i=[],r=[];for(;t&&t!==Object;)r.push(t),t=Object.getPrototypeOf(t);if(!r.length){const t="object"==typeof e?Object.keys(e):Array.isArray(e)?e.map(((e,t)=>t)):[];for(const r of t){const t=e[r];if(null==t)continue;const a=t?.uiConfig;if(a)i.push(a);else{const a=y(t);"folder"===a?i.push(g(r+"",t)):a&&i.push({type:a,label:r+"",property:[e,r]})}}}return r.reverse().forEach((t=>{a.get(t)?.forEach((({params:t,propKey:r,uiType:a})=>{let s;if(!a){const t=e[r];s=t?.uiConfig,s?i.push(s):null!=t&&("folder"===(a=y(t))?s=g(r+"",t):a&&(s={type:a,label:r+"",property:[e,r]}))}if(s||(s={property:[e,r],type:a||"input"}),t){const i="function"==typeof t.params?t.params(e):t.params||{};delete t.params,Object.assign(s,{...t,...i})}i.push(s)}))})),i}function g(e,t,i={},a="folder"){return{type:a,label:e,children:f(t),uuid:(0,r.Z)(),...i}}function v(e,t,i="folder"){return r=>class extends r{constructor(){super(...arguments),this.uiConfig=g(e,this,t||{},i)}}}function _(e,t){return v(e,t,"panel")}function y(e){return null==e?null:Array.isArray(e)?"folder":"boolean"==typeof e?"checkbox":"number"==typeof e?"number":"string"==typeof e?"input":"function"==typeof e?"button":"number"==typeof e.x?"vec":"number"==typeof e.r?"color":e.isTexture?"image":"object"==typeof e?"folder":null}},3269:function(e,t,i){i.d(t,{o:function(){return j}});var r,a=i(9008);!function(e){e[e.Error=-2]="Error",e[e.Destroyed=-1]="Destroyed",e[e.None=0]="None",e[e.Running=1]="Running",e[e.Paused=2]="Paused"}(r||(r={}));var s=i(2988),n=i(7758);class o extends n.x{constructor(e,t){super(e,t)}setPixelRatio(e,t=!0){const i=this.setSize;t||(this.setSize=()=>{}),super.setPixelRatio(e),t||(this.setSize=i)}}var l=i(6533),c=i(4107),d=i(8052),h=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};let p=class extends a.SimpleEventDispatcher{get composer(){return this._composer}get passes(){return this._passes}get isWebGL2(){return this._isWebGL2}get composerTarget(){return this._composerTarget}get renderSize(){return this._renderSize}get displayCanvasScaling(){return this._displayCanvasScaling}set displayCanvasScaling(e){e!==this._displayCanvasScaling&&(this._displayCanvasScaling=e,this.setSize(void 0,void 0,!0))}get frameCount(){return this._frameCount}get totalFrameCount(){return this._totalFrameCount}set pipeline(e){this._pipeline=e,this._passesNeedsUpdate=!0}get pipeline(){return this._pipeline}refreshPipeline(){const e=this._passes,t=[],i={};for(const t of e){if(!1===t.enabled)continue;const e={after:t.after??[],before:t.before??[],dependencies:new Set(t.required??[])};i[t.passId]=e}for(const[e,t]of Object.entries(i)){const r=new Set([...t.after,...t.before]);t.dependencies.forEach((e=>r.has(e)&&r.delete(e))),r.forEach((r=>{const a=i[r];if(a){if(a.dependencies.has(e))throw console.error("cyclic",e,r),"Cyclic dependency";t.dependencies.add(r)}}))}for(;;){let r=!1;const s=[...Object.entries(i)];for(const[n,o]of s)if(!t.includes(n)&&(0,a.includesAll)(t,o.dependencies.values())){const a=Math.max(-1,...o.after.map((e=>t.indexOf(e)))),s=Math.min(t.length,...o.before.map((e=>{const i=t.indexOf(e);return i<0?t.length:i})));if(a>=s)throw console.error(o,e,t,a,s),"Not possible";t.splice(o.after.length>0?a+1:s,0,n),r=!0,delete i[n]}if(Object.keys(i).length<1)break;if(!r)throw console.error(s,i,t),"Not possible 2"}return this.pipeline=t,this.pipeline}get context(){return this._context}get rendererObject(){return this._renderer}_animationLoop(e,t){const i=e-this._lastTime;this._lastTime=e,this.frameWaitTime-=i,this.frameWaitTime>0||(this.frameWaitTime=0,this.dispatchEvent({type:"animationLoop",deltaTime:i,time:e,renderer:this,xrFrame:t}))}get clock(){return this._composer.clock}registerPass(e,t=!0){if(t)for(const t of[...this._passes])e.passId===t.passId&&this.unregisterPass(t);this._passes.push(e),e.onRegister?.(this),this._passesNeedsUpdate=!0,this._updated()}unregisterPass(e){const t=this._passes.indexOf(e);t>=0&&(e.onUnregister?.(this),this._passes.splice(t,1),this._passesNeedsUpdate=!0,this._updated())}constructor({animationLoop:e,canvas:t,alpha:i=!0,targetOptions:r}){super(),this._isWebGL2=!1,this._trackedTargets=[],this.dirty=!0,this._lastTime=0,this.frameWaitTime=0,this._passes=[],this._pipeline=[],this._passesNeedsUpdate=!0,this._displayCanvasScaling=1,this._renderSize=new s.FM8(512,512),this._frameCount=0,this.defaultRenderToScreen=!0,this._tempTargets={},this.maxTempPerKey=5,this._totalFrameCount=0,this.stableNoise=!1,this._animationLoop=this._animationLoop.bind(this),this._processNewTarget=this._processNewTarget.bind(this),this._processNewTempTarget=this._processNewTempTarget.bind(this),this.trackTarget=this.trackTarget.bind(this),this.disposeTarget=this.disposeTarget.bind(this),this.createTarget=this.createTarget.bind(this),this.createTargetCustom=this.createTargetCustom.bind(this),this._renderer=new s.CP7({canvas:t,antialias:!1,alpha:i,premultipliedAlpha:!0,preserveDrawingBuffer:!0,powerPreference:"high-performance"}),this._renderer.useLegacyLights=!1,this._renderer.baseRenderer=this,this._renderer.setAnimationLoop(this._animationLoop),this._context=this._renderer.getContext(),this._isWebGL2=this._renderer.capabilities.isWebGL2,this._renderer.onContextLost=e=>{this.dispatchEvent({type:"contextLost",event:e})},this._renderer.onContextRestore=()=>{this.dispatchEvent({type:"contextRestored"})},this._renderSize=new s.FM8(t.clientWidth,t.clientHeight),this._renderer.setSize(this._renderSize.width,this._renderSize.height,!1),this._renderer.setPixelRatio(this._displayCanvasScaling),this._renderer.toneMapping=s.uL9,this._renderer.toneMappingExposure=1,this._renderer.outputColorSpace=s.aCh,this._renderer.shadowMap.enabled=!0,this._renderer.shadowMap.type=s._iA,this._renderer.shadowMap.autoUpdate=!1,this.resetShadows(),this._composerTarget=this.createTarget(r,!1),this._composerTarget.texture.name="EffectComposer.rt1",this._composer=new o(this._renderer,this._composerTarget),e&&this.addEventListener("animationLoop",e)}setSize(e,t,i=!1){!i&&(e?Math.abs(e-this._renderSize.width):0)+(t?Math.abs(t-this._renderSize.height):0)<.1||(e&&(this._renderSize.width=e),t&&(this._renderSize.height=t),this.rendererObject.xr.enabled&&this.rendererObject.xr.isPresenting||(this._renderer.setSize(this._renderSize.width,this._renderSize.height,!1),this._renderer.setPixelRatio(this._displayCanvasScaling)),this._composer.setPixelRatio(this._displayCanvasScaling,!1),this._composer.setSize(this._renderSize.width,this._renderSize.height),this._trackedTargets.forEach((e=>{const t=e,i=t.sizeMultiplier;if(i){const e=this._renderSize.clone().multiplyScalar(this._displayCanvasScaling*i);t.setSize(Math.floor(e.width),Math.floor(e.height))}})),this.dispatchEvent({type:"resize"}),this._updated(),this.reset())}blit(e,t,{viewport:i,material:r,shader:a,pass:n,clear:o=!0}={}){const c=this._composer.copyPass,{renderToScreen:d,material:h,uniforms:p,clear:u}=c;r&&(c.material=r);const m=this._renderer.getViewport(new s.Ltg),f=this._renderer.autoClear,g=this._renderer.getRenderTarget();i&&this._renderer.setViewport((new s.Ltg).fromArray(i)),this._renderer.autoClear=!1,c.uniforms=c.material.uniforms,c.renderToScreen=!1,c.clear=o,(0,l.of)(this._renderer,{sceneRender:!0,opaqueRender:!0,shadowMapRender:!1,backgroundRender:!1,transparentRender:!0,transmissionRender:!1},(()=>{c.render(this._renderer,t??null,{texture:e},0,!1)})),c.renderToScreen=d,c.clear=u,c.material=h,c.uniforms=p,this._renderer.autoClear=f,i&&this._renderer.setViewport(m),this._renderer.setRenderTarget(g)}clearColor({r:e,g:t,b:i,a:r,target:a,depth:n=!0,stencil:o=!0}){const l=this._renderer.getClearColor(new s.Ilk),c=this._renderer.getClearAlpha();this._renderer.setClearAlpha(r??c),this._renderer.setClearColor(new s.Ilk(e??l.r,t??l.g,i??l.b));const d=this._renderer.getRenderTarget(),h=this._renderer.getActiveCubeFace(),p=this._renderer.getActiveMipmapLevel();this._renderer.setRenderTarget(a??null),this._renderer.clear(!0,n,o),this._renderer.setRenderTarget(d,h,p),this._renderer.setClearColor(l),this._renderer.setClearAlpha(c)}renderModel(e,t){this._renderer.render(e.modelObject,t.cameraObject)}renderScene(e){const t=e.activeCamera;t&&this.renderModel(e,t)}_updated(){this.dispatchEvent({type:"update"})}render(e){this._passesNeedsUpdate&&this.refreshPasses();for(const e of this._passes)e.passObject.enabled&&e.update?.();e=e??this.defaultRenderToScreen,this._composer.renderToScreen=e,this._composer.render(),this._composer.renderToScreen=!0,e&&(this._frameCount+=1,this._totalFrameCount+=1),this.dirty=!1}updateDirty(){this.dirty=this.dirty||this._passes.findIndex((e=>e.dirty))>=0}reset(){this._frameCount=0,this.dirty=!0}resetShadows(){this._renderer.shadowMap.needsUpdate=!0}refreshPasses(){if(!this._passesNeedsUpdate)return;this._passesNeedsUpdate=!1;const e=[];for(const t of this._pipeline){const i=this._passes.find((e=>e.passId===t));i?e.push(i.passObject):console.warn("Unable to find pass: ",t)}[...this._composer.passes].forEach((e=>this._composer.removePass(e))),e.forEach((e=>this._composer.addPass(e))),this._updated()}dispose(){this._trackedTargets.forEach((e=>e.dispose())),this._trackedTargets=[],this._renderer.dispose()}trackTarget(e){this._trackedTargets.push(e)}removeTrackedTarget(e){const t=this._trackedTargets.indexOf(e);t>=0&&this._trackedTargets.splice(t,1)}createTarget({sizeMultiplier:e,samples:t=0,colorSpace:i=s.aCh,type:r=s.ywz,format:a=s.wk1,depthBuffer:n=!0,depthTexture:o=!1,depthTextureType:l=s.JQ4,depthTextureFormat:c=s.qkB,size:d,textureCount:h=1,...p}={},u=!0){this.isWebGL2||(t=0),void 0!==e&&void 0!==d&&console.error("Both sizeMultiplier and size are defined. sizeMultiplier will be ignored."),(d=d||this._renderSize.clone().multiplyScalar(this._displayCanvasScaling*(e=e||1))).width=Math.floor(d.width),d.height=Math.floor(d.height);const m=o?new s.$YQ(d.width,d.height,l):void 0;m&&(m.format=c);const f=this.createTargetCustom(h>1?{width:d.width,height:d.height,count:h}:d,{samples:t,colorSpace:i,type:r,format:a,depthBuffer:n,depthTexture:m},h>1?s.kFz:s.dd2);return this._processNewTarget(f,e,u),this._setTargetOptions(f,p),f}_processNewTarget(e,t,i){return void 0!==t&&(e.sizeMultiplier=t),i&&this.trackTarget(e),e}disposeTarget(e){if(e){if(e.isTemporary)return this.releaseTempTarget(e);this.removeTrackedTarget(e),e.dispose()}}createTargetCustom({width:e,height:t,count:i},r={},a){const n=this._processNewTarget,o=this.renderTargetToDataUrl.bind(this);this.renderTargetToBuffer.bind(this);let l=[e,t];if(i&&i>1&&l.push(i),a?.prototype===s.oAp.prototype){if(e!==t)throw"Width and height of cube render target must be equal";l=[e]}r={format:s.wk1,minFilter:s.wem,magFilter:s.wem,generateMipmaps:!1,type:s.ywz,colorSpace:s.aCh,...r};const c=[this,...l,r];return new class extends(a??s.dd2){constructor(e,...t){super(...t),this.renderer=e,this.assetType="renderTarget",this.name="RenderTarget",Array.isArray(this.texture)?this.texture.forEach((e=>{e.__target=this,e.userData||(e.userData={}),e.colorSpace=r.colorSpace,e.toJSON=()=>(console.warn("Multiple render target texture.toJSON not supported yet."),{})})):(this.texture.userData||(this.texture.userData={}),this.texture.__toJSON=this.texture.toJSON,this.texture.__target=this,this.texture.toJSON=function(e){console.warn("Render target texture.toJSON might be buggy."),this.source.data.url=o(this.__target,"image/png",90);const t=this.__toJSON.call(this,e);return delete this.source.data.url,t.isRenderTargetTexture=!0,t})}setSize(e,t,i){super.setSize(Math.floor(e),Math.floor(t),i)}clone(e=!0){if(this.isTemporary)throw"Cloning temporary render targets not supported";if(Array.isArray(this.texture))throw"Cloning multiple render targets not supported";const t=super.clone();return t.texture.isRenderTargetTexture=!0,n(t,this.sizeMultiplier||1,e)}}(...c)}getTempTarget(e={}){const t=function(e={}){return[e.sizeMultiplier,e.samples,e.colorSpace,e.type,e.format,e.depthBuffer,e.depthTexture,e.size?.width,e.size?.height].join(";")}(e);let i;return this._tempTargets[t]?.length&&(i=this._tempTargets[t].pop()),i?this._setTargetOptions(i,e):(i=this.createTarget(e),this._processNewTempTarget(i,t)),i}_processNewTempTarget(e,t){return e.isTemporary=!0,e.targetKey=t,void 0===this._tempTargets[t]&&(this._tempTargets[t]=[]),e}releaseTempTarget(e){const t=e.targetKey;if(!t||!e.isTemporary)throw"Not a temp target";this._tempTargets[t].length>this.maxTempPerKey?(this.removeTrackedTarget(e),e.dispose()):this._tempTargets[t].push(e)}updateShaderProperties(e){return this.stableNoise?e.uniforms.frameCount?e.uniforms.frameCount.value=this._totalFrameCount:console.warn("BaseRenderer: no uniform: frameCount"):e.uniforms.frameCount?e.uniforms.frameCount.value=this.frameCount:console.warn("BaseRenderer: no uniform: frameCount"),e.uniforms.frameCount2&&(e.uniforms.frameCount2.value=this.frameCount),this}_setTargetOptions(e,t){e.texture.minFilter=t.minFilter??s.wem,e.texture.magFilter=t.magFilter??s.wem,e.texture.generateMipmaps=t.generateMipmaps??!1,e.texture.generateMipmaps&&e.texture.minFilter===s.wem&&(e.texture.minFilter=s.FDw),e.texture.generateMipmaps||e.texture.minFilter!==s.FDw||(e.texture.minFilter=s.wem)}renderTargetToDataUrl(e,t="image/png",i=90,r=0){const a=document.createElement("canvas");a.width=e.width,a.height=e.height;const n=a.getContext("2d");if(!n)throw new Error("Unable to get 2d context");const o=Array.isArray(e.texture)?e.texture[r]:e.texture,l=n.createImageData(e.width,e.height,{colorSpace:["display-p3","srgb"].includes(o.colorSpace)?o.colorSpace:void 0});if(o.type===s.cLu){const t=new Uint16Array(e.width*e.height*4);this._renderer.readRenderTargetPixels(e,0,0,e.width,e.height,t,void 0,r),(0,d.$j)({data:t,width:e.width,height:e.height},o.colorSpace,l)}else if(o.type===s.VzW){const t=new Float32Array(e.width*e.height*4);this._renderer.readRenderTargetPixels(e,0,0,e.width,e.height,t,void 0,r),(0,d.$j)({data:t,width:e.width,height:e.height},o.colorSpace,l)}else this._renderer.readRenderTargetPixels(e,0,0,e.width,e.height,l.data,void 0,r);n.putImageData(l,0,0);const c=a.toDataURL(t,i);return a.remove(),c}renderTargetToBuffer(e,t=0){const i=(Array.isArray(e.texture)?e.texture[t]:e.texture).type===s.cLu?new Uint16Array(e.width*e.height*4):new Uint8Array(e.width*e.height*4);return this._renderer.readRenderTargetPixels(e,0,0,e.width,e.height,i,void 0,t),i}get useLegacyLights(){return this.rendererObject.useLegacyLights}set useLegacyLights(e){this.rendererObject.useLegacyLights=e,this._updated(),this.resetShadows()}get useTotalFrameCount(){return console.warn("useTotalFrameCount is deprecated, use stableNoise instead"),this.stableNoise}set useTotalFrameCount(e){console.warn("useTotalFrameCount is deprecated, use stableNoise instead"),this.stableNoise=e}get renderScale(){return this.displayCanvasScaling}set renderScale(e){this.displayCanvasScaling=e}};h([(0,c.qC)()],p.prototype,"stableNoise",void 0),h([(0,c.qC)()],p.prototype,"useLegacyLights",null),p=h([(0,c.Bg)("RenderManager")],p);var u=i(1483),m=i(5551),f=i(7052),g=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};let v=class extends f.z{constructor(){super(...arguments),this.type="OrbitControls",this.enabled=!0,this.dollyZoom=!1,this.enableDamping=!0,this.dampingFactor=.08,this.autoRotate=!0,this.autoRotateSpeed=1,this.enableZoom=!0,this.zoomSpeed=.15,this.maxZoomSpeed=.2,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.autoPushTarget=!1,this.autoPullTarget=!1,this.minDistance=4,this.maxDistance=15,this.minZoom=.01,this.maxZoom=1e3,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1e4,this.maxAzimuthAngle=1e4,this.clampMin=new s.Pa4(-1e4,-1e4,-1e4),this.clampMax=new s.Pa4(1e4,1e4,1e4),this.screenSpacePanning=!0,this.keyPanSpeed=7,this.throttleUpdate=60}zoomIn(e){super.zoomIn(e)}zoomOut(e){super.zoomOut(e)}dispatchEvent(e){super.dispatchEvent(e)}};g([(0,c.qC)()],v.prototype,"type",void 0),g([(0,m.Q7)()],v.prototype,"enabled",void 0),g([(0,m.Q7)(),(0,c.qC)()],v.prototype,"dollyZoom",void 0),g([(0,m.Q7)(),(0,c.qC)()],v.prototype,"enableDamping",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"dampingFactor",void 0),g([(0,m.Q7)(),(0,c.qC)()],v.prototype,"autoRotate",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"autoRotateSpeed",void 0),g([(0,m.Q7)(),(0,c.qC)()],v.prototype,"enableZoom",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"zoomSpeed",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"maxZoomSpeed",void 0),g([(0,m.Q7)(),(0,c.qC)()],v.prototype,"enableRotate",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"rotateSpeed",void 0),g([(0,m.Q7)(),(0,c.qC)()],v.prototype,"enablePan",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"panSpeed",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"autoPushTarget",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"autoPullTarget",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"minDistance",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"maxDistance",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"minZoom",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"maxZoom",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"minPolarAngle",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"maxPolarAngle",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"minAzimuthAngle",void 0),g([(0,m.ri)(),(0,c.qC)()],v.prototype,"maxAzimuthAngle",void 0),g([(0,m.KG)(),(0,c.qC)()],v.prototype,"clampMin",void 0),g([(0,m.KG)(),(0,c.qC)()],v.prototype,"clampMax",void 0),g([(0,c.qC)()],v.prototype,"screenSpacePanning",void 0),g([(0,c.qC)()],v.prototype,"keyPanSpeed",void 0),v=g([(0,m.BF)("Orbit Controls")],v);var _=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class y extends a.SimpleEventDispatcher{get controls(){return this._controls}getControls(){return this._controls}get userData(){return this._camera.modelObject.userData}set userData(e){this._camera.modelObject.userData=e}get isActiveCamera(){return this._isActiveCamera}get target(){return this._target}set target(e){const t=this._target.sub(e).length()>0;this._target.copy(e),t&&this.targetUpdated()}get position(){return this._position}set position(e){const t=this._position.sub(e).length()>0;this._position.copy(e),t&&this.positionUpdated()}get name(){return this._camera.name}set name(e){this._camera.name=e}getCameraOptions(){return{...this._options,position:this._position.toArray(),target:this._target.toArray()}}setCameraOptions(e,t=!0){const i={...e};i.position?.isVector3&&(i.position=[i.position.x,i.position.y,i.position.z]),i.target?.isVector3&&(i.target=[i.target.x,i.target.y,i.target.z]),Object.keys(i).forEach((e=>"frustumSize"!==e&&void 0===i[e]&&delete i[e])),Object.assign(this._options,i),this._refreshCameraOptions(!1),this.refreshCameraControls(!1),t&&this.setDirty()}_refreshCameraOptions(e=!0){let t=this._camera.modelObject;if(this._options.type!==t.type){const e="PerspectiveCamera"===this._options.type?new s.cPb:new s.iKG;e.name=this._camera.name,e.near=this._camera.modelObject.near,e.far=this._camera.modelObject.far,e.zoom=this._camera.modelObject.zoom,e.scale.copy(this._camera.modelObject.scale);const i=this._isActiveCamera;i&&this.deactivateMain(),this._camera=this._setCameraObject(e),t=this._camera.modelObject,i&&this.activateMain(),this._camera.modelObject.updateProjectionMatrix()}let i=this._options.aspect;if("auto"===i&&(i=this._container.clientWidth/this._container.clientHeight),this._options.position&&(this.position.set(...this._options.position),delete this._options.position),this._options.target&&(this.target.set(...this._options.target),delete this._options.target),this.positionUpdated(!1),"PerspectiveCamera"===this._options.type&&(t.fov=this._options.fov,t.focus=this._options.focus,t.aspect=i),"OrthographicCamera"===this._options.type){const e=this._options.frustumSize;void 0!==e?(t.top=e/2,t.bottom=-e/2,t.left=i*e/2,t.right=-i*e/2):(t.top=this._options.top,t.bottom=this._options.bottom,t.left=this._options.left,t.right=this._options.right)}t.zoom=this._options.zoom,this._nearFarChanged(),e&&this.setDirty()}_setCameraObject(e){return this._camera&&this._camera.removeEventListener("objectUpdate",this._cameraObjectUpdate),this._camera=(0,u.LC)(e),this._camera.addEventListener("objectUpdate",this._cameraObjectUpdate),this._camera}get interactionsEnabled(){return this._interactionsEnabled&&this._isActiveCamera&&this._options.controlsEnabled&&""!==this._options.controlsMode}set interactionsEnabled(e){this._interactionsEnabled!==e&&(this._interactionsEnabled=e,this.refreshCameraControls(!0))}_nearFarChanged(){this._camera&&(this._camera.modelObject.near=this.near,this._camera.modelObject.far=this.far,this._camera.modelObject.updateProjectionMatrix())}constructor(e,t,i){super(),this._controlsMode="",this._isActiveCamera=!1,this._cameraObjectUpdate=e=>{this.setDirty(e)},this._interactionsEnabled=!0,this.autoLookAtTarget=!1,this.near=.01,this.far=50,this._options={type:"PerspectiveCamera",aspect:"auto",focus:10,fov:25,zoom:1,frustumSize:1,top:1,bottom:-1,left:-1,right:1,controlsMode:"orbit",controlsEnabled:!0},this._position=new s.Pa4(5,5,5),this._target=new s.Pa4(0,0,0),this._controlsCtors=new Map([["orbit",(e,t)=>{const i=new v(e,t.ownerDocument?t:t.documentElement);return i.screenSpacePanning=!0,i}]]),this._positionWorld=new s.Pa4,this._camUi=[{type:"vec3",label:"Position",property:[this,"position"],onChange:()=>this.positionUpdated(!0)},{type:"vec3",label:"Target",property:[this,"target"],onChange:()=>this.targetUpdated(!0)},{type:"slider",bounds:[1,180],label:"Field Of View",hidden:()=>!this._camera.modelObject.isPerspectiveCamera,property:[this._options,"fov"],onChange:()=>this.refreshCameraOptions(),limitedUi:!0},{type:"checkbox",label:"Auto Near far",getValue:()=>this._camera.userData.autoNearFar??!0,setValue:e=>this._camera.userData.autoNearFar=e,onChange:()=>this.setDirty()},{type:"input",label:()=>this._camera.userData.autoNearFar??1?"Min Near":"Near",getValue:()=>this._camera.userData.minNearPlane??.5,setValue:e=>this._camera.userData.minNearPlane=e,onChange:()=>this.setDirty()},{type:"input",label:()=>this._camera.userData.autoNearFar??1?"Max Far":"Far",getValue:()=>this._camera.userData.maxFarPlane??1e3,setValue:e=>this._camera.userData.maxFarPlane=e,onChange:()=>this.setDirty()},()=>({type:"dropdown",label:"Controls Mode",property:[this._options,"controlsMode"],children:["","orbit",...this._controlsCtors.keys()].map((e=>({label:""===e?"none":e,value:e}))),onChange:()=>{this.refreshCameraOptions()}})],this.uiConfig={type:"folder",label:"Camera",limitedUi:!0,children:[...this._camUi,()=>this._controls?.zoomIn?{type:"button",label:"Zoom in",value:()=>{this._controls?.zoomIn(1)}}:{},()=>this._controls?.zoomOut?{type:"button",label:"Zoom out",value:()=>{this._controls?.zoomOut(1)}}:{},()=>this._controls?.uiConfig]},this.assetType="model",this.uuid=s.M8C.generateUUID(),this.setDirty=this.setDirty.bind(this),this.targetUpdated=this.targetUpdated.bind(this),this._refreshCameraOptions=this._refreshCameraOptions.bind(this),this._container=i??document.body;const r={...t}??this._options;this._camera=this._setCameraObject(e??("OrthographicCamera"===r.type?new s.iKG(-1,1,1,-1):new s.cPb)),this._camera.modelObject.userData.iCamera=this;const a=e;e&&(a.isPerspectiveCamera?(r.fov=a.fov,r.focus=a.focus,r.aspect=a.aspect<=0||a.userData.autoAspect?"auto":a.aspect,r.zoom=a.zoom):a.isOrthographicCamera&&(r.left=a.left,r.right=a.right,r.top=a.top,r.bottom=a.bottom,r.zoom=a.zoom),this.near=a.near,this.far=a.far,this._position.copy(e.position),this.refreshTarget()),this.positionUpdated(!1),this.setCameraOptions(r)}refreshAspect(e=!0){"auto"===this._options.aspect&&this._refreshCameraOptions(e)}refreshTarget(e=4){this._controls?.enabled&&this._controls.target?this._target.copy(this._controls.target):this.cameraObject.getWorldDirection(this._target).multiplyScalar(e).add(this.cameraObject.getWorldPosition(new s.Pa4))}setControlsCtor(e,t,i=!1){i||!this._controlsCtors.has(e)?this._controlsCtors.set(e,t):console.error(e+" already exists.")}removeControlsCtor(e){this._controlsCtors.delete(e)}_initCameraControls(){const e=this._options.controlsMode;this._controls=this._controlsCtors.get(e)?.(this._camera.modelObject,this._container)??void 0,this._controls||""===e||console.error("Unable to create controls with mode "+e+". Are you missing a plugin?"),this._controls?.addEventListener("change",this.setDirty),this._controlsMode=this._controls?e:""}_disposeCameraControls(){this._controlsMode,this._controls?.removeEventListener("change",this.setDirty),this._controls?.dispose(),this._controlsMode="",this._controls=void 0}refreshCameraControls(e=!0){if(this._options.controlsEnabled){const e=this._options.controlsMode;this._controls?this._controlsMode===e&&this._camera.modelObject===this._controls.object||(this._disposeCameraControls(),this._initCameraControls()):this._initCameraControls(),this._controlsMode=e}if(this._controls){const e=this.interactionsEnabled;this._controls.enabled=e,e&&this._camera.modelObject.up.copy(s.Tme.DEFAULT_UP)}e&&this.setDirty(),this.uiConfig.uiRefresh?.("postFrame",!0)}setDirty(e){this._position.copy(this._camera.modelObject.position),this._controls&&this._controls.enabled&&this._controls.target&&this._target.copy(this._controls.target),void 0!==this._camera.modelObject.fov&&(this._options.fov=this._camera.modelObject.fov),void 0!==this._camera.modelObject.focus&&(this._options.focus=this._camera.modelObject.focus),void 0!==this._camera.modelObject.zoom&&(this._options.zoom=this._camera.modelObject.zoom),this.cameraObject.getWorldPosition(this._positionWorld),this.dispatchEvent({...e,type:"update"}),this._camUi.forEach((e=>e?.uiRefresh?.("postFrame",!1,1)))}activateMain(e=!0){this._isActiveCamera||(this._isActiveCamera=!0,this._camera.modelObject.userData.__lastScale=this._camera.modelObject.scale.clone(),this._camera.modelObject.scale.divide(this._camera.modelObject.getWorldScale(new s.Pa4)),e&&(this.refreshCameraControls(!1),this._refreshCameraOptions(!0)),this._camera.setDirty?.({change:"activateMain"}))}deactivateMain(e=!0){this._isActiveCamera&&(this._isActiveCamera=!1,this._camera.modelObject.userData.__lastScale&&(this._camera.modelObject.scale.copy(this._camera.modelObject.userData.__lastScale),delete this._camera.modelObject.userData.__lastScale),e&&this.refreshCameraControls(!0))}get cameraObject(){return this._camera.modelObject}get modelObject(){return this._camera.modelObject}dispose(){this._disposeCameraControls()}targetUpdated(e=!0){const t=this.target;this._controls?.target?.set(t.x,t.y,t.z),this._controls&&this._controls.enabled&&this._controls.target?e&&this.setDirty():this._camera&&(void 0!==this._camera.userData.autoLookAtTarget&&(this.autoLookAtTarget=this._camera.userData.autoLookAtTarget),this.autoLookAtTarget&&this._camera.modelObject.lookAt(t),e&&this.setDirty())}positionUpdated(e=!0){const t=this.position;this._camera.modelObject.position.set(t.x,t.y,t.z),this.targetUpdated(e)}positionTargetUpdated(e=!0){this.positionUpdated(e)}copyFromCamera(e,t=4){e.getWorldPosition(this._position),e.getWorldDirection(this._target).multiplyScalar(t).add(this._position),this.positionUpdated(!1),this.setCameraOptions({fov:e.fov,focus:e.focus,zoom:e.zoom,type:e.type},!0)}updateShaderProperties(e){return e.uniforms.cameraPositionWorld?.value?.copy(this._positionWorld),e.uniforms.cameraNearFar?.value?.set(this._camera.modelObject.near,this._camera.modelObject.far),e.uniforms.projection&&(e.uniforms.projection.value=this._camera.modelObject.projectionMatrix),e.defines.PERSPECTIVE_CAMERA="PerspectiveCamera"===this._camera.modelObject.type?"1":"0",e.defines.ORTHOGRAPHIC_CAMERA="OrthographicCamera"===this._camera.modelObject.type?"1":"0",this}toJSON(e){const t={};return(0,u.A)(t,this.userData),Object.assign({userData:t},(0,c.HD)(this,!0,e))}fromJSON(e,t){return e.userData&&((0,u.A)(this.userData,e.userData),delete(e={...e}).userData),e.camOptions&&(this.setCameraOptions(e.camOptions,!1),this.refreshCameraOptions(!1)),(0,c.Hx)(e,this,!0,t),this.positionUpdated(!1),this.refreshCameraOptions(!1),this.setDirty({change:"deserialize"}),this}refreshCameraOptions(e=!0){this.setCameraOptions(this._options,e)}get visible(){return!0}set visible(e){console.error("Cannot set visible on camera",e)}}_([(0,c.qC)("camControls")],y.prototype,"_controls",void 0),_([(0,a.onChange)(y.prototype._nearFarChanged)],y.prototype,"near",void 0),_([(0,a.onChange)(y.prototype._nearFarChanged)],y.prototype,"far",void 0),_([(0,c.qC)("camOptions")],y.prototype,"_options",void 0),_([(0,c.qC)("position")],y.prototype,"_position",void 0),_([(0,c.qC)("target")],y.prototype,"_target",void 0);var b=i(1191),w=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};class x extends s.xsS{get activeCamera(){return this._activeCamera>=0?this._cameras[this._activeCamera]:this._dummyCam}set activeCamera(e){const t=this.activeCamera;if(e||(e=this.defaultCamera),t!==e){if(t&&(t.deactivateMain(),t.removeEventListener("update",this._activeCameraUpdate)),e){e.activateMain(),e.addEventListener("update",this._activeCameraUpdate);let t=this._cameras.indexOf(e);t<0&&(this._cameras.push(e),t=this._cameras.length-1),this._activeCamera=t}else this._activeCamera=-1;this.dispatchEvent({type:"activeCameraChange",lastCamera:t,camera:e}),this.setDirty()}}get renderCamera(){return this._renderCamera??this.activeCamera}set renderCamera(e){const t=this._renderCamera;this._renderCamera=e,this.dispatchEvent({type:"renderCameraChange",lastCamera:t,camera:e})}get modelObject(){return this}constructor(e){super(),this.isRootScene=!0,this.assetType="model",this._sceneBounds=new b.q,this._sceneBoundingRadius=0,this._cameras=[],this._activeCamera=-1,this.envMapIntensity=1,this.fixedEnvMapDirection=!1,this.backgroundIntensity=1,this._dummyCam=new y(new s.cPb,{controlsMode:"",controlsEnabled:!1}),this.environment=null,this.background=null,this.backgroundColor=null,this.setDirty=this.setDirty.bind(this),this.updateScene=this.updateScene.bind(this),this.refreshActiveCameraNearFar=this.refreshActiveCameraNearFar.bind(this),this._activeCameraUpdate=this._activeCameraUpdate.bind(this),this._onSceneMaterialUpdate=this._onSceneMaterialUpdate.bind(this),this._onSceneUpdate=this._onSceneUpdate.bind(this),this.addEventListener("materialUpdate",this._onSceneMaterialUpdate),this.addEventListener("materialChanged",this._onSceneMaterialUpdate),this.addEventListener("objectUpdate",this._onSceneUpdate),this.defaultCamera=e,this.modelRoot=(0,u.LC)(new s.ZAu,void 0),this.modelRoot.userData.rootSceneModelRoot=!0,this.modelRoot.name="Scene",this.modelRoot.addEventListener("update",this.setDirty),this.addSceneObject(this.modelRoot,{addToRoot:!0,autoScale:!1}),this.addSceneObject(this.defaultCamera,{addToRoot:!0}),this.activeCamera=this.defaultCamera,this.boxHelper=new s.GQ(this.getBounds())}addModel(e,t={}){return"model"!==e.assetType&&console.error("Invalid asset type for ",e,", adding anyway"),this.addSceneObject(e,t)}addWidget(e,t={}){"widget"!==e.assetType&&console.warn("Invalid asset type for ",e,", adding anyway"),this.add(e.modelObject)}_addModel(e,t={}){return this._addObject3D(e?.modelObject,t)}addSceneObject(e,t){if(!e)return e;const i=e.assetType;let r=!1;switch(i){case"model":r=e.modelObject.isCamera,r&&(t={...t,autoScale:!1}),this._addModel(e,t);break;case"material":break;case"texture":this.dispatchEvent({type:"textureAdded",texture:e});break;case"light":this._addLight(e,t);break;default:console.warn("Unknown asset imported",e,i)}return this.dispatchEvent({type:"addSceneObject",object:e,options:t}),e}_addObject3D(e,{autoScale:t=!0,autoScaleRadius:i=2,addToRoot:r=!1}={}){const a=e;a?(t&&!a.userData.autoScaled&&(0,l.RG)(a,a.userData.autoScaleRadius||i),a.traverse((e=>{e.isMesh&&!e.userData.__keepShadowDef&&(e.castShadow=!0,e.receiveShadow=!0,e.userData.__keepShadowDef=!0)})),r?this.modelObject.add(a):this.modelRoot.add(a),this.setDirty()):console.error("Invalid Model, cannot add.")}removeSceneModels(){this.modelRoot.clear(),this.modelRoot.children=[],this.setDirty({sceneUpdate:!0})}disposeSceneModels(){[...this.modelRoot.children].forEach((e=>{(e.dispose??e.modelObject?.removeFromParent)()})),this.setDirty({sceneUpdate:!0})}_onEnvironmentChange(){this.environment?.mapping===s.xfE&&(this.environment.mapping=s.dSO,this.environment.needsUpdate=!0),this.dispatchEvent({type:"environmentChanged",environment:this.environment}),this._onSceneUpdate({geometryChanged:!1})}_onBackgroundChange(){this.dispatchEvent({type:"backgroundChanged",background:this.background,backgroundColor:this.backgroundColor}),this._onSceneUpdate({geometryChanged:!1})}add(...e){return super.add(...e.map((e=>(0,u.LC)(e)))),this._onSceneUpdate(),this}setEnvironment(e){if(!e)return void(this.environment=null);if(!e.isTexture)return void console.error("Unknown Environment type",e);"texture"!==e.assetType&&console.warn("Environment asset not processed",e);const t=e.textureObject||e;this.environment=t}getEnvironment(){return this.environment}setBackground(e){let t;if(!e||"texture"===e.assetType||e.isTexture||e.isColor||"environment"===e)t=("texture"===e?.assetType||e.isTexture)&&e.textureObject||e;else{if("string"!=typeof e&&"number"!=typeof e)return void console.error("Unknown Background type",e);t=new s.Ilk(e)}this.background=t}setBackgroundColor(e){this.backgroundColor=e?new s.Ilk(e):null}getBackground(){return this.background}setDirty(e){return e?.sceneUpdate||e?.refreshScene?this._onSceneUpdate(e):this.dispatchEvent({type:"update"}),this}updateScene(e){return this._onSceneUpdate(e)}_activeCameraUpdate(e){this.setDirty(),this.refreshActiveCameraNearFar(),this.dispatchEvent({...e,type:"activeCameraUpdate"})}_onSceneUpdate(e={}){return!1===e.sceneUpdate&&!1===e.refreshScene?this.setDirty(e):(this.refreshActiveCameraNearFar(),this._sceneBounds=this.getBounds(!1,!0),this.boxHelper?.box?.copy?.(this._sceneBounds),this._sceneBoundingRadius=this._sceneBounds.getSize(new s.Pa4).length()/2,this.dispatchEvent({...e,type:"sceneUpdate",hierarchyChanged:["addedToParent","removedFromParent"].includes(e.change||"")}),this)}_onSceneMaterialUpdate(){this.dispatchEvent({type:"sceneMaterialUpdate"})}dispose(){this.disposeSceneModels(),this.clear(),this.environment?.dispose()}findObjectsByName(e,t){const i=[];return(t??this.modelObject).traverse((t=>{t.name===e&&i.push(t)})),i}addLight(e,t={}){this.addSceneObject(e,t)}_addLight(e,{addToRoot:t=!1}={}){const i=e.lightObject;i&&(i.children?.length,t?this.add(i):this.modelRoot.add(i))}getBounds(e=!1,t=!0,i=!0,r){return(new b.q).expandByObject(this.modelObject,e,t,(e=>!(!i||"widget"!==e.assetType)||(r?.(e)??!1)))}refreshActiveCameraNearFar(){const e=this.activeCamera;if(!e)return;if(!1===e.cameraObject.userData.autoNearFar)return e.near=e.cameraObject.userData.minNearPlane??.5,void(e.far=e.cameraObject.userData.maxFarPlane??1e3);const t=this.getBounds(!1),i=e.cameraObject.getWorldPosition(new s.Pa4).sub(t.getCenter(new s.Pa4)),r=1.5*t.getSize(new s.Pa4).length()/2,a=Math.max(.1,-i.clone().normalize().dot(e.cameraObject.getWorldDirection(new s.Pa4))),n=i.length(),o=Math.max(Math.max(e.cameraObject.userData.minNearPlane??.5,.001),a*(n-r)),l=Math.min(Math.max(o+r,a*(n+r)),e.cameraObject.userData.maxFarPlane??1e3);e.near=o,e.far=l}updateShaderProperties(e){return e.uniforms.sceneBoundingRadius?e.uniforms.sceneBoundingRadius.value=this._sceneBoundingRadius:console.warn("BaseRenderer: no uniform: frameCount"),this}toJSON(e){return(0,c.HD)(this,!0,e)}fromJSON(e,t){const i=e.environment;return void 0!==i&&(this.setEnvironment((0,c.Hx)(i,this.getEnvironment(),!1,t)),delete e.environment),(0,c.Hx)(e,this,!0,t),e.environment=i,this}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}get minNearDistance(){return console.error("minNearDistance is deprecated. Use camera.userData.minNearPlane instead"),this.activeCamera.userData.minNearPlane??.5}set minNearDistance(e){console.error("minNearDistance is deprecated. Use camera.userData.minNearPlane instead"),this.activeCamera&&(this.activeCamera.userData.minNearPlane=e)}}w([(0,c.qC)()],x.prototype,"defaultCamera",void 0),w([(0,a.onChange2)(x.prototype.setDirty),(0,c.qC)()],x.prototype,"envMapIntensity",void 0),w([(0,a.onChange2)(x.prototype.setDirty),(0,c.qC)()],x.prototype,"fixedEnvMapDirection",void 0),w([(0,a.onChange2)(x.prototype.setDirty),(0,c.qC)()],x.prototype,"backgroundIntensity",void 0),w([(0,c.qC)(),(0,a.onChange)(x.prototype._onEnvironmentChange.name)],x.prototype,"environment",void 0),w([(0,c.qC)(),(0,a.onChange)(x.prototype._onBackgroundChange)],x.prototype,"background",void 0),w([(0,c.qC)(),(0,a.onChange)(x.prototype._onBackgroundChange)],x.prototype,"backgroundColor",void 0);var D=i(6265),S=i(7245),C=i(4915);class M extends S.Hl{constructor(e,t="c = a + b;",i="",r){super({vertexShader:D.C.vertexShader,fragmentShader:a.glsl`
                varying vec2 vUv;
                
                ${i}
                
                void blend(in vec4 a, in vec4 b, inout vec4 c){
                
                ${t}
                
                }
                void main() {
                    vec4 texel = vec4(0);
                    blend(tDiffuseTexelToLinear ( texture2D( tDiffuse, vUv ) ), tDiffuse2TexelToLinear ( texture2D( tDiffuse2, vUv ) ), texel);
                    texel = clamp(texel, vec4(0), vec4(8));
                    gl_FragColor = texel;
                    #include <encodings_fragment>
                }
            `,uniforms:{tDiffuse:{value:null},tDiffuse2:{value:r},...e}},"tDiffuse","tDiffuse2"),this.clear=!1,this.needsSwap=!0}}var T=i(6757);class O extends C.C{get transparentTarget(){return this._transparentTarget||(this._transparentTarget=this._viewer.renderer.getTempTarget({sizeMultiplier:1,samples:this._viewer.renderer.composerTarget.samples||0,colorSpace:s.aCh,type:this._viewer.renderer.rendererObject.extensions.has("EXT_color_buffer_half_float")?s.cLu:s.ywz,format:s.wk1,minFilter:s.wem,magFilter:s.wem,depthBuffer:!1})),this._transparentTarget}_releaseTransparentTarget(){this._transparentTarget&&this._viewer.renderer.releaseTempTarget(this._transparentTarget),this._transparentTarget=void 0}constructor(e,t=!0){super(),this.blurTransmissionTarget=!0,this.preserveTransparentTarget=!1,this._viewer=e,this._doTransmissionFix=t,this.clear=!0,this.clearColor=new s.Ilk(0,0,0),this.clearAlpha=0,this.clearDepth=!1,this._blendPass=new M({},"c = vec4(a.rgb * (1. - b.a) + b.rgb * b.a, 1.);")}render(e,t,i,r,a){let s=!1;if(e.userData.mainRenderPass=!0,!this._doTransmissionFix)return super.render(e,t,i,r,a),this.needsSwap=s,void(e.userData.mainRenderPass=void 0);const n=e.userData;n||console.error("threejs is not patched?");const o=this._viewer.useGBufferDepth;let c;if(o){const t=this._viewer.getPlugin(T.m)?.getTarget();if(t){const i=e.properties.get(t);c=i.__webglDepthRenderbuffer||i.__webglDepthbuffer}else console.warn("No Gbuffer present for depth prepass.")}let d=(t=!1)=>{super.render(e,void 0,i,r,a,c)};if(this._viewer.useRgbm){if(this._viewer.useRgbm){if(s=!1,e.info&&!e.info.autoReset)throw"renderer.info.autoReset must be true";{const t=e.autoClearDepth;e.autoClearDepth=!o,(0,l.of)(e,{shadowMapRender:!0,backgroundRender:!0,opaqueRender:!0,transparentRender:!1,transmissionRender:!1},d),e.autoClearDepth=t}if(!o){const t=e.properties.get(i);c=t.__webglDepthRenderbuffer||t.__webglDepthbuffer}d=()=>{super.render(e,void 0,this.transparentTarget,r,a,c)};{const t=this.clear,i=e.autoClearDepth;e.autoClearDepth=!1,this.clear=!0,(0,l.of)(e,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!1,transparentRender:!0,transmissionRender:!1},d),this.clear=t,e.autoClearDepth=i}(!e.info||e.info.render.calls>0)&&(this._blendPass.uniforms.tDiffuse2.value=this.transparentTarget.texture,this._blendPass.render(e,t,i,r,a),s=!0);{const r=this.clear;this.clear=!1,n.transmissionRenderTarget=s?t:i,n.blurTransmissionTarget=this.blurTransmissionTarget&&0===n.transmissionRenderTarget.samples,(0,l.of)(e,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!1,transparentRender:!1,transmissionRender:!0},d),n.blurTransmissionTarget=void 0,n.transmissionRenderTarget=void 0,this.clear=r}(!e.info||e.info.render.calls>0)&&(this._blendPass.uniforms.tDiffuse2.value=this.transparentTarget.texture,this._blendPass.render(e,t,i,r,a),s=!0)}}else{{const t=this.clear,i=e.autoClearDepth;e.autoClearDepth=!o,this.clear=!0,(0,l.of)(e,{shadowMapRender:!0,backgroundRender:!0,opaqueRender:!0,transparentRender:!0,transmissionRender:!1},d),this.clear=t,e.autoClearDepth=i}{this._viewer.renderer.blit(i.texture,t,{clear:!0});const r=this.clear;this.clear=!1,n.transmissionRenderTarget=t,n.blurTransmissionTarget=this.blurTransmissionTarget,(0,l.of)(e,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!1,transparentRender:!1,transmissionRender:!0},d),n.blurTransmissionTarget=void 0,n.transmissionRenderTarget=void 0,this.clear=r}s=!1}this.preserveTransparentTarget||this._releaseTransparentTarget(),this.needsSwap=s,e.userData.mainRenderPass=void 0}dispose(){this._releaseTransparentTarget(),super.dispose()}}var P=i(4821),E=i(8112),R=function(e,t,i,r){var a,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,i,n):a(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n};function A(e){return Object.getPrototypeOf(e).constructor.PluginType}class j extends a.SimpleEventDispatcher{get useRgbm(){return this._useRgbm}get screenShader(){return this._screenShader}get useGBufferDepth(){return this._useGBufferDepth}get isAntialiased(){return this._isAntialiased}constructor({isAntialiased:e=!1,useRgbm:t=!0,useGBufferDepth:i=!1,screenShader:n="",...o}){super(),this.console=console,this._state=r.None,this.plugins={},this._needsResize=!1,this.resizeObserver=window.ResizeObserver?new window.ResizeObserver((e=>this.resize())):void 0,this._lastSize=new s.FM8,this._onContextRestore=e=>{this.enabled=!0,this._canvas.width=this._lastSize.width,this._canvas.height=this._lastSize.height,this.resize(),this.scene.setDirty({sceneUpdate:!0,frameFade:!1})},this._onContextLost=e=>{this._lastSize.set(this._canvas.width,this._canvas.height),this._canvas.width=2,this._canvas.height=2,this.resize(),this.enabled=!1},this.resize=()=>{this._needsResize=!0,this.setDirty()},this._needsReset=!0,this.enabled=!0,this.renderEnabled=!0,this._isRenderingFrame=!1,this.maxFramePerLoop=1,this.rendersPerFrame=1,this._rawBackground=null,this._sceneEnvironmentChanged=()=>{this._rawBackground===U&&this.scene.setBackground(this.scene.getEnvironment())},this._addSceneObject=e=>{if(!e||!e.object)return;const t=e.object.__importedViewerConfig||e.object.modelObject?.__importedViewerConfig;if(!t)return;const i=this.getManager();!function(e,t,i){if(e[0]<7||7===e[0]&&e[1]<6){const e=new Set;(t.options?.allImported?t.options.allImported:[t.object]).forEach((t=>t.traverse((t=>{t.material&&e.add(t.material)})))),e.forEach((e=>{const t=e.map;if(!t)return;const i=t.repeat,r=t.offset,a=t.center,s=t.rotation;["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","lightMap","metalnessMap","normalMap","roughnessMap","transmissionMap"].forEach((t=>{const n=e[t];n&&(n.repeat.copy(i),n.offset.copy(r),n.center.copy(a),n.rotation=s,n.needsUpdate=!0)})),e.needsUpdate=!0}))}}((t.version?t.version:"0.0.0").split(".").map((e=>parseInt(e))),e),i?i.applyViewerConfig(t,t.resources):this.fromJSON(t,t.resources)},this.alert=async e=>alert(e),this.confirm=async e=>confirm(e),this.prompt=async(e,t,i=!0)=>prompt(e,t),this._useRgbm=t,this._useGBufferDepth=i,this._screenShader=n,this._canvas=o.canvas||(0,a.createCanvasElement)();let c=o.container;if(c&&!o.canvas&&c.appendChild(this._canvas),c||(c=this._canvas.parentElement??void 0),!c)throw new Error("No container.");this._container=c,this._animationLoop=this._animationLoop.bind(this),this.setDirty=this.setDirty.bind(this),this._setActiveCameraView=this._setActiveCameraView.bind(this),window.webGiViewers||(window.webGiViewers=[]),window.webGiViewers.push(this),async function(){const e=window.location.href,t="https://dev-sandbox.pixotronics.com/webgi/";if(!e.startsWith(t))return!0;if(null!==(0,a.getUrlQueryParam)("noUpdate"))return!0;const i=e.match(/\/webgi\/([0-9.a-zA-Z-]+)/)?.[1],r=(await(await fetch(t+"version.txt")).text()).split("\n")[0];if(i&&i!==r){if(confirm(`New version ${r} is available, do you want to open?`)){const e=window.location.href.replace(i,r);return window.location.href=e,!1}window.location.href.includes("noUpdate")||(window.location.href+=(window.location.href.includes("?")?"&":"?")+"noUpdate")}}();const d=new y(void 0,void 0,this._canvas);d.autoLookAtTarget=!0,this.addEventListener("postFrame",(()=>{const e=u.scene.activeCamera;if(e&&e.interactionsEnabled){const t=this.getPluginByType("Progressive")?.postFrameConvergedRecordingDelta();if(void 0!==t&&0===t)return;e.controls?.update()}})),this.scene=new x(d),this.scene.addEventListener("environmentChanged",this._sceneEnvironmentChanged),this.scene.addEventListener("addSceneObject",this._addSceneObject),this.scene.addEventListener("setView",this._setActiveCameraView),this.scene.addEventListener("activateMain",this._setActiveCameraView),this._renderer=new p({canvas:this._canvas,animationLoop:this._animationLoop,targetOptions:{samples:e?4:0,colorSpace:t?l.N3:s.aCh,type:t?s.ywz:s.cLu,depthBuffer:!i,generateMipmaps:!!e,minFilter:e?s.FDw:s.wem}}),this._isAntialiased=e&&this._renderer.isWebGL2;let h=!0;this._renderer.rendererObject.userData||(h=!1,this._renderer.rendererObject.userData={}),this._renderer.rendererObject.userData.renderTransmissionPass=!h;const u=this;this.renderFilter={passId:"render",passObject:new O(this,h),update(){const e=this.passObject;e.scene=u.scene.modelObject,e.camera=u.scene.renderCamera.cameraObject}};const m={passId:"screen",after:["render"],required:["render"],passObject:L(n)};[this.renderFilter,m].forEach((e=>this._renderer.registerPass(e))),this._renderer.pipeline=["render","screen"],this.scene.addEventListener("textureUpdate",(e=>this.setDirty(this.scene,e))),this.scene.addEventListener("sceneMaterialUpdate",(e=>this.setDirty(this.scene,e))),this.scene.addEventListener("sceneUpdate",(e=>{this.setDirty(this.scene,e),!1!==e.geometryChanged&&this.renderer.resetShadows()})),this.scene.addEventListener("update",(e=>this.setDirty(this.scene,e))),this._renderer.addEventListener("update",(e=>this.setDirty(this._renderer,e))),this.resizeObserver&&this.resizeObserver.observe(this._canvas),window&&window.addEventListener("resize",this.resize),this._canvas.addEventListener("webglcontextrestored",this._onContextRestore,!1),this._canvas.addEventListener("webglcontextlost",this._onContextLost,!1),this.renderer.addEventListener("resize",(()=>{this.scene.activeCamera.refreshAspect()})),this.scene.setBackgroundColor("#ffffff"),o.assetManager&&this.addPluginSync(new P.k(void 0,void 0,"boolean"==typeof o.assetManager?{}:o.assetManager)),o.dropzone&&this.addPluginSync(new E.y),this.console.log("WebGi Viewer instance initialized, version: ",j.VERSION)}setDirty(e,t){this._needsReset=!0,e=e??this,this.dispatchEvent({...t??{},type:"update",source:e})}get renderer(){return this._renderer}dispose(){for(const e of[...Object.values(this.plugins)])this.removePlugin(e,!0);this.scene.dispose(),this.renderer.dispose(),this._canvas.removeEventListener("webglcontextrestored",this._onContextRestore,!1),this._canvas.removeEventListener("webglcontextlost",this._onContextLost,!1),window.webGiViewers?.splice(window.webGiViewers.indexOf(this),1),this.resizeObserver?this.resizeObserver.unobserve(this._canvas):window.removeEventListener("resize",this.resize),this.dispatchEvent({type:"dispose"})}_renderEnabledChanged(){this.dispatchEvent({type:this.renderEnabled?"renderEnabled":"renderDisabled"})}_animationLoop({time:e,deltaTime:t,xrFrame:i}){if(this.enabled&&this.renderEnabled)if(this._isRenderingFrame)this.console.warn("animation loop: frame skip");else{this._isRenderingFrame=!0;for(let r=0;r<this.maxFramePerLoop;r++){if(this._needsReset&&(this._renderer.reset(),this._needsReset=!1),this._needsResize){const e=[this._canvas.clientWidth,this._canvas.clientHeight];if(i){const t=this._renderer.rendererObject.xr.getCamera()?.cameras[0]?.viewport;t?(0===t.x&&0===t.y||this.console.warn("x and y must be 0?"),e[0]=t.width,e[1]=t.height,this.console.log("resize for xr",e)):this._needsResize=!1}this._needsResize&&(this._renderer.setSize(...e),this._needsResize=!1)}this.dispatchEvent({type:"preFrame",target:this,time:e,deltaTime:t,xrFrame:i});const r=Object.values(this.plugins).filter((e=>e.dirty));r.length>0&&this.setDirty(r),this._needsReset&&(this._renderer.reset(),this._needsReset=!1),this._renderer.updateDirty();const a=this._renderer.dirty;if(a)for(let e=0;e<this.rendersPerFrame;e++){this.dispatchEvent({type:"preRender",target:this});try{this.scene.renderCamera=this.scene.activeCamera,this._renderer.render(this._renderer.defaultRenderToScreen)}catch(e){this.console.error(e),this.enabled=!1}this.dispatchEvent({type:"postRender",target:this})}if(this.dispatchEvent({type:"postFrame",target:this}),!a)break}this._isRenderingFrame=!1}}get state(){return this._state}get container(){return this._canvas.parentElement!==this._container&&this.console.error("ViewerApp: Canvas is not in the container, this might cause issues with some plugins."),this._container}get canvas(){return this._canvas}get canvasTexture(){if(!this._canvas)throw new Error("Canvas not found");return this._canvasTexture||(this._canvasTexture=new s.ROQ(this._canvas),this._canvasTexture.flipY=!1,this._canvasTexture.needsUpdate=!0),this._canvasTexture}getPlugin(e){return"string"==typeof e?this.getPluginByType(e):this.plugins[e.PluginType]}getPluginByType(e){return this.plugins[e]}async getOrAddPlugin(e,...t){return this.getPlugin(e)||this.addPlugin(e,...t)}getOrAddPluginSync(e,...t){return this.getPlugin(e)||this.addPluginSync(e,...t)}async addPlugin(e,...t){let i;if(e.prototype){const r=this.getPlugin(e);if(r)return console.error(`Plugin of type ${A(r)} already exists, no new plugin created`,r),r;i=new e(...t)}else i=e;const r=A(i);if(!r)return this.console.error("PluginType is not defined for",i),i;for(const e of i.dependencies||[])await this.getOrAddPlugin(e);return this.plugins[r]&&(this.console.error(`Plugin of type ${r} already exists, old plugin will be removed and disposed`,this.plugins[r],i),await this.removePlugin(this.plugins[r],!0)),this.plugins[r]=i,await i.onAdded(this),this.dispatchEvent({type:"addPlugin",target:this,plugin:i}),this.setDirty(i),i}addPluginSync(e,...t){let i;if(e.prototype){const r=this.getPlugin(e);if(r)return console.error(`Plugin of type ${A(r)} already exists, no new plugin created`,r),r;i=new e(...t)}else i=e;const r=A(i);if(!r)return this.console.error("PluginType is not defined for",i),i;for(const e of i.dependencies||[])this.getOrAddPluginSync(e);return this.plugins[r]&&(this.console.error(`Plugin of type ${r} already exists, old plugin will be removed and disposed`,this.plugins[r],i),this.removePluginSync(this.plugins[r],!0)),this.plugins[r]=i,i.onAdded(this),this.dispatchEvent({type:"addPlugin",target:this,plugin:i}),this.setDirty(i),i}async addPlugins(e){for(const t of e)await this.addPlugin(t)}async addPluginsSync(e){for(const t of e)this.addPluginSync(t)}async removePlugin(e,t=!0){const i=A(e);this.plugins[i]&&(await e.onRemove(this),delete this.plugins[i],t&&e.onDispose&&await e.onDispose(this),this.setDirty(e))}removePluginSync(e,t=!0){const i=A(e);this.plugins[i]&&(e.onRemove(this),delete this.plugins[i],t&&e.onDispose&&e.onDispose(this),this.setDirty(e))}createCamera(e){const t=e.userData.iCamera??new y(e,{controlsMode:"",aspect:"auto"},this._canvas);return void 0===e.userData.autoLookAtTarget?(t.autoLookAtTarget=!1,e.userData.autoLookAtTarget=!1):t.autoLookAtTarget=e.userData.autoLookAtTarget,t}setSize(e){this._canvas.style.width=e?.width?e.width+"px":"100%",this._canvas.style.height=e?.height?e.height+"px":"100%",this.resize()}async doOnce(e,t){return new Promise((i=>{const r=async(...a)=>{this.removeEventListener(e,r),i(await(t?.(...a)))};this.addEventListener(e,r)}))}setBackgroundColor(e){return console.warn("viewer.setBackground is deprecated, use viewer.scene.setBackgroundColor instead."),this.setBackgroundColor(e)}setBackground(e){if(console.warn("viewer.setBackground is deprecated, use viewer.scene.setBackground instead."),this._rawBackground=e,null==e||"string"!=typeof e&&"number"!=typeof e&&!e.isColor)!e&&this.useRgbm&&this.console.error("Transparent background not supported with HDR RGBM rendering mode");else if(e===U)return this.scene.setBackground("environment");!e||e?.isTexture?(this.scene.setBackground(e),e||this.scene.setBackgroundColor(e)):this.scene.setBackgroundColor(e)}getBackground(e=!1){if(console.warn("viewer.getBackground is deprecated, use viewer.scene.background instead."),e)return this._rawBackground;let t=this._rawBackground??this.scene.getBackground();return t?(t?.isVector4&&(t=(i=t,7,function(e,t){e.multiplyScalar(7*e.w),e.w=1}(i),new s.Ilk(i.x,i.y,i.z)).getHexString()),t?.isColor?t.getHexString():this._rawBackground===U?this.scene.getEnvironment():t):null;var i}getManager(){return this.getPluginByType("AssetManager")||this.addPluginSync(P.k)}resetCamera({rootObject:e,centerOffset:t=new s.Pa4(1,1,1),targetOffset:i=new s.Pa4(0,0,0),...r}={}){if(this.scene.activeCamera){this.scene.matrixWorldNeedsUpdate=!0,this.scene.updateMatrixWorld(!0);const r=e?(new b.q).expandByObject(e,!0,!0):this.scene.getBounds(!0),a=r.getCenter(new s.Pa4),n=.5*r.getSize(new s.Pa4).length();a.add(i.clone().multiplyScalar(n)),this.scene.activeCamera.position=new s.Pa4(a.x+t.x*n,a.y+t.y*n,a.z+t.z*n),this.scene.activeCamera.target=a,this.setDirty()}}async fitToView(e,t=1.5,i,r){const a=this.getPluginByType("CameraViews");a?await(a?.animateToFitObject(e,t,i,r,{min:(this.scene.activeCamera.getControls()?.minDistance??.5)+.5,max:1e3})):this.console.error("CameraViews plugin is required for fitToView to work")}async createObject3D(e,t=!1){return this.getManager()?.addImportedSingle(e||new s.Tme,{autoScale:!1,pseudoCenter:!1,addToRoot:t})}createPhysicalMaterial(e){return this.createMaterial("standard",e)}createMaterial(e,t){if(t?.isMaterial){const e=this.getManager()?.materials?.findMaterial(t.uuid);if(e)return e}return this.getManager()?.materials?.generateFromTemplate(e,t)}serializePlugins(e,t){return Object.entries(this.plugins).map((i=>{if(!t||t.includes(i[1].constructor.PluginType))return!1!==i[1].serializeWithViewer?i[1].toJSON?.(e):void 0})).filter((e=>!!e))}deserializePlugins(e,t){return e.forEach((e=>{if(!e.type)return void this.console.warn("Invalid plugin to import ",e);const i=this.getPluginByType(e.type);i&&i.fromJSON?.(e,t)})),this}traverseSceneObjects(e){this.scene.modelRoot.modelObject.traverse(e)}toJSON(e,t){const i=Object.assign({version:j.VERSION,type:"ViewerApp",metadata:{generator:"WebGiViewerApp",version:1},plugins:this.serializePlugins(e,t)},(0,c.HD)(this,!0,e));return i.backgroundIntensity=this.scene.backgroundIntensity,i.useLegacyLights=this.renderer.useLegacyLights,i.background=i.scene.background||i.scene.backgroundColor,"environment"===i.background&&(i.background="envMapBackground"),i}fromJSON(e,t){const i={...e};return void 0!==i.backgroundIntensity&&void 0===i.scene?.backgroundIntensity&&(this.console.warn("old file format, backgroundIntensity moved to RootScene"),this.scene.backgroundIntensity=i.backgroundIntensity,delete i.backgroundIntensity),void 0!==i.useLegacyLights&&void 0===i.renderManager?.useLegacyLights&&(this.console.warn("old file format, useLegacyLights moved to BaseRenderer"),this.renderer.useLegacyLights=i.useLegacyLights,delete i.useLegacyLights),void 0!==i.background&&void 0===i.scene?.background&&(this.console.warn("old file format, background moved to RootScene"),"envMapBackground"===i.background?i.background="environment":"number"==typeof i.background?i.background=(new s.Ilk).setHex(i.background,s.GUF):"string"==typeof i.background?i.background=(new s.Ilk).setStyle(i.background,s.GUF):i.background?.isColor&&(i.background=new s.Ilk(i.background)),i.background?.isColor?(this.scene.backgroundColor=i.background,this.scene.background=null):i.background?(this.scene.backgroundColor=new s.Ilk("#ffffff"),i.scene.background=i.background):(this.scene.backgroundColor=null,this.scene.background=null),delete i.background),(0,c.Hx)(i,this,!0,t),Array.isArray(i.plugins)&&this.deserializePlugins(i.plugins,t),this}get renderManager(){return this._renderer}get assetManager(){return this.getManager()}async load(e,t){if(e)return await this.assetManager.addAssetSingle(e,t)}async setEnvironmentMap(e,{setBackground:t=!1,...i}={}){return this.scene.environment=e&&!e.isTexture?await this.assetManager.importer.importSingle(e,i)||null:e||null,t?this.setBackgroundMap(this.scene.environment):this.scene.environment}async setBackgroundMap(e,{setEnvironment:t=!1,...i}={}){return this.scene.background=e&&!e.isTexture?await this.assetManager.importer.importSingle(e,i)||null:e||null,t?this.setEnvironmentMap(this.scene.background):this.scene.background}_setActiveCameraView(e={}){if("setView"===e.type){if(!e.camera)return void this.console.warn("Cannot find camera",e);this.scene.activeCamera.copyFromCamera(e.camera)}else"activateMain"===e.type&&(this.scene.activeCamera=e.camera?this.createCamera(e.camera):void 0)}}j.VERSION="0.9.7",R([(0,c.qC)("renderManager")],j.prototype,"_renderer",void 0),R([(0,c.qC)()],j.prototype,"scene",void 0),R([(0,a.onChange)(j.prototype._renderEnabledChanged)],j.prototype,"renderEnabled",void 0);const U="envMapBackground";function L(e){return e?.isShaderPass2?e:new S.Hl({...D.C,fragmentShader:`\n                       varying vec2 vUv;\n                       \n                       ${Array.isArray(e)?e[0]:e?.pars||""}\n                       \n                       void main() {\n\n                            gl_FragColor = tDiffuseTexelToLinear (texture2D(tDiffuse, vUv));\n                            \n                            ${Array.isArray(e)?e[1]:"string"==typeof e?e:e?.main||""}\n                            \n                        }`,uniforms:{tDiffuse:{value:null}}},"tDiffuse")}},5804:function(e,t){t.Z="#ifndef BASIC_HELPERS\n#define BASIC_HELPERS \nfloat saturate2(float v,float mx){return max(0.,min(mx,v));}vec3 saturate2(vec3 v){return max(vec3(0.),min(vec3(1.),v));}\n#endif\n"},3138:function(e,t){t.Z="#ifndef BASIC_CAMERA_HELPERS\n#define BASIC_CAMERA_HELPERS \nuniform vec2 cameraNearFar;uniform vec3 cameraPositionWorld;uniform mat4 projection;\n#ifndef THREE_PACKING_INCLUDED\n#define THREE_PACKING_INCLUDED \n#include <packing>\n#endif\nfloat linstep(float edge0,float edge1,float value){return clamp((value-edge0)/(edge1-edge0),0.,1.);}float depthToViewZ(const in float depth){return(depth>0.999)?-cameraNearFar.y*1000.:-mix(cameraNearFar.x,cameraNearFar.y,depth);}float viewZToDepth(const in float viewZ){return linstep(-cameraNearFar.x,-cameraNearFar.y,viewZ);}vec4 viewToScreen3(const in vec3 pos){vec4 projected=projection*vec4(pos,1.);projected.z=pos.z;projected.w=1./projected.w;projected.xyz*=projected.w;projected.xy=0.5+0.5*projected.xy;return projected;}vec3 screenToView(const in vec2 uv,const in float viewZ){vec2 uv_=2.*uv-1.;float xe=-(uv_.x+projection[2][0])*viewZ/projection[0][0];float ye=-(uv_.y+projection[2][1])*viewZ/projection[1][1];return vec3(xe,ye,viewZ);}\n#endif\n"},7320:function(e,t){t.Z="varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},9389:function(e,t){t.Z="vec2 poisson_disk_samples[16];void setPds(){poisson_disk_samples[0]=vec2(-0.399691779231,0.728591545584);poisson_disk_samples[1]=vec2(-0.48622557676,-0.84016533712);poisson_disk_samples[2]=vec2(0.770309468987,-0.24906070432);poisson_disk_samples[3]=vec2(0.556596796154,0.820359876432);poisson_disk_samples[4]=vec2(-0.933902004071,0.0600539051593);poisson_disk_samples[5]=vec2(0.330144964342,0.207477293384);poisson_disk_samples[6]=vec2(0.289013230975,-0.686749271417);poisson_disk_samples[7]=vec2(-0.0832470893559,-0.187351643125);poisson_disk_samples[8]=vec2(-0.296314525615,0.254474834305);poisson_disk_samples[9]=vec2(-0.850977666059,0.484642744689);poisson_disk_samples[10]=vec2(0.829287915319,0.2345063545);poisson_disk_samples[11]=vec2(-0.773042143899,-0.543741521254);poisson_disk_samples[12]=vec2(0.0561133030864,0.928419742597);poisson_disk_samples[13]=vec2(-0.205799249508,-0.562072714492);poisson_disk_samples[14]=vec2(-0.526991665882,-0.193690188118);poisson_disk_samples[15]=vec2(-0.051789270667,-0.935374050821);}"},3198:function(e,t){t.Z="#ifndef BASIC_RANDOM_HELPERS\n#define BASIC_RANDOM_HELPERS \nuniform float frameCount;float random(float n){return fract(sin(n)*43758.5453123);}float random2(vec2 n,float x){n+=x;return fract(sin(dot(n.xy,vec2(12.9898,78.233)))*43758.5453);}float random3(vec3 v){v=fract(v*443.8975);v+=dot(v,v.yzx+19.19);return fract((v.x+v.y)*v.z);}float interleavedGradientNoise(const in vec2 fragCoord,const in float seed){vec3 magic=vec3(0.06711056,0.00583715,52.9829189);return fract(magic.z*fract(dot(fragCoord.xy+seed*vec2(2.083,4.867),magic.xy)));}vec3 hash3(vec2 p){vec3 q=vec3(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3)),dot(p,vec2(419.2,371.9)));return fract(sin(q)*43758.5453);}\n#endif\n"},9698:function(e,t){t.Z="#define PI  3.141592653589793\nmat3 GetTangentBasis(vec3 TangentZ){vec3 up=vec3(0.,0.,1.);vec3 TangentX=normalize(cross(dot(TangentZ,up)<0.8?up:vec3(1.,0.,0.),TangentZ));vec3 TangentY=cross(TangentZ,TangentX);return mat3(TangentX,TangentY,TangentZ);}vec4 CosineSampleHemisphere(vec2 E){float Phi=2.*PI*E.x;float CosTheta=sqrt(E.y);float SinTheta=sqrt(1.-CosTheta*CosTheta);vec3 H;H.x=SinTheta*cos(Phi);H.y=SinTheta*sin(Phi);H.z=CosTheta;float PDF=CosTheta*(1./PI);return vec4(H,PDF);}vec4 UniformSampleHemisphere(vec2 E){float Phi=2.*PI*E.x;float CosTheta=E.y;float SinTheta=sqrt(1.-CosTheta*CosTheta);vec3 H;H.x=SinTheta*cos(Phi);H.y=SinTheta*sin(Phi);H.z=CosTheta;float PDF=1./(2.*PI);return vec4(H,PDF);}vec2 UniformSampleDiskConcentric(vec2 E){vec2 p=2.*E-1.;float Radius;float Phi;if(abs(p.x)>abs(p.y)){Radius=p.x;Phi=(PI/4.)*(p.y/p.x);}else{Radius=p.y;Phi=(PI/2.)-(PI/4.)*(p.x/p.y);}return vec2(Radius*cos(Phi),Radius*sin(Phi));}vec2 UniformSampleDiskConcentricApprox(vec2 E){vec2 sf=E*sqrt(2.)-sqrt(0.5);vec2 sq=sf*sf;float root=sqrt(2.*max(sq.x,sq.y)-min(sq.x,sq.y));if(sq.x>sq.y){sf.x=sf.x>0.?root:-root;}else{sf.y=sf.y>0.?root:-root;}return sf;}"},5130:function(e,t){t.Z="#ifndef SIMPLE_CAMERA_HELPERS\n#define SIMPLE_CAMERA_HELPERS \n#ifndef USE_TRANSMISSION\nuniform mat4 projectionMatrix;\n#endif\nvec3 viewToScreen(const in vec3 pos){vec4 projected=projectionMatrix*vec4(pos,1.);return vec3(0.5+0.5*projected.xy/projected.w,projected.w);}\n#endif\n"},7337:function(e,t){t.Z="#ifndef SSRT_PARS_SNIP\n#define SSRT_PARS_SNIP \n#define pow2(a)a*a\nfloat getDepth2(const in vec2 uv,const in float lod){float viewDepth=getDepth(uv);return depthToViewZ(viewDepth);}\n#define LOD_DEPTH  1.0\n#define LOD_COLOR  5.0\nvoid _traceRay(in vec4 ray_origin,in vec4 ray_dir,in float tolerance,inout vec3 state,in int loopMax,in float iStepCount){vec4 sample_uv;float d,hit;float dLod=0.;\n#pragma unroll_loop_start\nfor(int i=0;i<8;i++){if(UNROLLED_LOOP_INDEX<loopMax){sample_uv=ray_origin+ray_dir*state.y;d=getDepth2(sample_uv.xy,dLod);d=sample_uv.z/sample_uv.w-d;if(abs(d+tolerance)<tolerance){hit=clamp(state.x/(state.x-d),0.,1.)-1.;hit=(state.y+hit*iStepCount);state.z=min(state.z,hit);}state.x=d;state.y+=1.*iStepCount;}}\n#pragma unroll_loop_end\n}vec3 traceRay(in vec3 ray_origin_view,in vec3 ray_dir_view,in float tolerance,inout vec3 state,in int _STEP_COUNT){vec4 sample_uv;vec4 ray_origin=viewToScreen3(ray_origin_view);vec3 ray_end_view=ray_origin_view+ray_dir_view;vec4 ray_dir=viewToScreen3(ray_end_view);vec2 clamp_end=clamp(ray_dir.xy,vec2(0.),vec2(1.));vec2 correction=abs(ray_dir.xy-clamp_end);correction=(step(0.01,correction)*correction/(abs(clamp_end-ray_origin.xy)+0.01))+1.;correction.x=1./min(max(correction.y,correction.x),10.);ray_dir=ray_dir-ray_origin;ray_dir.xyw*=correction.x;float iStepCount=1./float(_STEP_COUNT);tolerance*=0.125;_traceRay(ray_origin,ray_dir,tolerance,state,_STEP_COUNT,iStepCount);if(_STEP_COUNT>8&&state.z>0.98)_traceRay(ray_origin,ray_dir,tolerance,state,_STEP_COUNT-8,iStepCount);if(_STEP_COUNT>15&&state.z>0.98)_traceRay(ray_origin,ray_dir,tolerance,state,_STEP_COUNT-16,iStepCount);if(_STEP_COUNT>23&&state.z>0.98)_traceRay(ray_origin,ray_dir,tolerance,state,_STEP_COUNT-16,iStepCount);sample_uv=ray_origin+ray_dir*state.z;sample_uv.z/=sample_uv.w;state.z=state.z<0.999?state.z:9999999.;return sample_uv.xyz;}\n#endif\n"},9033:function(e,t){t.Z="#ifndef UNPACK_GBUFFER_SNIPPET\n#define UNPACK_GBUFFER_SNIPPET \nuniform sampler2D tNormalDepth;float unpack16(vec2 value){return value.x+value.y/255.;}vec3 unpackNormal(vec2 enc){vec2 fenc=enc*4.-2.;float f=dot(fenc,fenc);float g=sqrt(1.-f/4.);return vec3(fenc*g,1.-f/2.);}float unpackDepth(vec2 uncodedDepth){float x=unpack16(uncodedDepth.xy);return x*x;}float getDepth(vec2 uv){vec4 uncodedDepth=texture2D(tNormalDepth,uv);return unpackDepth(uncodedDepth.xy);}void getDepthNormal(const in vec2 uv,out float depth,out vec3 normal){vec4 uncodedDepth=texture2D(tNormalDepth,uv);depth=unpackDepth(uncodedDepth.xy);normal=unpackNormal(uncodedDepth.zw);}vec3 getViewNormal(const in vec2 uv){return unpackNormal(texture2D(tNormalDepth,uv).zw);}\n#if defined(GBUFFER_HAS_FLAGS) && GBUFFER_HAS_FLAGS == 1\nuniform sampler2D tGBufferFlags;\n#endif\nivec4 getGBufferFlags(const in vec2 uv){\n#if defined(GBUFFER_HAS_FLAGS) && GBUFFER_HAS_FLAGS == 1\nreturn ivec4(texture2D(tGBufferFlags,uv)*255.);\n#else\nreturn ivec4(1);\n#endif\n}\n#endif\n"}}]);
